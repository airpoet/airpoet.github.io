<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>A.Pçš„æ–‡è‰ºæ‚è°ˆ</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://airpoet.github.io/"/>
  <updated>2018-07-30T03:09:19.161Z</updated>
  <id>https://airpoet.github.io/</id>
  
  <author>
    <name>airpoet</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sparké‡ç‚¹è§£æ(ä¸‰) =&gt; Spark SQL</title>
    <link href="https://airpoet.github.io/2018/07/27/Spark/Spark%E9%87%8D%E7%82%B9%E8%A7%A3%E6%9E%90(%E4%B8%89)-=-Spark-SQL/"/>
    <id>https://airpoet.github.io/2018/07/27/Spark/Sparké‡ç‚¹è§£æ(ä¸‰)-=-Spark-SQL/</id>
    <published>2018-07-27T06:32:27.283Z</published>
    <updated>2018-07-30T03:09:19.161Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-SparkSQL-çš„å‰ä¸–ä»Šç”Ÿ"><a href="#ä¸€-SparkSQL-çš„å‰ä¸–ä»Šç”Ÿ" class="headerlink" title="ä¸€. SparkSQL çš„å‰ä¸–ä»Šç”Ÿ"></a>ä¸€. SparkSQL çš„å‰ä¸–ä»Šç”Ÿ</h1><ul><li>Hive =&gt; MapReduce =&gt; HDFS</li><li>Shark =&gt; ä½¿ç”¨ Hive çš„ SQL è§£æå¼•æ“ =&gt; RDD =&gt; é€šè¿‡Hive çš„metadataè¡¨å»æ“ä½œ HDFS</li><li>SparkSQL =&gt; <strong>ä½¿ç”¨è‡ªå·±SQL è§£æå¼•æ“</strong> =&gt; RDD =&gt; é€šè¿‡Hive çš„metadataè¡¨å»æ“ä½œ HDFS</li></ul><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-27-064024.jpg" alt=""></p><hr><h1 id="äºŒ-SparkSession"><a href="#äºŒ-SparkSession" class="headerlink" title="äºŒ. SparkSession"></a>äºŒ. SparkSession</h1><p>åœ¨ Spark çš„æ—©æœŸç‰ˆæœ¬(<strong>1.x ç‰ˆæœ¬)</strong>ä¸­ï¼ŒSparkContext æ˜¯ Spark çš„ä¸»è¦åˆ‡å…¥ç‚¹ï¼Œç”±äº RDD æ˜¯ä¸»è¦çš„ APIï¼Œæˆ‘ ä»¬é€šè¿‡ sparkContext æ¥åˆ›å»ºå’Œæ“ä½œ RDDã€‚å¯¹äºæ¯ä¸ªå…¶ä»–çš„ APIï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸åŒçš„ contextã€‚ ä¾‹å¦‚ï¼š</p><p>SparkContext      =&gt; åˆ›å»º RDD</p><p>StreamingContext =&gt; åˆ›å»º Streaming</p><p>SQLContext          =&gt; åˆ›å»º SQL</p><p>HiveContext          =&gt; åˆ›å»º Hive</p><p><strong>ä» Spark 2.0å¼€å§‹, å¼•å…¥ <code>SparkSession</code></strong></p><p>â€”- ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç»Ÿä¸€çš„åˆ‡å…¥ç‚¹ä½¿ç”¨ Spark å„é¡¹åŠŸèƒ½</p><p>â€”- å…è®¸ç”¨æˆ·é€šè¿‡å®ƒè°ƒç”¨ DataFrame å’Œ Dataset ç›¸å…³ API æ¥ç¼–å†™ç¨‹åº</p><p>â€”- å‡å°‘äº†ç”¨æˆ·éœ€è¦äº†è§£çš„ä¸€äº›æ¦‚å¿µï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ä¸ Spark è¿›è¡Œäº¤äº’</p><p>â€”- ä¸ Spark äº¤äº’ä¹‹æ—¶ä¸éœ€è¦æ˜¾ç¤ºçš„åˆ›å»º SparkConfã€SparkContext ä»¥åŠ SQlContextï¼Œè¿™äº›å¯¹è±¡å·²ç»å°é—­åœ¨ SparkSession ä¸­</p><p>â€”- SparkSession æä¾›å¯¹ Hive ç‰¹å¾çš„å†…éƒ¨æ”¯æŒï¼šç”¨ HiveQL å†™ SQL è¯­å¥ï¼Œè®¿é—® Hive UDFsï¼Œä» Hive è¡¨ä¸­è¯»å–æ•°æ®ã€‚</p><hr><h1 id="ä¸‰-DataFrame"><a href="#ä¸‰-DataFrame" class="headerlink" title="ä¸‰. DataFrame"></a>ä¸‰. DataFrame</h1><p><strong>æ³¨æ„</strong>: è¿™é‡Œçš„æ“ä½œéƒ½æ˜¯åŸºäº1.x ç‰ˆæœ¬,  ä¸2.x çš„åŒºåˆ«å°±æ˜¯2.x ç»Ÿä¸€äº†æ“ä½œå…¥å£ä¸º SparkSession</p><p><a href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-2/#more">2.x çš„æ“ä½œä»£ç è§æˆ‘çš„å¦ä¸€ç¯‡ bolg</a></p><blockquote><p>ä» json æ–‡ä»¶è¯»å–ä¸º dataframe, ä½¿ç”¨spark çš„ api è°ƒç”¨</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SQLContext</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DataFrameOperation</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//create  datarame</span></span><br><span class="line">    <span class="comment">//é¦–å…ˆåˆ›å»ºç¨‹åºå…¥å£</span></span><br><span class="line">    <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"DataFrameOperation"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">    <span class="comment">//create sqlcontext</span></span><br><span class="line">    <span class="keyword">val</span> sqlContext=<span class="keyword">new</span> <span class="type">SQLContext</span>(sc);</span><br><span class="line">    <span class="keyword">val</span> df=sqlContext.read.json(<span class="string">"hdfs://mycluster/user/ap/sparkdatas/people"</span>)</span><br><span class="line">    df.show();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//print schema</span></span><br><span class="line">    df.printSchema()</span><br><span class="line">    <span class="comment">//name age</span></span><br><span class="line">    df.select(<span class="string">"name"</span>).show();</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    df.select(df(<span class="string">"name"</span>),df(<span class="string">"age"</span>)+<span class="number">1</span>).show()</span><br><span class="line">    <span class="comment">//where</span></span><br><span class="line">    df.filter(df(<span class="string">"age"</span>) &gt; <span class="number">21</span>).show()</span><br><span class="line">    <span class="comment">//groupby</span></span><br><span class="line">    df.groupBy(<span class="string">"age"</span>).count().show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å››-RDD-è½¬ä¸º-DataFrame"><a href="#å››-RDD-è½¬ä¸º-DataFrame" class="headerlink" title="å››. RDD è½¬ä¸º DataFrame"></a>å››. RDD è½¬ä¸º DataFrame</h1><h2 id="1-ä½¿ç”¨å¯¹è±¡-RDD-åå°„-Reflection-çš„æ–¹å¼"><a href="#1-ä½¿ç”¨å¯¹è±¡-RDD-åå°„-Reflection-çš„æ–¹å¼" class="headerlink" title="1.ä½¿ç”¨å¯¹è±¡ RDD åå°„ Reflection çš„æ–¹å¼"></a>1.ä½¿ç”¨å¯¹è±¡ RDD åå°„ Reflection çš„æ–¹å¼</h2><blockquote><p>Scala æ–¹å¼</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">æ­¥éª¤: </span><br><span class="line"><span class="number">1</span>) æ„é€ ä¸€ä¸ªå°è£…äº†æŒ‡å®šå¯¹è±¡çš„<span class="type">RDD</span></span><br><span class="line"><span class="number">2</span>) å¼•å…¥sparksessionçš„éšå¼è½¬æ¢</span><br><span class="line"><span class="number">3</span>) è°ƒç”¨ rdd.toDF()</span><br><span class="line">=====================================================================</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SQLContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">age:<span class="type">Int</span>,name:<span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">object</span> <span class="title">RDD2DataFrameReflection</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">     <span class="comment">//create  datarame</span></span><br><span class="line">    <span class="comment">//é¦–å…ˆåˆ›å»ºç¨‹åºå…¥å£</span></span><br><span class="line">    <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"RDD2DataFrameReflection"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//create sqlcontext</span></span><br><span class="line">    <span class="keyword">val</span> sqlContext=<span class="keyword">new</span> <span class="type">SQLContext</span>(sc);</span><br><span class="line">    <span class="keyword">import</span> sqlContext.implicits._</span><br><span class="line">    <span class="keyword">val</span> personRDD= sc.textFile(<span class="string">"hdfs://mycluster/user/ap/sparkdatas/peopletxt/people.txt"</span>, <span class="number">2</span>)</span><br><span class="line">    .map &#123; line =&gt; line.split(<span class="string">","</span>) &#125;.map &#123; p =&gt; <span class="type">Person</span>(p(<span class="number">1</span>).trim().toInt,p(<span class="number">0</span>)) &#125;</span><br><span class="line">    <span class="keyword">val</span> personDF=personRDD.toDF()</span><br><span class="line">   <span class="comment">// æˆ–è€… personDF.createOrReplaceTempView("person") / createGlobalTempView / createTempView</span></span><br><span class="line">    personDF.registerTempTable(<span class="string">"person"</span>)</span><br><span class="line">    <span class="keyword">val</span> personDataframe=sqlContext.sql(<span class="string">"select name,age from person where age &gt; 13 and age &lt;= 19"</span>)</span><br><span class="line">    personDataframe.rdd.foreach &#123; row =&gt; println(row.getString(<span class="number">0</span>)+<span class="string">"  "</span>+row.getString(<span class="number">1</span>)) &#125;</span><br><span class="line">    personDataframe.rdd.saveAsTextFile(<span class="string">"hdfs://hadoop1:9000/reflectionresult/"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Java æ–¹å¼</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.DataFrame;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.SQLContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RDD2DataFrameReflection</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">conf.setAppName(<span class="string">"RDD2DataFrameReflection"</span>);</span><br><span class="line">JavaSparkContext sc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">SQLContext sqlContext = <span class="keyword">new</span> SQLContext(sc);</span><br><span class="line">JavaRDD&lt;Person&gt; PersonRDD = sc.textFile(<span class="string">"hdfs://hadoop1:9000/examples/src/main/resources/people.txt"</span>)</span><br><span class="line">.map(<span class="keyword">new</span> Function&lt;String, Person&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Person <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">String[] strs = line.split(<span class="string">","</span>);</span><br><span class="line">String name=strs[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">int</span> age=Integer.parseInt(strs[<span class="number">1</span>].trim());</span><br><span class="line">Person person=<span class="keyword">new</span> Person(age,name);</span><br><span class="line"><span class="keyword">return</span> person;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">DataFrame personDF = sqlContext.createDataFrame(PersonRDD, Person.class);</span><br><span class="line">personDF.registerTempTable(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">DataFrame resultperson = sqlContext.sql(<span class="string">"select name,age from person where age &gt; 13 and age &lt;= 19"</span>);</span><br><span class="line">resultperson.javaRDD().foreach(<span class="keyword">new</span> VoidFunction&lt;Row&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Row row)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//æŠŠæ¯ä¸€æ¡æ•°æ®éƒ½çœ‹æˆæ˜¯ä¸€ä¸ªrow  row(0)=name  row(1)=age </span></span><br><span class="line">System.out.println(<span class="string">"name"</span>+row.getString(<span class="number">0</span>));</span><br><span class="line">System.out.println(<span class="string">"age"</span>+row.getInt(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">resultperson.javaRDD().saveAsTextFile(<span class="string">"hdfs://hadoop1:9000/reflectionresult"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-ä½¿ç”¨æ„é€ StructTypeæ–¹å¼"><a href="#2-ä½¿ç”¨æ„é€ StructTypeæ–¹å¼" class="headerlink" title="2.  ä½¿ç”¨æ„é€ StructTypeæ–¹å¼"></a>2.  ä½¿ç”¨æ„é€ StructTypeæ–¹å¼</h2><blockquote><p>scala</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">è¦ç‚¹: </span><br><span class="line"><span class="number">1</span>) æ„é€  <span class="type">StructType</span></span><br><span class="line"><span class="number">2</span>) æ„é€  rowRDD </span><br><span class="line"><span class="keyword">val</span> rowRDD = studentRDD.map(p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>).toInt, p(<span class="number">1</span>).trim, p(<span class="number">2</span>).trim, p(<span class="number">3</span>).toInt, p(<span class="number">4</span>).trim))</span><br><span class="line"><span class="number">3</span>) æ„é€  <span class="type">DataFrame</span></span><br><span class="line">df = sparksession.createDataFrame(rowRDD, schema) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SQLContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.<span class="type">StructType</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.<span class="type">StructField</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.<span class="type">StringType</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">RDD2DataFrameProgrammatically</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"RDD2DataFrameProgrammatically"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//create sqlcontext</span></span><br><span class="line">    <span class="keyword">val</span> sqlContext=<span class="keyword">new</span> <span class="type">SQLContext</span>(sc);</span><br><span class="line">    <span class="keyword">import</span> sqlContext.implicits._</span><br><span class="line">    <span class="keyword">val</span> personRDD= sc.textFile(<span class="string">"hdfs://hadoop1:9000/examples/src/main/resources/people.txt"</span>, <span class="number">1</span>)</span><br><span class="line">      </span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">//create schema</span></span><br><span class="line">    <span class="keyword">val</span> schemaString=<span class="string">"nameage"</span>;</span><br><span class="line">    <span class="keyword">val</span> schema=<span class="type">StructType</span>(</span><br><span class="line">        schemaString.split(<span class="string">"\t"</span>).map &#123; fieldsName =&gt; <span class="type">StructField</span>(fieldsName,<span class="type">StringType</span>,<span class="literal">true</span>) &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">/**  å‚æ•°</span></span><br><span class="line"><span class="comment">            case class StructField(</span></span><br><span class="line"><span class="comment">            name: String,</span></span><br><span class="line"><span class="comment">            dataType: DataType,</span></span><br><span class="line"><span class="comment">            nullable: Boolean = true,</span></span><br><span class="line"><span class="comment">            metadata: Metadata = Metadata.empty)</span></span><br><span class="line"><span class="comment">    æ„é€ æ–¹å¼:</span></span><br><span class="line"><span class="comment">    val schema = StructType(</span></span><br><span class="line"><span class="comment">              List(</span></span><br><span class="line"><span class="comment">                StructField("id", IntegerType, true),</span></span><br><span class="line"><span class="comment">                StructField("name", StringType, true),</span></span><br><span class="line"><span class="comment">                StructField("sex", StringType, true),</span></span><br><span class="line"><span class="comment">                StructField("age", IntegerType, true),</span></span><br><span class="line"><span class="comment">                StructField("department", StringType, true)</span></span><br><span class="line"><span class="comment">              )</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">     <span class="comment">//create rowrdd</span></span><br><span class="line">    <span class="keyword">val</span> rowRDD=personRDD.map &#123; line =&gt; line.split(<span class="string">","</span>) &#125;.map &#123; p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>),p(<span class="number">1</span>)) &#125;</span><br><span class="line">    <span class="keyword">val</span> personDF=sqlContext.createDataFrame(rowRDD, schema)</span><br><span class="line">      </span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////      </span></span><br><span class="line">    personDF.registerTempTable(<span class="string">"person"</span>);</span><br><span class="line">     <span class="keyword">val</span> personDataframe=sqlContext.sql(<span class="string">"select name,age from person where age &gt; 13 and age &lt;= 19"</span>)</span><br><span class="line">    </span><br><span class="line">     personDataframe.rdd.foreach &#123; row =&gt; println(row.getString(<span class="number">0</span>)+<span class="string">"=&gt;  "</span>+row.getString(<span class="number">1</span>)) &#125;</span><br><span class="line">    personDataframe.rdd.saveAsTextFile(<span class="string">"hdfs://hadoop1:9000/RDD2DataFrameProgrammatically/"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Java</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.DataFrame;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.RowFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.SQLContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.DataTypes;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.StructField;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.StructType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RDD2DataFrameProgrammactically</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">conf.setAppName(<span class="string">"RDD2DataFrameProgrammactically"</span>);</span><br><span class="line">JavaSparkContext sc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">SQLContext sqlContext = <span class="keyword">new</span> SQLContext(sc);</span><br><span class="line">JavaRDD&lt;String&gt; personRDD = sc.textFile(<span class="string">"hdfs://hadoop1:9000/examples/src/main/resources/people.txt"</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œçš„schemaString æ˜¯ä»æ•°æ®åº“é‡Œé¢åŠ¨æ€è·å–ä»æ¥çš„</span></span><br><span class="line"><span class="comment"> * åœ¨å®é™…çš„å¼€å‘ä¸­æˆ‘ä»¬éœ€è¦å†™å¦å¤–çš„ä»£ç å»è·å–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String schemaString=<span class="string">"nameage"</span>;</span><br><span class="line"><span class="comment">//create  schema</span></span><br><span class="line">ArrayList&lt;StructField&gt; list = <span class="keyword">new</span> ArrayList&lt;StructField&gt;();</span><br><span class="line"><span class="keyword">for</span>(String str:schemaString.split(<span class="string">"\t"</span>))&#123;</span><br><span class="line">list.add(DataTypes.createStructField(str, DataTypes.StringType, <span class="keyword">true</span>));</span><br><span class="line">&#125;</span><br><span class="line">StructType schema = DataTypes.createStructType(list);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éœ€è¦å°†RDDè½¬æ¢ä¸ºä¸€ä¸ªJavaRDDã€ŠRowã€‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JavaRDD&lt;Row&gt; rowRDD = personRDD.map(<span class="keyword">new</span> Function&lt;String, Row&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Row <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> RowFactory.create(fields[<span class="number">0</span>],fields[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">DataFrame personDF = sqlContext.createDataFrame(rowRDD, schema);</span><br><span class="line">personDF.registerTempTable(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">DataFrame resultperson = sqlContext.sql(<span class="string">"select name,age from person where age &gt; 13 and age &lt;= 19"</span>);</span><br><span class="line">resultperson.javaRDD().foreach(<span class="keyword">new</span> VoidFunction&lt;Row&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Row row)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//æŠŠæ¯ä¸€æ¡æ•°æ®éƒ½çœ‹æˆæ˜¯ä¸€ä¸ªrow  row(0)=name  row(1)=age </span></span><br><span class="line">System.out.println(<span class="string">"name"</span>+row.getString(<span class="number">0</span>));</span><br><span class="line">System.out.println(<span class="string">"age"</span>+row.getInt(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">resultperson.javaRDD().saveAsTextFile(<span class="string">"hdfs://hadoop1:9000/reflectionresult"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-DataSet-amp-DataFrame-amp-RDD"><a href="#3-DataSet-amp-DataFrame-amp-RDD" class="headerlink" title="3.DataSet &amp; DataFrame &amp; RDD"></a>3.DataSet &amp; DataFrame &amp; RDD</h2><p><strong>RDD ä»…è¡¨ç¤ºæ•°æ®é›†ï¼ŒRDD æ²¡æœ‰å…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰å­—æ®µè¯­ä¹‰å®šä¹‰</strong></p><p><strong>DataFrame = RDD+Schema = SchemaRDD</strong></p><p><strong>Schema æ˜¯å°±æ˜¯å…ƒæ•°æ®ï¼Œæ˜¯è¯­ä¹‰æè¿°ä¿¡æ¯ã€‚</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-27-084726.png" alt="image-20180727164726341"></p><p><strong>DataFrame æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ Datasetï¼ŒDataSet[Row] = DataFrame</strong></p><p><strong>DataFrame çš„æ•°æ®ç±»å‹ç»Ÿä¸€æ˜¯ Row,  ç¼ºç‚¹: </strong></p><ul><li>Row ä¸èƒ½ç›´æ¥æ“ä½œ domain å¯¹è±¡</li><li>å‡½æ•°é£æ ¼ç¼–ç¨‹ï¼Œæ²¡æœ‰é¢å‘å¯¹è±¡é£æ ¼çš„ API</li></ul><p>æ‰€ä»¥ï¼ŒSpark SQL å¼•å…¥äº† Datasetï¼Œæ‰©å±•äº† DataFrame APIï¼Œæä¾›äº†ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé¢å‘å¯¹è±¡é£æ ¼çš„ APIã€‚</p><ul><li>Dataset å¯ä»¥å’Œ DataFrameã€RDD ç›¸äº’è½¬æ¢ã€‚DataFrame=Dataset[Row]</li><li>å¯è§ DataFrame æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Datasetã€‚</li></ul><p><strong>æ—¢ç„¶ Spark SQL æä¾›äº† SQL è®¿é—®æ–¹å¼ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ DataFrame å’Œ Dataset çš„ API å‘¢ï¼Ÿ</strong></p><ul><li>SQL çš„è¡¨è¾¾èƒ½åŠ›å´æ˜¯æœ‰é™çš„</li><li>DataFrame å’Œ Dataset å¯ä»¥é‡‡ç”¨æ›´åŠ é€šç”¨çš„è¯­è¨€ï¼ˆScala æˆ– Pythonï¼‰æ¥è¡¨è¾¾ç”¨æˆ·çš„ æŸ¥è¯¢è¯·æ±‚ã€‚</li><li>DataFrame / Dataset çš„é¢å‘å¯¹è±¡è¯­æ³•, å¯ä»¥æ›´å¿«æ•æ‰é”™è¯¯ï¼Œå› ä¸º SQL æ˜¯è¿è¡Œæ—¶æ•è·å¼‚å¸¸ï¼Œè€Œ Dataset æ˜¯ ç¼–è¯‘æ—¶æ£€æŸ¥é”™è¯¯ã€‚</li></ul><p><strong>DataFrame &amp; Dataset çš„éƒ¨åˆ† api</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-27-085823.png" alt="image-20180727165823013"></p><h4 id="æ€»çš„æ¥è®²"><a href="#æ€»çš„æ¥è®²" class="headerlink" title="æ€»çš„æ¥è®²"></a>æ€»çš„æ¥è®²</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataFream</span>=<span class="type">DataSet</span>[row]  <span class="comment">//å¼±ç±»å‹</span></span><br><span class="line"><span class="type">DataFream</span>=<span class="type">Untyped</span> <span class="type">Dataset</span></span><br><span class="line"><span class="type">DataSet</span>=<span class="type">Untyped</span> <span class="type">Dataset</span> +typed <span class="type">Dataset</span></span><br></pre></td></tr></table></figure><h4 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h4><blockquote><p><strong>SparkCore: RDD</strong></p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">rdd</span> </span>= sc.textFile(<span class="string">"/user/ap/sparkdatas/peopletxt/people.txt"</span>).map(line =&gt; line.split(<span class="string">","</span>)).map(x =&gt; <span class="type">Person</span>(x(<span class="number">0</span>),x(<span class="number">1</span>).trim.toLong))</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Person</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">14</span>] at map at &lt;console&gt;:<span class="number">26</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¾—åˆ°çš„æ˜¯ RDD[Person] ç±»å‹</span></span><br><span class="line"></span><br><span class="line">scala&gt; rdd.collect</span><br><span class="line">res11: <span class="type">Array</span>[<span class="type">Person</span>] = <span class="type">Array</span>(<span class="type">Person</span>(<span class="type">Michael</span>,<span class="number">29</span>), <span class="type">Person</span>(<span class="type">Andy</span>,<span class="number">30</span>), <span class="type">Person</span>(<span class="type">Justin</span>,<span class="number">19</span>))</span><br></pre></td></tr></table></figure><blockquote><p><strong>SparkSQL: DataFrame</strong> </p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> df = spark.read.json(<span class="string">"/user/ap/sparkdatas/people"</span>)</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [age: bigint, name: string]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Row  =&gt;ç›¸å½“äº æ•°æ®åº“çš„è¡¨é‡Œé¢çš„ä¸€è¡Œæ•°æ®  DataFrame=DataSet[Row]</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>SparkSQL: DataSet</strong> </p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// as[Person] æŠŠ Json è¯»å‡ºæ¥çš„ DataFrame ç›´æ¥åå°„åˆ° Personç±»ä¸Š, è½¬ä¸º DataSet  !! è¿˜æœ‰è¿™ç§éªšæ“ä½œ??</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> personDS = spark.read.json(<span class="string">"/user/ap/sparkdatas/people"</span>).as[<span class="type">Person</span>]</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">personDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [age: bigint, name: string]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†æŠŠ dataSet è½¬ä¸º dataFrame</span></span><br><span class="line"><span class="keyword">val</span> personDS2 = personDS.toDF </span><br><span class="line">res13: org.apache.spark.sql.<span class="type">DataFrame</span> = [age: bigint, name: string]</span><br></pre></td></tr></table></figure><h4 id="æ¥å¼ å›¾"><a href="#æ¥å¼ å›¾" class="headerlink" title="æ¥å¼ å›¾!"></a>æ¥å¼ å›¾!</h4><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-27-145640.png" alt="image-20180727225640182"></p><hr><h1 id="äº”-æ•°æ®æºä¹‹load-å’Œ-Save"><a href="#äº”-æ•°æ®æºä¹‹load-å’Œ-Save" class="headerlink" title="äº”. æ•°æ®æºä¹‹load å’Œ Save"></a>äº”. æ•°æ®æºä¹‹load å’Œ Save</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SQLContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hdfs.server.namenode.<span class="type">SafeMode</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SaveMode</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DatasourceLoadAndSave</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"RDD2DataFrameReflection"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">    <span class="keyword">val</span> sqlContext=<span class="keyword">new</span> <span class="type">SQLContext</span>(sc);</span><br><span class="line">  <span class="comment">//  sqlContext.read.json("person.json");</span></span><br><span class="line">    <span class="comment">//sparksqlé»˜è®¤æ”¯æŒçš„æ˜¯parquetæ–‡ä»¶æ ¼å¼</span></span><br><span class="line">  <span class="keyword">val</span> df=  sqlContext.read.load(<span class="string">"examples/src/main/resources/users.parquet"</span>);</span><br><span class="line">  <span class="comment">//  sqlContext.read.format("json").load("person.json")</span></span><br><span class="line">  <span class="comment">//  sqlContext.read.format("parquet").load("users.parquet")</span></span><br><span class="line">  <span class="comment">//dfä¿å­˜çš„æ—¶å€™ï¼Œå¦‚æœä¸æŒ‡å®šä¿å­˜çš„æ–‡ä»¶æ ¼å¼ï¼Œé»˜è®¤å°±æ˜¯parquet</span></span><br><span class="line">    df.select(<span class="string">"name"</span>, <span class="string">"age"</span>).write.save(<span class="string">"namesAndAges.parquet"</span>);</span><br><span class="line">  <span class="comment">//  df.select("name", "age").write.json("user.json")</span></span><br><span class="line">  <span class="comment">//   df.select("name", "age").write.format("json").save("user.json")</span></span><br><span class="line">    df.select(<span class="string">"name"</span>, <span class="string">"age"</span>).write.format(<span class="string">"parquet"</span>).save(<span class="string">"user.parquet"</span>)</span><br><span class="line">    </span><br><span class="line">    df.select(<span class="string">"name"</span>, <span class="string">"age"</span>).write.mode(<span class="type">SaveMode</span>.<span class="type">ErrorIfExists</span>).format(<span class="string">"json"</span>).save(<span class="string">"hdfs://hadoop1:9000/user.json"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜ç»“æœæ–‡ä»¶çš„æ—¶å€™çš„ç­–ç•¥</span></span><br><span class="line"><span class="comment">     * if data/table already exists,</span></span><br><span class="line"><span class="comment">       Append,    // contents of the DataFrame are expected to be appended to existing data</span></span><br><span class="line"><span class="comment">       Overwrite,   // existing data is expected to be overwritten</span></span><br><span class="line"><span class="comment">       ErrorIfExists,   // an exception is expected to be thrown</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å…­-æ•°æ®æºä¹‹parquet-files-åˆå¹¶"><a href="#å…­-æ•°æ®æºä¹‹parquet-files-åˆå¹¶" class="headerlink" title="å…­. æ•°æ®æºä¹‹parquet  files åˆå¹¶"></a>å…­. æ•°æ®æºä¹‹parquet  files åˆå¹¶</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> df1 = sc.makeRDD(<span class="number">1</span> to <span class="number">5</span>).map(i =&gt; (i, i * <span class="number">2</span>)).toDF(<span class="string">"single"</span>, <span class="string">"double"</span>)</span><br><span class="line">df1.write.parquet(<span class="string">"/user/ap/test_table/key=1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> df2 = sc.makeRDD(<span class="number">6</span> to <span class="number">10</span>).map(i =&gt; (i, i * <span class="number">3</span>)).toDF(<span class="string">"single"</span>, <span class="string">"triple"</span>)</span><br><span class="line">df2.write.parquet(<span class="string">"/user/ap/test_table/key=2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå¹¶ä¸¤ä¸ªdataframe, æˆ‘ä»¬æœŸæœ›çš„å°±æ˜¯åˆå¹¶å‡ºæ¥åº”è¯¥æ˜¯ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯single double triple</span></span><br><span class="line"><span class="comment">//å®é™…ä¸Šæœ€åè¿˜ä¼šæœ‰ä¸€ä¸ªåˆ†åŒºå°±æ˜¯keys</span></span><br><span class="line"><span class="keyword">val</span> df3 = sqlContext.read.option(<span class="string">"mergeSchema"</span>, <span class="string">"true"</span>).parquet(<span class="string">"/user/ap/test_table"</span>)</span><br><span class="line"></span><br><span class="line">df3.printSchema()</span><br><span class="line">df3.show()</span><br></pre></td></tr></table></figure><h1 id="ä¸ƒ-æ•°æ®æºä¹‹-MySQL"><a href="#ä¸ƒ-æ•°æ®æºä¹‹-MySQL" class="headerlink" title="ä¸ƒ. æ•°æ®æºä¹‹ MySQL"></a>ä¸ƒ. æ•°æ®æºä¹‹ MySQL</h1><p><a href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-2/#more">åœ¨ idea ä¸­è®¿é—® mysql çš„, çœ‹è¿™é‡Œ</a></p><p><strong>æ³¨æ„: å¯åŠ¨ Spark Shellï¼Œå¿…é¡»æŒ‡å®š mysql è¿æ¥é©±åŠ¨ jar åŒ…</strong></p><blockquote><p>å¯åŠ¨æœ¬æœºçš„å•è¿›ç¨‹ Shell</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spark-shell \</span><br><span class="line">--jars $<span class="type">SPARK_HOME</span>/jars/mysql-connector-java<span class="number">-5.1</span><span class="number">.40</span>-bin.jar \</span><br><span class="line">--driver-<span class="class"><span class="keyword">class</span><span class="title">-path</span> <span class="title">$SPARK_HOME/jars/mysql-connector-java-5</span>.1.40<span class="title">-bin</span>.<span class="title">jar</span></span></span><br></pre></td></tr></table></figure><blockquote><p>è¿æ¥ Spark é›†ç¾¤çš„ shell</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">spark-shell \</span><br><span class="line">--driver-<span class="class"><span class="keyword">class</span><span class="title">-path</span> <span class="title">$SPARK_HOME/jars/mysql-connector-java-5</span>.1.40<span class="title">-bin</span>.<span class="title">jar</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">--master</span> <span class="title">yarn</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">æŸ¥è¯¢</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">jdbcDF</span> </span>= spark.read.format(<span class="string">"jdbc"</span>).option(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://cs2:3306/test"</span>).option(<span class="string">"dbtable"</span>, <span class="string">"student"</span>).option(<span class="string">"user"</span>, <span class="string">"root"</span>).option(<span class="string">"password"</span>, <span class="string">"123"</span>).option(<span class="string">"driver"</span>,<span class="string">"com.mysql.jdbc.Driver"</span>).load();</span><br><span class="line"></span><br><span class="line">jdbcDF: org.apache.spark.sql.<span class="type">DataFrame</span> = [id: int, name: string ... <span class="number">2</span> more fields]</span><br><span class="line"></span><br><span class="line">scala&gt; jdbcDF.show</span><br><span class="line">+---+------------+--------+-----+</span><br><span class="line">| id|        name|  course|score|</span><br><span class="line">+---+------------+--------+-----+</span><br><span class="line">|  <span class="number">1</span>|     huangbo|    math|   <span class="number">81</span>|</span><br><span class="line">|  <span class="number">2</span>|     huangbo| englist|   <span class="number">87</span>|</span><br><span class="line">|  <span class="number">3</span>|     huangbo|computer|   <span class="number">67</span>|</span><br><span class="line">|  <span class="number">4</span>|     xuzheng|    math|   <span class="number">89</span>|</span><br><span class="line">|  <span class="number">5</span>|     xuzheng| english|   <span class="number">92</span>|</span><br><span class="line">|  <span class="number">6</span>|     xuzheng|computer|   <span class="number">83</span>|</span><br><span class="line">|  <span class="number">7</span>|wangbaoqiang|    math|   <span class="number">78</span>|</span><br><span class="line">|  <span class="number">8</span>|wangbaoqiang| english|   <span class="number">88</span>|</span><br><span class="line">|  <span class="number">9</span>|wangbaoqiang|computer|   <span class="number">90</span>|</span><br><span class="line">| <span class="number">10</span>|    dengchao|    math|   <span class="number">88</span>|</span><br><span class="line">+---+------------+--------+-----+</span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡ Spark-submit çš„æ–¹å¼</p></blockquote><p>ç¼–å†™ä»£ç </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡è¯»å–æ–‡ä»¶åˆ›å»º RDD</span></span><br><span class="line"><span class="keyword">val</span> studentRDD = sc.textFile(args(<span class="number">0</span>)).map(_.split(<span class="string">","</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡ StructType ç›´æ¥æŒ‡å®šæ¯ä¸ªå­—æ®µçš„ schema</span></span><br><span class="line"><span class="keyword">val</span> schema = <span class="type">StructType</span>(</span><br><span class="line">  <span class="type">List</span>(</span><br><span class="line">    <span class="type">StructField</span>(<span class="string">"id"</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),</span><br><span class="line">    <span class="type">StructField</span>(<span class="string">"name"</span>, <span class="type">StringType</span>, <span class="literal">true</span>),</span><br><span class="line">    <span class="type">StructField</span>(<span class="string">"sex"</span>, <span class="type">StringType</span>, <span class="literal">true</span>),</span><br><span class="line">    <span class="type">StructField</span>(<span class="string">"age"</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),</span><br><span class="line">    <span class="type">StructField</span>(<span class="string">"department"</span>, <span class="type">StringType</span>, <span class="literal">true</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°† RDD æ˜ å°„åˆ° rowRDD</span></span><br><span class="line"><span class="keyword">val</span> rowRDD = studentRDD.map(p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>).toInt, p(<span class="number">1</span>).trim, p(<span class="number">2</span>).trim, p(<span class="number">3</span>).toInt,</span><br><span class="line">  p(<span class="number">4</span>).trim))</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°† schema ä¿¡æ¯åº”ç”¨åˆ° rowRDD ä¸Š</span></span><br><span class="line"><span class="keyword">val</span> studentDataFrame = sqlContext.createDataFrame(rowRDD, schema)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»º Properties å­˜å‚¨æ•°æ®åº“ç›¸å…³å±æ€§</span></span><br><span class="line"><span class="keyword">val</span> prop = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">"user"</span>, <span class="string">"root"</span>)</span><br><span class="line">prop.put(<span class="string">"password"</span>, <span class="string">"root"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æ•°æ®è¿½åŠ åˆ°æ•°æ®åº“</span></span><br><span class="line">studentDataFrame.write.mode(<span class="string">"append"</span>).jdbc(<span class="string">"jdbc:mysql://hadoop02:3306/spider"</span>,</span><br><span class="line">  <span class="string">"student"</span>, prop)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœæ­¢ SparkContext</span></span><br><span class="line">sc.stop()</span><br></pre></td></tr></table></figure><p>å‡†å¤‡æ•°æ®ï¼šstudent.txt å­˜å‚¨åœ¨ HDFS ä¸Šçš„/student ç›®å½•ä¸­</p><p>ç»™é¡¹ç›®æ‰“æˆ jar åŒ…ï¼Œä¸Šä¼ åˆ°å®¢æˆ·ç«¯</p><p>æäº¤ä»»åŠ¡ç»™ Spark é›†ç¾¤ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$<span class="type">SPARK_HOME</span>/bin/spark-submit \</span><br><span class="line">--<span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">mazh</span>.<span class="title">spark</span>.<span class="title">sql</span>.<span class="title">SparkSQL_JDBC</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">--master</span> <span class="title">yarn</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">--driver-class-path</span> <span class="title">$SPARK_HOME/jars/mysql-connector-java-5</span>.1.40<span class="title">-bin</span>.<span class="title">jar</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">/home/hadoop/Spark_WordCount-1</span>.0<span class="title">-SNAPSHOT</span>.<span class="title">jar</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">hdfs</span></span>:<span class="comment">//mycluster/user/ap/sparkdatas/student.txt</span></span><br></pre></td></tr></table></figure><h1 id="å…«-æ•°æ®æºä¹‹json"><a href="#å…«-æ•°æ®æºä¹‹json" class="headerlink" title="å…«. æ•°æ®æºä¹‹json"></a>å…«. æ•°æ®æºä¹‹json</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹å¼ 1</span></span><br><span class="line"><span class="keyword">val</span> df1 = sparkSession.read.json(<span class="string">"file://.."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹å¼ 2</span></span><br><span class="line"><span class="keyword">val</span> df2 = sparkSession.read.format(<span class="string">"json"</span>).load(<span class="string">"hdfs://mycluster/..."</span>)</span><br></pre></td></tr></table></figure><h1 id="ä¹-æ•°æ®æºä¹‹-Hive"><a href="#ä¹-æ•°æ®æºä¹‹-Hive" class="headerlink" title="ä¹. æ•°æ®æºä¹‹ Hive"></a>ä¹. æ•°æ®æºä¹‹ Hive</h1><p><a href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-2/">å…¶å®ƒå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« </a></p><p>ä¸ä¹‹å‰çš„è‡ªå·±æ„é€ æ•°æ®, æˆ–è€…è¯»<code>json</code>æ•°æ®ç­‰,å¾—åˆ° <code>DataFrame</code> , ç„¶åæŠŠæ­¤ <code>df.createTempView(â€œtmpViewâ€)</code></p><p>ç„¶åå†å¯¹æ­¤ <code>tmpView</code> ä½¿ç”¨ sql è¯­å¥æŸ¥è¯¢ä¸ä¸€æ ·</p><p><strong>ç›´æ¥ç”¨ <code>sparkSession.sql(â€œ...â€)</code> æ“ä½œçš„å¯¹è±¡é»˜è®¤å°±æ˜¯ hive</strong> </p><p><strong>==&gt; è®¿é—® hive çš„å…ƒæ•°æ®åº“(mysql),  æŠŠ hive åº•å±‚çš„æ‰§è¡Œå¼•æ“ <code>MapReduce</code> æ¢æˆäº†<code>SparkCore</code></strong></p><h1 id="å-æ•°æ®æºä¹‹-HBase"><a href="#å-æ•°æ®æºä¹‹-HBase" class="headerlink" title="å. æ•°æ®æºä¹‹ HBase"></a>å. æ•°æ®æºä¹‹ HBase</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-SparkSQL-çš„å‰ä¸–ä»Šç”Ÿ&quot;&gt;&lt;a href=&quot;#ä¸€-SparkSQL-çš„å‰ä¸–ä»Šç”Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. SparkSQL çš„å‰ä¸–ä»Šç”Ÿ&quot;&gt;&lt;/a&gt;ä¸€. SparkSQL çš„å‰ä¸–ä»Šç”Ÿ&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Hive =
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="ç²¾è®²" scheme="https://airpoet.github.io/categories/Spark/%E7%B2%BE%E8%AE%B2/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://airpoet.github.io/2018/07/27/Spark/Spark%E9%87%8D%E7%82%B9%E8%A7%A3%E6%9E%90(%E4%BA%8C)%20=%3E%20Spark%E8%B0%83%E4%BC%98/"/>
    <id>https://airpoet.github.io/2018/07/27/Spark/Sparké‡ç‚¹è§£æ(äºŒ) =&gt; Sparkè°ƒä¼˜/</id>
    <published>2018-07-26T17:47:32.984Z</published>
    <updated>2018-07-30T01:37:36.309Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Sparkæ•´å¥—è°ƒä¼˜æ–¹æ¡ˆä¸»è¦åˆ†ä¸ºå¼€å‘è°ƒä¼˜ã€èµ„æºè°ƒä¼˜ã€æ•°æ®å€¾æ–œè°ƒä¼˜ã€shuffleè°ƒä¼˜å‡ ä¸ªéƒ¨åˆ†ã€‚</p><p><strong>å¼€å‘è°ƒä¼˜å’Œèµ„æºè°ƒä¼˜</strong>æ˜¯æ‰€æœ‰Sparkä½œä¸šéƒ½éœ€è¦æ³¨æ„å’Œéµå¾ªçš„ä¸€äº›åŸºæœ¬åŸåˆ™ï¼Œ<strong>æ˜¯é«˜æ€§èƒ½Sparkä½œä¸šçš„åŸºç¡€</strong>ï¼›</p><p><strong>æ•°æ®å€¾æ–œè°ƒä¼˜</strong>ï¼Œä¸»è¦è®²è§£äº†ä¸€å¥—å®Œæ•´çš„ç”¨æ¥<strong>è§£å†³Sparkä½œä¸šæ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ</strong>ï¼›</p><p><strong>shuffleè°ƒä¼˜</strong>ï¼Œä¸»è¦è®²è§£äº†å¦‚ä½•<strong>å¯¹Sparkä½œä¸šçš„shuffleè¿è¡Œè¿‡ç¨‹ä»¥åŠç»†èŠ‚è¿›è¡Œè°ƒä¼˜</strong>ã€‚</p><p><strong>æœ¬æ–‡ä¸»è¦å‚è€ƒç¾å›¢ç‚¹è¯„æŠ€æœ¯åšå®¢ä¹‹</strong></p><ul><li><a href="https://tech.meituan.com/spark_tuning_basic.html" target="_blank" rel="noopener">Sparkæ€§èƒ½ä¼˜åŒ–æŒ‡å—â€”â€”åŸºç¡€ç¯‡</a></li><li><a href="https://tech.meituan.com/spark_tuning_pro.html" target="_blank" rel="noopener">Sparkæ€§èƒ½ä¼˜åŒ–æŒ‡å—â€”â€”é«˜çº§ç¯‡</a></li></ul><hr><h1 id="ä¸€-å¼€å‘è°ƒä¼˜"><a href="#ä¸€-å¼€å‘è°ƒä¼˜" class="headerlink" title="ä¸€. å¼€å‘è°ƒä¼˜"></a>ä¸€. å¼€å‘è°ƒä¼˜</h1><h2 id="è°ƒä¼˜æ¦‚è¿°"><a href="#è°ƒä¼˜æ¦‚è¿°" class="headerlink" title="è°ƒä¼˜æ¦‚è¿°"></a>è°ƒä¼˜æ¦‚è¿°</h2><p>Sparkæ€§èƒ½ä¼˜åŒ–çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è¦åœ¨å¼€å‘Sparkä½œä¸šçš„è¿‡ç¨‹ä¸­æ³¨æ„å’Œåº”ç”¨ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™ã€‚å¼€å‘è°ƒä¼˜ï¼Œå°±æ˜¯è¦è®©å¤§å®¶äº†è§£ä»¥ä¸‹ä¸€äº›SparkåŸºæœ¬å¼€å‘åŸåˆ™ï¼ŒåŒ…æ‹¬ï¼šRDD lineageè®¾è®¡ã€ç®—å­çš„åˆç†ä½¿ç”¨ã€ç‰¹æ®Šæ“ä½œçš„ä¼˜åŒ–ç­‰ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½åº”è¯¥æ³¨æ„ä»¥ä¸ŠåŸåˆ™ï¼Œå¹¶å°†è¿™äº›åŸåˆ™æ ¹æ®å…·ä½“çš„ä¸šåŠ¡ä»¥åŠå®é™…çš„åº”ç”¨åœºæ™¯ï¼Œçµæ´»åœ°è¿ç”¨åˆ°è‡ªå·±çš„Sparkä½œä¸šä¸­ã€‚</p><h2 id="åŸåˆ™ä¸€ï¼šé¿å…åˆ›å»ºé‡å¤çš„RDD"><a href="#åŸåˆ™ä¸€ï¼šé¿å…åˆ›å»ºé‡å¤çš„RDD" class="headerlink" title="åŸåˆ™ä¸€ï¼šé¿å…åˆ›å»ºé‡å¤çš„RDD"></a>åŸåˆ™ä¸€ï¼šé¿å…åˆ›å»ºé‡å¤çš„RDD</h2><p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªSparkä½œä¸šæ—¶ï¼Œé¦–å…ˆæ˜¯åŸºäºæŸä¸ªæ•°æ®æºï¼ˆæ¯”å¦‚Hiveè¡¨æˆ–HDFSæ–‡ä»¶ï¼‰åˆ›å»ºä¸€ä¸ªåˆå§‹çš„RDDï¼›æ¥ç€å¯¹è¿™ä¸ªRDDæ‰§è¡ŒæŸä¸ªç®—å­æ“ä½œï¼Œç„¶åå¾—åˆ°ä¸‹ä¸€ä¸ªRDDï¼›ä»¥æ­¤ç±»æ¨ï¼Œå¾ªç¯å¾€å¤ï¼Œç›´åˆ°è®¡ç®—å‡ºæœ€ç»ˆæˆ‘ä»¬éœ€è¦çš„ç»“æœã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¤šä¸ªRDDä¼šé€šè¿‡ä¸åŒçš„ç®—å­æ“ä½œï¼ˆæ¯”å¦‚mapã€reduceç­‰ï¼‰ä¸²èµ·æ¥ï¼Œè¿™ä¸ªâ€œRDDä¸²â€ï¼Œå°±æ˜¯RDD lineageï¼Œä¹Ÿå°±æ˜¯â€œRDDçš„è¡€ç¼˜å…³ç³»é“¾â€ã€‚</p><p>æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­è¦æ³¨æ„ï¼šå¯¹äºåŒä¸€ä»½æ•°æ®ï¼Œåªåº”è¯¥åˆ›å»ºä¸€ä¸ªRDDï¼Œä¸èƒ½åˆ›å»ºå¤šä¸ªRDDæ¥ä»£è¡¨åŒä¸€ä»½æ•°æ®ã€‚</p><p>ä¸€äº›Sparkåˆå­¦è€…åœ¨åˆšå¼€å§‹å¼€å‘Sparkä½œä¸šæ—¶ï¼Œæˆ–è€…æ˜¯æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆåœ¨å¼€å‘RDD lineageæå…¶å†—é•¿çš„Sparkä½œä¸šæ—¶ï¼Œå¯èƒ½ä¼šå¿˜äº†è‡ªå·±ä¹‹å‰å¯¹äºæŸä¸€ä»½æ•°æ®å·²ç»åˆ›å»ºè¿‡ä¸€ä¸ªRDDäº†ï¼Œä»è€Œå¯¼è‡´å¯¹äºåŒä¸€ä»½æ•°æ®ï¼Œåˆ›å»ºäº†å¤šä¸ªRDDã€‚è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬çš„Sparkä½œä¸šä¼šè¿›è¡Œå¤šæ¬¡é‡å¤è®¡ç®—æ¥åˆ›å»ºå¤šä¸ªä»£è¡¨ç›¸åŒæ•°æ®çš„RDDï¼Œè¿›è€Œå¢åŠ äº†ä½œä¸šçš„æ€§èƒ½å¼€é”€ã€‚</p><h3 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­"><a href="#ä¸€ä¸ªç®€å•çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a>ä¸€ä¸ªç®€å•çš„ä¾‹å­</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éœ€è¦å¯¹åä¸ºâ€œhello.txtâ€çš„HDFSæ–‡ä»¶è¿›è¡Œä¸€æ¬¡mapæ“ä½œï¼Œå†è¿›è¡Œä¸€æ¬¡reduceæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦å¯¹ä¸€ä»½æ•°æ®æ‰§è¡Œä¸¤æ¬¡ç®—å­æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯çš„åšæ³•ï¼šå¯¹äºåŒä¸€ä»½æ•°æ®æ‰§è¡Œå¤šæ¬¡ç®—å­æ“ä½œæ—¶ï¼Œåˆ›å»ºå¤šä¸ªRDDã€‚</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ‰§è¡Œäº†ä¸¤æ¬¡textFileæ–¹æ³•ï¼Œé’ˆå¯¹åŒä¸€ä¸ªHDFSæ–‡ä»¶ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªRDDå‡ºæ¥ï¼Œç„¶ååˆ†åˆ«å¯¹æ¯ä¸ªRDDéƒ½æ‰§è¡Œäº†ä¸€ä¸ªç®—å­æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// è¿™ç§æƒ…å†µä¸‹ï¼ŒSparkéœ€è¦ä»HDFSä¸Šä¸¤æ¬¡åŠ è½½hello.txtæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶åˆ›å»ºä¸¤ä¸ªå•ç‹¬çš„RDDï¼›ç¬¬äºŒæ¬¡åŠ è½½HDFSæ–‡ä»¶ä»¥åŠåˆ›å»ºRDDçš„æ€§èƒ½å¼€é”€ï¼Œå¾ˆæ˜æ˜¾æ˜¯ç™½ç™½æµªè´¹æ‰çš„ã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"hdfs://192.168.0.1:9000/hello.txt"</span>)</span><br><span class="line">rdd1.map(...)</span><br><span class="line"><span class="keyword">val</span> rdd2 = sc.textFile(<span class="string">"hdfs://192.168.0.1:9000/hello.txt"</span>)</span><br><span class="line">rdd2.reduce(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®çš„ç”¨æ³•ï¼šå¯¹äºä¸€ä»½æ•°æ®æ‰§è¡Œå¤šæ¬¡ç®—å­æ“ä½œæ—¶ï¼Œåªä½¿ç”¨ä¸€ä¸ªRDDã€‚</span></span><br><span class="line"><span class="comment">// è¿™ç§å†™æ³•å¾ˆæ˜æ˜¾æ¯”ä¸Šä¸€ç§å†™æ³•è¦å¥½å¤šäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹äºåŒä¸€ä»½æ•°æ®åªåˆ›å»ºäº†ä¸€ä¸ªRDDï¼Œç„¶åå¯¹è¿™ä¸€ä¸ªRDDæ‰§è¡Œäº†å¤šæ¬¡ç®—å­æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯è¦æ³¨æ„åˆ°è¿™é‡Œä¸ºæ­¢ä¼˜åŒ–è¿˜æ²¡æœ‰ç»“æŸï¼Œç”±äºrdd1è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ç®—å­æ“ä½œï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œreduceæ“ä½œçš„æ—¶å€™ï¼Œè¿˜ä¼šå†æ¬¡ä»æºå¤´å¤„é‡æ–°è®¡ç®—ä¸€æ¬¡rdd1çš„æ•°æ®ï¼Œå› æ­¤è¿˜æ˜¯ä¼šæœ‰é‡å¤è®¡ç®—çš„æ€§èƒ½å¼€é”€ã€‚</span></span><br><span class="line"><span class="comment">// è¦å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»ç»“åˆâ€œåŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–â€ï¼Œæ‰èƒ½ä¿è¯ä¸€ä¸ªRDDè¢«å¤šæ¬¡ä½¿ç”¨æ—¶åªè¢«è®¡ç®—ä¸€æ¬¡ã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"hdfs://192.168.0.1:9000/hello.txt"</span>)</span><br><span class="line">rdd1.map(...)</span><br><span class="line">rdd1.reduce(...)</span><br></pre></td></tr></table></figure><h2 id="åŸåˆ™äºŒï¼šå°½å¯èƒ½å¤ç”¨åŒä¸€ä¸ªRDD"><a href="#åŸåˆ™äºŒï¼šå°½å¯èƒ½å¤ç”¨åŒä¸€ä¸ªRDD" class="headerlink" title="åŸåˆ™äºŒï¼šå°½å¯èƒ½å¤ç”¨åŒä¸€ä¸ªRDD"></a>åŸåˆ™äºŒï¼šå°½å¯èƒ½å¤ç”¨åŒä¸€ä¸ªRDD</h2><p>é™¤äº†è¦é¿å…åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯¹ä¸€ä»½å®Œå…¨ç›¸åŒçš„æ•°æ®åˆ›å»ºå¤šä¸ªRDDä¹‹å¤–ï¼Œåœ¨å¯¹ä¸åŒçš„æ•°æ®æ‰§è¡Œç®—å­æ“ä½œæ—¶è¿˜è¦å°½å¯èƒ½åœ°å¤ç”¨ä¸€ä¸ªRDDã€‚æ¯”å¦‚è¯´ï¼Œæœ‰ä¸€ä¸ªRDDçš„æ•°æ®æ ¼å¼æ˜¯key-valueç±»å‹çš„ï¼Œå¦ä¸€ä¸ªæ˜¯å•valueç±»å‹çš„ï¼Œè¿™ä¸¤ä¸ªRDDçš„valueæ•°æ®æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å¯ä»¥åªä½¿ç”¨key-valueç±»å‹çš„é‚£ä¸ªRDDï¼Œå› ä¸ºå…¶ä¸­å·²ç»åŒ…å«äº†å¦ä¸€ä¸ªçš„æ•°æ®ã€‚å¯¹äºç±»ä¼¼è¿™ç§å¤šä¸ªRDDçš„æ•°æ®æœ‰é‡å æˆ–è€…åŒ…å«çš„æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡å¤ç”¨ä¸€ä¸ªRDDï¼Œè¿™æ ·å¯ä»¥å°½å¯èƒ½åœ°å‡å°‘RDDçš„æ•°é‡ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç®—å­æ‰§è¡Œçš„æ¬¡æ•°ã€‚</p><h3 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­-1"><a href="#ä¸€ä¸ªç®€å•çš„ä¾‹å­-1" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a>ä¸€ä¸ªç®€å•çš„ä¾‹å­</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯çš„åšæ³•ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ‰ä¸€ä¸ª&lt;Long, String&gt;æ ¼å¼çš„RDDï¼Œå³rdd1ã€‚</span></span><br><span class="line"><span class="comment">// æ¥ç€ç”±äºä¸šåŠ¡éœ€è¦ï¼Œå¯¹rdd1æ‰§è¡Œäº†ä¸€ä¸ªmapæ“ä½œï¼Œåˆ›å»ºäº†ä¸€ä¸ªrdd2ï¼Œè€Œrdd2ä¸­çš„æ•°æ®ä»…ä»…æ˜¯rdd1ä¸­çš„valueå€¼è€Œå·²ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œrdd2æ˜¯rdd1çš„å­é›†ã€‚</span></span><br><span class="line"><span class="type">JavaPairRDD</span>&lt;<span class="type">Long</span>, <span class="type">String</span>&gt; rdd1 = ...</span><br><span class="line"><span class="type">JavaRDD</span>&lt;<span class="type">String</span>&gt; rdd2 = rdd1.map(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†åˆ«å¯¹rdd1å’Œrdd2æ‰§è¡Œäº†ä¸åŒçš„ç®—å­æ“ä½œã€‚</span></span><br><span class="line">rdd1.reduceByKey(...)</span><br><span class="line">rdd2.map(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®çš„åšæ³•ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢è¿™ä¸ªcaseä¸­ï¼Œå…¶å®rdd1å’Œrdd2çš„åŒºåˆ«æ— éå°±æ˜¯æ•°æ®æ ¼å¼ä¸åŒè€Œå·²ï¼Œrdd2çš„æ•°æ®å®Œå…¨å°±æ˜¯rdd1çš„å­é›†è€Œå·²ï¼Œå´åˆ›å»ºäº†ä¸¤ä¸ªrddï¼Œå¹¶å¯¹ä¸¤ä¸ªrddéƒ½æ‰§è¡Œäº†ä¸€æ¬¡ç®—å­æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶ä¼šå› ä¸ºå¯¹rdd1æ‰§è¡Œmapç®—å­æ¥åˆ›å»ºrdd2ï¼Œè€Œå¤šæ‰§è¡Œä¸€æ¬¡ç®—å­æ“ä½œï¼Œè¿›è€Œå¢åŠ æ€§èƒ½å¼€é”€ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶å®åœ¨è¿™ç§æƒ…å†µä¸‹å®Œå…¨å¯ä»¥å¤ç”¨åŒä¸€ä¸ªRDDã€‚</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨rdd1ï¼Œæ—¢åšreduceByKeyæ“ä½œï¼Œä¹Ÿåšmapæ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// åœ¨è¿›è¡Œç¬¬äºŒä¸ªmapæ“ä½œæ—¶ï¼Œåªä½¿ç”¨æ¯ä¸ªæ•°æ®çš„tuple._2ï¼Œä¹Ÿå°±æ˜¯rdd1ä¸­çš„valueå€¼ï¼Œå³å¯ã€‚</span></span><br><span class="line"><span class="type">JavaPairRDD</span>&lt;<span class="type">Long</span>, <span class="type">String</span>&gt; rdd1 = ...</span><br><span class="line">rdd1.reduceByKey(...)</span><br><span class="line">rdd1.map(tuple._2...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒç§æ–¹å¼ç›¸è¾ƒäºç¬¬ä¸€ç§æ–¹å¼è€Œè¨€ï¼Œå¾ˆæ˜æ˜¾å‡å°‘äº†ä¸€æ¬¡rdd2çš„è®¡ç®—å¼€é”€ã€‚</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä¼˜åŒ–è¿˜æ²¡æœ‰ç»“æŸï¼Œå¯¹rdd1æˆ‘ä»¬è¿˜æ˜¯æ‰§è¡Œäº†ä¸¤æ¬¡ç®—å­æ“ä½œï¼Œrdd1å®é™…ä¸Šè¿˜æ˜¯ä¼šè¢«è®¡ç®—ä¸¤æ¬¡ã€‚</span></span><br><span class="line"><span class="comment">// å› æ­¤è¿˜éœ€è¦é…åˆâ€œåŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–â€è¿›è¡Œä½¿ç”¨ï¼Œæ‰èƒ½ä¿è¯ä¸€ä¸ªRDDè¢«å¤šæ¬¡ä½¿ç”¨æ—¶åªè¢«è®¡ç®—ä¸€æ¬¡ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="åŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–"><a href="#åŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–" class="headerlink" title="åŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–"></a>åŸåˆ™ä¸‰ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–</h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-29-140950.png" alt="image-20180729220949680"></p><p>å½“ä½ åœ¨Sparkä»£ç ä¸­å¤šæ¬¡å¯¹ä¸€ä¸ªRDDåšäº†ç®—å­æ“ä½œåï¼Œæ­å–œï¼Œä½ å·²ç»å®ç°Sparkä½œä¸šç¬¬ä¸€æ­¥çš„ä¼˜åŒ–äº†ï¼Œä¹Ÿå°±æ˜¯å°½å¯èƒ½å¤ç”¨RDDã€‚æ­¤æ—¶å°±è¯¥åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œè¿›è¡Œç¬¬äºŒæ­¥ä¼˜åŒ–äº†ï¼Œä¹Ÿå°±æ˜¯è¦ä¿è¯å¯¹ä¸€ä¸ªRDDæ‰§è¡Œå¤šæ¬¡ç®—å­æ“ä½œæ—¶ï¼Œè¿™ä¸ªRDDæœ¬èº«ä»…ä»…è¢«è®¡ç®—ä¸€æ¬¡ã€‚</p><p>Sparkä¸­å¯¹äºä¸€ä¸ªRDDæ‰§è¡Œå¤šæ¬¡ç®—å­çš„é»˜è®¤åŸç†æ˜¯è¿™æ ·çš„ï¼šæ¯æ¬¡ä½ å¯¹ä¸€ä¸ªRDDæ‰§è¡Œä¸€ä¸ªç®—å­æ“ä½œæ—¶ï¼Œéƒ½ä¼šé‡æ–°ä»æºå¤´å¤„è®¡ç®—ä¸€éï¼Œè®¡ç®—å‡ºé‚£ä¸ªRDDæ¥ï¼Œç„¶åå†å¯¹è¿™ä¸ªRDDæ‰§è¡Œä½ çš„ç®—å­æ“ä½œã€‚è¿™ç§æ–¹å¼çš„æ€§èƒ½æ˜¯å¾ˆå·®çš„ã€‚</p><p>å› æ­¤å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬çš„å»ºè®®æ˜¯ï¼šå¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–ã€‚æ­¤æ—¶Sparkå°±ä¼šæ ¹æ®ä½ çš„æŒä¹…åŒ–ç­–ç•¥ï¼Œå°†RDDä¸­çš„æ•°æ®ä¿å­˜åˆ°å†…å­˜æˆ–è€…ç£ç›˜ä¸­ã€‚ä»¥åæ¯æ¬¡å¯¹è¿™ä¸ªRDDè¿›è¡Œç®—å­æ“ä½œæ—¶ï¼Œéƒ½ä¼šç›´æ¥ä»å†…å­˜æˆ–ç£ç›˜ä¸­æå–æŒä¹…åŒ–çš„RDDæ•°æ®ï¼Œç„¶åæ‰§è¡Œç®—å­ï¼Œè€Œä¸ä¼šä»æºå¤´å¤„é‡æ–°è®¡ç®—ä¸€éè¿™ä¸ªRDDï¼Œå†æ‰§è¡Œç®—å­æ“ä½œã€‚</p><h3 id="å¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–çš„ä»£ç ç¤ºä¾‹"><a href="#å¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–çš„ä»£ç ç¤ºä¾‹" class="headerlink" title="å¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–çš„ä»£ç ç¤ºä¾‹"></a>å¯¹å¤šæ¬¡ä½¿ç”¨çš„RDDè¿›è¡ŒæŒä¹…åŒ–çš„ä»£ç ç¤ºä¾‹</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœè¦å¯¹ä¸€ä¸ªRDDè¿›è¡ŒæŒä¹…åŒ–ï¼Œåªè¦å¯¹è¿™ä¸ªRDDè°ƒç”¨cache()å’Œpersist()å³å¯ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®çš„åšæ³•ã€‚</span></span><br><span class="line"><span class="comment">// cache()æ–¹æ³•è¡¨ç¤ºï¼šä½¿ç”¨éåºåˆ—åŒ–çš„æ–¹å¼å°†RDDä¸­çš„æ•°æ®å…¨éƒ¨å°è¯•æŒä¹…åŒ–åˆ°å†…å­˜ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶å†å¯¹rdd1æ‰§è¡Œä¸¤æ¬¡ç®—å­æ“ä½œæ—¶ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œmapç®—å­æ—¶ï¼Œæ‰ä¼šå°†è¿™ä¸ªrdd1ä»æºå¤´å¤„è®¡ç®—ä¸€æ¬¡ã€‚</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ¬¡æ‰§è¡Œreduceç®—å­æ—¶ï¼Œå°±ä¼šç›´æ¥ä»å†…å­˜ä¸­æå–æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä¸ä¼šé‡å¤è®¡ç®—ä¸€ä¸ªrddã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"hdfs://192.168.0.1:9000/hello.txt"</span>).cache()</span><br><span class="line">rdd1.map(...)</span><br><span class="line">rdd1.reduce(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// persist()æ–¹æ³•è¡¨ç¤ºï¼šæ‰‹åŠ¨é€‰æ‹©æŒä¹…åŒ–çº§åˆ«ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„æ–¹å¼è¿›è¡ŒæŒä¹…åŒ–ã€‚</span></span><br><span class="line"><span class="comment">// æ¯”å¦‚è¯´ï¼ŒStorageLevel.MEMORY_AND_DISK_SERè¡¨ç¤ºï¼Œå†…å­˜å……è¶³æ—¶ä¼˜å…ˆæŒä¹…åŒ–åˆ°å†…å­˜ä¸­ï¼Œå†…å­˜ä¸å……è¶³æ—¶æŒä¹…åŒ–åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// è€Œä¸”å…¶ä¸­çš„_SERåç¼€è¡¨ç¤ºï¼Œä½¿ç”¨åºåˆ—åŒ–çš„æ–¹å¼æ¥ä¿å­˜RDDæ•°æ®ï¼Œæ­¤æ—¶RDDä¸­çš„æ¯ä¸ªpartitionéƒ½ä¼šåºåˆ—åŒ–æˆä¸€ä¸ªå¤§çš„å­—èŠ‚æ•°ç»„ï¼Œç„¶åå†æŒä¹…åŒ–åˆ°å†…å­˜æˆ–ç£ç›˜ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–çš„æ–¹å¼å¯ä»¥å‡å°‘æŒä¹…åŒ–çš„æ•°æ®å¯¹å†…å­˜/ç£ç›˜çš„å ç”¨é‡ï¼Œè¿›è€Œé¿å…å†…å­˜è¢«æŒä¹…åŒ–æ•°æ®å ç”¨è¿‡å¤šï¼Œä»è€Œå‘ç”Ÿé¢‘ç¹GCã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"hdfs://192.168.0.1:9000/hello.txt"</span>).persist(<span class="type">StorageLevel</span>.<span class="type">MEMORY_AND_DISK_SER</span>)</span><br><span class="line">rdd1.map(...)</span><br><span class="line">rdd1.reduce(...)</span><br></pre></td></tr></table></figure><p>å¯¹äºpersist()æ–¹æ³•è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©ä¸åŒçš„æŒä¹…åŒ–çº§åˆ«ã€‚</p><h3 id="Sparkçš„æŒä¹…åŒ–çº§åˆ«"><a href="#Sparkçš„æŒä¹…åŒ–çº§åˆ«" class="headerlink" title="Sparkçš„æŒä¹…åŒ–çº§åˆ«"></a>Sparkçš„æŒä¹…åŒ–çº§åˆ«</h3><table><thead><tr><th>æŒä¹…åŒ–çº§åˆ«</th><th>å«ä¹‰è§£é‡Š</th></tr></thead><tbody><tr><td>MEMORY_ONLY</td><td>ä½¿ç”¨æœªåºåˆ—åŒ–çš„Javaå¯¹è±¡æ ¼å¼ï¼Œå°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¦‚æœå†…å­˜ä¸å¤Ÿå­˜æ”¾æ‰€æœ‰çš„æ•°æ®ï¼Œåˆ™æ•°æ®å¯èƒ½å°±ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–ã€‚é‚£ä¹ˆä¸‹æ¬¡å¯¹è¿™ä¸ªRDDæ‰§è¡Œç®—å­æ“ä½œæ—¶ï¼Œé‚£äº›æ²¡æœ‰è¢«æŒä¹…åŒ–çš„æ•°æ®ï¼Œéœ€è¦ä»æºå¤´å¤„é‡æ–°è®¡ç®—ä¸€éã€‚è¿™æ˜¯é»˜è®¤çš„æŒä¹…åŒ–ç­–ç•¥ï¼Œä½¿ç”¨cache()æ–¹æ³•æ—¶ï¼Œå®é™…å°±æ˜¯ä½¿ç”¨çš„è¿™ç§æŒä¹…åŒ–ç­–ç•¥ã€‚</td></tr><tr><td>MEMORY_AND_DISK</td><td>ä½¿ç”¨æœªåºåˆ—åŒ–çš„Javaå¯¹è±¡æ ¼å¼ï¼Œä¼˜å…ˆå°è¯•å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¦‚æœå†…å­˜ä¸å¤Ÿå­˜æ”¾æ‰€æœ‰çš„æ•°æ®ï¼Œä¼šå°†æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡å¯¹è¿™ä¸ªRDDæ‰§è¡Œç®—å­æ—¶ï¼ŒæŒä¹…åŒ–åœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®ä¼šè¢«è¯»å–å‡ºæ¥ä½¿ç”¨ã€‚</td></tr><tr><td>MEMORY_ONLY_SER</td><td>åŸºæœ¬å«ä¹‰åŒMEMORY_ONLYã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œä¼šå°†RDDä¸­çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼ŒRDDçš„æ¯ä¸ªpartitionä¼šè¢«åºåˆ—åŒ–æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚è¿™ç§æ–¹å¼æ›´åŠ èŠ‚çœå†…å­˜ï¼Œä»è€Œå¯ä»¥é¿å…æŒä¹…åŒ–çš„æ•°æ®å ç”¨è¿‡å¤šå†…å­˜å¯¼è‡´é¢‘ç¹GCã€‚</td></tr><tr><td>MEMORY_AND_DISK_SER</td><td>åŸºæœ¬å«ä¹‰åŒMEMORY_AND_DISKã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œä¼šå°†RDDä¸­çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼ŒRDDçš„æ¯ä¸ªpartitionä¼šè¢«åºåˆ—åŒ–æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚è¿™ç§æ–¹å¼æ›´åŠ èŠ‚çœå†…å­˜ï¼Œä»è€Œå¯ä»¥é¿å…æŒä¹…åŒ–çš„æ•°æ®å ç”¨è¿‡å¤šå†…å­˜å¯¼è‡´é¢‘ç¹GCã€‚</td></tr><tr><td>DISK_ONLY</td><td>ä½¿ç”¨æœªåºåˆ—åŒ–çš„Javaå¯¹è±¡æ ¼å¼ï¼Œå°†æ•°æ®å…¨éƒ¨å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ã€‚</td></tr><tr><td>MEMORY_ONLY_2, MEMORY_AND_DISK_2, ç­‰ç­‰.</td><td>å¯¹äºä¸Šè¿°ä»»æ„ä¸€ç§æŒä¹…åŒ–ç­–ç•¥ï¼Œå¦‚æœåŠ ä¸Šåç¼€_2ï¼Œä»£è¡¨çš„æ˜¯å°†æ¯ä¸ªæŒä¹…åŒ–çš„æ•°æ®ï¼Œéƒ½å¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œå¹¶å°†å‰¯æœ¬ä¿å­˜åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚è¿™ç§åŸºäºå‰¯æœ¬çš„æŒä¹…åŒ–æœºåˆ¶ä¸»è¦ç”¨äºè¿›è¡Œå®¹é”™ã€‚å‡å¦‚æŸä¸ªèŠ‚ç‚¹æŒ‚æ‰ï¼ŒèŠ‚ç‚¹çš„å†…å­˜æˆ–ç£ç›˜ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¸¢å¤±äº†ï¼Œé‚£ä¹ˆåç»­å¯¹RDDè®¡ç®—æ—¶è¿˜å¯ä»¥ä½¿ç”¨è¯¥æ•°æ®åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šçš„å‰¯æœ¬ã€‚å¦‚æœæ²¡æœ‰å‰¯æœ¬çš„è¯ï¼Œå°±åªèƒ½å°†è¿™äº›æ•°æ®ä»æºå¤´å¤„é‡æ–°è®¡ç®—ä¸€éäº†ã€‚</td></tr></tbody></table><h3 id="å¦‚ä½•é€‰æ‹©ä¸€ç§æœ€åˆé€‚çš„æŒä¹…åŒ–ç­–ç•¥"><a href="#å¦‚ä½•é€‰æ‹©ä¸€ç§æœ€åˆé€‚çš„æŒä¹…åŒ–ç­–ç•¥" class="headerlink" title="å¦‚ä½•é€‰æ‹©ä¸€ç§æœ€åˆé€‚çš„æŒä¹…åŒ–ç­–ç•¥"></a>å¦‚ä½•é€‰æ‹©ä¸€ç§æœ€åˆé€‚çš„æŒä¹…åŒ–ç­–ç•¥</h3><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ€§èƒ½æœ€é«˜çš„å½“ç„¶æ˜¯MEMORY_ONLYï¼Œä½†å‰ææ˜¯ä½ çš„å†…å­˜å¿…é¡»è¶³å¤Ÿè¶³å¤Ÿå¤§ï¼Œå¯ä»¥ç»°ç»°æœ‰ä½™åœ°å­˜æ”¾ä¸‹æ•´ä¸ªRDDçš„æ‰€æœ‰æ•°æ®ã€‚å› ä¸ºä¸è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ“ä½œï¼Œå°±é¿å…äº†è¿™éƒ¨åˆ†çš„æ€§èƒ½å¼€é”€ï¼›å¯¹è¿™ä¸ªRDDçš„åç»­ç®—å­æ“ä½œï¼Œéƒ½æ˜¯åŸºäºçº¯å†…å­˜ä¸­çš„æ•°æ®çš„æ“ä½œï¼Œä¸éœ€è¦ä»ç£ç›˜æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œæ€§èƒ½ä¹Ÿå¾ˆé«˜ï¼›è€Œä¸”ä¸éœ€è¦å¤åˆ¶ä¸€ä»½æ•°æ®å‰¯æœ¬ï¼Œå¹¶è¿œç¨‹ä¼ é€åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ä½†æ˜¯è¿™é‡Œå¿…é¡»è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œææ€•èƒ½å¤Ÿç›´æ¥ç”¨è¿™ç§ç­–ç•¥çš„åœºæ™¯è¿˜æ˜¯æœ‰é™çš„ï¼Œå¦‚æœRDDä¸­æ•°æ®æ¯”è¾ƒå¤šæ—¶ï¼ˆæ¯”å¦‚å‡ åäº¿ï¼‰ï¼Œç›´æ¥ç”¨è¿™ç§æŒä¹…åŒ–çº§åˆ«ï¼Œä¼šå¯¼è‡´JVMçš„OOMå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</li><li>å¦‚æœä½¿ç”¨MEMORY_ONLYçº§åˆ«æ—¶å‘ç”Ÿäº†å†…å­˜æº¢å‡ºï¼Œé‚£ä¹ˆå»ºè®®å°è¯•ä½¿ç”¨MEMORY_ONLY_SERçº§åˆ«ã€‚è¯¥çº§åˆ«ä¼šå°†RDDæ•°æ®åºåˆ—åŒ–åå†ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ—¶æ¯ä¸ªpartitionä»…ä»…æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„è€Œå·²ï¼Œå¤§å¤§å‡å°‘äº†å¯¹è±¡æ•°é‡ï¼Œå¹¶é™ä½äº†å†…å­˜å ç”¨ã€‚è¿™ç§çº§åˆ«æ¯”MEMORY_ONLYå¤šå‡ºæ¥çš„æ€§èƒ½å¼€é”€ï¼Œä¸»è¦å°±æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å¼€é”€ã€‚ä½†æ˜¯åç»­ç®—å­å¯ä»¥åŸºäºçº¯å†…å­˜è¿›è¡Œæ“ä½œï¼Œå› æ­¤æ€§èƒ½æ€»ä½“è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚æ­¤å¤–ï¼Œå¯èƒ½å‘ç”Ÿçš„é—®é¢˜åŒä¸Šï¼Œå¦‚æœRDDä¸­çš„æ•°æ®é‡è¿‡å¤šçš„è¯ï¼Œè¿˜æ˜¯å¯èƒ½ä¼šå¯¼è‡´OOMå†…å­˜æº¢å‡ºçš„å¼‚å¸¸ã€‚</li><li>å¦‚æœçº¯å†…å­˜çš„çº§åˆ«éƒ½æ— æ³•ä½¿ç”¨ï¼Œé‚£ä¹ˆå»ºè®®ä½¿ç”¨MEMORY_AND_DISK_SERç­–ç•¥ï¼Œè€Œä¸æ˜¯MEMORY_AND_DISKç­–ç•¥ã€‚å› ä¸ºæ—¢ç„¶åˆ°äº†è¿™ä¸€æ­¥ï¼Œå°±è¯´æ˜RDDçš„æ•°æ®é‡å¾ˆå¤§ï¼Œå†…å­˜æ— æ³•å®Œå…¨æ”¾ä¸‹ã€‚åºåˆ—åŒ–åçš„æ•°æ®æ¯”è¾ƒå°‘ï¼Œå¯ä»¥èŠ‚çœå†…å­˜å’Œç£ç›˜çš„ç©ºé—´å¼€é”€ã€‚åŒæ—¶è¯¥ç­–ç•¥ä¼šä¼˜å…ˆå°½é‡å°è¯•å°†æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ç¼“å­˜ä¸ä¸‹æ‰ä¼šå†™å…¥ç£ç›˜ã€‚</li><li>é€šå¸¸ä¸å»ºè®®ä½¿ç”¨DISK_ONLYå’Œåç¼€ä¸º_2çš„çº§åˆ«ï¼šå› ä¸ºå®Œå…¨åŸºäºç£ç›˜æ–‡ä»¶è¿›è¡Œæ•°æ®çš„è¯»å†™ï¼Œä¼šå¯¼è‡´æ€§èƒ½æ€¥å‰§é™ä½ï¼Œæœ‰æ—¶è¿˜ä¸å¦‚é‡æ–°è®¡ç®—ä¸€æ¬¡æ‰€æœ‰RDDã€‚åç¼€ä¸º_2çš„çº§åˆ«ï¼Œå¿…é¡»å°†æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œå¹¶å‘é€åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®å¤åˆ¶ä»¥åŠç½‘ç»œä¼ è¾“ä¼šå¯¼è‡´è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ï¼Œé™¤éæ˜¯è¦æ±‚ä½œä¸šçš„é«˜å¯ç”¨æ€§ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨ã€‚</li></ul><h2 id="åŸåˆ™å››ï¼šå°½é‡é¿å…ä½¿ç”¨shuffleç±»ç®—å­"><a href="#åŸåˆ™å››ï¼šå°½é‡é¿å…ä½¿ç”¨shuffleç±»ç®—å­" class="headerlink" title="åŸåˆ™å››ï¼šå°½é‡é¿å…ä½¿ç”¨shuffleç±»ç®—å­"></a>åŸåˆ™å››ï¼šå°½é‡é¿å…ä½¿ç”¨shuffleç±»ç®—å­</h2><p>å¦‚æœæœ‰å¯èƒ½çš„è¯ï¼Œè¦å°½é‡é¿å…ä½¿ç”¨shuffleç±»ç®—å­ã€‚å› ä¸º<strong>Sparkä½œä¸šè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ€æ¶ˆè€—æ€§èƒ½çš„åœ°æ–¹å°±æ˜¯shuffleè¿‡ç¨‹</strong>ã€‚shuffleè¿‡ç¨‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯<strong>å°†åˆ†å¸ƒåœ¨é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹ä¸Šçš„åŒä¸€ä¸ªkeyï¼Œæ‹‰å–åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè¿›è¡Œèšåˆæˆ–joinç­‰æ“ä½œ</strong>ã€‚æ¯”å¦‚reduceByKeyã€joinç­‰ç®—å­ï¼Œéƒ½ä¼šè§¦å‘shuffleæ“ä½œã€‚</p><p>shuffleè¿‡ç¨‹ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¸Šçš„ç›¸åŒkeyéƒ½ä¼šå…ˆå†™å…¥æœ¬åœ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œç„¶åå…¶ä»–èŠ‚ç‚¹éœ€è¦é€šè¿‡ç½‘ç»œä¼ è¾“æ‹‰å–å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ç£ç›˜æ–‡ä»¶ä¸­çš„ç›¸åŒkeyã€‚è€Œä¸”ç›¸åŒkeyéƒ½æ‹‰å–åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œèšåˆæ“ä½œæ—¶ï¼Œè¿˜æœ‰å¯èƒ½ä¼šå› ä¸ºä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¤„ç†çš„keyè¿‡å¤šï¼Œå¯¼è‡´å†…å­˜ä¸å¤Ÿå­˜æ”¾ï¼Œè¿›è€Œæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚å› æ­¤åœ¨shuffleè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå¤§é‡çš„ç£ç›˜æ–‡ä»¶è¯»å†™çš„IOæ“ä½œï¼Œä»¥åŠæ•°æ®çš„ç½‘ç»œä¼ è¾“æ“ä½œã€‚<strong>ç£ç›˜IOå’Œç½‘ç»œæ•°æ®ä¼ è¾“ä¹Ÿæ˜¯shuffleæ€§èƒ½è¾ƒå·®çš„ä¸»è¦åŸå› ã€‚</strong></p><p>å› æ­¤åœ¨æˆ‘ä»¬çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œèƒ½é¿å…åˆ™å°½å¯èƒ½é¿å…ä½¿ç”¨reduceByKeyã€joinã€distinctã€repartitionç­‰ä¼šè¿›è¡Œshuffleçš„ç®—å­ï¼Œå°½é‡ä½¿ç”¨mapç±»çš„éshuffleç®—å­ã€‚è¿™æ ·çš„è¯ï¼Œæ²¡æœ‰shuffleæ“ä½œæˆ–è€…ä»…æœ‰è¾ƒå°‘shuffleæ“ä½œçš„Sparkä½œä¸šï¼Œå¯ä»¥å¤§å¤§å‡å°‘æ€§èƒ½å¼€é”€ã€‚</p><h3 id="Broadcastä¸mapè¿›è¡Œjoinä»£ç ç¤ºä¾‹-â€»"><a href="#Broadcastä¸mapè¿›è¡Œjoinä»£ç ç¤ºä¾‹-â€»" class="headerlink" title="Broadcastä¸mapè¿›è¡Œjoinä»£ç ç¤ºä¾‹ â€»"></a>Broadcastä¸mapè¿›è¡Œjoinä»£ç ç¤ºä¾‹ â€»</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿçš„joinæ“ä½œä¼šå¯¼è‡´shuffleæ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// å› ä¸ºä¸¤ä¸ªRDDä¸­ï¼Œç›¸åŒçš„keyéƒ½éœ€è¦é€šè¿‡ç½‘ç»œæ‹‰å–åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç”±ä¸€ä¸ªtaskè¿›è¡Œjoinæ“ä½œã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd3 = rdd1.join(rdd2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Broadcast+mapçš„joinæ“ä½œï¼Œä¸ä¼šå¯¼è‡´shuffleæ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨Broadcastå°†ä¸€ä¸ªæ•°æ®é‡è¾ƒå°çš„RDDä½œä¸ºå¹¿æ’­å˜é‡ã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd2Data = rdd2.collect()</span><br><span class="line"><span class="keyword">val</span> rdd2DataBroadcast = sc.broadcast(rdd2Data)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨rdd1.mapç®—å­ä¸­ï¼Œå¯ä»¥ä»rdd2DataBroadcastä¸­ï¼Œè·å–rdd2çš„æ‰€æœ‰æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// ç„¶åè¿›è¡Œéå†ï¼Œå¦‚æœå‘ç°rdd2ä¸­æŸæ¡æ•°æ®çš„keyä¸rdd1çš„å½“å‰æ•°æ®çš„keyæ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆå°±åˆ¤å®šå¯ä»¥è¿›è¡Œjoinã€‚</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶å°±å¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦çš„æ–¹å¼ï¼Œå°†rdd1å½“å‰æ•°æ®ä¸rdd2ä¸­å¯ä»¥è¿æ¥çš„æ•°æ®ï¼Œæ‹¼æ¥åœ¨ä¸€èµ·ï¼ˆStringæˆ–Tupleï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">val</span> rdd3 = rdd1.map(rdd2DataBroadcast...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œä»¥ä¸Šæ“ä½œï¼Œå»ºè®®ä»…ä»…åœ¨rdd2çš„æ•°æ®é‡æ¯”è¾ƒå°‘ï¼ˆæ¯”å¦‚å‡ ç™¾Mï¼Œæˆ–è€…ä¸€ä¸¤Gï¼‰çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="comment">// å› ä¸ºæ¯ä¸ªExecutorçš„å†…å­˜ä¸­ï¼Œéƒ½ä¼šé©»ç•™ä¸€ä»½rdd2çš„å…¨é‡æ•°æ®ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="åŸåˆ™äº”ï¼šä½¿ç”¨map-sideé¢„èšåˆçš„shuffleæ“ä½œ"><a href="#åŸåˆ™äº”ï¼šä½¿ç”¨map-sideé¢„èšåˆçš„shuffleæ“ä½œ" class="headerlink" title="åŸåˆ™äº”ï¼šä½¿ç”¨map-sideé¢„èšåˆçš„shuffleæ“ä½œ"></a>åŸåˆ™äº”ï¼šä½¿ç”¨map-sideé¢„èšåˆçš„shuffleæ“ä½œ</h2><p>å¦‚æœå› ä¸ºä¸šåŠ¡éœ€è¦ï¼Œä¸€å®šè¦ä½¿ç”¨<strong>shuffleæ“ä½œ</strong>ï¼Œæ— æ³•ç”¨mapç±»çš„ç®—å­æ¥æ›¿ä»£ï¼Œé‚£ä¹ˆ<strong>å°½é‡ä½¿ç”¨å¯ä»¥map-sideé¢„èšåˆçš„ç®—å­</strong>ã€‚</p><p>æ‰€è°“çš„map-sideé¢„èšåˆï¼Œè¯´çš„æ˜¯åœ¨æ¯ä¸ªèŠ‚ç‚¹æœ¬åœ°å¯¹ç›¸åŒçš„keyè¿›è¡Œä¸€æ¬¡èšåˆæ“ä½œï¼Œç±»ä¼¼äºMapReduceä¸­çš„æœ¬åœ°combinerã€‚map-sideé¢„èšåˆä¹‹åï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ¬åœ°å°±åªä¼šæœ‰ä¸€æ¡ç›¸åŒçš„keyï¼Œå› ä¸ºå¤šæ¡ç›¸åŒçš„keyéƒ½è¢«èšåˆèµ·æ¥äº†ã€‚å…¶ä»–èŠ‚ç‚¹åœ¨æ‹‰å–æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç›¸åŒkeyæ—¶ï¼Œå°±ä¼šå¤§å¤§å‡å°‘éœ€è¦æ‹‰å–çš„æ•°æ®æ•°é‡ï¼Œä»è€Œä¹Ÿå°±å‡å°‘äº†ç£ç›˜IOä»¥åŠç½‘ç»œä¼ è¾“å¼€é”€ã€‚é€šå¸¸æ¥è¯´ï¼Œ<strong>åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä½¿ç”¨<code>reduceByKey</code>æˆ–è€…<code>aggregateByKey</code>ç®—å­æ¥æ›¿ä»£æ‰<code>groupByKey</code>ç®—å­</strong>ã€‚å› ä¸ºreduceByKeyå’ŒaggregateByKeyç®—å­éƒ½ä¼šä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°å¯¹æ¯ä¸ªèŠ‚ç‚¹æœ¬åœ°çš„ç›¸åŒkeyè¿›è¡Œé¢„èšåˆã€‚è€Œ<strong><code>groupByKey</code>ç®—å­æ˜¯ä¸ä¼šè¿›è¡Œé¢„èšåˆçš„ï¼Œå…¨é‡çš„æ•°æ®ä¼šåœ¨é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹ä¹‹é—´åˆ†å‘å’Œä¼ è¾“ï¼Œæ€§èƒ½ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå·®</strong>ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ä¸¤å¹…å›¾ï¼Œå°±æ˜¯å…¸å‹çš„ä¾‹å­ï¼Œåˆ†åˆ«åŸºäºreduceByKeyå’ŒgroupByKeyè¿›è¡Œå•è¯è®¡æ•°ã€‚å…¶ä¸­ç¬¬ä¸€å¼ å›¾æ˜¯groupByKeyçš„åŸç†å›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ²¡æœ‰è¿›è¡Œä»»ä½•æœ¬åœ°èšåˆæ—¶ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¼šåœ¨é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´ä¼ è¾“ï¼›ç¬¬äºŒå¼ å›¾æ˜¯reduceByKeyçš„åŸç†å›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ¬åœ°çš„ç›¸åŒkeyæ•°æ®ï¼Œéƒ½è¿›è¡Œäº†é¢„èšåˆï¼Œç„¶åæ‰ä¼ è¾“åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿›è¡Œå…¨å±€èšåˆã€‚<img src="https://tech.meituan.com/img/spark-tuning/group-by-key-wordcount.png" alt="groupByKeyå®ç°wordcountåŸç†"></p><p><img src="https://tech.meituan.com/img/spark-tuning/reduce-by-key-wordcount.png" alt="reduceByKeyå®ç°wordcountåŸç†"></p><h2 id="åŸåˆ™å…­ï¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç®—å­"><a href="#åŸåˆ™å…­ï¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç®—å­" class="headerlink" title="åŸåˆ™å…­ï¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç®—å­"></a>åŸåˆ™å…­ï¼šä½¿ç”¨é«˜æ€§èƒ½çš„ç®—å­</h2><p>é™¤äº†shuffleç›¸å…³çš„ç®—å­æœ‰ä¼˜åŒ–åŸåˆ™ä¹‹å¤–ï¼Œå…¶ä»–çš„ç®—å­ä¹Ÿéƒ½æœ‰ç€ç›¸åº”çš„ä¼˜åŒ–åŸåˆ™ã€‚</p><h3 id="1-ä½¿ç”¨reduceByKey-aggregateByKeyæ›¿ä»£groupByKey"><a href="#1-ä½¿ç”¨reduceByKey-aggregateByKeyæ›¿ä»£groupByKey" class="headerlink" title="1. ä½¿ç”¨reduceByKey/aggregateByKeyæ›¿ä»£groupByKey"></a>1. ä½¿ç”¨reduceByKey/aggregateByKeyæ›¿ä»£groupByKey</h3><p>è¯¦æƒ…è§â€œåŸåˆ™äº”ï¼šä½¿ç”¨map-sideé¢„èšåˆçš„shuffleæ“ä½œâ€ã€‚</p><h3 id="2-ä½¿ç”¨mapPartitionsæ›¿ä»£æ™®é€šmap"><a href="#2-ä½¿ç”¨mapPartitionsæ›¿ä»£æ™®é€šmap" class="headerlink" title="2. ä½¿ç”¨mapPartitionsæ›¿ä»£æ™®é€šmap"></a>2. ä½¿ç”¨mapPartitionsæ›¿ä»£æ™®é€šmap</h3><p>mapPartitionsç±»çš„ç®—å­ï¼Œä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¼šå¤„ç†ä¸€ä¸ªpartitionæ‰€æœ‰çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨å¤„ç†ä¸€æ¡ï¼Œæ€§èƒ½ç›¸å¯¹æ¥è¯´ä¼šé«˜ä¸€äº›ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œä½¿ç”¨mapPartitionsä¼šå‡ºç°OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰çš„é—®é¢˜ã€‚å› ä¸ºå•æ¬¡å‡½æ•°è°ƒç”¨å°±è¦å¤„ç†æ‰ä¸€ä¸ªpartitionæ‰€æœ‰çš„æ•°æ®ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿï¼Œåƒåœ¾å›æ”¶æ—¶æ˜¯æ— æ³•å›æ”¶æ‰å¤ªå¤šå¯¹è±¡çš„ï¼Œå¾ˆå¯èƒ½å‡ºç°OOMå¼‚å¸¸ã€‚æ‰€ä»¥ä½¿ç”¨è¿™ç±»æ“ä½œæ—¶è¦æ…é‡ï¼</p><h3 id="3-ä½¿ç”¨foreachPartitionsæ›¿ä»£foreach"><a href="#3-ä½¿ç”¨foreachPartitionsæ›¿ä»£foreach" class="headerlink" title="3. ä½¿ç”¨foreachPartitionsæ›¿ä»£foreach"></a>3. ä½¿ç”¨foreachPartitionsæ›¿ä»£foreach</h3><p>åŸç†ç±»ä¼¼äºâ€œä½¿ç”¨mapPartitionsæ›¿ä»£mapâ€ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨å¤„ç†ä¸€ä¸ªpartitionçš„æ‰€æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨å¤„ç†ä¸€æ¡æ•°æ®ã€‚åœ¨å®è·µä¸­å‘ç°ï¼ŒforeachPartitionsç±»çš„ç®—å­ï¼Œå¯¹æ€§èƒ½çš„æå‡è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚æ¯”å¦‚åœ¨foreachå‡½æ•°ä¸­ï¼Œå°†RDDä¸­æ‰€æœ‰æ•°æ®å†™MySQLï¼Œé‚£ä¹ˆå¦‚æœæ˜¯æ™®é€šçš„foreachç®—å­ï¼Œå°±ä¼šä¸€æ¡æ•°æ®ä¸€æ¡æ•°æ®åœ°å†™ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨å¯èƒ½å°±ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œæ­¤æ—¶å°±åŠ¿å¿…ä¼šé¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½æ˜¯éå¸¸ä½ä¸‹ï¼›ä½†æ˜¯å¦‚æœç”¨foreachPartitionsç®—å­ä¸€æ¬¡æ€§å¤„ç†ä¸€ä¸ªpartitionçš„æ•°æ®ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ªpartitionï¼Œåªè¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥å³å¯ï¼Œç„¶åæ‰§è¡Œæ‰¹é‡æ’å…¥æ“ä½œï¼Œæ­¤æ—¶æ€§èƒ½æ˜¯æ¯”è¾ƒé«˜çš„ã€‚å®è·µä¸­å‘ç°ï¼Œå¯¹äº1ä¸‡æ¡å·¦å³çš„æ•°æ®é‡å†™MySQLï¼Œæ€§èƒ½å¯ä»¥æå‡30%ä»¥ä¸Šã€‚</p><h3 id="4-ä½¿ç”¨filterä¹‹åè¿›è¡Œcoalesceæ“ä½œ"><a href="#4-ä½¿ç”¨filterä¹‹åè¿›è¡Œcoalesceæ“ä½œ" class="headerlink" title="4. ä½¿ç”¨filterä¹‹åè¿›è¡Œcoalesceæ“ä½œ"></a>4. ä½¿ç”¨filterä¹‹åè¿›è¡Œcoalesceæ“ä½œ</h3><p>é€šå¸¸å¯¹ä¸€ä¸ªRDDæ‰§è¡Œfilterç®—å­è¿‡æ»¤æ‰RDDä¸­è¾ƒå¤šæ•°æ®åï¼ˆæ¯”å¦‚30%ä»¥ä¸Šçš„æ•°æ®ï¼‰ï¼Œå»ºè®®ä½¿ç”¨coalesceç®—å­ï¼Œæ‰‹åŠ¨å‡å°‘RDDçš„partitionæ•°é‡ï¼Œå°†RDDä¸­çš„æ•°æ®å‹ç¼©åˆ°æ›´å°‘çš„partitionä¸­å»ã€‚å› ä¸ºfilterä¹‹åï¼ŒRDDçš„æ¯ä¸ªpartitionä¸­éƒ½ä¼šæœ‰å¾ˆå¤šæ•°æ®è¢«è¿‡æ»¤æ‰ï¼Œæ­¤æ—¶å¦‚æœç…§å¸¸è¿›è¡Œåç»­çš„è®¡ç®—ï¼Œå…¶å®æ¯ä¸ªtaskå¤„ç†çš„partitionä¸­çš„æ•°æ®é‡å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œæœ‰ä¸€ç‚¹èµ„æºæµªè´¹ï¼Œè€Œä¸”æ­¤æ—¶å¤„ç†çš„taskè¶Šå¤šï¼Œå¯èƒ½é€Ÿåº¦åè€Œè¶Šæ…¢ã€‚å› æ­¤ç”¨coalesceå‡å°‘partitionæ•°é‡ï¼Œå°†RDDä¸­çš„æ•°æ®å‹ç¼©åˆ°æ›´å°‘çš„partitionä¹‹åï¼Œåªè¦ä½¿ç”¨æ›´å°‘çš„taskå³å¯å¤„ç†å®Œæ‰€æœ‰çš„partitionã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¯¹äºæ€§èƒ½çš„æå‡ä¼šæœ‰ä¸€å®šçš„å¸®åŠ©ã€‚</p><h3 id="5-ä½¿ç”¨repartitionAndSortWithinPartitionsæ›¿ä»£repartitionä¸sortç±»æ“ä½œ"><a href="#5-ä½¿ç”¨repartitionAndSortWithinPartitionsæ›¿ä»£repartitionä¸sortç±»æ“ä½œ" class="headerlink" title="5. ä½¿ç”¨repartitionAndSortWithinPartitionsæ›¿ä»£repartitionä¸sortç±»æ“ä½œ"></a>5. ä½¿ç”¨repartitionAndSortWithinPartitionsæ›¿ä»£repartitionä¸sortç±»æ“ä½œ</h3><p>repartitionAndSortWithinPartitionsæ˜¯Sparkå®˜ç½‘æ¨èçš„ä¸€ä¸ªç®—å­ï¼Œå®˜æ–¹å»ºè®®ï¼Œå¦‚æœéœ€è¦åœ¨repartitioné‡åˆ†åŒºä¹‹åï¼Œè¿˜è¦è¿›è¡Œæ’åºï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨repartitionAndSortWithinPartitionsç®—å­ã€‚å› ä¸ºè¯¥ç®—å­å¯ä»¥ä¸€è¾¹è¿›è¡Œé‡åˆ†åŒºçš„shuffleæ“ä½œï¼Œä¸€è¾¹è¿›è¡Œæ’åºã€‚shuffleä¸sortä¸¤ä¸ªæ“ä½œåŒæ—¶è¿›è¡Œï¼Œæ¯”å…ˆshuffleå†sortæ¥è¯´ï¼Œæ€§èƒ½å¯èƒ½æ˜¯è¦é«˜çš„ã€‚</p><h2 id="åŸåˆ™ä¸ƒï¼šå¹¿æ’­å¤§å˜é‡"><a href="#åŸåˆ™ä¸ƒï¼šå¹¿æ’­å¤§å˜é‡" class="headerlink" title="åŸåˆ™ä¸ƒï¼šå¹¿æ’­å¤§å˜é‡"></a>åŸåˆ™ä¸ƒï¼šå¹¿æ’­å¤§å˜é‡</h2><p>æœ‰æ—¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šé‡åˆ°éœ€è¦åœ¨ç®—å­å‡½æ•°ä¸­ä½¿ç”¨å¤–éƒ¨å˜é‡çš„åœºæ™¯ï¼ˆå°¤å…¶æ˜¯å¤§å˜é‡ï¼Œæ¯”å¦‚100Mä»¥ä¸Šçš„å¤§é›†åˆï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±åº”è¯¥ä½¿ç”¨Sparkçš„å¹¿æ’­ï¼ˆBroadcastï¼‰åŠŸèƒ½æ¥æå‡æ€§èƒ½ã€‚</p><p>åœ¨ç®—å­å‡½æ•°ä¸­ä½¿ç”¨åˆ°å¤–éƒ¨å˜é‡æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒSparkä¼šå°†è¯¥å˜é‡å¤åˆ¶å¤šä¸ªå‰¯æœ¬ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“åˆ°taskä¸­ï¼Œæ­¤æ—¶æ¯ä¸ªtaskéƒ½æœ‰ä¸€ä¸ªå˜é‡å‰¯æœ¬ã€‚å¦‚æœå˜é‡æœ¬èº«æ¯”è¾ƒå¤§çš„è¯ï¼ˆæ¯”å¦‚100Mï¼Œç”šè‡³1Gï¼‰ï¼Œé‚£ä¹ˆå¤§é‡çš„å˜é‡å‰¯æœ¬åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„æ€§èƒ½å¼€é”€ï¼Œä»¥åŠåœ¨å„ä¸ªèŠ‚ç‚¹çš„Executorä¸­å ç”¨è¿‡å¤šå†…å­˜å¯¼è‡´çš„é¢‘ç¹GCï¼Œéƒ½ä¼šæå¤§åœ°å½±å“æ€§èƒ½ã€‚</p><p>å› æ­¤å¯¹äºä¸Šè¿°æƒ…å†µï¼Œå¦‚æœä½¿ç”¨çš„å¤–éƒ¨å˜é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨Sparkçš„å¹¿æ’­åŠŸèƒ½ï¼Œå¯¹è¯¥å˜é‡è¿›è¡Œå¹¿æ’­ã€‚å¹¿æ’­åçš„å˜é‡ï¼Œä¼šä¿è¯æ¯ä¸ªExecutorçš„å†…å­˜ä¸­ï¼Œåªé©»ç•™ä¸€ä»½å˜é‡å‰¯æœ¬ï¼Œè€ŒExecutorä¸­çš„taskæ‰§è¡Œæ—¶å…±äº«è¯¥Executorä¸­çš„é‚£ä»½å˜é‡å‰¯æœ¬ã€‚è¿™æ ·çš„è¯ï¼Œå¯ä»¥å¤§å¤§å‡å°‘å˜é‡å‰¯æœ¬çš„æ•°é‡ï¼Œä»è€Œå‡å°‘ç½‘ç»œä¼ è¾“çš„æ€§èƒ½å¼€é”€ï¼Œå¹¶å‡å°‘å¯¹Executorå†…å­˜çš„å ç”¨å¼€é”€ï¼Œé™ä½GCçš„é¢‘ç‡ã€‚</p><h3 id="å¹¿æ’­å¤§å˜é‡çš„ä»£ç ç¤ºä¾‹"><a href="#å¹¿æ’­å¤§å˜é‡çš„ä»£ç ç¤ºä¾‹" class="headerlink" title="å¹¿æ’­å¤§å˜é‡çš„ä»£ç ç¤ºä¾‹"></a>å¹¿æ’­å¤§å˜é‡çš„ä»£ç ç¤ºä¾‹</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»¥ä¸‹ä»£ç åœ¨ç®—å­å‡½æ•°ä¸­ï¼Œä½¿ç”¨äº†å¤–éƒ¨çš„å˜é‡ã€‚</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶æ²¡æœ‰åšä»»ä½•ç‰¹æ®Šæ“ä½œï¼Œæ¯ä¸ªtaskéƒ½ä¼šæœ‰ä¸€ä»½list1çš„å‰¯æœ¬ã€‚</span></span><br><span class="line"><span class="keyword">val</span> list1 = ...</span><br><span class="line">rdd1.map(list1...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹ä»£ç å°†list1å°è£…æˆäº†Broadcastç±»å‹çš„å¹¿æ’­å˜é‡ã€‚</span></span><br><span class="line"><span class="comment">// åœ¨ç®—å­å‡½æ•°ä¸­ï¼Œä½¿ç”¨å¹¿æ’­å˜é‡æ—¶ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å½“å‰taskæ‰€åœ¨Executorå†…å­˜ä¸­ï¼Œæ˜¯å¦æœ‰å˜é‡å‰¯æœ¬ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼›å¦‚æœæ²¡æœ‰åˆ™ä»Driveræˆ–è€…å…¶ä»–ExecutorèŠ‚ç‚¹ä¸Šè¿œç¨‹æ‹‰å–ä¸€ä»½æ”¾åˆ°æœ¬åœ°Executorå†…å­˜ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªExecutorå†…å­˜ä¸­ï¼Œå°±åªä¼šé©»ç•™ä¸€ä»½å¹¿æ’­å˜é‡å‰¯æœ¬ã€‚</span></span><br><span class="line"><span class="keyword">val</span> list1 = ...</span><br><span class="line"><span class="keyword">val</span> list1Broadcast = sc.broadcast(list1)</span><br><span class="line">rdd1.map(list1Broadcast...)</span><br></pre></td></tr></table></figure><h2 id="åŸåˆ™å…«ï¼šä½¿ç”¨Kryoä¼˜åŒ–åºåˆ—åŒ–æ€§èƒ½"><a href="#åŸåˆ™å…«ï¼šä½¿ç”¨Kryoä¼˜åŒ–åºåˆ—åŒ–æ€§èƒ½" class="headerlink" title="åŸåˆ™å…«ï¼šä½¿ç”¨Kryoä¼˜åŒ–åºåˆ—åŒ–æ€§èƒ½"></a>åŸåˆ™å…«ï¼šä½¿ç”¨Kryoä¼˜åŒ–åºåˆ—åŒ–æ€§èƒ½</h2><p><strong>åœ¨Sparkä¸­ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªåœ°æ–¹æ¶‰åŠåˆ°äº†åºåˆ—åŒ–ï¼š</strong></p><ul><li>åœ¨ç®—å­å‡½æ•°ä¸­ä½¿ç”¨åˆ°å¤–éƒ¨å˜é‡æ—¶ï¼Œè¯¥å˜é‡ä¼šè¢«åºåˆ—åŒ–åè¿›è¡Œç½‘ç»œä¼ è¾“ï¼ˆè§â€œåŸåˆ™ä¸ƒï¼šå¹¿æ’­å¤§å˜é‡â€ä¸­çš„è®²è§£ï¼‰ã€‚</li><li>å°†è‡ªå®šä¹‰çš„ç±»å‹ä½œä¸ºRDDçš„æ³›å‹ç±»å‹æ—¶ï¼ˆæ¯”å¦‚JavaRDDï¼ŒStudentæ˜¯è‡ªå®šä¹‰ç±»å‹ï¼‰ï¼Œæ‰€æœ‰è‡ªå®šä¹‰ç±»å‹å¯¹è±¡ï¼Œéƒ½ä¼šè¿›è¡Œåºåˆ—åŒ–ã€‚å› æ­¤è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿè¦æ±‚è‡ªå®šä¹‰çš„ç±»å¿…é¡»å®ç°Serializableæ¥å£ã€‚</li><li>ä½¿ç”¨å¯åºåˆ—åŒ–çš„æŒä¹…åŒ–ç­–ç•¥æ—¶ï¼ˆæ¯”å¦‚MEMORY_ONLY_SERï¼‰ï¼ŒSparkä¼šå°†RDDä¸­çš„æ¯ä¸ªpartitionéƒ½åºåˆ—åŒ–æˆä¸€ä¸ªå¤§çš„å­—èŠ‚æ•°ç»„ã€‚</li></ul><p>å¯¹äºè¿™ä¸‰ç§å‡ºç°åºåˆ—åŒ–çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨Kryoåºåˆ—åŒ–ç±»åº“ï¼Œæ¥ä¼˜åŒ–åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ€§èƒ½ã€‚Sparké»˜è®¤ä½¿ç”¨çš„æ˜¯Javaçš„åºåˆ—åŒ–æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ObjectOutputStream/ObjectInputStream APIæ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ä½†æ˜¯SparkåŒæ—¶æ”¯æŒä½¿ç”¨Kryoåºåˆ—åŒ–åº“ï¼ŒKryoåºåˆ—åŒ–ç±»åº“çš„æ€§èƒ½æ¯”Javaåºåˆ—åŒ–ç±»åº“çš„æ€§èƒ½è¦é«˜å¾ˆå¤šã€‚å®˜æ–¹ä»‹ç»ï¼ŒKryoåºåˆ—åŒ–æœºåˆ¶æ¯”Javaåºåˆ—åŒ–æœºåˆ¶ï¼Œæ€§èƒ½é«˜10å€å·¦å³ã€‚Sparkä¹‹æ‰€ä»¥é»˜è®¤æ²¡æœ‰ä½¿ç”¨Kryoä½œä¸ºåºåˆ—åŒ–ç±»åº“ï¼Œæ˜¯å› ä¸ºKryoè¦æ±‚æœ€å¥½è¦æ³¨å†Œæ‰€æœ‰éœ€è¦è¿›è¡Œåºåˆ—åŒ–çš„è‡ªå®šä¹‰ç±»å‹ï¼Œå› æ­¤å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒéº»çƒ¦ã€‚</p><p><strong>ä»¥ä¸‹æ˜¯ä½¿ç”¨<code>Kryo</code>çš„ä»£ç ç¤ºä¾‹</strong>ï¼Œæˆ‘ä»¬åªè¦è®¾ç½®åºåˆ—åŒ–ç±»ï¼Œå†æ³¨å†Œè¦åºåˆ—åŒ–çš„è‡ªå®šä¹‰ç±»å‹å³å¯ï¼ˆæ¯”å¦‚ç®—å­å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„å¤–éƒ¨å˜é‡ç±»å‹ã€ä½œä¸ºRDDæ³›å‹ç±»å‹çš„è‡ªå®šä¹‰ç±»å‹ç­‰, é¿å…ä¼šä½¿ç”¨å…¨é™å®šå, è¿™æ ·å°±ä¼šæœ‰é¢å¤–çš„å¼€é”€ï¼‰ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºSparkConfå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(...).setAppName(...)</span><br><span class="line"><span class="comment">// è®¾ç½®åºåˆ—åŒ–å™¨ä¸ºKryoSerializerã€‚</span></span><br><span class="line">conf.set(<span class="string">"spark.serializer"</span>, <span class="string">"org.apache.spark.serializer.KryoSerializer"</span>)</span><br><span class="line"><span class="comment">// æ³¨å†Œè¦åºåˆ—åŒ–çš„è‡ªå®šä¹‰ç±»å‹ã€‚</span></span><br><span class="line">conf.registerKryoClasses(<span class="type">Array</span>(classOf[<span class="type">MyClass1</span>], classOf[<span class="type">MyClass2</span>]))</span><br></pre></td></tr></table></figure><h2 id="åŸåˆ™ä¹ï¼šä¼˜åŒ–æ•°æ®ç»“æ„"><a href="#åŸåˆ™ä¹ï¼šä¼˜åŒ–æ•°æ®ç»“æ„" class="headerlink" title="åŸåˆ™ä¹ï¼šä¼˜åŒ–æ•°æ®ç»“æ„"></a>åŸåˆ™ä¹ï¼šä¼˜åŒ–æ•°æ®ç»“æ„</h2><p>Javaä¸­ï¼Œæœ‰ä¸‰ç§ç±»å‹æ¯”è¾ƒè€—è´¹å†…å­˜ï¼š</p><ul><li><strong>å¯¹è±¡</strong>ï¼Œæ¯ä¸ªJavaå¯¹è±¡éƒ½æœ‰å¯¹è±¡å¤´ã€å¼•ç”¨ç­‰é¢å¤–çš„ä¿¡æ¯ï¼Œå› æ­¤æ¯”è¾ƒå ç”¨å†…å­˜ç©ºé—´ã€‚</li><li><strong>å­—ç¬¦ä¸²</strong>ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦æ•°ç»„ä»¥åŠé•¿åº¦ç­‰é¢å¤–ä¿¡æ¯ã€‚</li><li><strong>é›†åˆç±»å‹</strong>ï¼Œæ¯”å¦‚HashMapã€LinkedListç­‰ï¼Œå› ä¸ºé›†åˆç±»å‹å†…éƒ¨é€šå¸¸ä¼šä½¿ç”¨ä¸€äº›å†…éƒ¨ç±»æ¥å°è£…é›†åˆå…ƒç´ ï¼Œæ¯”å¦‚Map.Entryã€‚</li></ul><p>å› æ­¤Sparkå®˜æ–¹å»ºè®®ï¼Œåœ¨Sparkç¼–ç å®ç°ä¸­ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç®—å­å‡½æ•°ä¸­çš„ä»£ç ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ä¸Šè¿°ä¸‰ç§æ•°æ®ç»“æ„ï¼Œå°½é‡ä½¿ç”¨<strong>å­—ç¬¦ä¸²æ›¿ä»£å¯¹è±¡</strong>ï¼Œä½¿ç”¨<strong>åŸå§‹ç±»å‹ï¼ˆæ¯”å¦‚Intã€Longï¼‰æ›¿ä»£å­—ç¬¦ä¸²</strong>ï¼Œä½¿ç”¨<strong>æ•°ç»„æ›¿ä»£é›†åˆ</strong>ç±»å‹ï¼Œè¿™æ ·å°½å¯èƒ½åœ°å‡å°‘å†…å­˜å ç”¨ï¼Œä»è€Œé™ä½GCé¢‘ç‡ï¼Œæå‡æ€§èƒ½ã€‚</p><p>ä½†æ˜¯åœ¨ç¬”è€…çš„ç¼–ç å®è·µä¸­å‘ç°ï¼Œè¦åšåˆ°è¯¥åŸåˆ™å…¶å®å¹¶ä¸å®¹æ˜“ã€‚å› ä¸ºæˆ‘ä»¬åŒæ—¶è¦è€ƒè™‘åˆ°ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œå¦‚æœä¸€ä¸ªä»£ç ä¸­ï¼Œå®Œå…¨æ²¡æœ‰ä»»ä½•å¯¹è±¡æŠ½è±¡ï¼Œå…¨éƒ¨æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œé‚£ä¹ˆå¯¹äºåç»­çš„ä»£ç ç»´æŠ¤å’Œä¿®æ”¹ï¼Œæ— ç–‘æ˜¯ä¸€åœºå·¨å¤§çš„ç¾éš¾ã€‚åŒç†ï¼Œå¦‚æœæ‰€æœ‰æ“ä½œéƒ½åŸºäºæ•°ç»„å®ç°ï¼Œè€Œä¸ä½¿ç”¨HashMapã€LinkedListç­‰é›†åˆç±»å‹ï¼Œé‚£ä¹ˆå¯¹äºæˆ‘ä»¬çš„ç¼–ç éš¾åº¦ä»¥åŠä»£ç å¯ç»´æŠ¤æ€§ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæå¤§çš„æŒ‘æˆ˜ã€‚å› æ­¤ç¬”è€…å»ºè®®ï¼Œ<strong>åœ¨å¯èƒ½ä»¥åŠåˆé€‚çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å ç”¨å†…å­˜è¾ƒå°‘çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å‰ææ˜¯è¦ä¿è¯ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚</strong></p><p>ä¸»è¦å°±æ˜¯ä¼˜åŒ–ä½ çš„ç®—å­å‡½æ•°ï¼Œå†…éƒ¨ä½¿ç”¨åˆ°çš„å±€éƒ¨æ•°æ®ï¼Œæˆ–è€…æ˜¯ç®—å­å‡½æ•°å¤–éƒ¨çš„æ•°æ®ã€‚éƒ½å¯ä»¥è¿›è¡Œæ•°æ®ç»“æ„çš„ä¼˜åŒ–ã€‚ä¼˜åŒ–ä¹‹åï¼Œéƒ½ä¼šå‡å°‘å…¶å¯¹å†…å­˜çš„æ¶ˆè€—å’Œå ç”¨ã€‚ </p><p><strong>é€šå¸¸ä¼ä¸šçº§åº”ç”¨ä¸­çš„åšæ³•æ˜¯: </strong></p><ul><li>å¯¹äº<strong>HashMapã€List</strong>è¿™ç§æ•°æ®ï¼Œç»Ÿä¸€<strong>ç”¨Stringæ‹¼æ¥æˆç‰¹æ®Šæ ¼å¼çš„å­—ç¬¦ä¸²</strong>ï¼Œæ¯”å¦‚Map&lt;Integer, Person&gt; persons = new HashMap&lt;Integer, Person&gt;()ã€‚å¯ä»¥ä¼˜åŒ–ä¸ºï¼Œç‰¹æ®Šçš„å­—ç¬¦ä¸²æ ¼å¼ï¼šid:name,address|id:name,addressâ€¦ã€‚ </li><li><strong>é¿å…ä½¿ç”¨å¤šå±‚åµŒå¥—çš„å¯¹è±¡ç»“æ„</strong>ã€‚æ¯”å¦‚è¯´ï¼Œpublic class Teacher { private List<student> students = new ArrayList\&lt;Student>() }ã€‚å°±æ˜¯éå¸¸ä¸å¥½çš„ä¾‹å­ã€‚å› ä¸ºTeacherç±»çš„å†…éƒ¨åˆåµŒå¥—äº†å¤§é‡çš„å°Studentå¯¹è±¡ã€‚å¯¹äºä¸Šè¿°ä¾‹å­ï¼Œä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„å­—ç¬¦ä¸²æ¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ã€‚æ¯”å¦‚ï¼Œ<strong>ç”¨jsonå­—ç¬¦ä¸²</strong>æ¥å­˜å‚¨æ•°æ®ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ <code>{&quot;teacherId&quot;: 1, &quot;teacherName&quot;: &quot;leo&quot;, students:[{&quot;studentId&quot;: 1, &quot;studentName&quot;: &quot;tom&quot;},{&quot;studentId&quot;:2, &quot;studentName&quot;:&quot;marry&quot;}]}</code></student></li><li><strong>å°½é‡ä½¿ç”¨intæ›¿ä»£String</strong> ,åœ¨sparkåº”ç”¨ä¸­ï¼Œ<strong>idå°±ä¸è¦ç”¨å¸¸ç”¨çš„uuidäº†</strong>ï¼Œå› ä¸ºæ— æ³•è½¬æˆintï¼Œå°±<strong>ç”¨è‡ªå¢çš„intç±»å‹çš„idå³å¯</strong>ã€‚ï¼ˆsdfsdfdf-234242342-sdfsfsfdfdï¼‰ </li></ul><h2 id="åŸåˆ™å-GroupByKey-å’Œ-ReduceByKeyçš„ä½¿ç”¨"><a href="#åŸåˆ™å-GroupByKey-å’Œ-ReduceByKeyçš„ä½¿ç”¨" class="headerlink" title="åŸåˆ™å: GroupByKey å’Œ ReduceByKeyçš„ä½¿ç”¨"></a>åŸåˆ™å: GroupByKey å’Œ ReduceByKeyçš„ä½¿ç”¨</h2><blockquote><p>GroupByKey</p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-30-groupByKey%E5%8E%9F%E7%90%86.png" alt=""></p><blockquote><p>ReduceByKey</p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-30-reduceByKey%E5%8E%9F%E7%90%86.png" alt=""></p><hr><h1 id="äºŒ-èµ„æºè°ƒä¼˜"><a href="#äºŒ-èµ„æºè°ƒä¼˜" class="headerlink" title="äºŒ. èµ„æºè°ƒä¼˜"></a>äºŒ. èµ„æºè°ƒä¼˜</h1><h2 id="è°ƒä¼˜æ¦‚è¿°-1"><a href="#è°ƒä¼˜æ¦‚è¿°-1" class="headerlink" title="è°ƒä¼˜æ¦‚è¿°"></a>è°ƒä¼˜æ¦‚è¿°</h2><p>åœ¨å¼€å‘å®ŒSparkä½œä¸šä¹‹åï¼Œå°±è¯¥ä¸ºä½œä¸šé…ç½®åˆé€‚çš„èµ„æºäº†ã€‚<strong>Sparkçš„èµ„æºå‚æ•°ï¼ŒåŸºæœ¬éƒ½å¯ä»¥åœ¨spark-submitå‘½ä»¤ä¸­ä½œä¸ºå‚æ•°è®¾ç½®ã€‚</strong>å¾ˆå¤šSparkåˆå­¦è€…ï¼Œé€šå¸¸ä¸çŸ¥é“è¯¥è®¾ç½®å“ªäº›å¿…è¦çš„å‚æ•°ï¼Œä»¥åŠå¦‚ä½•è®¾ç½®è¿™äº›å‚æ•°ï¼Œæœ€åå°±åªèƒ½èƒ¡ä¹±è®¾ç½®ï¼Œç”šè‡³å‹æ ¹å„¿ä¸è®¾ç½®ã€‚èµ„æºå‚æ•°è®¾ç½®çš„ä¸åˆç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ²¡æœ‰å……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼Œä½œä¸šè¿è¡Œä¼šæå…¶ç¼“æ…¢ï¼›æˆ–è€…è®¾ç½®çš„èµ„æºè¿‡å¤§ï¼Œé˜Ÿåˆ—æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥æä¾›ï¼Œè¿›è€Œå¯¼è‡´å„ç§å¼‚å¸¸ã€‚æ€»ä¹‹ï¼Œæ— è®ºæ˜¯å“ªç§æƒ…å†µï¼Œéƒ½ä¼šå¯¼è‡´Sparkä½œä¸šçš„è¿è¡Œæ•ˆç‡ä½ä¸‹ï¼Œç”šè‡³æ ¹æœ¬æ— æ³•è¿è¡Œã€‚å› æ­¤æˆ‘ä»¬<strong>å¿…é¡»å¯¹Sparkä½œä¸šçš„èµ„æºä½¿ç”¨åŸç†æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†</strong>ï¼Œ<strong>å¹¶çŸ¥é“åœ¨Sparkä½œä¸šè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰å“ªäº›èµ„æºå‚æ•°æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œä»¥åŠå¦‚ä½•è®¾ç½®åˆé€‚çš„å‚æ•°å€¼ã€‚</strong></p><h2 id="Sparkä½œä¸šåŸºæœ¬è¿è¡ŒåŸç†"><a href="#Sparkä½œä¸šåŸºæœ¬è¿è¡ŒåŸç†" class="headerlink" title="Sparkä½œä¸šåŸºæœ¬è¿è¡ŒåŸç†"></a>Sparkä½œä¸šåŸºæœ¬è¿è¡ŒåŸç†</h2><p><img src="https://tech.meituan.com/img/spark-tuning/spark-base-mech.png" alt="SparkåŸºæœ¬è¿è¡ŒåŸç†"></p><p>è¯¦ç»†åŸç†è§ä¸Šå›¾ã€‚æˆ‘ä»¬ä½¿ç”¨spark-submitæäº¤ä¸€ä¸ªSparkä½œä¸šä¹‹åï¼Œè¿™ä¸ªä½œä¸šå°±ä¼šå¯åŠ¨ä¸€ä¸ªå¯¹åº”çš„Driverè¿›ç¨‹ã€‚æ ¹æ®ä½ ä½¿ç”¨çš„éƒ¨ç½²æ¨¡å¼ï¼ˆdeploy-modeï¼‰ä¸åŒï¼ŒDriverè¿›ç¨‹å¯èƒ½åœ¨æœ¬åœ°å¯åŠ¨ï¼Œä¹Ÿå¯èƒ½åœ¨é›†ç¾¤ä¸­æŸä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šå¯åŠ¨ã€‚Driverè¿›ç¨‹æœ¬èº«ä¼šæ ¹æ®æˆ‘ä»¬è®¾ç½®çš„å‚æ•°ï¼Œå æœ‰ä¸€å®šæ•°é‡çš„å†…å­˜å’ŒCPU coreã€‚è€Œ<strong>Driverè¿›ç¨‹è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å‘é›†ç¾¤ç®¡ç†å™¨</strong>ï¼ˆå¯ä»¥æ˜¯Spark Standaloneé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„èµ„æºç®¡ç†é›†ç¾¤ï¼Œç¾å›¢â€¢å¤§ä¼—ç‚¹è¯„ä½¿ç”¨çš„æ˜¯YARNä½œä¸ºèµ„æºç®¡ç†é›†ç¾¤ï¼‰<strong>ç”³è¯·è¿è¡ŒSparkä½œä¸šéœ€è¦ä½¿ç”¨çš„èµ„æºï¼Œè¿™é‡Œçš„èµ„æºæŒ‡çš„å°±æ˜¯Executorè¿›ç¨‹ã€‚YARNé›†ç¾¤ç®¡ç†å™¨ä¼šæ ¹æ®æˆ‘ä»¬ä¸ºSparkä½œä¸šè®¾ç½®çš„èµ„æºå‚æ•°ï¼Œåœ¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨ä¸€å®šæ•°é‡çš„Executorè¿›ç¨‹ï¼Œæ¯ä¸ªExecutorè¿›ç¨‹éƒ½å æœ‰ä¸€å®šæ•°é‡çš„å†…å­˜å’ŒCPU coreã€‚</strong></p><p>åœ¨ç”³è¯·åˆ°äº†ä½œä¸šæ‰§è¡Œæ‰€éœ€çš„èµ„æºä¹‹åï¼ŒDriverè¿›ç¨‹å°±ä¼šå¼€å§‹è°ƒåº¦å’Œæ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„ä½œä¸šä»£ç äº†ã€‚Driverè¿›ç¨‹ä¼šå°†æˆ‘ä»¬ç¼–å†™çš„Sparkä½œä¸šä»£ç åˆ†æ‹†ä¸ºå¤šä¸ªstageï¼Œæ¯ä¸ªstageæ‰§è¡Œä¸€éƒ¨åˆ†ä»£ç ç‰‡æ®µï¼Œå¹¶ä¸ºæ¯ä¸ªstageåˆ›å»ºä¸€æ‰¹taskï¼Œç„¶åå°†è¿™äº›taskåˆ†é…åˆ°å„ä¸ªExecutorè¿›ç¨‹ä¸­æ‰§è¡Œã€‚taskæ˜¯æœ€å°çš„è®¡ç®—å•å…ƒï¼Œè´Ÿè´£æ‰§è¡Œä¸€æ¨¡ä¸€æ ·çš„è®¡ç®—é€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„æŸä¸ªä»£ç ç‰‡æ®µï¼‰ï¼Œåªæ˜¯æ¯ä¸ªtaskå¤„ç†çš„æ•°æ®ä¸åŒè€Œå·²ã€‚<strong>ä¸€ä¸ªstageçš„æ‰€æœ‰taskéƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<u>ä¼šåœ¨å„ä¸ªèŠ‚ç‚¹æœ¬åœ°çš„ç£ç›˜æ–‡ä»¶ä¸­å†™å…¥è®¡ç®—ä¸­é—´ç»“æœ</u>ï¼Œç„¶åDriverå°±ä¼šè°ƒåº¦è¿è¡Œä¸‹ä¸€ä¸ªstageã€‚ä¸‹ä¸€ä¸ªstageçš„taskçš„è¾“å…¥æ•°æ®å°±æ˜¯ä¸Šä¸€ä¸ªstageè¾“å‡ºçš„ä¸­é—´ç»“æœã€‚</strong>å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œç›´åˆ°å°†æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä»£ç é€»è¾‘å…¨éƒ¨æ‰§è¡Œå®Œï¼Œå¹¶ä¸”è®¡ç®—å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœä¸ºæ­¢ã€‚</p><p><strong>Sparkæ˜¯æ ¹æ®shuffleç±»ç®—å­æ¥è¿›è¡Œstageçš„åˆ’åˆ†</strong>ã€‚å¦‚æœæˆ‘ä»¬çš„ä»£ç ä¸­æ‰§è¡Œäº†æŸä¸ªshuffleç±»ç®—å­ï¼ˆæ¯”å¦‚reduceByKeyã€joinç­‰ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è¯¥ç®—å­å¤„ï¼Œåˆ’åˆ†å‡ºä¸€ä¸ªstageç•Œé™æ¥ã€‚å¯ä»¥å¤§è‡´ç†è§£ä¸ºï¼Œshuffleç®—å­æ‰§è¡Œä¹‹å‰çš„ä»£ç ä¼šè¢«åˆ’åˆ†ä¸ºä¸€ä¸ªstageï¼Œshuffleç®—å­æ‰§è¡Œä»¥åŠä¹‹åçš„ä»£ç ä¼šè¢«åˆ’åˆ†ä¸ºä¸‹ä¸€ä¸ªstageã€‚å› æ­¤ä¸€ä¸ªstageåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒçš„æ¯ä¸ªtaskå¯èƒ½éƒ½ä¼šä»ä¸Šä¸€ä¸ªstageçš„taskæ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œå»é€šè¿‡ç½‘ç»œä¼ è¾“æ‹‰å–éœ€è¦è‡ªå·±å¤„ç†çš„æ‰€æœ‰keyï¼Œç„¶åå¯¹æ‹‰å–åˆ°çš„æ‰€æœ‰ç›¸åŒçš„keyä½¿ç”¨æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ç®—å­å‡½æ•°æ‰§è¡Œèšåˆæ“ä½œï¼ˆæ¯”å¦‚reduceByKey()ç®—å­æ¥æ”¶çš„å‡½æ•°ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯shuffleã€‚</p><p>å½“æˆ‘ä»¬åœ¨ä»£ç ä¸­æ‰§è¡Œäº†<strong>cache/persistç­‰æŒä¹…åŒ–æ“ä½œ</strong>æ—¶ï¼Œæ ¹æ®æˆ‘ä»¬é€‰æ‹©çš„æŒä¹…åŒ–çº§åˆ«çš„ä¸åŒï¼Œ<strong>æ¯ä¸ªtaskè®¡ç®—å‡ºæ¥çš„æ•°æ®ä¹Ÿä¼šä¿å­˜åˆ°Executorè¿›ç¨‹çš„å†…å­˜æˆ–è€…æ‰€åœ¨èŠ‚ç‚¹çš„ç£ç›˜æ–‡ä»¶ä¸­</strong>ã€‚</p><p>å› æ­¤<strong>Executorçš„å†…å­˜ä¸»è¦åˆ†ä¸ºä¸‰å—</strong>ï¼šç¬¬ä¸€å—æ˜¯è®©taskæ‰§è¡Œæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä»£ç æ—¶ä½¿ç”¨ï¼Œé»˜è®¤æ˜¯å Executoræ€»å†…å­˜çš„20%ï¼›ç¬¬äºŒå—æ˜¯è®©taské€šè¿‡shuffleè¿‡ç¨‹æ‹‰å–äº†ä¸Šä¸€ä¸ªstageçš„taskçš„è¾“å‡ºåï¼Œè¿›è¡Œèšåˆç­‰æ“ä½œæ—¶ä½¿ç”¨ï¼Œé»˜è®¤ä¹Ÿæ˜¯å Executoræ€»å†…å­˜çš„20%ï¼›ç¬¬ä¸‰å—æ˜¯è®©RDDæŒä¹…åŒ–æ—¶ä½¿ç”¨ï¼Œé»˜è®¤å Executoræ€»å†…å­˜çš„60%ã€‚(è¿™é‡Œ<strong>æŒ‡çš„æ˜¯é™æ€å†…å­˜åˆ†é…</strong>, è¯¦æƒ…è§ä¸‹æ–‡) </p><p>taskçš„æ‰§è¡Œé€Ÿåº¦æ˜¯è·Ÿæ¯ä¸ªExecutorè¿›ç¨‹çš„CPU coreæ•°é‡æœ‰ç›´æ¥å…³ç³»çš„ã€‚ä¸€ä¸ªCPU coreåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚è€Œæ¯ä¸ªExecutorè¿›ç¨‹ä¸Šåˆ†é…åˆ°çš„å¤šä¸ªtaskï¼Œéƒ½æ˜¯ä»¥æ¯ä¸ªtaskä¸€æ¡çº¿ç¨‹çš„æ–¹å¼ï¼Œå¤šçº¿ç¨‹å¹¶å‘è¿è¡Œçš„ã€‚<strong>å¦‚æœCPU coreæ•°é‡æ¯”è¾ƒå……è¶³ï¼Œè€Œä¸”åˆ†é…åˆ°çš„taskæ•°é‡æ¯”è¾ƒåˆç†ï¼Œé‚£ä¹ˆé€šå¸¸æ¥è¯´ï¼Œå¯ä»¥æ¯”è¾ƒå¿«é€Ÿå’Œé«˜æ•ˆåœ°æ‰§è¡Œå®Œè¿™äº›taskçº¿ç¨‹ã€‚</strong></p><p>ä»¥ä¸Šå°±æ˜¯Sparkä½œä¸šçš„åŸºæœ¬è¿è¡ŒåŸç†çš„è¯´æ˜ï¼Œå¤§å®¶å¯ä»¥ç»“åˆä¸Šå›¾æ¥ç†è§£ã€‚ç†è§£ä½œä¸šåŸºæœ¬åŸç†ï¼Œæ˜¯æˆ‘ä»¬è¿›è¡Œèµ„æºå‚æ•°è°ƒä¼˜çš„åŸºæœ¬å‰æã€‚</p><h2 id="æ•°æ®æœ¬åœ°åŒ–"><a href="#æ•°æ®æœ¬åœ°åŒ–" class="headerlink" title="æ•°æ®æœ¬åœ°åŒ–"></a>æ•°æ®æœ¬åœ°åŒ–</h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-29-171030.jpg" alt=""></p><p>ç§»åŠ¨ä»£ç åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä¼šæ¯”ç§»åŠ¨æ•°æ®åˆ°ä»£ç æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šå»ï¼Œé€Ÿåº¦è¦å¿«å¾—å¤šï¼Œå› ä¸ºä»£ç æ¯”è¾ƒå°ã€‚Sparkä¹Ÿæ­£æ˜¯åŸºäºè¿™ä¸ªæ•°æ®æœ¬åœ°åŒ–çš„åŸåˆ™æ¥æ„å»ºtaskè°ƒåº¦ç®—æ³•çš„ã€‚ </p><p>æ•°æ®æœ¬åœ°åŒ–ï¼ŒæŒ‡çš„æ˜¯ï¼Œæ•°æ®ç¦»è®¡ç®—å®ƒçš„ä»£ç æœ‰å¤šè¿‘ã€‚<strong>åŸºäºæ•°æ®è·ç¦»ä»£ç çš„è·ç¦»ï¼Œæœ‰å‡ ç§æ•°æ®æœ¬åœ°åŒ–çº§åˆ«ï¼š</strong> </p><ol><li><code>PROCESS_LOCAL</code>ï¼šæ•°æ®å’Œè®¡ç®—å®ƒçš„ä»£ç åœ¨åŒä¸€ä¸ªJVMè¿›ç¨‹ä¸­ã€‚</li><li><code>NODE_LOCAL</code>ï¼šæ•°æ®å’Œè®¡ç®—å®ƒçš„ä»£ç åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯ä¸åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ¯”å¦‚åœ¨ä¸åŒçš„executorè¿›ç¨‹ä¸­ï¼Œæˆ–è€…æ˜¯æ•°æ®åœ¨HDFSæ–‡ä»¶çš„blockä¸­ã€‚</li><li><code>NO_PREF</code>ï¼šæ•°æ®ä»å“ªé‡Œè¿‡æ¥ï¼Œæ€§èƒ½éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li><li><code>RACK_LOCAL</code>ï¼šæ•°æ®å’Œè®¡ç®—å®ƒçš„ä»£ç åœ¨ä¸€ä¸ªæœºæ¶ä¸Šã€‚</li><li><code>ANY</code>ï¼šæ•°æ®å¯èƒ½åœ¨ä»»æ„åœ°æ–¹ï¼Œæ¯”å¦‚å…¶ä»–ç½‘ç»œç¯å¢ƒå†…ï¼Œæˆ–è€…å…¶ä»–æœºæ¶ä¸Šã€‚</li></ol><p>Sparkå€¾å‘äºä½¿ç”¨æœ€å¥½çš„æœ¬åœ°åŒ–çº§åˆ«æ¥è°ƒåº¦taskï¼Œä½†æ˜¯è¿™æ˜¯ä¸å¯èƒ½çš„ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•æœªå¤„ç†çš„æ•°æ®åœ¨ç©ºé—²çš„executorä¸Šï¼Œé‚£ä¹ˆSparkå°±ä¼šæ”¾ä½æœ¬åœ°åŒ–çº§åˆ«ã€‚è¿™æ—¶æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼šç¬¬ä¸€ï¼Œç­‰å¾…ï¼Œç›´åˆ°executorä¸Šçš„cpué‡Šæ”¾å‡ºæ¥ï¼Œé‚£ä¹ˆå°±åˆ†é…taskè¿‡å»ï¼›ç¬¬äºŒï¼Œç«‹å³åœ¨ä»»æ„ä¸€ä¸ªexecutorä¸Šå¯åŠ¨ä¸€ä¸ªtaskã€‚ </p><p>Sparké»˜è®¤ä¼šç­‰å¾…ä¸€ä¼šå„¿ï¼Œæ¥æœŸæœ›taskè¦å¤„ç†çš„æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šçš„executorç©ºé—²å‡ºä¸€ä¸ªcpuï¼Œä»è€Œå°†taskåˆ†é…è¿‡å»ã€‚åªè¦è¶…è¿‡äº†æ—¶é—´ï¼Œé‚£ä¹ˆSparkå°±ä¼šå°†taskåˆ†é…åˆ°å…¶ä»–ä»»æ„ä¸€ä¸ªç©ºé—²çš„executorä¸Šã€‚ </p><p>å¯ä»¥è®¾ç½®å‚æ•°ï¼Œ<code>spark.locality</code>ç³»åˆ—å‚æ•°ï¼Œæ¥è°ƒèŠ‚Sparkç­‰å¾…taskå¯ä»¥è¿›è¡Œæ•°æ®æœ¬åœ°åŒ–çš„æ—¶é—´ã€‚<code>spark.locality.wait</code>ï¼ˆ3000æ¯«ç§’ï¼‰ã€spark.locality.wait.nodeã€spark.locality.wait.processã€spark.locality.wait.rackã€‚ </p><h2 id="å†…å­˜ç©ºé—´åˆ†é…"><a href="#å†…å­˜ç©ºé—´åˆ†é…" class="headerlink" title="å†…å­˜ç©ºé—´åˆ†é…"></a>å†…å­˜ç©ºé—´åˆ†é…</h2><h3 id="1-é™æ€å†…å­˜ç®¡ç†"><a href="#1-é™æ€å†…å­˜ç®¡ç†" class="headerlink" title="1.é™æ€å†…å­˜ç®¡ç†"></a>1.é™æ€å†…å­˜ç®¡ç†</h3><p>åœ¨ Spark æœ€åˆé‡‡ç”¨çš„é™æ€å†…å­˜ç®¡ç†æœºåˆ¶ä¸‹ï¼Œå­˜å‚¨å†…å­˜ã€æ‰§è¡Œå†…å­˜å’Œå…¶ä»–å†…å­˜çš„å¤§å°åœ¨ Spark åº”ç”¨ç¨‹åºè¿è¡ŒæœŸé—´å‡ä¸ºå›ºå®šçš„ï¼Œä½†ç”¨æˆ·å¯ä»¥åº”ç”¨ç¨‹åºå¯åŠ¨å‰è¿›è¡Œé…ç½®</p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-28-083345.png" alt="image-20180728163345199"></p><p><strong>å¯ç”¨çš„å­˜å‚¨å†…å­˜</strong><code>StorageMemory =systemMaxMemory * spark.storage.memoryFraction * spark.storage.safetyFraction = 43%</code></p><p><strong>å¯ç”¨çš„æ‰§è¡Œå†…å­˜</strong> = <code>systemMaxMemory * spark.shuffle.memoryFraction * spark.shuffle.safetyFraction = 16%</code></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-28-083901.png" alt="image-20180728163901027"></p><p>ç”±äºæ–°çš„å†…å­˜ç®¡ç†æœºåˆ¶çš„å‡ºç°ï¼Œè¿™ç§æ–¹å¼ ä½¿ç”¨ï¼Œå‡ºäºå…¼å®¹æ—§ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºçš„ç›®çš„ï¼ŒSpark ä»ç„¶ä¿ç•™äº†å®ƒçš„å®ç°ã€‚</p><h3 id="2-ç»Ÿä¸€å†…å­˜ç®¡ç†"><a href="#2-ç»Ÿä¸€å†…å­˜ç®¡ç†" class="headerlink" title="2.ç»Ÿä¸€å†…å­˜ç®¡ç†"></a>2.ç»Ÿä¸€å†…å­˜ç®¡ç†</h3><p><strong>Spark-1.6 ä¹‹åå¼•å…¥çš„ç»Ÿä¸€å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¸é™æ€å†…å­˜ç®¡ç†çš„åŒºåˆ«åœ¨äºå­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜ å…±äº«åŒä¸€å—ç©ºé—´ï¼Œå¯ä»¥åŠ¨æ€å ç”¨å¯¹æ–¹çš„ç©ºé—²åŒºåŸŸ</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-28-084013.png" alt="image-20180728164012590"></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-28-084035.png" alt="image-20180728164035249"></p><p><strong>å…¶ä¸­æœ€é‡è¦çš„ä¼˜åŒ–åœ¨äºåŠ¨æ€å ç”¨æœºåˆ¶</strong></p><ol><li>è®¾å®šåŸºæœ¬çš„å­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜åŒºåŸŸï¼ˆspark.memory.storageFractionå‚æ•°), è¯¥è®¾å®šç¡®å®šäº†åŒæ–¹å„è‡ªæ‹¥æœ‰çš„ç©ºé—´çš„èŒƒå›´</li><li>åŒæ–¹çš„ç©ºé—´éƒ½ä¸è¶³æ—¶ï¼Œåˆ™å­˜å‚¨åˆ°ç¡¬ç›˜ï¼›è‹¥å·±æ–¹ç©ºé—´ä¸è¶³è€Œå¯¹æ–¹ç©ºä½™æ—¶ï¼Œå¯å€Ÿç”¨å¯¹æ–¹çš„ç©º é—´;ï¼ˆå­˜å‚¨ç©ºé—´ä¸è¶³æ˜¯æŒ‡ä¸è¶³ä»¥æ”¾ä¸‹ä¸€ä¸ªå®Œæ•´çš„ Blockï¼‰</li><li><strong><code>æ‰§è¡Œå†…å­˜</code>çš„ç©ºé—´è¢«<code>å­˜å‚¨å†…å­˜</code>å ç”¨åï¼Œå¯è®©<code>å­˜å‚¨å†…å­˜</code>å°†å ç”¨çš„éƒ¨åˆ†è½¬å­˜åˆ°ç¡¬ç›˜ï¼Œç„¶å<code>å½’è¿˜</code>å€Ÿç”¨çš„ç©ºé—´</strong></li><li><strong><code>å­˜å‚¨å†…å­˜</code>çš„ç©ºé—´è¢«<code>æ‰§è¡Œå†…å­˜</code>å ç”¨åï¼Œ<code>æ— æ³•è®©æ‰§è¡Œå†…å­˜</code>â€œå½’è¿˜â€ï¼Œå› ä¸ºéœ€è¦è€ƒè™‘ Shuffle è¿‡ç¨‹ä¸­çš„å¾ˆå¤š å› ç´ ï¼Œå®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚</strong></li></ol><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-28-090452.png" alt="image-20180728170452408"></p><h3 id="åƒåœ¾å›æ”¶-JVM-ä¼˜åŒ–"><a href="#åƒåœ¾å›æ”¶-JVM-ä¼˜åŒ–" class="headerlink" title="åƒåœ¾å›æ”¶, JVM ä¼˜åŒ–"></a>åƒåœ¾å›æ”¶, JVM ä¼˜åŒ–</h3><blockquote><p>GC å¯¹æ€§èƒ½çš„å½±å“</p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-29-GC%E5%AF%B9Spark%E6%80%A7%E8%83%BD%E5%BD%B1%E5%93%8D%E7%9A%84%E5%8E%9F%E7%90%86.png" alt=""></p><p>å¯¹äºåƒåœ¾å›æ”¶çš„æ€§èƒ½é—®é¢˜ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯ï¼Œä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚arrayå’Œstringï¼›å…¶æ¬¡å°±æ˜¯åœ¨æŒä¹…åŒ–rddæ—¶ï¼Œä½¿ç”¨åºåˆ—åŒ–çš„æŒä¹…åŒ–çº§åˆ«ï¼Œè€Œä¸”ç”¨Kryoåºåˆ—åŒ–ç±»åº“ï¼Œè¿™æ ·ï¼Œæ¯ä¸ªpartitionå°±åªæ˜¯ä¸€ä¸ªå¯¹è±¡â€”â€”ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥<strong>å¯¹åƒåœ¾å›æ”¶è¿›è¡Œç›‘æµ‹</strong>ï¼ŒåŒ…æ‹¬å¤šä¹…è¿›è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ï¼Œä»¥åŠæ¯æ¬¡åƒåœ¾å›æ”¶è€—è´¹çš„æ—¶é—´ã€‚åªè¦åœ¨spark-submitè„šæœ¬ä¸­ï¼Œå¢åŠ ä¸€ä¸ªé…ç½®å³å¯ï¼Œâ€“conf â€œspark.executor.extraJavaOptions=-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStampsâ€ã€‚ è¿™é‡Œè™½ç„¶ä¼šæ‰“å°å‡ºJavaè™šæ‹Ÿæœºçš„åƒåœ¾å›æ”¶çš„ç›¸å…³ä¿¡æ¯ï¼Œä½†æ˜¯æ˜¯è¾“å‡ºåˆ°äº†workerä¸Šçš„æ—¥å¿—ä¸­ï¼Œè€Œä¸æ˜¯driverçš„æ—¥å¿—ä¸­ã€‚ </p><p>ä¹Ÿå®Œå…¨å¯ä»¥é€šè¿‡<strong>SparkUI</strong>ï¼ˆ4040ç«¯å£ï¼‰æ¥è§‚å¯Ÿæ¯ä¸ªstageçš„åƒåœ¾å›æ”¶çš„æƒ…å†µã€‚ </p><blockquote><p><strong>è°ƒèŠ‚executorå†…å­˜æ¯”ä¾‹</strong></p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-29-%E8%B0%83%E8%8A%82executor%E5%86%85%E5%AD%98%E6%AF%94%E4%BE%8B.png" alt=""></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSparkä½¿ç”¨æ¯ä¸ªexecutor 60%çš„å†…å­˜ç©ºé—´æ¥ç¼“å­˜RDDï¼Œé‚£ä¹ˆåœ¨taskæ‰§è¡ŒæœŸé—´åˆ›å»ºçš„å¯¹è±¡ï¼Œåªæœ‰40%çš„å†…å­˜ç©ºé—´æ¥å­˜æ”¾ã€‚ </p><p>åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç°åƒåœ¾å›æ”¶é¢‘ç¹å‘ç”Ÿã€‚é‚£ä¹ˆå°±éœ€è¦å¯¹é‚£ä¸ªæ¯”ä¾‹è¿›è¡Œè°ƒä¼˜ï¼Œä½¿ç”¨new SparkConf().set(â€œspark.storage.memoryFractionâ€, â€œ0.5â€)å³å¯ï¼Œå¯ä»¥å°†RDDç¼“å­˜å ç”¨ç©ºé—´çš„æ¯”ä¾‹é™ä½ï¼Œä»è€Œç»™æ›´å¤šçš„ç©ºé—´è®©taskåˆ›å»ºçš„å¯¹è±¡è¿›è¡Œä½¿ç”¨ã€‚ </p><p>å› æ­¤ï¼Œ<strong>å¯¹äºRDDæŒä¹…åŒ–ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨Kryoåºåˆ—åŒ–ï¼ŒåŠ ä¸Šé™ä½å…¶executorå†…å­˜å æ¯”çš„æ–¹å¼ï¼Œæ¥å‡å°‘å…¶å†…å­˜æ¶ˆè€—</strong>ã€‚ç»™taskæä¾›æ›´å¤šçš„å†…å­˜ï¼Œä»è€Œé¿å…taskçš„æ‰§è¡Œé¢‘ç¹è§¦å‘åƒåœ¾å›æ”¶ã€‚ </p><h3 id="é«˜çº§åƒåœ¾å›æ”¶è°ƒä¼˜"><a href="#é«˜çº§åƒåœ¾å›æ”¶è°ƒä¼˜" class="headerlink" title="é«˜çº§åƒåœ¾å›æ”¶è°ƒä¼˜"></a>é«˜çº§åƒåœ¾å›æ”¶è°ƒä¼˜</h3><blockquote><p>JVM minor gcä¸full gcåŸç†</p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-29-JVM%20minor%20gc%E4%B8%8Efull%20gc%E5%8E%9F%E7%90%86.png" alt=""></p><p>Javaå †ç©ºé—´è¢«åˆ’åˆ†æˆäº†ä¸¤å—ç©ºé—´ï¼Œä¸€ä¸ªæ˜¯å¹´è½»ä»£ï¼Œä¸€ä¸ªæ˜¯è€å¹´ä»£ã€‚å¹´è½»ä»£æ”¾çš„æ˜¯çŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œè€å¹´ä»£æ”¾çš„æ˜¯é•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡ã€‚å¹´è½»ä»£åˆè¢«åˆ’åˆ†äº†ä¸‰å—ç©ºé—´ï¼ŒEdenã€Survivor1ã€Survivor2ã€‚</p><p>é¦–å…ˆï¼ŒEdenåŒºåŸŸå’ŒSurvivor1åŒºåŸŸç”¨äºå­˜æ”¾å¯¹è±¡ï¼ŒSurvivor2åŒºåŸŸå¤‡ç”¨ã€‚åˆ›å»ºçš„å¯¹è±¡ï¼Œé¦–å…ˆæ”¾å…¥EdenåŒºåŸŸå’ŒSurvivor1åŒºåŸŸï¼Œå¦‚æœEdenåŒºåŸŸæ»¡äº†ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸€æ¬¡Minor GCï¼Œè¿›è¡Œå¹´è½»ä»£çš„åƒåœ¾å›æ”¶ã€‚Edenå’ŒSurvivor1åŒºåŸŸä¸­å­˜æ´»çš„å¯¹è±¡ï¼Œä¼šè¢«ç§»åŠ¨åˆ°Survivor2åŒºåŸŸä¸­ã€‚ç„¶åSurvivor1å’ŒSurvivor2çš„è§’è‰²è°ƒæ¢ï¼ŒSurvivor1å˜æˆäº†å¤‡ç”¨</p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å¹´è½»ä»£ä¸­ï¼Œæ’‘è¿‡äº†å¤šæ¬¡åƒåœ¾å›æ”¶ï¼Œéƒ½æ²¡æœ‰è¢«å›æ”¶æ‰ï¼Œé‚£ä¹ˆä¼šè¢«è®¤ä¸ºæ˜¯é•¿æ—¶é—´å­˜æ´»çš„ï¼Œæ­¤æ—¶å°±ä¼šè¢«ç§»å…¥è€å¹´ä»£ã€‚æ­¤å¤–ï¼Œå¦‚æœåœ¨å°†Edenå’ŒSurvivor1ä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œå°è¯•æ”¾å…¥Survivor2ä¸­æ—¶ï¼Œå‘ç°Survivor2æ”¾æ»¡äº†ï¼Œé‚£ä¹ˆä¼šç›´æ¥æ”¾å…¥è€å¹´ä»£ã€‚æ­¤æ—¶å°±å‡ºç°äº†ï¼ŒçŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œè¿›å…¥è€å¹´ä»£çš„é—®é¢˜ã€‚</p><p>å¦‚æœè€å¹´ä»£çš„ç©ºé—´æ»¡äº†ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Full GCï¼Œè¿›è¡Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶æ“ä½œã€‚</p><p>Sparkä¸­ï¼Œåƒåœ¾å›æ”¶è°ƒä¼˜çš„ç›®æ ‡å°±æ˜¯ï¼Œåªæœ‰çœŸæ­£é•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰èƒ½è¿›å…¥è€å¹´ä»£ï¼ŒçŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œåªèƒ½å‘†åœ¨å¹´è½»ä»£ã€‚ä¸èƒ½å› ä¸ºæŸä¸ªSurvivoråŒºåŸŸç©ºé—´ä¸å¤Ÿï¼Œåœ¨Minor GCæ—¶ï¼Œå°±è¿›å…¥äº†è€å¹´ä»£ã€‚ä»è€Œé€ æˆçŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œé•¿æœŸå‘†åœ¨è€å¹´ä»£ä¸­å æ®äº†ç©ºé—´ï¼Œè€Œä¸”Full GCæ—¶è¦å›æ”¶å¤§é‡çš„çŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼Œå¯¼è‡´Full GCé€Ÿåº¦ç¼“æ…¢ã€‚</p><p><strong>å¦‚æœå‘ç°ï¼Œåœ¨taskæ‰§è¡ŒæœŸé—´ï¼Œå¤§é‡full gcå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆè¯´æ˜ï¼Œå¹´è½»ä»£çš„EdenåŒºåŸŸï¼Œç»™çš„ç©ºé—´ä¸å¤Ÿå¤§ã€‚æ­¤æ—¶å¯ä»¥æ‰§è¡Œä¸€äº›æ“ä½œæ¥ä¼˜åŒ–åƒåœ¾å›æ”¶è¡Œä¸ºï¼š</strong></p><p>1ã€åŒ…æ‹¬é™ä½spark.storage.memoryFractionçš„æ¯”ä¾‹ï¼Œç»™å¹´è½»ä»£æ›´å¤šçš„ç©ºé—´ï¼Œæ¥å­˜æ”¾çŸ­æ—¶é—´å­˜æ´»çš„å¯¹è±¡ï¼›</p><p>2ã€ç»™EdenåŒºåŸŸåˆ†é…æ›´å¤§çš„ç©ºé—´ï¼Œä½¿ç”¨-Xmnå³å¯ï¼Œé€šå¸¸å»ºè®®ç»™EdenåŒºåŸŸï¼Œé¢„è®¡å¤§å°çš„4/3ï¼›</p><p>3ã€å¦‚æœä½¿ç”¨çš„æ˜¯HDFSæ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ˆå¥½ä¼°è®¡EdenåŒºåŸŸå¤§å°ï¼Œå¦‚æœæ¯ä¸ªexecutoræœ‰4ä¸ªtaskï¼Œç„¶åæ¯ä¸ªhdfså‹ç¼©å—è§£å‹ç¼©åå¤§å°æ˜¯3å€ï¼Œæ­¤å¤–æ¯ä¸ªhdfså—çš„å¤§å°æ˜¯64Mï¼Œé‚£ä¹ˆEdenåŒºåŸŸçš„é¢„è®¡å¤§å°å°±æ˜¯ï¼š4 <em> 3 </em> 64MBï¼Œç„¶åå‘¢ï¼Œå†é€šè¿‡-Xmnå‚æ•°ï¼Œå°†EdenåŒºåŸŸå¤§å°è®¾ç½®ä¸º4 <em> 3 </em> 64 * 4/3ã€‚</p><p>å…¶å®å•Šï¼Œæ ¹æ®ç»éªŒæ¥çœ‹ï¼Œ<strong>å¯¹äºåƒåœ¾å›æ”¶çš„è°ƒä¼˜ï¼Œå°½é‡å°±æ˜¯è¯´ï¼Œè°ƒèŠ‚executorå†…å­˜çš„æ¯”ä¾‹å°±å¯ä»¥äº†ã€‚</strong>å› ä¸ºjvmçš„è°ƒä¼˜æ˜¯éå¸¸å¤æ‚å’Œæ•æ„Ÿçš„ã€‚é™¤éæ˜¯ï¼ŒçœŸçš„åˆ°äº†ä¸‡ä¸å¾—å·²çš„åœ°æ–¹ï¼Œç„¶åå‘¢ï¼Œè‡ªå·±æœ¬èº«åˆå¯¹jvmç›¸å…³çš„æŠ€æœ¯å¾ˆäº†è§£ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿›è¡ŒedenåŒºåŸŸçš„è°ƒèŠ‚ï¼Œè°ƒä¼˜ï¼Œæ˜¯å¯ä»¥çš„ã€‚</p><p><strong>ä¸€äº›é«˜çº§çš„å‚æ•°</strong></p><p>-XX:SurvivorRatio=4ï¼šå¦‚æœå€¼ä¸º4ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸¤ä¸ªSurvivorè·ŸEdençš„æ¯”ä¾‹æ˜¯2:4ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªSurvivorå æ®çš„å¹´è½»ä»£çš„æ¯”ä¾‹æ˜¯1/6ï¼Œæ‰€ä»¥ï¼Œä½ å…¶å®ä¹Ÿå¯ä»¥å°è¯•è°ƒå¤§SurvivoråŒºåŸŸçš„å¤§å°ã€‚</p><p>-XX:NewRatio=4ï¼šè°ƒèŠ‚æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹</p><h2 id="èµ„æºå‚æ•°è°ƒä¼˜"><a href="#èµ„æºå‚æ•°è°ƒä¼˜" class="headerlink" title="èµ„æºå‚æ•°è°ƒä¼˜"></a>èµ„æºå‚æ•°è°ƒä¼˜</h2><p>äº†è§£å®Œäº†Sparkä½œä¸šè¿è¡Œçš„åŸºæœ¬åŸç†ä¹‹åï¼Œå¯¹èµ„æºç›¸å…³çš„å‚æ•°å°±å®¹æ˜“ç†è§£äº†ã€‚æ‰€è°“çš„Sparkèµ„æºå‚æ•°è°ƒä¼˜ï¼Œå…¶å®ä¸»è¦å°±æ˜¯å¯¹Sparkè¿è¡Œè¿‡ç¨‹ä¸­å„ä¸ªä½¿ç”¨èµ„æºçš„åœ°æ–¹ï¼Œé€šè¿‡è°ƒèŠ‚å„ç§å‚æ•°ï¼Œæ¥ä¼˜åŒ–èµ„æºä½¿ç”¨çš„æ•ˆç‡ï¼Œä»è€Œæå‡Sparkä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ã€‚ä»¥ä¸‹å‚æ•°å°±æ˜¯Sparkä¸­ä¸»è¦çš„èµ„æºå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°éƒ½å¯¹åº”ç€ä½œä¸šè¿è¡ŒåŸç†ä¸­çš„æŸä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªè°ƒä¼˜çš„å‚è€ƒå€¼ã€‚</p><h3 id="num-executors"><a href="#num-executors" class="headerlink" title="num-executors"></a>num-executors</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®Sparkä½œä¸šæ€»å…±è¦ç”¨å¤šå°‘ä¸ªExecutorè¿›ç¨‹æ¥æ‰§è¡Œã€‚</u>Driveråœ¨å‘YARNé›†ç¾¤ç®¡ç†å™¨ç”³è¯·èµ„æºæ—¶ï¼ŒYARNé›†ç¾¤ç®¡ç†å™¨ä¼šå°½å¯èƒ½æŒ‰ç…§ä½ çš„è®¾ç½®æ¥åœ¨é›†ç¾¤çš„å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨ç›¸åº”æ•°é‡çš„Executorè¿›ç¨‹ã€‚è¿™ä¸ªå‚æ•°éå¸¸ä¹‹é‡è¦ï¼Œå¦‚æœä¸è®¾ç½®çš„è¯ï¼Œé»˜è®¤åªä¼šç»™ä½ å¯åŠ¨å°‘é‡çš„Executorè¿›ç¨‹ï¼Œæ­¤æ—¶ä½ çš„Sparkä½œä¸šçš„è¿è¡Œé€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ã€‚</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šæ¯ä¸ªSparkä½œä¸šçš„è¿è¡Œä¸€èˆ¬è®¾ç½®50~100ä¸ªå·¦å³çš„Executorè¿›ç¨‹æ¯”è¾ƒåˆé€‚ï¼Œè®¾ç½®å¤ªå°‘æˆ–å¤ªå¤šçš„Executorè¿›ç¨‹éƒ½ä¸å¥½ã€‚è®¾ç½®çš„å¤ªå°‘ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼›è®¾ç½®çš„å¤ªå¤šçš„è¯ï¼Œå¤§éƒ¨åˆ†é˜Ÿåˆ—å¯èƒ½æ— æ³•ç»™äºˆå……åˆ†çš„èµ„æºã€‚</li></ul><h3 id="executor-memory"><a href="#executor-memory" class="headerlink" title="executor-memory"></a>executor-memory</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®æ¯ä¸ªExecutorè¿›ç¨‹çš„å†…å­˜ã€‚</u>Executorå†…å­˜çš„å¤§å°ï¼Œå¾ˆå¤šæ—¶å€™ç›´æ¥å†³å®šäº†Sparkä½œä¸šçš„æ€§èƒ½ï¼Œè€Œä¸”è·Ÿå¸¸è§çš„JVM OOMå¼‚å¸¸ï¼Œä¹Ÿæœ‰ç›´æ¥çš„å…³è”ã€‚</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šæ¯ä¸ªExecutorè¿›ç¨‹çš„å†…å­˜è®¾ç½®4G<sub>8Gè¾ƒä¸ºåˆé€‚ã€‚ä½†æ˜¯è¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜æ˜¯å¾—æ ¹æ®ä¸åŒéƒ¨é—¨çš„èµ„æºé˜Ÿåˆ—æ¥å®šã€‚å¯ä»¥çœ‹çœ‹è‡ªå·±å›¢é˜Ÿçš„èµ„æºé˜Ÿåˆ—çš„æœ€å¤§å†…å­˜é™åˆ¶æ˜¯å¤šå°‘ï¼Œnum-executorsä¹˜ä»¥executor-memoryï¼Œæ˜¯ä¸èƒ½è¶…è¿‡é˜Ÿåˆ—çš„æœ€å¤§å†…å­˜é‡çš„ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ æ˜¯è·Ÿå›¢é˜Ÿé‡Œå…¶ä»–äººå…±äº«è¿™ä¸ªèµ„æºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆç”³è¯·çš„å†…å­˜é‡æœ€å¥½ä¸è¦è¶…è¿‡èµ„æºé˜Ÿåˆ—æœ€å¤§æ€»å†…å­˜çš„1/3</sub>1/2ï¼Œé¿å…ä½ è‡ªå·±çš„Sparkä½œä¸šå ç”¨äº†é˜Ÿåˆ—æ‰€æœ‰çš„èµ„æºï¼Œå¯¼è‡´åˆ«çš„åŒå­¦çš„ä½œä¸šæ— æ³•è¿è¡Œã€‚</li></ul><h3 id="executor-cores"><a href="#executor-cores" class="headerlink" title="executor-cores"></a>executor-cores</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®æ¯ä¸ªExecutorè¿›ç¨‹çš„CPU coreæ•°é‡ã€‚</u>è¿™ä¸ªå‚æ•°å†³å®šäº†æ¯ä¸ªExecutorè¿›ç¨‹å¹¶è¡Œæ‰§è¡Œtaskçº¿ç¨‹çš„èƒ½åŠ›ã€‚å› ä¸ºæ¯ä¸ªCPU coreåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªtaskçº¿ç¨‹ï¼Œå› æ­¤æ¯ä¸ªExecutorè¿›ç¨‹çš„CPU coreæ•°é‡è¶Šå¤šï¼Œè¶Šèƒ½å¤Ÿå¿«é€Ÿåœ°æ‰§è¡Œå®Œåˆ†é…ç»™è‡ªå·±çš„æ‰€æœ‰taskçº¿ç¨‹ã€‚</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šExecutorçš„CPU coreæ•°é‡è®¾ç½®ä¸º2<sub>4ä¸ªè¾ƒä¸ºåˆé€‚ã€‚åŒæ ·å¾—æ ¹æ®ä¸åŒéƒ¨é—¨çš„èµ„æºé˜Ÿåˆ—æ¥å®šï¼Œå¯ä»¥çœ‹çœ‹è‡ªå·±çš„èµ„æºé˜Ÿåˆ—çš„æœ€å¤§CPU coreé™åˆ¶æ˜¯å¤šå°‘ï¼Œå†ä¾æ®è®¾ç½®çš„Executoræ•°é‡ï¼Œæ¥å†³å®šæ¯ä¸ªExecutorè¿›ç¨‹å¯ä»¥åˆ†é…åˆ°å‡ ä¸ªCPU coreã€‚åŒæ ·å»ºè®®ï¼Œ<strong>å¦‚æœæ˜¯è·Ÿä»–äººå…±äº«è¿™ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆnum-executors * executor-coresä¸è¦è¶…è¿‡é˜Ÿåˆ—æ€»CPU coreçš„1/3</strong></sub>1/2å·¦å³æ¯”è¾ƒåˆé€‚ï¼Œä¹Ÿæ˜¯é¿å…å½±å“å…¶ä»–åŒå­¦çš„ä½œä¸šè¿è¡Œã€‚</li></ul><h3 id="driver-memory"><a href="#driver-memory" class="headerlink" title="driver-memory"></a>driver-memory</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®Driverè¿›ç¨‹çš„å†…å­˜ã€‚</u></li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šDriverçš„å†…å­˜é€šå¸¸æ¥è¯´ä¸è®¾ç½®ï¼Œæˆ–è€…è®¾ç½®1Gå·¦å³åº”è¯¥å°±å¤Ÿäº†ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨collectç®—å­å°†RDDçš„æ•°æ®å…¨éƒ¨æ‹‰å–åˆ°Driverä¸Šè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¿…é¡»ç¡®ä¿Driverçš„å†…å­˜è¶³å¤Ÿå¤§ï¼Œå¦åˆ™ä¼šå‡ºç°OOMå†…å­˜æº¢å‡ºçš„é—®é¢˜ã€‚</li></ul><h3 id="spark-default-parallelism-â€»-task-å¹¶è¡Œåº¦"><a href="#spark-default-parallelism-â€»-task-å¹¶è¡Œåº¦" class="headerlink" title="spark.default.parallelism â€»  task å¹¶è¡Œåº¦"></a>spark.default.parallelism â€»  task å¹¶è¡Œåº¦</h3><ul><li><strong>å‚æ•°è¯´æ˜</strong>ï¼š<strong><u>è¯¥å‚æ•°ç”¨äºè®¾ç½®<code>æ¯ä¸ªstageçš„é»˜è®¤taskæ•°é‡</code>ã€‚</u>**</strong>è¿™ä¸ªå‚æ•°æä¸ºé‡è¦<strong>ï¼Œå¦‚æœä¸è®¾ç½®å¯èƒ½ä¼šç›´æ¥å½±å“ä½ çš„Sparkä½œä¸šæ€§èƒ½ã€‚ </strong>æé«˜å¹¶è¡Œåº¦.**</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šSparkä½œä¸šçš„é»˜è®¤taskæ•°é‡ä¸º500<sub>1000ä¸ªè¾ƒä¸ºåˆé€‚ã€‚å¾ˆå¤šåŒå­¦å¸¸çŠ¯çš„ä¸€ä¸ªé”™è¯¯å°±æ˜¯ä¸å»è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šå¯¼è‡´Sparkè‡ªå·±æ ¹æ®åº•å±‚HDFSçš„blockæ•°é‡æ¥è®¾ç½®taskçš„æ•°é‡ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªHDFS blockå¯¹åº”ä¸€ä¸ªtaskã€‚é€šå¸¸æ¥è¯´ï¼ŒSparké»˜è®¤è®¾ç½®çš„æ•°é‡æ˜¯åå°‘çš„ï¼ˆæ¯”å¦‚å°±å‡ åä¸ªtaskï¼‰ï¼Œ<em>å¦‚æœtaskæ•°é‡åå°‘çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä½ å‰é¢è®¾ç½®å¥½çš„Executorçš„å‚æ•°éƒ½å‰åŠŸå°½å¼ƒ</em>ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œæ— è®ºä½ çš„Executorè¿›ç¨‹æœ‰å¤šå°‘ä¸ªï¼Œå†…å­˜å’ŒCPUæœ‰å¤šå¤§ï¼Œä½†æ˜¯taskåªæœ‰1ä¸ªæˆ–è€…10ä¸ªï¼Œé‚£ä¹ˆ90%çš„Executorè¿›ç¨‹å¯èƒ½æ ¹æœ¬å°±æ²¡æœ‰taskæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ç™½ç™½æµªè´¹äº†èµ„æºï¼å› æ­¤<strong>Sparkå®˜ç½‘å»ºè®®çš„è®¾ç½®åŸåˆ™æ˜¯ï¼Œè®¾ç½®è¯¥å‚æ•°ä¸º<code>num-executors * executor-cores</code>çš„<code>2&lt;/sub&gt;3</code>å€è¾ƒä¸ºåˆé€‚</strong>ï¼Œæ¯”å¦‚<strong>æ‰€æœ‰Executorçš„æ€»CPU core</strong>æ•°é‡ä¸º300ä¸ªï¼Œé‚£ä¹ˆè®¾ç½®1000ä¸ªtaskæ˜¯å¯ä»¥çš„ï¼Œæ­¤æ—¶<u>å¯ä»¥å……åˆ†åœ°åˆ©ç”¨Sparké›†ç¾¤çš„èµ„æº</u>ã€‚</sub></li></ul><h3 id="spark-storage-memoryFraction"><a href="#spark-storage-memoryFraction" class="headerlink" title="spark.storage.memoryFraction"></a>spark.<u>storage</u>.memoryFraction</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®RDDæŒä¹…åŒ–æ•°æ®åœ¨Executorå†…å­˜ä¸­èƒ½å çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯0.6</u>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤Executor 60%çš„å†…å­˜ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜æŒä¹…åŒ–çš„RDDæ•°æ®ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ä¸åŒçš„æŒä¹…åŒ–ç­–ç•¥ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿæ—¶ï¼Œå¯èƒ½æ•°æ®å°±ä¸ä¼šæŒä¹…åŒ–ï¼Œæˆ–è€…æ•°æ®ä¼šå†™å…¥ç£ç›˜ã€‚</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šå¦‚æœSparkä½œä¸šä¸­ï¼Œæœ‰è¾ƒå¤šçš„RDDæŒä¹…åŒ–æ“ä½œï¼Œè¯¥å‚æ•°çš„å€¼å¯ä»¥é€‚å½“æé«˜ä¸€äº›ï¼Œä¿è¯æŒä¹…åŒ–çš„æ•°æ®èƒ½å¤Ÿå®¹çº³åœ¨å†…å­˜ä¸­ã€‚é¿å…å†…å­˜ä¸å¤Ÿç¼“å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®åªèƒ½å†™å…¥ç£ç›˜ä¸­ï¼Œé™ä½äº†æ€§èƒ½ã€‚ä½†æ˜¯å¦‚æœSparkä½œä¸šä¸­çš„shuffleç±»æ“ä½œæ¯”è¾ƒå¤šï¼Œè€ŒæŒä¹…åŒ–æ“ä½œæ¯”è¾ƒå°‘ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°çš„å€¼é€‚å½“é™ä½ä¸€äº›æ¯”è¾ƒåˆé€‚ã€‚æ­¤å¤–ï¼Œå¦‚æœå‘ç°ä½œä¸šç”±äºé¢‘ç¹çš„gcå¯¼è‡´è¿è¡Œç¼“æ…¢ï¼ˆé€šè¿‡spark web uiå¯ä»¥è§‚å¯Ÿåˆ°ä½œä¸šçš„gcè€—æ—¶ï¼‰ï¼Œæ„å‘³ç€taskæ‰§è¡Œç”¨æˆ·ä»£ç çš„å†…å­˜ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆåŒæ ·å»ºè®®è°ƒä½è¿™ä¸ªå‚æ•°çš„å€¼ã€‚</li></ul><h3 id="spark-shuffle-memoryFraction"><a href="#spark-shuffle-memoryFraction" class="headerlink" title="spark.shuffle.memoryFraction"></a>spark.<u>shuffle</u>.memoryFraction</h3><ul><li>å‚æ•°è¯´æ˜ï¼š<u>è¯¥å‚æ•°ç”¨äºè®¾ç½®shuffleè¿‡ç¨‹ä¸­ä¸€ä¸ªtaskæ‹‰å–åˆ°ä¸Šä¸ªstageçš„taskçš„è¾“å‡ºåï¼Œè¿›è¡Œèšåˆæ“ä½œæ—¶èƒ½å¤Ÿä½¿ç”¨çš„Executorå†…å­˜çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯0.2ã€‚</u>ä¹Ÿå°±æ˜¯è¯´ï¼ŒExecutoré»˜è®¤åªæœ‰20%çš„å†…å­˜ç”¨æ¥è¿›è¡Œè¯¥æ“ä½œã€‚shuffleæ“ä½œåœ¨è¿›è¡Œèšåˆæ—¶ï¼Œå¦‚æœå‘ç°ä½¿ç”¨çš„å†…å­˜è¶…å‡ºäº†è¿™ä¸ª20%çš„é™åˆ¶ï¼Œé‚£ä¹ˆå¤šä½™çš„æ•°æ®å°±ä¼šæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ï¼Œæ­¤æ—¶å°±ä¼šæå¤§åœ°é™ä½æ€§èƒ½ã€‚</li><li><strong>å‚æ•°è°ƒä¼˜å»ºè®®</strong>ï¼šå¦‚æœSparkä½œä¸šä¸­çš„RDDæŒä¹…åŒ–æ“ä½œè¾ƒå°‘ï¼Œshuffleæ“ä½œè¾ƒå¤šæ—¶ï¼Œå»ºè®®é™ä½æŒä¹…åŒ–æ“ä½œçš„å†…å­˜å æ¯”ï¼Œæé«˜shuffleæ“ä½œçš„å†…å­˜å æ¯”æ¯”ä¾‹ï¼Œé¿å…shuffleè¿‡ç¨‹ä¸­æ•°æ®è¿‡å¤šæ—¶å†…å­˜ä¸å¤Ÿç”¨ï¼Œå¿…é¡»æº¢å†™åˆ°ç£ç›˜ä¸Šï¼Œé™ä½äº†æ€§èƒ½ã€‚æ­¤å¤–ï¼Œå¦‚æœå‘ç°ä½œä¸šç”±äºé¢‘ç¹çš„gcå¯¼è‡´è¿è¡Œç¼“æ…¢ï¼Œæ„å‘³ç€taskæ‰§è¡Œç”¨æˆ·ä»£ç çš„å†…å­˜ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆåŒæ ·å»ºè®®è°ƒä½è¿™ä¸ªå‚æ•°çš„å€¼ã€‚</li></ul><p><strong>èµ„æºå‚æ•°çš„è°ƒä¼˜ï¼Œæ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œéœ€è¦åŒå­¦ä»¬æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µï¼ˆåŒ…æ‹¬Sparkä½œä¸šä¸­çš„shuffleæ“ä½œæ•°é‡ã€RDDæŒä¹…åŒ–æ“ä½œæ•°é‡ä»¥åŠspark web uiä¸­æ˜¾ç¤ºçš„ä½œä¸šgcæƒ…å†µï¼‰ï¼ŒåŒæ—¶å‚è€ƒæœ¬ç¯‡æ–‡ç« ä¸­ç»™å‡ºçš„åŸç†ä»¥åŠè°ƒä¼˜å»ºè®®ï¼Œåˆç†åœ°è®¾ç½®ä¸Šè¿°å‚æ•°ã€‚</strong></p><h2 id="èµ„æºå‚æ•°å‚è€ƒç¤ºä¾‹"><a href="#èµ„æºå‚æ•°å‚è€ƒç¤ºä¾‹" class="headerlink" title="èµ„æºå‚æ•°å‚è€ƒç¤ºä¾‹"></a>èµ„æºå‚æ•°å‚è€ƒç¤ºä¾‹</h2><p>ä»¥ä¸‹æ˜¯ä¸€ä»½spark-submitå‘½ä»¤çš„ç¤ºä¾‹ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µè¿›è¡Œè°ƒèŠ‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-submit \</span><br><span class="line">  --master yarn-cluster \</span><br><span class="line">  --num-executors 100 \</span><br><span class="line">  --executor-memory 6G \</span><br><span class="line">  --executor-cores 4 \</span><br><span class="line">  --driver-memory 1G \</span><br><span class="line">  --conf spark.default.parallelism=1000 \</span><br><span class="line">  --conf spark.storage.memoryFraction=0.5 \</span><br><span class="line">  --conf spark.shuffle.memoryFraction=0.3 \</span><br></pre></td></tr></table></figure><hr><h1 id="ä¸‰-æ•°æ®å€¾æ–œè°ƒä¼˜"><a href="#ä¸‰-æ•°æ®å€¾æ–œè°ƒä¼˜" class="headerlink" title="ä¸‰. æ•°æ®å€¾æ–œè°ƒä¼˜"></a>ä¸‰. æ•°æ®å€¾æ–œè°ƒä¼˜</h1><h2 id="è°ƒä¼˜æ¦‚è¿°-2"><a href="#è°ƒä¼˜æ¦‚è¿°-2" class="headerlink" title="è°ƒä¼˜æ¦‚è¿°"></a>è°ƒä¼˜æ¦‚è¿°</h2><p>æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°å¤§æ•°æ®è®¡ç®—ä¸­ä¸€ä¸ªæœ€æ£˜æ‰‹çš„é—®é¢˜â€”â€”æ•°æ®å€¾æ–œï¼Œæ­¤æ—¶Sparkä½œä¸šçš„æ€§èƒ½ä¼šæ¯”æœŸæœ›å·®å¾ˆå¤šã€‚æ•°æ®å€¾æ–œè°ƒä¼˜ï¼Œå°±æ˜¯ä½¿ç”¨å„ç§æŠ€æœ¯æ–¹æ¡ˆè§£å†³ä¸åŒç±»å‹çš„æ•°æ®å€¾æ–œé—®é¢˜ï¼Œä»¥ä¿è¯Sparkä½œä¸šçš„æ€§èƒ½ã€‚</p><h2 id="æ•°æ®å€¾æ–œå‘ç”Ÿæ—¶çš„ç°è±¡"><a href="#æ•°æ®å€¾æ–œå‘ç”Ÿæ—¶çš„ç°è±¡" class="headerlink" title="æ•°æ®å€¾æ–œå‘ç”Ÿæ—¶çš„ç°è±¡"></a>æ•°æ®å€¾æ–œå‘ç”Ÿæ—¶çš„ç°è±¡</h2><ul><li>ç»å¤§å¤šæ•°taskæ‰§è¡Œå¾—éƒ½éå¸¸å¿«ï¼Œä½†ä¸ªåˆ«taskæ‰§è¡Œææ…¢ã€‚æ¯”å¦‚ï¼Œæ€»å…±æœ‰1000ä¸ªtaskï¼Œ997ä¸ªtaskéƒ½åœ¨1åˆ†é’Ÿä¹‹å†…æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯å‰©ä½™ä¸¤ä¸‰ä¸ªtaskå´è¦ä¸€ä¸¤ä¸ªå°æ—¶ã€‚è¿™ç§æƒ…å†µå¾ˆå¸¸è§ã€‚</li><li>åŸæœ¬èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œçš„Sparkä½œä¸šï¼ŒæŸå¤©çªç„¶æŠ¥å‡ºOOMï¼ˆå†…å­˜æº¢å‡ºï¼‰å¼‚å¸¸ï¼Œè§‚å¯Ÿå¼‚å¸¸æ ˆï¼Œæ˜¯æˆ‘ä»¬å†™çš„ä¸šåŠ¡ä»£ç é€ æˆçš„ã€‚è¿™ç§æƒ…å†µæ¯”è¾ƒå°‘è§ã€‚</li></ul><h2 id="æ•°æ®å€¾æ–œå‘ç”Ÿçš„åŸç†"><a href="#æ•°æ®å€¾æ–œå‘ç”Ÿçš„åŸç†" class="headerlink" title="æ•°æ®å€¾æ–œå‘ç”Ÿçš„åŸç†"></a>æ•°æ®å€¾æ–œå‘ç”Ÿçš„åŸç†</h2><p>æ•°æ®å€¾æ–œçš„åŸç†å¾ˆç®€å•ï¼šåœ¨è¿›è¡Œshuffleçš„æ—¶å€™ï¼Œå¿…é¡»å°†å„ä¸ªèŠ‚ç‚¹ä¸Šç›¸åŒçš„keyæ‹‰å–åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªtaskæ¥è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚æŒ‰ç…§keyè¿›è¡Œèšåˆæˆ–joinç­‰æ“ä½œã€‚æ­¤æ—¶å¦‚æœæŸä¸ªkeyå¯¹åº”çš„æ•°æ®é‡ç‰¹åˆ«å¤§çš„è¯ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚æ¯”å¦‚å¤§éƒ¨åˆ†keyå¯¹åº”10æ¡æ•°æ®ï¼Œä½†æ˜¯ä¸ªåˆ«keyå´å¯¹åº”äº†100ä¸‡æ¡æ•°æ®ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†taskå¯èƒ½å°±åªä¼šåˆ†é…åˆ°10æ¡æ•°æ®ï¼Œç„¶å1ç§’é’Ÿå°±è¿è¡Œå®Œäº†ï¼›ä½†æ˜¯ä¸ªåˆ«taskå¯èƒ½åˆ†é…åˆ°äº†100ä¸‡æ•°æ®ï¼Œè¦è¿è¡Œä¸€ä¸¤ä¸ªå°æ—¶ã€‚å› æ­¤ï¼Œæ•´ä¸ªSparkä½œä¸šçš„è¿è¡Œè¿›åº¦æ˜¯ç”±è¿è¡Œæ—¶é—´æœ€é•¿çš„é‚£ä¸ªtaskå†³å®šçš„ã€‚</p><p>å› æ­¤å‡ºç°æ•°æ®å€¾æ–œçš„æ—¶å€™ï¼ŒSparkä½œä¸šçœ‹èµ·æ¥ä¼šè¿è¡Œå¾—éå¸¸ç¼“æ…¢ï¼Œç”šè‡³å¯èƒ½å› ä¸ºæŸä¸ªtaskå¤„ç†çš„æ•°æ®é‡è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p><p>ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå¾ˆæ¸…æ™°çš„ä¾‹å­ï¼šhelloè¿™ä¸ªkeyï¼Œåœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šå¯¹åº”äº†æ€»å…±7æ¡æ•°æ®ï¼Œè¿™äº›æ•°æ®éƒ½ä¼šè¢«æ‹‰å–åˆ°åŒä¸€ä¸ªtaskä¸­è¿›è¡Œå¤„ç†ï¼›è€Œworldå’Œyouè¿™ä¸¤ä¸ªkeyåˆ†åˆ«æ‰å¯¹åº”1æ¡æ•°æ®ï¼Œæ‰€ä»¥å¦å¤–ä¸¤ä¸ªtaskåªè¦åˆ†åˆ«å¤„ç†1æ¡æ•°æ®å³å¯ã€‚æ­¤æ—¶ç¬¬ä¸€ä¸ªtaskçš„è¿è¡Œæ—¶é—´å¯èƒ½æ˜¯å¦å¤–ä¸¤ä¸ªtaskçš„7å€ï¼Œè€Œ<strong>æ•´ä¸ªstageçš„è¿è¡Œé€Ÿåº¦ä¹Ÿç”±è¿è¡Œæœ€æ…¢çš„é‚£ä¸ªtaskæ‰€å†³å®š</strong>ã€‚</p><p><img src="https://tech.meituan.com/img/spark-tuning/skwed-mech.png" alt="æ•°æ®å€¾æ–œåŸç†"></p><h2 id="å¦‚ä½•å®šä½å¯¼è‡´æ•°æ®å€¾æ–œçš„ä»£ç "><a href="#å¦‚ä½•å®šä½å¯¼è‡´æ•°æ®å€¾æ–œçš„ä»£ç " class="headerlink" title="å¦‚ä½•å®šä½å¯¼è‡´æ•°æ®å€¾æ–œçš„ä»£ç "></a>å¦‚ä½•å®šä½å¯¼è‡´æ•°æ®å€¾æ–œçš„ä»£ç </h2><p>æ•°æ®å€¾æ–œåªä¼šå‘ç”Ÿåœ¨shuffleè¿‡ç¨‹ä¸­ã€‚è¿™é‡Œç»™å¤§å®¶ç½—åˆ—ä¸€äº›å¸¸ç”¨çš„å¹¶ä¸”å¯èƒ½ä¼šè§¦å‘shuffleæ“ä½œçš„ç®—å­ï¼šdistinctã€groupByKeyã€reduceByKeyã€aggregateByKeyã€joinã€cogroupã€repartitionç­‰ã€‚å‡ºç°æ•°æ®å€¾æ–œæ—¶ï¼Œå¯èƒ½å°±æ˜¯ä½ çš„ä»£ç ä¸­ä½¿ç”¨äº†è¿™äº›ç®—å­ä¸­çš„æŸä¸€ä¸ªæ‰€å¯¼è‡´çš„ã€‚</p><h3 id="æŸä¸ªtaskæ‰§è¡Œç‰¹åˆ«æ…¢çš„æƒ…å†µ"><a href="#æŸä¸ªtaskæ‰§è¡Œç‰¹åˆ«æ…¢çš„æƒ…å†µ" class="headerlink" title="æŸä¸ªtaskæ‰§è¡Œç‰¹åˆ«æ…¢çš„æƒ…å†µ"></a>æŸä¸ªtaskæ‰§è¡Œç‰¹åˆ«æ…¢çš„æƒ…å†µ</h3><p>é¦–å…ˆè¦çœ‹çš„ï¼Œå°±æ˜¯æ•°æ®å€¾æ–œå‘ç”Ÿåœ¨ç¬¬å‡ ä¸ªstageä¸­ã€‚</p><p>å¦‚æœæ˜¯ç”¨yarn-clientæ¨¡å¼æäº¤ï¼Œé‚£ä¹ˆæœ¬åœ°æ˜¯ç›´æ¥å¯ä»¥çœ‹åˆ°logçš„ï¼Œå¯ä»¥åœ¨logä¸­æ‰¾åˆ°å½“å‰è¿è¡Œåˆ°äº†ç¬¬å‡ ä¸ªstageï¼›å¦‚æœæ˜¯ç”¨yarn-clusteræ¨¡å¼æäº¤ï¼Œåˆ™å¯ä»¥é€šè¿‡Spark Web UIæ¥æŸ¥çœ‹å½“å‰è¿è¡Œåˆ°äº†ç¬¬å‡ ä¸ªstageã€‚æ­¤å¤–ï¼Œæ— è®ºæ˜¯ä½¿ç”¨yarn-clientæ¨¡å¼è¿˜æ˜¯yarn-clusteræ¨¡å¼ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥åœ¨Spark Web UIä¸Šæ·±å…¥çœ‹ä¸€ä¸‹å½“å‰è¿™ä¸ªstageå„ä¸ªtaskåˆ†é…çš„æ•°æ®é‡ï¼Œä»è€Œè¿›ä¸€æ­¥ç¡®å®šæ˜¯ä¸æ˜¯taskåˆ†é…çš„æ•°æ®ä¸å‡åŒ€å¯¼è‡´äº†æ•°æ®å€¾æ–œã€‚</p><p>æ¯”å¦‚ä¸‹å›¾ä¸­ï¼Œå€’æ•°ç¬¬ä¸‰åˆ—æ˜¾ç¤ºäº†æ¯ä¸ªtaskçš„è¿è¡Œæ—¶é—´ã€‚æ˜æ˜¾å¯ä»¥çœ‹åˆ°ï¼Œæœ‰çš„taskè¿è¡Œç‰¹åˆ«å¿«ï¼Œåªéœ€è¦å‡ ç§’é’Ÿå°±å¯ä»¥è¿è¡Œå®Œï¼›è€Œæœ‰çš„taskè¿è¡Œç‰¹åˆ«æ…¢ï¼Œéœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½è¿è¡Œå®Œï¼Œæ­¤æ—¶å•ä»è¿è¡Œæ—¶é—´ä¸Šçœ‹å°±å·²ç»èƒ½å¤Ÿç¡®å®šå‘ç”Ÿæ•°æ®å€¾æ–œäº†ã€‚æ­¤å¤–ï¼Œå€’æ•°ç¬¬ä¸€åˆ—æ˜¾ç¤ºäº†æ¯ä¸ªtaskå¤„ç†çš„æ•°æ®é‡ï¼Œæ˜æ˜¾å¯ä»¥çœ‹åˆ°ï¼Œè¿è¡Œæ—¶é—´ç‰¹åˆ«çŸ­çš„taskåªéœ€è¦å¤„ç†å‡ ç™¾KBçš„æ•°æ®å³å¯ï¼Œè€Œè¿è¡Œæ—¶é—´ç‰¹åˆ«é•¿çš„taskéœ€è¦å¤„ç†å‡ åƒKBçš„æ•°æ®ï¼Œå¤„ç†çš„æ•°æ®é‡å·®äº†10å€ã€‚æ­¤æ—¶æ›´åŠ èƒ½å¤Ÿç¡®å®šæ˜¯å‘ç”Ÿäº†æ•°æ®å€¾æ–œã€‚</p><p><img src="https://tech.meituan.com/img/spark-tuning/shuffle-skwed-web-ui-demo.png" alt="img"></p><p>çŸ¥é“æ•°æ®å€¾æ–œå‘ç”Ÿåœ¨å“ªä¸€ä¸ªstageä¹‹åï¼Œæ¥ç€æˆ‘ä»¬å°±éœ€è¦æ ¹æ®stageåˆ’åˆ†åŸç†ï¼Œæ¨ç®—å‡ºæ¥å‘ç”Ÿå€¾æ–œçš„é‚£ä¸ªstageå¯¹åº”ä»£ç ä¸­çš„å“ªä¸€éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¸­è‚¯å®šä¼šæœ‰ä¸€ä¸ªshuffleç±»ç®—å­ã€‚ç²¾å‡†æ¨ç®—stageä¸ä»£ç çš„å¯¹åº”å…³ç³»ï¼Œéœ€è¦å¯¹Sparkçš„æºç æœ‰æ·±å…¥çš„ç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä»‹ç»ä¸€ä¸ªç›¸å¯¹ç®€å•å®ç”¨çš„æ¨ç®—æ–¹æ³•ï¼šåªè¦çœ‹åˆ°Sparkä»£ç ä¸­å‡ºç°äº†ä¸€ä¸ªshuffleç±»ç®—å­æˆ–è€…æ˜¯Spark SQLçš„SQLè¯­å¥ä¸­å‡ºç°äº†ä¼šå¯¼è‡´shuffleçš„è¯­å¥ï¼ˆæ¯”å¦‚group byè¯­å¥ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ¤å®šï¼Œä»¥é‚£ä¸ªåœ°æ–¹ä¸ºç•Œé™åˆ’åˆ†å‡ºäº†å‰åä¸¤ä¸ªstageã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å°±ä»¥Sparkæœ€åŸºç¡€çš„å…¥é—¨ç¨‹åºâ€”â€”å•è¯è®¡æ•°æ¥ä¸¾ä¾‹ï¼Œå¦‚ä½•ç”¨æœ€ç®€å•çš„æ–¹æ³•å¤§è‡´æ¨ç®—å‡ºä¸€ä¸ªstageå¯¹åº”çš„ä»£ç ã€‚å¦‚ä¸‹ç¤ºä¾‹ï¼Œåœ¨æ•´ä¸ªä»£ç ä¸­ï¼Œåªæœ‰ä¸€ä¸ªreduceByKeyæ˜¯ä¼šå‘ç”Ÿshuffleçš„ç®—å­ï¼Œå› æ­¤å°±å¯ä»¥è®¤ä¸ºï¼Œä»¥è¿™ä¸ªç®—å­ä¸ºç•Œé™ï¼Œä¼šåˆ’åˆ†å‡ºå‰åä¸¤ä¸ªstageã€‚</p><ul><li><strong>stage0</strong>ï¼Œä¸»è¦æ˜¯æ‰§è¡Œä»textFileåˆ°mapæ“ä½œï¼Œä»¥åŠæ‰§è¡Œshuffle writeæ“ä½œã€‚<strong>shuffle write</strong>æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸ºå¯¹pairs RDDä¸­çš„æ•°æ®è¿›è¡Œåˆ†åŒºæ“ä½œï¼Œæ¯ä¸ªtaskå¤„ç†çš„æ•°æ®ä¸­ï¼Œç›¸åŒçš„keyä¼šå†™å…¥åŒä¸€ä¸ªç£ç›˜æ–‡ä»¶å†…ã€‚</li><li><strong>stage1</strong>ï¼Œä¸»è¦æ˜¯æ‰§è¡Œä»reduceByKeyåˆ°collectæ“ä½œï¼Œstage1çš„å„ä¸ªtaskä¸€å¼€å§‹è¿è¡Œï¼Œå°±ä¼šé¦–å…ˆæ‰§è¡Œ<strong>shuffle read</strong>æ“ä½œã€‚æ‰§è¡Œshuffle readæ“ä½œçš„taskï¼Œä¼šä»stage0çš„å„ä¸ªtaskæ‰€åœ¨èŠ‚ç‚¹æ‹‰å–å±äºè‡ªå·±å¤„ç†çš„é‚£äº›keyï¼Œç„¶åå¯¹åŒä¸€ä¸ªkeyè¿›è¡Œå…¨å±€æ€§çš„èšåˆæˆ–joinç­‰æ“ä½œï¼Œåœ¨è¿™é‡Œå°±æ˜¯å¯¹keyçš„valueå€¼è¿›è¡Œç´¯åŠ ã€‚stage1åœ¨æ‰§è¡Œå®ŒreduceByKeyç®—å­ä¹‹åï¼Œå°±è®¡ç®—å‡ºäº†æœ€ç»ˆçš„wordCounts RDDï¼Œç„¶åä¼šæ‰§è¡Œcollectç®—å­ï¼Œå°†æ‰€æœ‰æ•°æ®æ‹‰å–åˆ°Driverä¸Šï¼Œä¾›æˆ‘ä»¬éå†å’Œæ‰“å°è¾“å‡ºã€‚</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> lines = sc.textFile(<span class="string">"hdfs://..."</span>)</span><br><span class="line"><span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</span><br><span class="line"><span class="keyword">val</span> pairs = words.map((_, <span class="number">1</span>))</span><br><span class="line"><span class="keyword">val</span> wordCounts = pairs.reduceByKey(_ + _)</span><br><span class="line"></span><br><span class="line">wordCounts.collect().foreach(println(_))</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¯¹å•è¯è®¡æ•°ç¨‹åºçš„åˆ†æï¼Œå¸Œæœ›èƒ½å¤Ÿè®©å¤§å®¶äº†è§£æœ€åŸºæœ¬çš„stageåˆ’åˆ†çš„åŸç†ï¼Œä»¥åŠstageåˆ’åˆ†åshuffleæ“ä½œæ˜¯å¦‚ä½•åœ¨ä¸¤ä¸ªstageçš„è¾¹ç•Œå¤„æ‰§è¡Œçš„ã€‚ç„¶åæˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•å¿«é€Ÿå®šä½å‡ºå‘ç”Ÿæ•°æ®å€¾æ–œçš„stageå¯¹åº”ä»£ç çš„å“ªä¸€ä¸ªéƒ¨åˆ†äº†ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨Spark Web UIæˆ–è€…æœ¬åœ°logä¸­å‘ç°ï¼Œstage1çš„æŸå‡ ä¸ªtaskæ‰§è¡Œå¾—ç‰¹åˆ«æ…¢ï¼Œåˆ¤å®šstage1å‡ºç°äº†æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆå°±å¯ä»¥å›åˆ°ä»£ç ä¸­å®šä½å‡ºstage1ä¸»è¦åŒ…æ‹¬äº†reduceByKeyè¿™ä¸ªshuffleç±»ç®—å­ï¼Œæ­¤æ—¶åŸºæœ¬å°±å¯ä»¥ç¡®å®šæ˜¯ç”±reduceByKeyç®—å­å¯¼è‡´çš„æ•°æ®å€¾æ–œé—®é¢˜ã€‚æ¯”å¦‚æŸä¸ªå•è¯å‡ºç°äº†100ä¸‡æ¬¡ï¼Œå…¶ä»–å•è¯æ‰å‡ºç°10æ¬¡ï¼Œé‚£ä¹ˆstage1çš„æŸä¸ªtaskå°±è¦å¤„ç†100ä¸‡æ•°æ®ï¼Œæ•´ä¸ªstageçš„é€Ÿåº¦å°±ä¼šè¢«è¿™ä¸ªtaskæ‹–æ…¢ã€‚</p><h3 id="æŸä¸ªtaskè«åå…¶å¦™å†…å­˜æº¢å‡ºçš„æƒ…å†µ"><a href="#æŸä¸ªtaskè«åå…¶å¦™å†…å­˜æº¢å‡ºçš„æƒ…å†µ" class="headerlink" title="æŸä¸ªtaskè«åå…¶å¦™å†…å­˜æº¢å‡ºçš„æƒ…å†µ"></a>æŸä¸ªtaskè«åå…¶å¦™å†…å­˜æº¢å‡ºçš„æƒ…å†µ</h3><p>è¿™ç§æƒ…å†µä¸‹å»å®šä½å‡ºé—®é¢˜çš„ä»£ç å°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚æˆ‘ä»¬å»ºè®®ç›´æ¥çœ‹yarn-clientæ¨¡å¼ä¸‹æœ¬åœ°logçš„å¼‚å¸¸æ ˆï¼Œæˆ–è€…æ˜¯é€šè¿‡YARNæŸ¥çœ‹yarn-clusteræ¨¡å¼ä¸‹çš„logä¸­çš„å¼‚å¸¸æ ˆã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé€šè¿‡å¼‚å¸¸æ ˆä¿¡æ¯å°±å¯ä»¥å®šä½åˆ°ä½ çš„ä»£ç ä¸­å“ªä¸€è¡Œå‘ç”Ÿäº†å†…å­˜æº¢å‡ºã€‚ç„¶ååœ¨é‚£è¡Œä»£ç é™„è¿‘æ‰¾æ‰¾ï¼Œä¸€èˆ¬ä¹Ÿä¼šæœ‰shuffleç±»ç®—å­ï¼Œæ­¤æ—¶å¾ˆå¯èƒ½å°±æ˜¯è¿™ä¸ªç®—å­å¯¼è‡´äº†æ•°æ®å€¾æ–œã€‚</p><p>ä½†æ˜¯å¤§å®¶è¦æ³¨æ„çš„æ˜¯ï¼Œä¸èƒ½å•çº¯é å¶ç„¶çš„å†…å­˜æº¢å‡ºå°±åˆ¤å®šå‘ç”Ÿäº†æ•°æ®å€¾æ–œã€‚å› ä¸ºè‡ªå·±ç¼–å†™çš„ä»£ç çš„bugï¼Œä»¥åŠå¶ç„¶å‡ºç°çš„æ•°æ®å¼‚å¸¸ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚å› æ­¤è¿˜æ˜¯è¦æŒ‰ç…§ä¸Šé¢æ‰€è®²çš„æ–¹æ³•ï¼Œé€šè¿‡Spark Web UIæŸ¥çœ‹æŠ¥é”™çš„é‚£ä¸ªstageçš„å„ä¸ªtaskçš„è¿è¡Œæ—¶é—´ä»¥åŠåˆ†é…çš„æ•°æ®é‡ï¼Œæ‰èƒ½ç¡®å®šæ˜¯å¦æ˜¯ç”±äºæ•°æ®å€¾æ–œæ‰å¯¼è‡´äº†è¿™æ¬¡å†…å­˜æº¢å‡ºã€‚</p><h2 id="æŸ¥çœ‹å¯¼è‡´æ•°æ®å€¾æ–œçš„keyçš„æ•°æ®åˆ†å¸ƒæƒ…å†µ"><a href="#æŸ¥çœ‹å¯¼è‡´æ•°æ®å€¾æ–œçš„keyçš„æ•°æ®åˆ†å¸ƒæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹å¯¼è‡´æ•°æ®å€¾æ–œçš„keyçš„æ•°æ®åˆ†å¸ƒæƒ…å†µ"></a>æŸ¥çœ‹å¯¼è‡´æ•°æ®å€¾æ–œçš„keyçš„æ•°æ®åˆ†å¸ƒæƒ…å†µ</h2><p>çŸ¥é“äº†æ•°æ®å€¾æ–œå‘ç”Ÿåœ¨å“ªé‡Œä¹‹åï¼Œé€šå¸¸éœ€è¦åˆ†æä¸€ä¸‹é‚£ä¸ªæ‰§è¡Œäº†shuffleæ“ä½œå¹¶ä¸”å¯¼è‡´äº†æ•°æ®å€¾æ–œçš„RDD/Hiveè¡¨ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å…¶ä¸­keyçš„åˆ†å¸ƒæƒ…å†µã€‚è¿™ä¸»è¦æ˜¯ä¸ºä¹‹åé€‰æ‹©å“ªä¸€ç§æŠ€æœ¯æ–¹æ¡ˆæä¾›ä¾æ®ã€‚é’ˆå¯¹ä¸åŒçš„keyåˆ†å¸ƒä¸ä¸åŒçš„shuffleç®—å­ç»„åˆèµ·æ¥çš„å„ç§æƒ…å†µï¼Œå¯èƒ½éœ€è¦é€‰æ‹©ä¸åŒçš„æŠ€æœ¯æ–¹æ¡ˆæ¥è§£å†³ã€‚</p><p>æ­¤æ—¶æ ¹æ®ä½ æ‰§è¡Œæ“ä½œçš„æƒ…å†µä¸åŒï¼Œå¯ä»¥æœ‰å¾ˆå¤šç§<strong>æŸ¥çœ‹keyåˆ†å¸ƒçš„æ–¹å¼</strong>ï¼š</p><ol><li>å¦‚æœ<strong>æ˜¯Spark SQLä¸­çš„group byã€joinè¯­å¥å¯¼è‡´çš„æ•°æ®å€¾æ–œ</strong>ï¼Œé‚£ä¹ˆå°±<strong>æŸ¥è¯¢ä¸€ä¸‹SQLä¸­ä½¿ç”¨çš„è¡¨çš„keyåˆ†å¸ƒæƒ…å†µ</strong>ã€‚</li><li>å¦‚æœæ˜¯å¯¹<strong>Spark RDDæ‰§è¡Œshuffleç®—å­å¯¼è‡´çš„æ•°æ®å€¾æ–œ</strong>ï¼Œé‚£ä¹ˆ<strong>å¯ä»¥åœ¨Sparkä½œä¸šä¸­åŠ å…¥æŸ¥çœ‹keyåˆ†å¸ƒçš„ä»£ç </strong>ï¼Œæ¯”å¦‚RDD.countByKey()ã€‚ç„¶åå¯¹ç»Ÿè®¡å‡ºæ¥çš„å„ä¸ªkeyå‡ºç°çš„æ¬¡æ•°ï¼Œcollect/takeåˆ°å®¢æˆ·ç«¯æ‰“å°ä¸€ä¸‹ï¼Œå°±å¯ä»¥çœ‹åˆ°keyçš„åˆ†å¸ƒæƒ…å†µã€‚</li></ol><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äºä¸Šé¢æ‰€è¯´çš„å•è¯è®¡æ•°ç¨‹åºï¼Œå¦‚æœç¡®å®šäº†æ˜¯stage1çš„reduceByKeyç®—å­å¯¼è‡´äº†æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆå°±åº”è¯¥çœ‹çœ‹è¿›è¡ŒreduceByKeyæ“ä½œçš„RDDä¸­çš„keyåˆ†å¸ƒæƒ…å†µï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æŒ‡çš„å°±æ˜¯pairs RDDã€‚å¦‚ä¸‹ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆ<strong>å¯¹pairsé‡‡æ ·10%çš„æ ·æœ¬æ•°æ®ï¼Œç„¶åä½¿ç”¨countByKeyç®—å­ç»Ÿè®¡å‡ºæ¯ä¸ªkeyå‡ºç°çš„æ¬¡æ•°ï¼Œæœ€ååœ¨å®¢æˆ·ç«¯éå†å’Œæ‰“å°æ ·æœ¬æ•°æ®ä¸­å„ä¸ªkeyçš„å‡ºç°æ¬¡æ•°ã€‚</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sampledPairs = pairs.sample(<span class="literal">false</span>, <span class="number">0.1</span>)</span><br><span class="line"><span class="keyword">val</span> sampledWordCounts = sampledPairs.countByKey()</span><br><span class="line">sampledWordCounts.foreach(println(_))</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ"><a href="#æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ"></a>æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ</h2><h3 id="è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Hive-ETLé¢„å¤„ç†æ•°æ®"><a href="#è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Hive-ETLé¢„å¤„ç†æ•°æ®" class="headerlink" title="è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Hive ETLé¢„å¤„ç†æ•°æ®"></a>è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Hive ETLé¢„å¤„ç†æ•°æ®</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>å¯¼è‡´æ•°æ®å€¾æ–œçš„æ˜¯Hiveè¡¨ã€‚å¦‚æœè¯¥Hiveè¡¨ä¸­çš„æ•°æ®æœ¬èº«å¾ˆä¸å‡åŒ€ï¼ˆæ¯”å¦‚æŸä¸ªkeyå¯¹åº”äº†100ä¸‡æ•°æ®ï¼Œå…¶ä»–keyæ‰å¯¹åº”äº†10æ¡æ•°æ®ï¼‰ï¼Œè€Œä¸”ä¸šåŠ¡åœºæ™¯éœ€è¦é¢‘ç¹ä½¿ç”¨Sparkå¯¹Hiveè¡¨æ‰§è¡ŒæŸä¸ªåˆ†ææ“ä½œï¼Œé‚£ä¹ˆæ¯”è¾ƒé€‚åˆä½¿ç”¨è¿™ç§æŠ€æœ¯æ–¹æ¡ˆã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>æ­¤æ—¶å¯ä»¥è¯„ä¼°ä¸€ä¸‹ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡Hiveæ¥è¿›è¡Œæ•°æ®é¢„å¤„ç†ï¼ˆå³é€šè¿‡Hive ETLé¢„å…ˆå¯¹æ•°æ®æŒ‰ç…§keyè¿›è¡Œèšåˆï¼Œæˆ–è€…æ˜¯é¢„å…ˆå’Œå…¶ä»–è¡¨è¿›è¡Œjoinï¼‰ï¼Œç„¶ååœ¨Sparkä½œä¸šä¸­é’ˆå¯¹çš„æ•°æ®æºå°±ä¸æ˜¯åŸæ¥çš„Hiveè¡¨äº†ï¼Œè€Œæ˜¯é¢„å¤„ç†åçš„Hiveè¡¨ã€‚æ­¤æ—¶ç”±äºæ•°æ®å·²ç»é¢„å…ˆè¿›è¡Œè¿‡èšåˆæˆ–joinæ“ä½œäº†ï¼Œé‚£ä¹ˆåœ¨Sparkä½œä¸šä¸­ä¹Ÿå°±ä¸éœ€è¦ä½¿ç”¨åŸå…ˆçš„shuffleç±»ç®—å­æ‰§è¡Œè¿™ç±»æ“ä½œäº†ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>è¿™ç§æ–¹æ¡ˆä»æ ¹æºä¸Šè§£å†³äº†æ•°æ®å€¾æ–œï¼Œå› ä¸ºå½»åº•é¿å…äº†åœ¨Sparkä¸­æ‰§è¡Œshuffleç±»ç®—å­ï¼Œé‚£ä¹ˆè‚¯å®šå°±ä¸ä¼šæœ‰æ•°æ®å€¾æ–œçš„é—®é¢˜äº†ã€‚ä½†æ˜¯è¿™é‡Œä¹Ÿè¦æé†’ä¸€ä¸‹å¤§å®¶ï¼Œè¿™ç§æ–¹å¼å±äºæ²»æ ‡ä¸æ²»æœ¬ã€‚å› ä¸ºæ¯•ç«Ÿæ•°æ®æœ¬èº«å°±å­˜åœ¨åˆ†å¸ƒä¸å‡åŒ€çš„é—®é¢˜ï¼Œæ‰€ä»¥Hive ETLä¸­è¿›è¡Œgroup byæˆ–è€…joinç­‰shuffleæ“ä½œæ—¶ï¼Œè¿˜æ˜¯ä¼šå‡ºç°æ•°æ®å€¾æ–œï¼Œå¯¼è‡´Hive ETLçš„é€Ÿåº¦å¾ˆæ…¢ã€‚æˆ‘ä»¬åªæ˜¯æŠŠæ•°æ®å€¾æ–œçš„å‘ç”Ÿæå‰åˆ°äº†Hive ETLä¸­ï¼Œé¿å…Sparkç¨‹åºå‘ç”Ÿæ•°æ®å€¾æ–œè€Œå·²ã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å®ç°èµ·æ¥ç®€å•ä¾¿æ·ï¼Œæ•ˆæœè¿˜éå¸¸å¥½ï¼Œå®Œå…¨è§„é¿æ‰äº†æ•°æ®å€¾æ–œï¼ŒSparkä½œä¸šçš„æ€§èƒ½ä¼šå¤§å¹…åº¦æå‡ã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>æ²»æ ‡ä¸æ²»æœ¬ï¼ŒHive ETLä¸­è¿˜æ˜¯ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆå®è·µç»éªŒï¼š</strong>åœ¨ä¸€äº›Javaç³»ç»Ÿä¸Sparkç»“åˆä½¿ç”¨çš„é¡¹ç›®ä¸­ï¼Œä¼šå‡ºç°Javaä»£ç é¢‘ç¹è°ƒç”¨Sparkä½œä¸šçš„åœºæ™¯ï¼Œè€Œä¸”å¯¹Sparkä½œä¸šçš„æ‰§è¡Œæ€§èƒ½è¦æ±‚å¾ˆé«˜ï¼Œå°±æ¯”è¾ƒé€‚åˆä½¿ç”¨è¿™ç§æ–¹æ¡ˆã€‚å°†æ•°æ®å€¾æ–œæå‰åˆ°ä¸Šæ¸¸çš„Hive ETLï¼Œæ¯å¤©ä»…æ‰§è¡Œä¸€æ¬¡ï¼Œåªæœ‰é‚£ä¸€æ¬¡æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œè€Œä¹‹åæ¯æ¬¡Javaè°ƒç”¨Sparkä½œä¸šæ—¶ï¼Œæ‰§è¡Œé€Ÿåº¦éƒ½ä¼šå¾ˆå¿«ï¼Œèƒ½å¤Ÿæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚</p><p><strong>é¡¹ç›®å®è·µç»éªŒï¼š</strong>åœ¨ç¾å›¢Â·ç‚¹è¯„çš„äº¤äº’å¼ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿä¸­ä½¿ç”¨äº†è¿™ç§æ–¹æ¡ˆï¼Œè¯¥ç³»ç»Ÿä¸»è¦æ˜¯å…è®¸ç”¨æˆ·é€šè¿‡Java Webç³»ç»Ÿæäº¤æ•°æ®åˆ†æç»Ÿè®¡ä»»åŠ¡ï¼Œåç«¯é€šè¿‡Javaæäº¤Sparkä½œä¸šè¿›è¡Œæ•°æ®åˆ†æç»Ÿè®¡ã€‚è¦æ±‚Sparkä½œä¸šé€Ÿåº¦å¿…é¡»è¦å¿«ï¼Œå°½é‡åœ¨10åˆ†é’Ÿä»¥å†…ï¼Œå¦åˆ™é€Ÿåº¦å¤ªæ…¢ï¼Œç”¨æˆ·ä½“éªŒä¼šå¾ˆå·®ã€‚æ‰€ä»¥æˆ‘ä»¬å°†æœ‰äº›Sparkä½œä¸šçš„shuffleæ“ä½œæå‰åˆ°äº†Hive ETLä¸­ï¼Œä»è€Œè®©Sparkç›´æ¥ä½¿ç”¨é¢„å¤„ç†çš„Hiveä¸­é—´è¡¨ï¼Œå°½å¯èƒ½åœ°å‡å°‘Sparkçš„shuffleæ“ä½œï¼Œå¤§å¹…åº¦æå‡äº†æ€§èƒ½ï¼Œå°†éƒ¨åˆ†ä½œä¸šçš„æ€§èƒ½æå‡äº†6å€ä»¥ä¸Šã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆäºŒï¼šè¿‡æ»¤å°‘æ•°å¯¼è‡´å€¾æ–œçš„key"><a href="#è§£å†³æ–¹æ¡ˆäºŒï¼šè¿‡æ»¤å°‘æ•°å¯¼è‡´å€¾æ–œçš„key" class="headerlink" title="è§£å†³æ–¹æ¡ˆäºŒï¼šè¿‡æ»¤å°‘æ•°å¯¼è‡´å€¾æ–œçš„key"></a>è§£å†³æ–¹æ¡ˆäºŒï¼šè¿‡æ»¤å°‘æ•°å¯¼è‡´å€¾æ–œçš„key</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>å¦‚æœå‘ç°å¯¼è‡´å€¾æ–œçš„keyå°±å°‘æ•°å‡ ä¸ªï¼Œè€Œä¸”å¯¹è®¡ç®—æœ¬èº«çš„å½±å“å¹¶ä¸å¤§çš„è¯ï¼Œé‚£ä¹ˆå¾ˆé€‚åˆä½¿ç”¨è¿™ç§æ–¹æ¡ˆã€‚æ¯”å¦‚99%çš„keyå°±å¯¹åº”10æ¡æ•°æ®ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªkeyå¯¹åº”äº†100ä¸‡æ•°æ®ï¼Œä»è€Œå¯¼è‡´äº†æ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>å¦‚æœæˆ‘ä»¬åˆ¤æ–­é‚£å°‘æ•°å‡ ä¸ªæ•°æ®é‡ç‰¹åˆ«å¤šçš„keyï¼Œå¯¹ä½œä¸šçš„æ‰§è¡Œå’Œè®¡ç®—ç»“æœä¸æ˜¯ç‰¹åˆ«é‡è¦çš„è¯ï¼Œé‚£ä¹ˆå¹²è„†å°±ç›´æ¥è¿‡æ»¤æ‰é‚£å°‘æ•°å‡ ä¸ªkeyã€‚æ¯”å¦‚ï¼Œåœ¨Spark SQLä¸­å¯ä»¥ä½¿ç”¨whereå­å¥è¿‡æ»¤æ‰è¿™äº›keyæˆ–è€…åœ¨Spark Coreä¸­å¯¹RDDæ‰§è¡Œfilterç®—å­è¿‡æ»¤æ‰è¿™äº›keyã€‚å¦‚æœéœ€è¦æ¯æ¬¡ä½œä¸šæ‰§è¡Œæ—¶ï¼ŒåŠ¨æ€åˆ¤å®šå“ªäº›keyçš„æ•°æ®é‡æœ€å¤šç„¶åå†è¿›è¡Œè¿‡æ»¤ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨sampleç®—å­å¯¹RDDè¿›è¡Œé‡‡æ ·ï¼Œç„¶åè®¡ç®—å‡ºæ¯ä¸ªkeyçš„æ•°é‡ï¼Œå–æ•°æ®é‡æœ€å¤šçš„keyè¿‡æ»¤æ‰å³å¯ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>å°†å¯¼è‡´æ•°æ®å€¾æ–œçš„keyç»™è¿‡æ»¤æ‰ä¹‹åï¼Œè¿™äº›keyå°±ä¸ä¼šå‚ä¸è®¡ç®—äº†ï¼Œè‡ªç„¶ä¸å¯èƒ½äº§ç”Ÿæ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å®ç°ç®€å•ï¼Œè€Œä¸”æ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œå¯ä»¥å®Œå…¨è§„é¿æ‰æ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>é€‚ç”¨åœºæ™¯ä¸å¤šï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¼è‡´å€¾æ–œçš„keyè¿˜æ˜¯å¾ˆå¤šçš„ï¼Œå¹¶ä¸æ˜¯åªæœ‰å°‘æ•°å‡ ä¸ªã€‚</p><p><strong>æ–¹æ¡ˆå®è·µç»éªŒï¼š</strong>åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬ä¹Ÿé‡‡ç”¨è¿‡è¿™ç§æ–¹æ¡ˆè§£å†³æ•°æ®å€¾æ–œã€‚æœ‰ä¸€æ¬¡å‘ç°æŸä¸€å¤©Sparkä½œä¸šåœ¨è¿è¡Œçš„æ—¶å€™çªç„¶OOMäº†ï¼Œè¿½æŸ¥ä¹‹åå‘ç°ï¼Œæ˜¯Hiveè¡¨ä¸­çš„æŸä¸€ä¸ªkeyåœ¨é‚£å¤©æ•°æ®å¼‚å¸¸ï¼Œå¯¼è‡´æ•°æ®é‡æš´å¢ã€‚å› æ­¤å°±é‡‡å–æ¯æ¬¡æ‰§è¡Œå‰å…ˆè¿›è¡Œé‡‡æ ·ï¼Œè®¡ç®—å‡ºæ ·æœ¬ä¸­æ•°æ®é‡æœ€å¤§çš„å‡ ä¸ªkeyä¹‹åï¼Œç›´æ¥åœ¨ç¨‹åºä¸­å°†é‚£äº›keyç»™è¿‡æ»¤æ‰ã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆä¸‰ï¼šæé«˜shuffleæ“ä½œçš„å¹¶è¡Œåº¦"><a href="#è§£å†³æ–¹æ¡ˆä¸‰ï¼šæé«˜shuffleæ“ä½œçš„å¹¶è¡Œåº¦" class="headerlink" title="è§£å†³æ–¹æ¡ˆä¸‰ï¼šæé«˜shuffleæ“ä½œçš„å¹¶è¡Œåº¦"></a>è§£å†³æ–¹æ¡ˆä¸‰ï¼šæé«˜shuffleæ“ä½œçš„å¹¶è¡Œåº¦</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>å¦‚æœæˆ‘ä»¬å¿…é¡»è¦å¯¹æ•°æ®å€¾æ–œè¿éš¾è€Œä¸Šï¼Œé‚£ä¹ˆå»ºè®®ä¼˜å…ˆä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå› ä¸ºè¿™æ˜¯å¤„ç†æ•°æ®å€¾æ–œæœ€ç®€å•çš„ä¸€ç§æ–¹æ¡ˆã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>åœ¨å¯¹RDDæ‰§è¡Œshuffleç®—å­æ—¶ï¼Œç»™shuffleç®—å­ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œæ¯”å¦‚reduceByKey(1000)ï¼Œè¯¥å‚æ•°å°±è®¾ç½®äº†è¿™ä¸ªshuffleç®—å­æ‰§è¡Œæ—¶shuffle read taskçš„æ•°é‡ã€‚å¯¹äºSpark SQLä¸­çš„shuffleç±»è¯­å¥ï¼Œæ¯”å¦‚group byã€joinç­‰ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªå‚æ•°ï¼Œå³spark.sql.shuffle.partitionsï¼Œè¯¥å‚æ•°ä»£è¡¨äº†shuffle read taskçš„å¹¶è¡Œåº¦ï¼Œè¯¥å€¼é»˜è®¤æ˜¯200ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´éƒ½æœ‰ç‚¹è¿‡å°ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>å¢åŠ shuffle read taskçš„æ•°é‡ï¼Œå¯ä»¥è®©åŸæœ¬åˆ†é…ç»™ä¸€ä¸ªtaskçš„å¤šä¸ªkeyåˆ†é…ç»™å¤šä¸ªtaskï¼Œä»è€Œè®©æ¯ä¸ªtaskå¤„ç†æ¯”åŸæ¥æ›´å°‘çš„æ•°æ®ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœåŸæœ¬æœ‰5ä¸ªkeyï¼Œæ¯ä¸ªkeyå¯¹åº”10æ¡æ•°æ®ï¼Œè¿™5ä¸ªkeyéƒ½æ˜¯åˆ†é…ç»™ä¸€ä¸ªtaskçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªtaskå°±è¦å¤„ç†50æ¡æ•°æ®ã€‚è€Œå¢åŠ äº†shuffle read taskä»¥åï¼Œæ¯ä¸ªtaskå°±åˆ†é…åˆ°ä¸€ä¸ªkeyï¼Œå³æ¯ä¸ªtaskå°±å¤„ç†10æ¡æ•°æ®ï¼Œé‚£ä¹ˆè‡ªç„¶æ¯ä¸ªtaskçš„æ‰§è¡Œæ—¶é—´éƒ½ä¼šå˜çŸ­äº†ã€‚å…·ä½“åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥æœ‰æ•ˆç¼“è§£å’Œå‡è½»æ•°æ®å€¾æ–œçš„å½±å“ã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>åªæ˜¯ç¼“è§£äº†æ•°æ®å€¾æ–œè€Œå·²ï¼Œæ²¡æœ‰å½»åº•æ ¹é™¤é—®é¢˜ï¼Œæ ¹æ®å®è·µç»éªŒæ¥çœ‹ï¼Œå…¶æ•ˆæœæœ‰é™ã€‚</p><p><strong>æ–¹æ¡ˆå®è·µç»éªŒï¼š</strong>è¯¥æ–¹æ¡ˆé€šå¸¸æ— æ³•å½»åº•è§£å†³æ•°æ®å€¾æ–œï¼Œå› ä¸ºå¦‚æœå‡ºç°ä¸€äº›æç«¯æƒ…å†µï¼Œæ¯”å¦‚æŸä¸ªkeyå¯¹åº”çš„æ•°æ®é‡æœ‰100ä¸‡ï¼Œé‚£ä¹ˆæ— è®ºä½ çš„taskæ•°é‡å¢åŠ åˆ°å¤šå°‘ï¼Œè¿™ä¸ªå¯¹åº”ç€100ä¸‡æ•°æ®çš„keyè‚¯å®šè¿˜æ˜¯ä¼šåˆ†é…åˆ°ä¸€ä¸ªtaskä¸­å»å¤„ç†ï¼Œå› æ­¤æ³¨å®šè¿˜æ˜¯ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œçš„ã€‚æ‰€ä»¥è¿™ç§æ–¹æ¡ˆåªèƒ½è¯´æ˜¯åœ¨å‘ç°æ•°æ®å€¾æ–œæ—¶å°è¯•ä½¿ç”¨çš„ç¬¬ä¸€ç§æ‰‹æ®µï¼Œå°è¯•å»ç”¨å˜´ç®€å•çš„æ–¹æ³•ç¼“è§£æ•°æ®å€¾æ–œè€Œå·²ï¼Œæˆ–è€…æ˜¯å’Œå…¶ä»–æ–¹æ¡ˆç»“åˆèµ·æ¥ä½¿ç”¨ã€‚</p><p> <img src="https://tech.meituan.com/img/spark-tuning/shuffle-skwed-add-partition.png" alt="img"></p><h3 id="è§£å†³æ–¹æ¡ˆå››ï¼šä¸¤é˜¶æ®µèšåˆï¼ˆå±€éƒ¨èšåˆ-å…¨å±€èšåˆï¼‰"><a href="#è§£å†³æ–¹æ¡ˆå››ï¼šä¸¤é˜¶æ®µèšåˆï¼ˆå±€éƒ¨èšåˆ-å…¨å±€èšåˆï¼‰" class="headerlink" title="è§£å†³æ–¹æ¡ˆå››ï¼šä¸¤é˜¶æ®µèšåˆï¼ˆå±€éƒ¨èšåˆ+å…¨å±€èšåˆï¼‰"></a>è§£å†³æ–¹æ¡ˆå››ï¼šä¸¤é˜¶æ®µèšåˆï¼ˆå±€éƒ¨èšåˆ+å…¨å±€èšåˆï¼‰</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>å¯¹RDDæ‰§è¡ŒreduceByKeyç­‰èšåˆç±»shuffleç®—å­æˆ–è€…åœ¨Spark SQLä¸­ä½¿ç”¨group byè¯­å¥è¿›è¡Œåˆ†ç»„èšåˆæ—¶ï¼Œæ¯”è¾ƒé€‚ç”¨è¿™ç§æ–¹æ¡ˆã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>è¿™ä¸ªæ–¹æ¡ˆçš„æ ¸å¿ƒå®ç°æ€è·¯å°±æ˜¯è¿›è¡Œä¸¤é˜¶æ®µèšåˆã€‚ç¬¬ä¸€æ¬¡æ˜¯å±€éƒ¨èšåˆï¼Œå…ˆç»™æ¯ä¸ªkeyéƒ½æ‰“ä¸Šä¸€ä¸ªéšæœºæ•°ï¼Œæ¯”å¦‚10ä»¥å†…çš„éšæœºæ•°ï¼Œæ­¤æ—¶åŸå…ˆä¸€æ ·çš„keyå°±å˜æˆä¸ä¸€æ ·çš„äº†ï¼Œæ¯”å¦‚(hello, 1) (hello, 1) (hello, 1) (hello, 1)ï¼Œå°±ä¼šå˜æˆ(1_hello, 1) (1_hello, 1) (2_hello, 1) (2_hello, 1)ã€‚æ¥ç€å¯¹æ‰“ä¸Šéšæœºæ•°åçš„æ•°æ®ï¼Œæ‰§è¡ŒreduceByKeyç­‰èšåˆæ“ä½œï¼Œè¿›è¡Œå±€éƒ¨èšåˆï¼Œé‚£ä¹ˆå±€éƒ¨èšåˆç»“æœï¼Œå°±ä¼šå˜æˆäº†(1_hello, 2) (2_hello, 2)ã€‚ç„¶åå°†å„ä¸ªkeyçš„å‰ç¼€ç»™å»æ‰ï¼Œå°±ä¼šå˜æˆ(hello,2)(hello,2)ï¼Œå†æ¬¡è¿›è¡Œå…¨å±€èšåˆæ“ä½œï¼Œå°±å¯ä»¥å¾—åˆ°æœ€ç»ˆç»“æœäº†ï¼Œæ¯”å¦‚(hello, 4)ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>å°†åŸæœ¬ç›¸åŒçš„keyé€šè¿‡é™„åŠ éšæœºå‰ç¼€çš„æ–¹å¼ï¼Œå˜æˆå¤šä¸ªä¸åŒçš„keyï¼Œå°±å¯ä»¥è®©åŸæœ¬è¢«ä¸€ä¸ªtaskå¤„ç†çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªtaskä¸Šå»åšå±€éƒ¨èšåˆï¼Œè¿›è€Œè§£å†³å•ä¸ªtaskå¤„ç†æ•°æ®é‡è¿‡å¤šçš„é—®é¢˜ã€‚æ¥ç€å»é™¤æ‰éšæœºå‰ç¼€ï¼Œå†æ¬¡è¿›è¡Œå…¨å±€èšåˆï¼Œå°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚å…·ä½“åŸç†è§ä¸‹å›¾ã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å¯¹äºèšåˆç±»çš„shuffleæ“ä½œå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œæ•ˆæœæ˜¯éå¸¸ä¸é”™çš„ã€‚é€šå¸¸éƒ½å¯ä»¥è§£å†³æ‰æ•°æ®å€¾æ–œï¼Œæˆ–è€…è‡³å°‘æ˜¯å¤§å¹…åº¦ç¼“è§£æ•°æ®å€¾æ–œï¼Œå°†Sparkä½œä¸šçš„æ€§èƒ½æå‡æ•°å€ä»¥ä¸Šã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>ä»…ä»…é€‚ç”¨äºèšåˆç±»çš„shuffleæ“ä½œï¼Œé€‚ç”¨èŒƒå›´ç›¸å¯¹è¾ƒçª„ã€‚å¦‚æœæ˜¯joinç±»çš„shuffleæ“ä½œï¼Œè¿˜å¾—ç”¨å…¶ä»–çš„è§£å†³æ–¹æ¡ˆã€‚</p><p><img src="https://tech.meituan.com/img/spark-tuning/shuffle-skwed-two-phase-aggr.png" alt="img"></p><blockquote><p>Java ç‰ˆ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ­¥ï¼Œç»™RDDä¸­çš„æ¯ä¸ªkeyéƒ½æ‰“ä¸Šä¸€ä¸ªéšæœºå‰ç¼€ã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Long&gt; randomPrefixRdd = rdd.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,Long&gt;, String, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title">call</span><span class="params">(Tuple2&lt;Long, Long&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="keyword">int</span> prefix = random.nextInt(<span class="number">10</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, Long&gt;(prefix + <span class="string">"_"</span> + tuple._1, tuple._2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ­¥ï¼Œå¯¹æ‰“ä¸Šéšæœºå‰ç¼€çš„keyè¿›è¡Œå±€éƒ¨èšåˆã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Long&gt; localAggrRdd = randomPrefixRdd.reduceByKey(</span><br><span class="line">        <span class="keyword">new</span> Function2&lt;Long, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">(Long v1, Long v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v1 + v2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰æ­¥ï¼Œå»é™¤RDDä¸­æ¯ä¸ªkeyçš„éšæœºå‰ç¼€ã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Long&gt; removedRandomPrefixRdd = localAggrRdd.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;String,Long&gt;, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">call</span><span class="params">(Tuple2&lt;String, Long&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> originalKey = Long.valueOf(tuple._1.split(<span class="string">"_"</span>)[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Long, Long&gt;(originalKey, tuple._2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬å››æ­¥ï¼Œå¯¹å»é™¤äº†éšæœºå‰ç¼€çš„RDDè¿›è¡Œå…¨å±€èšåˆã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Long&gt; globalAggrRdd = removedRandomPrefixRdd.reduceByKey(</span><br><span class="line">        <span class="keyword">new</span> Function2&lt;Long, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">(Long v1, Long v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v1 + v2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><blockquote><p> scala ç‰ˆ</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sc.textFile(<span class="string">"hdfs://mycluster/user/ap/a.txt"</span>,<span class="number">4</span>).flatMap(_.split(<span class="string">" "</span>)).map((_,<span class="number">1</span>)).map(t =&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> w1 = t._1; </span><br><span class="line">  <span class="keyword">import</span> scala.util.<span class="type">Random</span>;</span><br><span class="line">  <span class="keyword">val</span> n = <span class="type">Random</span>.nextInt(<span class="number">100</span>); </span><br><span class="line">  (w1 + <span class="string">"_"</span> + n, t._2);</span><br><span class="line">&#125;).reduceByKey(_ + _,<span class="number">4</span>).map(t =&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> w2 = t._1; </span><br><span class="line">  <span class="keyword">val</span> count = t._2; </span><br><span class="line">  <span class="keyword">val</span> w3 = w2.split(<span class="string">"_"</span>)(<span class="number">0</span>); </span><br><span class="line">  (w3, count);</span><br><span class="line">&#125;).reduceByKey(_ + _,<span class="number">4</span>).saveAsTextFile(<span class="string">"/user/ap/scala/DataSkew"</span>)</span><br></pre></td></tr></table></figure><h3 id="è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce-joinè½¬ä¸ºmap-join"><a href="#è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce-joinè½¬ä¸ºmap-join" class="headerlink" title="è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce joinè½¬ä¸ºmap join"></a>è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce joinè½¬ä¸ºmap join</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>åœ¨å¯¹RDDä½¿ç”¨joinç±»æ“ä½œï¼Œæˆ–è€…æ˜¯åœ¨Spark SQLä¸­ä½¿ç”¨joinè¯­å¥æ—¶ï¼Œè€Œä¸”joinæ“ä½œä¸­çš„ä¸€ä¸ªRDDæˆ–è¡¨çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼ˆæ¯”å¦‚å‡ ç™¾Mæˆ–è€…ä¸€ä¸¤Gï¼‰ï¼Œæ¯”è¾ƒé€‚ç”¨æ­¤æ–¹æ¡ˆã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>ä¸ä½¿ç”¨joinç®—å­è¿›è¡Œè¿æ¥æ“ä½œï¼Œè€Œä½¿ç”¨Broadcastå˜é‡ä¸mapç±»ç®—å­å®ç°joinæ“ä½œï¼Œè¿›è€Œå®Œå…¨è§„é¿æ‰shuffleç±»çš„æ“ä½œï¼Œå½»åº•é¿å…æ•°æ®å€¾æ–œçš„å‘ç”Ÿå’Œå‡ºç°ã€‚å°†è¾ƒå°RDDä¸­çš„æ•°æ®ç›´æ¥é€šè¿‡collectç®—å­æ‹‰å–åˆ°Driverç«¯çš„å†…å­˜ä¸­æ¥ï¼Œç„¶åå¯¹å…¶åˆ›å»ºä¸€ä¸ªBroadcastå˜é‡ï¼›æ¥ç€å¯¹å¦å¤–ä¸€ä¸ªRDDæ‰§è¡Œmapç±»ç®—å­ï¼Œåœ¨ç®—å­å‡½æ•°å†…ï¼Œä»Broadcastå˜é‡ä¸­è·å–è¾ƒå°RDDçš„å…¨é‡æ•°æ®ï¼Œä¸å½“å‰RDDçš„æ¯ä¸€æ¡æ•°æ®æŒ‰ç…§è¿æ¥keyè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœè¿æ¥keyç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆå°±å°†ä¸¤ä¸ªRDDçš„æ•°æ®ç”¨ä½ éœ€è¦çš„æ–¹å¼è¿æ¥èµ·æ¥ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>æ™®é€šçš„joinæ˜¯ä¼šèµ°shuffleè¿‡ç¨‹çš„ï¼Œè€Œä¸€æ—¦shuffleï¼Œå°±ç›¸å½“äºä¼šå°†ç›¸åŒkeyçš„æ•°æ®æ‹‰å–åˆ°ä¸€ä¸ªshuffle read taskä¸­å†è¿›è¡Œjoinï¼Œæ­¤æ—¶å°±æ˜¯reduce joinã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªRDDæ˜¯æ¯”è¾ƒå°çš„ï¼Œåˆ™å¯ä»¥é‡‡ç”¨å¹¿æ’­å°RDDå…¨é‡æ•°æ®+mapç®—å­æ¥å®ç°ä¸joinåŒæ ·çš„æ•ˆæœï¼Œä¹Ÿå°±æ˜¯map joinï¼Œæ­¤æ—¶å°±ä¸ä¼šå‘ç”Ÿshuffleæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚å…·ä½“åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å¯¹joinæ“ä½œå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œæ•ˆæœéå¸¸å¥½ï¼Œå› ä¸ºæ ¹æœ¬å°±ä¸ä¼šå‘ç”Ÿshuffleï¼Œä¹Ÿå°±æ ¹æœ¬ä¸ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>é€‚ç”¨åœºæ™¯è¾ƒå°‘ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ¡ˆåªé€‚ç”¨äºä¸€ä¸ªå¤§è¡¨å’Œä¸€ä¸ªå°è¡¨çš„æƒ…å†µã€‚æ¯•ç«Ÿæˆ‘ä»¬éœ€è¦å°†å°è¡¨è¿›è¡Œå¹¿æ’­ï¼Œæ­¤æ—¶ä¼šæ¯”è¾ƒæ¶ˆè€—å†…å­˜èµ„æºï¼Œdriverå’Œæ¯ä¸ªExecutorå†…å­˜ä¸­éƒ½ä¼šé©»ç•™ä¸€ä»½å°RDDçš„å…¨é‡æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬å¹¿æ’­å‡ºå»çš„RDDæ•°æ®æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚10Gä»¥ä¸Šï¼Œé‚£ä¹ˆå°±å¯èƒ½å‘ç”Ÿå†…å­˜æº¢å‡ºäº†ã€‚å› æ­¤å¹¶ä¸é€‚åˆä¸¤ä¸ªéƒ½æ˜¯å¤§è¡¨çš„æƒ…å†µã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce-joinè½¬ä¸ºmap-join-1"><a href="#è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce-joinè½¬ä¸ºmap-join-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce joinè½¬ä¸ºmap join"></a>è§£å†³æ–¹æ¡ˆäº”ï¼šå°†reduce joinè½¬ä¸ºmap join</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>åœ¨å¯¹RDDä½¿ç”¨joinç±»æ“ä½œï¼Œæˆ–è€…æ˜¯åœ¨Spark SQLä¸­ä½¿ç”¨joinè¯­å¥æ—¶ï¼Œè€Œä¸”joinæ“ä½œä¸­çš„ä¸€ä¸ªRDDæˆ–è¡¨çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼ˆæ¯”å¦‚å‡ ç™¾Mæˆ–è€…ä¸€ä¸¤Gï¼‰ï¼Œæ¯”è¾ƒé€‚ç”¨æ­¤æ–¹æ¡ˆã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong>ä¸ä½¿ç”¨joinç®—å­è¿›è¡Œè¿æ¥æ“ä½œï¼Œè€Œä½¿ç”¨Broadcastå˜é‡ä¸mapç±»ç®—å­å®ç°joinæ“ä½œï¼Œè¿›è€Œå®Œå…¨è§„é¿æ‰shuffleç±»çš„æ“ä½œï¼Œå½»åº•é¿å…æ•°æ®å€¾æ–œçš„å‘ç”Ÿå’Œå‡ºç°ã€‚å°†è¾ƒå°RDDä¸­çš„æ•°æ®ç›´æ¥é€šè¿‡collectç®—å­æ‹‰å–åˆ°Driverç«¯çš„å†…å­˜ä¸­æ¥ï¼Œç„¶åå¯¹å…¶åˆ›å»ºä¸€ä¸ªBroadcastå˜é‡ï¼›æ¥ç€å¯¹å¦å¤–ä¸€ä¸ªRDDæ‰§è¡Œmapç±»ç®—å­ï¼Œåœ¨ç®—å­å‡½æ•°å†…ï¼Œä»Broadcastå˜é‡ä¸­è·å–è¾ƒå°RDDçš„å…¨é‡æ•°æ®ï¼Œä¸å½“å‰RDDçš„æ¯ä¸€æ¡æ•°æ®æŒ‰ç…§è¿æ¥keyè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœè¿æ¥keyç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆå°±å°†ä¸¤ä¸ªRDDçš„æ•°æ®ç”¨ä½ éœ€è¦çš„æ–¹å¼è¿æ¥èµ·æ¥ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>æ™®é€šçš„joinæ˜¯ä¼šèµ°shuffleè¿‡ç¨‹çš„ï¼Œè€Œä¸€æ—¦shuffleï¼Œå°±ç›¸å½“äºä¼šå°†ç›¸åŒkeyçš„æ•°æ®æ‹‰å–åˆ°ä¸€ä¸ªshuffle read taskä¸­å†è¿›è¡Œjoinï¼Œæ­¤æ—¶å°±æ˜¯reduce joinã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªRDDæ˜¯æ¯”è¾ƒå°çš„ï¼Œåˆ™å¯ä»¥é‡‡ç”¨å¹¿æ’­å°RDDå…¨é‡æ•°æ®+mapç®—å­æ¥å®ç°ä¸joinåŒæ ·çš„æ•ˆæœï¼Œä¹Ÿå°±æ˜¯map joinï¼Œæ­¤æ—¶å°±ä¸ä¼šå‘ç”Ÿshuffleæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚å…·ä½“åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å¯¹joinæ“ä½œå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œæ•ˆæœéå¸¸å¥½ï¼Œå› ä¸ºæ ¹æœ¬å°±ä¸ä¼šå‘ç”Ÿshuffleï¼Œä¹Ÿå°±æ ¹æœ¬ä¸ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>é€‚ç”¨åœºæ™¯è¾ƒå°‘ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ¡ˆåªé€‚ç”¨äºä¸€ä¸ªå¤§è¡¨å’Œä¸€ä¸ªå°è¡¨çš„æƒ…å†µã€‚æ¯•ç«Ÿæˆ‘ä»¬éœ€è¦å°†å°è¡¨è¿›è¡Œå¹¿æ’­ï¼Œæ­¤æ—¶ä¼šæ¯”è¾ƒæ¶ˆè€—å†…å­˜èµ„æºï¼Œdriverå’Œæ¯ä¸ªExecutorå†…å­˜ä¸­éƒ½ä¼šé©»ç•™ä¸€ä»½å°RDDçš„å…¨é‡æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬å¹¿æ’­å‡ºå»çš„RDDæ•°æ®æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚10Gä»¥ä¸Šï¼Œé‚£ä¹ˆå°±å¯èƒ½å‘ç”Ÿå†…å­˜æº¢å‡ºäº†ã€‚å› æ­¤å¹¶ä¸é€‚åˆä¸¤ä¸ªéƒ½æ˜¯å¤§è¡¨çš„æƒ…å†µã€‚</p><p> <img src="https://tech.meituan.com/img/spark-tuning/shuffle-skwed-map-join.png" alt="img"></p><blockquote><p><strong>é€šè¿‡å¹¿æ’­å˜é‡, é¿å…æ‰ shuffle</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆå°†æ•°æ®é‡æ¯”è¾ƒå°çš„RDDçš„æ•°æ®ï¼Œcollectåˆ°Driverä¸­æ¥ã€‚</span></span><br><span class="line">List&lt;Tuple2&lt;Long, Row&gt;&gt; rdd1Data = rdd1.collect()</span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨Sparkçš„å¹¿æ’­åŠŸèƒ½ï¼Œå°†å°RDDçš„æ•°æ®è½¬æ¢æˆå¹¿æ’­å˜é‡ï¼Œè¿™æ ·æ¯ä¸ªExecutorå°±åªæœ‰ä¸€ä»½RDDçš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// å¯ä»¥å°½å¯èƒ½èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”å‡å°‘ç½‘ç»œä¼ è¾“æ€§èƒ½å¼€é”€ã€‚</span></span><br><span class="line"><span class="keyword">final</span> Broadcast&lt;List&lt;Tuple2&lt;Long, Row&gt;&gt;&gt; rdd1DataBroadcast = sc.broadcast(rdd1Data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹å¦å¤–ä¸€ä¸ªRDDæ‰§è¡Œmapç±»æ“ä½œï¼Œè€Œä¸å†æ˜¯joinç±»æ“ä½œã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Tuple2&lt;String, Row&gt;&gt; joinedRdd = rdd2.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,String&gt;, String, Tuple2&lt;String, Row&gt;&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Tuple2&lt;String, Tuple2&lt;String, Row&gt;&gt; call(Tuple2&lt;Long, String&gt; tuple)</span><br><span class="line">                    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// åœ¨ç®—å­å‡½æ•°ä¸­ï¼Œé€šè¿‡å¹¿æ’­å˜é‡ï¼Œè·å–åˆ°æœ¬åœ°Executorä¸­çš„rdd1æ•°æ®ã€‚</span></span><br><span class="line">                List&lt;Tuple2&lt;Long, Row&gt;&gt; rdd1Data = rdd1DataBroadcast.value();</span><br><span class="line">                <span class="comment">// å¯ä»¥å°†rdd1çš„æ•°æ®è½¬æ¢ä¸ºä¸€ä¸ªMapï¼Œä¾¿äºåé¢è¿›è¡Œjoinæ“ä½œã€‚</span></span><br><span class="line">                Map&lt;Long, Row&gt; rdd1DataMap = <span class="keyword">new</span> HashMap&lt;Long, Row&gt;();</span><br><span class="line">                <span class="keyword">for</span>(Tuple2&lt;Long, Row&gt; data : rdd1Data) &#123;</span><br><span class="line">                    rdd1DataMap.put(data._1, data._2);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è·å–å½“å‰RDDæ•°æ®çš„keyä»¥åŠvalueã€‚</span></span><br><span class="line">                String key = tuple._1;</span><br><span class="line">                String value = tuple._2;</span><br><span class="line">                <span class="comment">// ä»rdd1æ•°æ®Mapä¸­ï¼Œæ ¹æ®keyè·å–åˆ°å¯ä»¥joinåˆ°çš„æ•°æ®ã€‚</span></span><br><span class="line">                Row rdd1Value = rdd1DataMap.get(key);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, String&gt;(key, <span class="keyword">new</span> Tuple2&lt;String, Row&gt;(value, rdd1Value));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå¾—æç¤ºä¸€ä¸‹ã€‚</span></span><br><span class="line">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line"><span class="comment">// ä¸Šé¢çš„åšæ³•ï¼Œä»…ä»…é€‚ç”¨äºrdd1ä¸­çš„keyæ²¡æœ‰é‡å¤ï¼Œå…¨éƒ¨æ˜¯å”¯ä¸€çš„åœºæ™¯ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœrdd1ä¸­æœ‰å¤šä¸ªç›¸åŒçš„keyï¼Œé‚£ä¹ˆå°±å¾—ç”¨flatMapç±»çš„æ“ä½œï¼Œåœ¨è¿›è¡Œjoinçš„æ—¶å€™ä¸èƒ½ç”¨mapï¼Œè€Œæ˜¯å¾—éå†rdd1æ‰€æœ‰æ•°æ®è¿›è¡Œjoinã€‚</span></span><br><span class="line"><span class="comment">// rdd2ä¸­æ¯æ¡æ•°æ®éƒ½å¯èƒ½ä¼šè¿”å›å¤šæ¡joinåçš„æ•°æ®ã€‚</span></span><br><span class="line">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br></pre></td></tr></table></figure><h3 id="è§£å†³æ–¹æ¡ˆå…­ï¼šé‡‡æ ·å€¾æ–œkeyå¹¶åˆ†æ‹†joinæ“ä½œ"><a href="#è§£å†³æ–¹æ¡ˆå…­ï¼šé‡‡æ ·å€¾æ–œkeyå¹¶åˆ†æ‹†joinæ“ä½œ" class="headerlink" title="è§£å†³æ–¹æ¡ˆå…­ï¼šé‡‡æ ·å€¾æ–œkeyå¹¶åˆ†æ‹†joinæ“ä½œ"></a>è§£å†³æ–¹æ¡ˆå…­ï¼šé‡‡æ ·å€¾æ–œkeyå¹¶åˆ†æ‹†joinæ“ä½œ</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>ä¸¤ä¸ªRDD/Hiveè¡¨è¿›è¡Œjoinçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®é‡éƒ½æ¯”è¾ƒå¤§ï¼Œæ— æ³•é‡‡ç”¨â€œè§£å†³æ–¹æ¡ˆäº”â€ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥çœ‹ä¸€ä¸‹ä¸¤ä¸ªRDD/Hiveè¡¨ä¸­çš„keyåˆ†å¸ƒæƒ…å†µã€‚å¦‚æœå‡ºç°æ•°æ®å€¾æ–œï¼Œæ˜¯å› ä¸ºå…¶ä¸­æŸä¸€ä¸ªRDD/Hiveè¡¨ä¸­çš„å°‘æ•°å‡ ä¸ªkeyçš„æ•°æ®é‡è¿‡å¤§ï¼Œè€Œå¦ä¸€ä¸ªRDD/Hiveè¡¨ä¸­çš„æ‰€æœ‰keyéƒ½åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€ï¼Œé‚£ä¹ˆé‡‡ç”¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong></p><ul><li>å¯¹åŒ…å«å°‘æ•°å‡ ä¸ªæ•°æ®é‡è¿‡å¤§çš„keyçš„é‚£ä¸ªRDDï¼Œé€šè¿‡sampleç®—å­é‡‡æ ·å‡ºä¸€ä»½æ ·æœ¬æ¥ï¼Œç„¶åç»Ÿè®¡ä¸€ä¸‹æ¯ä¸ªkeyçš„æ•°é‡ï¼Œè®¡ç®—å‡ºæ¥æ•°æ®é‡æœ€å¤§çš„æ˜¯å“ªå‡ ä¸ªkeyã€‚</li><li>ç„¶åå°†è¿™å‡ ä¸ªkeyå¯¹åº”çš„æ•°æ®ä»åŸæ¥çš„RDDä¸­æ‹†åˆ†å‡ºæ¥ï¼Œå½¢æˆä¸€ä¸ªå•ç‹¬çš„RDDï¼Œå¹¶ç»™æ¯ä¸ªkeyéƒ½æ‰“ä¸Šnä»¥å†…çš„éšæœºæ•°ä½œä¸ºå‰ç¼€ï¼Œè€Œä¸ä¼šå¯¼è‡´å€¾æ–œçš„å¤§éƒ¨åˆ†keyå½¢æˆå¦å¤–ä¸€ä¸ªRDDã€‚</li><li>æ¥ç€å°†éœ€è¦joinçš„å¦ä¸€ä¸ªRDDï¼Œä¹Ÿè¿‡æ»¤å‡ºæ¥é‚£å‡ ä¸ªå€¾æ–œkeyå¯¹åº”çš„æ•°æ®å¹¶å½¢æˆä¸€ä¸ªå•ç‹¬çš„RDDï¼Œå°†æ¯æ¡æ•°æ®è†¨èƒ€æˆnæ¡æ•°æ®ï¼Œè¿™næ¡æ•°æ®éƒ½æŒ‰é¡ºåºé™„åŠ ä¸€ä¸ª0~nçš„å‰ç¼€ï¼Œä¸ä¼šå¯¼è‡´å€¾æ–œçš„å¤§éƒ¨åˆ†keyä¹Ÿå½¢æˆå¦å¤–ä¸€ä¸ªRDDã€‚</li><li>å†å°†é™„åŠ äº†éšæœºå‰ç¼€çš„ç‹¬ç«‹RDDä¸å¦ä¸€ä¸ªè†¨èƒ€nå€çš„ç‹¬ç«‹RDDè¿›è¡Œjoinï¼Œæ­¤æ—¶å°±å¯ä»¥å°†åŸå…ˆç›¸åŒçš„keyæ‰“æ•£æˆnä»½ï¼Œåˆ†æ•£åˆ°å¤šä¸ªtaskä¸­å»è¿›è¡Œjoinäº†ã€‚</li><li>è€Œå¦å¤–ä¸¤ä¸ªæ™®é€šçš„RDDå°±ç…§å¸¸joinå³å¯ã€‚</li><li>æœ€åå°†ä¸¤æ¬¡joinçš„ç»“æœä½¿ç”¨unionç®—å­åˆå¹¶èµ·æ¥å³å¯ï¼Œå°±æ˜¯æœ€ç»ˆçš„joinç»“æœã€‚</li></ul><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>å¯¹äºjoinå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œå¦‚æœåªæ˜¯æŸå‡ ä¸ªkeyå¯¼è‡´äº†å€¾æ–œï¼Œå¯ä»¥å°†å°‘æ•°å‡ ä¸ªkeyåˆ†æ‹†æˆç‹¬ç«‹RDDï¼Œå¹¶é™„åŠ éšæœºå‰ç¼€æ‰“æ•£æˆnä»½å»è¿›è¡Œjoinï¼Œæ­¤æ—¶è¿™å‡ ä¸ªkeyå¯¹åº”çš„æ•°æ®å°±ä¸ä¼šé›†ä¸­åœ¨å°‘æ•°å‡ ä¸ªtaskä¸Šï¼Œè€Œæ˜¯åˆ†æ•£åˆ°å¤šä¸ªtaskè¿›è¡Œjoinäº†ã€‚å…·ä½“åŸç†è§ä¸‹å›¾ã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å¯¹äºjoinå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œå¦‚æœåªæ˜¯æŸå‡ ä¸ªkeyå¯¼è‡´äº†å€¾æ–œï¼Œé‡‡ç”¨è¯¥æ–¹å¼å¯ä»¥ç”¨æœ€æœ‰æ•ˆçš„æ–¹å¼æ‰“æ•£keyè¿›è¡Œjoinã€‚è€Œä¸”åªéœ€è¦é’ˆå¯¹å°‘æ•°å€¾æ–œkeyå¯¹åº”çš„æ•°æ®è¿›è¡Œæ‰©å®¹nå€ï¼Œä¸éœ€è¦å¯¹å…¨é‡æ•°æ®è¿›è¡Œæ‰©å®¹ã€‚é¿å…äº†å ç”¨è¿‡å¤šå†…å­˜ã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>å¦‚æœå¯¼è‡´å€¾æ–œçš„keyç‰¹åˆ«å¤šçš„è¯ï¼Œæ¯”å¦‚æˆåƒä¸Šä¸‡ä¸ªkeyéƒ½å¯¼è‡´æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼ä¹Ÿä¸é€‚åˆã€‚</p><p> <img src="https://tech.meituan.com/img/spark-tuning/shuffle-skwed-sample-expand.png" alt="img"></p><blockquote><p><strong>è¿™Java ä»£ç å¯çœŸæ¶å¿ƒ, æœ‰ç©ºæ”¹æˆ scala</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆä»åŒ…å«äº†å°‘æ•°å‡ ä¸ªå¯¼è‡´æ•°æ®å€¾æ–œkeyçš„rdd1ä¸­ï¼Œé‡‡æ ·10%çš„æ ·æœ¬æ•°æ®ã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, String&gt; sampledRDD = rdd1.sample(<span class="keyword">false</span>, <span class="number">0.1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æ ·æœ¬æ•°æ®RDDç»Ÿè®¡å‡ºæ¯ä¸ªkeyçš„å‡ºç°æ¬¡æ•°ï¼Œå¹¶æŒ‰å‡ºç°æ¬¡æ•°é™åºæ’åºã€‚</span></span><br><span class="line"><span class="comment">// å¯¹é™åºæ’åºåçš„æ•°æ®ï¼Œå–å‡ºtop 1æˆ–è€…top 100çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯keyæœ€å¤šçš„å‰nä¸ªæ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// å…·ä½“å–å‡ºå¤šå°‘ä¸ªæ•°æ®é‡æœ€å¤šçš„keyï¼Œç”±å¤§å®¶è‡ªå·±å†³å®šï¼Œæˆ‘ä»¬è¿™é‡Œå°±å–1ä¸ªä½œä¸ºç¤ºèŒƒã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Long&gt; mappedSampledRDD = sampledRDD.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,String&gt;, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">call</span><span class="params">(Tuple2&lt;Long, String&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Long, Long&gt;(tuple._1, <span class="number">1L</span>);</span><br><span class="line">            &#125;     </span><br><span class="line">        &#125;);</span><br><span class="line">JavaPairRDD&lt;Long, Long&gt; countedSampledRDD = mappedSampledRDD.reduceByKey(</span><br><span class="line">        <span class="keyword">new</span> Function2&lt;Long, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">(Long v1, Long v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v1 + v2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">JavaPairRDD&lt;Long, Long&gt; reversedSampledRDD = countedSampledRDD.mapToPair( </span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,Long&gt;, Long, Long&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">call</span><span class="params">(Tuple2&lt;Long, Long&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Long, Long&gt;(tuple._2, tuple._1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å€¾æ–œé‡æœ€å¤§çš„ key</span></span><br><span class="line"><span class="keyword">final</span> Long skewedUserid = reversedSampledRDD.sortByKey(<span class="keyword">false</span>).take(<span class="number">1</span>).get(<span class="number">0</span>)._2;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»rdd1ä¸­åˆ†æ‹†å‡ºå¯¼è‡´æ•°æ®å€¾æ–œçš„keyï¼Œå½¢æˆç‹¬ç«‹çš„RDDã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, String&gt; skewedRDD = rdd1.filter(</span><br><span class="line">        <span class="keyword">new</span> Function&lt;Tuple2&lt;Long,String&gt;, Boolean&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Tuple2&lt;Long, String&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> tuple._1.equals(skewedUserid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">// ä»rdd1ä¸­åˆ†æ‹†å‡ºä¸å¯¼è‡´æ•°æ®å€¾æ–œçš„æ™®é€škeyï¼Œå½¢æˆç‹¬ç«‹çš„RDDã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, String&gt; commonRDD = rdd1.filter(</span><br><span class="line">        <span class="keyword">new</span> Function&lt;Tuple2&lt;Long,String&gt;, Boolean&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Tuple2&lt;Long, String&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> !tuple._1.equals(skewedUserid);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// rdd2ï¼Œå°±æ˜¯é‚£ä¸ªæ‰€æœ‰keyçš„åˆ†å¸ƒç›¸å¯¹è¾ƒä¸ºå‡åŒ€çš„rddã€‚</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå°†rdd2ä¸­ï¼Œå‰é¢è·å–åˆ°çš„keyå¯¹åº”çš„æ•°æ®ï¼Œè¿‡æ»¤å‡ºæ¥ï¼Œåˆ†æ‹†æˆå•ç‹¬çš„rddï¼Œå¹¶å¯¹rddä¸­çš„æ•°æ®ä½¿ç”¨flatMapç®—å­éƒ½æ‰©å®¹100å€ã€‚</span></span><br><span class="line"><span class="comment">// å¯¹æ‰©å®¹çš„æ¯æ¡æ•°æ®ï¼Œéƒ½æ‰“ä¸Š0ï½100çš„å‰ç¼€ã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Row&gt; skewedRdd2 = rdd2.filter(</span><br><span class="line">         <span class="keyword">new</span> Function&lt;Tuple2&lt;Long,Row&gt;, Boolean&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Tuple2&lt;Long, Row&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> tuple._1.equals(skewedUserid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).flatMapToPair(<span class="keyword">new</span> PairFlatMapFunction&lt;Tuple2&lt;Long,Row&gt;, String, Row&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Iterable&lt;Tuple2&lt;String, Row&gt;&gt; call(</span><br><span class="line">                    Tuple2&lt;Long, Row&gt; tuple) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                List&lt;Tuple2&lt;String, Row&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Tuple2&lt;String, Row&gt;&gt;();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    list.add(<span class="keyword">new</span> Tuple2&lt;String, Row&gt;(i + <span class="string">"_"</span> + tuple._1, tuple._2));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> list;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†rdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„å¯¼è‡´å€¾æ–œçš„keyçš„ç‹¬ç«‹rddï¼Œæ¯æ¡æ•°æ®éƒ½æ‰“ä¸Š100ä»¥å†…çš„éšæœºå‰ç¼€ã€‚</span></span><br><span class="line"><span class="comment">// ç„¶åå°†è¿™ä¸ªrdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„ç‹¬ç«‹rddï¼Œä¸ä¸Šé¢rdd2ä¸­åˆ†æ‹†å‡ºæ¥çš„ç‹¬ç«‹rddï¼Œè¿›è¡Œjoinã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Tuple2&lt;String, Row&gt;&gt; joinedRDD1 = skewedRDD.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,String&gt;, String, String&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">call</span><span class="params">(Tuple2&lt;Long, String&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="keyword">int</span> prefix = random.nextInt(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, String&gt;(prefix + <span class="string">"_"</span> + tuple._1, tuple._2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .join(skewedRdd2)</span><br><span class="line">        .mapToPair(<span class="keyword">new</span> PairFunction&lt;Tuple2&lt;String,Tuple2&lt;String,Row&gt;&gt;, Long, Tuple2&lt;String, Row&gt;&gt;() &#123;</span><br><span class="line">                        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> Tuple2&lt;Long, Tuple2&lt;String, Row&gt;&gt; call(</span><br><span class="line">                            Tuple2&lt;String, Tuple2&lt;String, Row&gt;&gt; tuple)</span><br><span class="line">                            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="keyword">long</span> key = Long.valueOf(tuple._1.split(<span class="string">"_"</span>)[<span class="number">1</span>]);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Long, Tuple2&lt;String, Row&gt;&gt;(key, tuple._2);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†rdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„åŒ…å«æ™®é€škeyçš„ç‹¬ç«‹rddï¼Œç›´æ¥ä¸rdd2è¿›è¡Œjoinã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Tuple2&lt;String, Row&gt;&gt; joinedRDD2 = commonRDD.join(rdd2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å€¾æ–œkey joinåçš„ç»“æœä¸æ™®é€škey joinåçš„ç»“æœï¼Œuinonèµ·æ¥ã€‚</span></span><br><span class="line"><span class="comment">// å°±æ˜¯æœ€ç»ˆçš„joinç»“æœã€‚</span></span><br><span class="line">JavaPairRDD&lt;Long, Tuple2&lt;String, Row&gt;&gt; joinedRDD = joinedRDD1.union(joinedRDD2);</span><br></pre></td></tr></table></figure><h3 id="è§£å†³æ–¹æ¡ˆä¸ƒï¼šä½¿ç”¨éšæœºå‰ç¼€å’Œæ‰©å®¹RDDè¿›è¡Œjoin"><a href="#è§£å†³æ–¹æ¡ˆä¸ƒï¼šä½¿ç”¨éšæœºå‰ç¼€å’Œæ‰©å®¹RDDè¿›è¡Œjoin" class="headerlink" title="è§£å†³æ–¹æ¡ˆä¸ƒï¼šä½¿ç”¨éšæœºå‰ç¼€å’Œæ‰©å®¹RDDè¿›è¡Œjoin"></a>è§£å†³æ–¹æ¡ˆä¸ƒï¼šä½¿ç”¨éšæœºå‰ç¼€å’Œæ‰©å®¹RDDè¿›è¡Œjoin</h3><p><strong>æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼š</strong>å¦‚æœåœ¨è¿›è¡Œjoinæ“ä½œæ—¶ï¼ŒRDDä¸­æœ‰å¤§é‡çš„keyå¯¼è‡´æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆè¿›è¡Œåˆ†æ‹†keyä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæ­¤æ—¶å°±åªèƒ½ä½¿ç”¨æœ€åä¸€ç§æ–¹æ¡ˆæ¥è§£å†³é—®é¢˜äº†ã€‚</p><p><strong>æ–¹æ¡ˆå®ç°æ€è·¯ï¼š</strong></p><ul><li>è¯¥æ–¹æ¡ˆçš„å®ç°æ€è·¯åŸºæœ¬å’Œâ€œè§£å†³æ–¹æ¡ˆå…­â€ç±»ä¼¼ï¼Œé¦–å…ˆæŸ¥çœ‹RDD/Hiveè¡¨ä¸­çš„æ•°æ®åˆ†å¸ƒæƒ…å†µï¼Œæ‰¾åˆ°é‚£ä¸ªé€ æˆæ•°æ®å€¾æ–œçš„RDD/Hiveè¡¨ï¼Œæ¯”å¦‚æœ‰å¤šä¸ªkeyéƒ½å¯¹åº”äº†è¶…è¿‡1ä¸‡æ¡æ•°æ®ã€‚</li><li>ç„¶åå°†è¯¥RDDçš„æ¯æ¡æ•°æ®éƒ½æ‰“ä¸Šä¸€ä¸ªnä»¥å†…çš„éšæœºå‰ç¼€ã€‚</li><li>åŒæ—¶å¯¹å¦å¤–ä¸€ä¸ªæ­£å¸¸çš„RDDè¿›è¡Œæ‰©å®¹ï¼Œå°†æ¯æ¡æ•°æ®éƒ½æ‰©å®¹æˆnæ¡æ•°æ®ï¼Œæ‰©å®¹å‡ºæ¥çš„æ¯æ¡æ•°æ®éƒ½ä¾æ¬¡æ‰“ä¸Šä¸€ä¸ª0~nçš„å‰ç¼€ã€‚</li><li>æœ€åå°†ä¸¤ä¸ªå¤„ç†åçš„RDDè¿›è¡Œjoinå³å¯ã€‚</li></ul><p><strong>æ–¹æ¡ˆå®ç°åŸç†ï¼š</strong>å°†åŸå…ˆä¸€æ ·çš„keyé€šè¿‡é™„åŠ éšæœºå‰ç¼€å˜æˆä¸ä¸€æ ·çš„keyï¼Œç„¶åå°±å¯ä»¥å°†è¿™äº›å¤„ç†åçš„â€œä¸åŒkeyâ€åˆ†æ•£åˆ°å¤šä¸ªtaskä¸­å»å¤„ç†ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªtaskå¤„ç†å¤§é‡çš„ç›¸åŒkeyã€‚è¯¥æ–¹æ¡ˆä¸â€œè§£å†³æ–¹æ¡ˆå…­â€çš„ä¸åŒä¹‹å¤„å°±åœ¨äºï¼Œä¸Šä¸€ç§æ–¹æ¡ˆæ˜¯å°½é‡åªå¯¹å°‘æ•°å€¾æ–œkeyå¯¹åº”çš„æ•°æ®è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œç”±äºå¤„ç†è¿‡ç¨‹éœ€è¦æ‰©å®¹RDDï¼Œå› æ­¤ä¸Šä¸€ç§æ–¹æ¡ˆæ‰©å®¹RDDåå¯¹å†…å­˜çš„å ç”¨å¹¶ä¸å¤§ï¼›è€Œè¿™ä¸€ç§æ–¹æ¡ˆæ˜¯é’ˆå¯¹æœ‰å¤§é‡å€¾æ–œkeyçš„æƒ…å†µï¼Œæ²¡æ³•å°†éƒ¨åˆ†keyæ‹†åˆ†å‡ºæ¥è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œå› æ­¤åªèƒ½å¯¹æ•´ä¸ªRDDè¿›è¡Œæ•°æ®æ‰©å®¹ï¼Œå¯¹å†…å­˜èµ„æºè¦æ±‚å¾ˆé«˜ã€‚</p><p><strong>æ–¹æ¡ˆä¼˜ç‚¹ï¼š</strong>å¯¹joinç±»å‹çš„æ•°æ®å€¾æ–œåŸºæœ¬éƒ½å¯ä»¥å¤„ç†ï¼Œè€Œä¸”æ•ˆæœä¹Ÿç›¸å¯¹æ¯”è¾ƒæ˜¾è‘—ï¼Œæ€§èƒ½æå‡æ•ˆæœéå¸¸ä¸é”™ã€‚</p><p><strong>æ–¹æ¡ˆç¼ºç‚¹ï¼š</strong>è¯¥æ–¹æ¡ˆæ›´å¤šçš„æ˜¯ç¼“è§£æ•°æ®å€¾æ–œï¼Œè€Œä¸æ˜¯å½»åº•é¿å…æ•°æ®å€¾æ–œã€‚è€Œä¸”éœ€è¦å¯¹æ•´ä¸ªRDDè¿›è¡Œæ‰©å®¹ï¼Œå¯¹å†…å­˜èµ„æºè¦æ±‚å¾ˆé«˜ã€‚</p><p><strong>æ–¹æ¡ˆå®è·µç»éªŒï¼š</strong>æ›¾ç»å¼€å‘ä¸€ä¸ªæ•°æ®éœ€æ±‚çš„æ—¶å€™ï¼Œå‘ç°ä¸€ä¸ªjoinå¯¼è‡´äº†æ•°æ®å€¾æ–œã€‚ä¼˜åŒ–ä¹‹å‰ï¼Œä½œä¸šçš„æ‰§è¡Œæ—¶é—´å¤§çº¦æ˜¯60åˆ†é’Ÿå·¦å³ï¼›ä½¿ç”¨è¯¥æ–¹æ¡ˆä¼˜åŒ–ä¹‹åï¼Œæ‰§è¡Œæ—¶é—´ç¼©çŸ­åˆ°10åˆ†é’Ÿå·¦å³ï¼Œæ€§èƒ½æå‡äº†6å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆå°†å…¶ä¸­ä¸€ä¸ªkeyåˆ†å¸ƒç›¸å¯¹è¾ƒä¸ºå‡åŒ€çš„RDDè†¨èƒ€100å€ã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Row&gt; expandedRDD = rdd1.flatMapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFlatMapFunction&lt;Tuple2&lt;Long,Row&gt;, String, Row&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Iterable&lt;Tuple2&lt;String, Row&gt;&gt; call(Tuple2&lt;Long, Row&gt; tuple)</span><br><span class="line">                    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                List&lt;Tuple2&lt;String, Row&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Tuple2&lt;String, Row&gt;&gt;();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    list.add(<span class="keyword">new</span> Tuple2&lt;String, Row&gt;(<span class="number">0</span> + <span class="string">"_"</span> + tuple._1, tuple._2));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> list;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶æ¬¡ï¼Œå°†å¦ä¸€ä¸ªæœ‰æ•°æ®å€¾æ–œkeyçš„RDDï¼Œæ¯æ¡æ•°æ®éƒ½æ‰“ä¸Š100ä»¥å†…çš„éšæœºå‰ç¼€ã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, String&gt; mappedRDD = rdd2.mapToPair(</span><br><span class="line">        <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;Long,String&gt;, String, String&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">call</span><span class="params">(Tuple2&lt;Long, String&gt; tuple)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="keyword">int</span> prefix = random.nextInt(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, String&gt;(prefix + <span class="string">"_"</span> + tuple._1, tuple._2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ä¸¤ä¸ªå¤„ç†åçš„RDDè¿›è¡Œjoinå³å¯ã€‚</span></span><br><span class="line">JavaPairRDD&lt;String, Tuple2&lt;String, Row&gt;&gt; joinedRDD = mappedRDD.join(expandedRDD);</span><br></pre></td></tr></table></figure><h3 id="è§£å†³æ–¹æ¡ˆå…«ï¼šå¤šç§æ–¹æ¡ˆç»„åˆä½¿ç”¨"><a href="#è§£å†³æ–¹æ¡ˆå…«ï¼šå¤šç§æ–¹æ¡ˆç»„åˆä½¿ç”¨" class="headerlink" title="è§£å†³æ–¹æ¡ˆå…«ï¼šå¤šç§æ–¹æ¡ˆç»„åˆä½¿ç”¨"></a>è§£å†³æ–¹æ¡ˆå…«ï¼šå¤šç§æ–¹æ¡ˆç»„åˆä½¿ç”¨</h3><p>åœ¨å®è·µä¸­å‘ç°ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¦‚æœåªæ˜¯å¤„ç†è¾ƒä¸ºç®€å•çš„æ•°æ®å€¾æ–œåœºæ™¯ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆä¸­çš„æŸä¸€ç§åŸºæœ¬å°±å¯ä»¥è§£å†³ã€‚ä½†æ˜¯å¦‚æœè¦å¤„ç†ä¸€ä¸ªè¾ƒä¸ºå¤æ‚çš„æ•°æ®å€¾æ–œåœºæ™¯ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦å°†å¤šç§æ–¹æ¡ˆç»„åˆèµ·æ¥ä½¿ç”¨ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬é’ˆå¯¹å‡ºç°äº†å¤šä¸ªæ•°æ®å€¾æ–œç¯èŠ‚çš„Sparkä½œä¸šï¼Œå¯ä»¥å…ˆè¿ç”¨è§£å†³æ–¹æ¡ˆä¸€å’ŒäºŒï¼Œé¢„å¤„ç†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¹¶è¿‡æ»¤ä¸€éƒ¨åˆ†æ•°æ®æ¥ç¼“è§£ï¼›å…¶æ¬¡å¯ä»¥å¯¹æŸäº›shuffleæ“ä½œæå‡å¹¶è¡Œåº¦ï¼Œä¼˜åŒ–å…¶æ€§èƒ½ï¼›æœ€åè¿˜å¯ä»¥é’ˆå¯¹ä¸åŒçš„èšåˆæˆ–joinæ“ä½œï¼Œé€‰æ‹©ä¸€ç§æ–¹æ¡ˆæ¥ä¼˜åŒ–å…¶æ€§èƒ½ã€‚å¤§å®¶éœ€è¦å¯¹è¿™äº›æ–¹æ¡ˆçš„æ€è·¯å’ŒåŸç†éƒ½é€å½»ç†è§£ä¹‹åï¼Œåœ¨å®è·µä¸­æ ¹æ®å„ç§ä¸åŒçš„æƒ…å†µï¼Œçµæ´»è¿ç”¨å¤šç§æ–¹æ¡ˆï¼Œæ¥è§£å†³è‡ªå·±çš„æ•°æ®å€¾æ–œé—®é¢˜ã€‚</p><hr><h1 id="å››-shuffle-è°ƒä¼˜"><a href="#å››-shuffle-è°ƒä¼˜" class="headerlink" title="å››. shuffle è°ƒä¼˜"></a>å››. shuffle è°ƒä¼˜</h1><h2 id="è°ƒä¼˜æ¦‚è¿°-3"><a href="#è°ƒä¼˜æ¦‚è¿°-3" class="headerlink" title="è°ƒä¼˜æ¦‚è¿°"></a>è°ƒä¼˜æ¦‚è¿°</h2><p>å¤§å¤šæ•°Sparkä½œä¸šçš„æ€§èƒ½ä¸»è¦å°±æ˜¯æ¶ˆè€—åœ¨äº†shuffleç¯èŠ‚ï¼Œå› ä¸ºè¯¥ç¯èŠ‚åŒ…å«äº†å¤§é‡çš„ç£ç›˜IOã€åºåˆ—åŒ–ã€ç½‘ç»œæ•°æ®ä¼ è¾“ç­‰æ“ä½œã€‚å› æ­¤ï¼Œå¦‚æœè¦è®©ä½œä¸šçš„æ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ï¼Œå°±æœ‰å¿…è¦å¯¹shuffleè¿‡ç¨‹è¿›è¡Œè°ƒä¼˜ã€‚ä½†æ˜¯ä¹Ÿå¿…é¡»æé†’å¤§å®¶çš„æ˜¯ï¼Œå½±å“ä¸€ä¸ªSparkä½œä¸šæ€§èƒ½çš„å› ç´ ï¼Œä¸»è¦è¿˜æ˜¯ä»£ç å¼€å‘ã€èµ„æºå‚æ•°ä»¥åŠæ•°æ®å€¾æ–œï¼Œshuffleè°ƒä¼˜åªèƒ½åœ¨æ•´ä¸ªSparkçš„æ€§èƒ½è°ƒä¼˜ä¸­å åˆ°ä¸€å°éƒ¨åˆ†è€Œå·²ã€‚å› æ­¤å¤§å®¶åŠ¡å¿…æŠŠæ¡ä½è°ƒä¼˜çš„åŸºæœ¬åŸåˆ™ï¼Œåƒä¸‡ä¸è¦èˆæœ¬é€æœ«ã€‚ä¸‹é¢æˆ‘ä»¬å°±ç»™å¤§å®¶è¯¦ç»†è®²è§£shuffleçš„åŸç†ï¼Œä»¥åŠç›¸å…³å‚æ•°çš„è¯´æ˜ï¼ŒåŒæ—¶ç»™å‡ºå„ä¸ªå‚æ•°çš„è°ƒä¼˜å»ºè®®ã€‚</p><h2 id="ShuffleManagerå‘å±•æ¦‚è¿°"><a href="#ShuffleManagerå‘å±•æ¦‚è¿°" class="headerlink" title="ShuffleManagerå‘å±•æ¦‚è¿°"></a>ShuffleManagerå‘å±•æ¦‚è¿°</h2><p> åœ¨Sparkçš„æºç ä¸­ï¼Œ<strong>è´Ÿè´£shuffleè¿‡ç¨‹çš„æ‰§è¡Œã€è®¡ç®—å’Œå¤„ç†çš„ç»„ä»¶ä¸»è¦å°±æ˜¯<code>ShuffleManager</code></strong>ï¼Œä¹Ÿå³shuffleç®¡ç†å™¨ã€‚è€Œéšç€Sparkçš„ç‰ˆæœ¬çš„å‘å±•ï¼ŒShuffleManagerä¹Ÿåœ¨ä¸æ–­è¿­ä»£ï¼Œå˜å¾—è¶Šæ¥è¶Šå…ˆè¿›ã€‚</p><p>åœ¨<strong>Spark 1.2ä»¥å‰ï¼Œé»˜è®¤çš„shuffleè®¡ç®—å¼•æ“æ˜¯<code>HashShuffleManager</code>ã€‚</strong>è¯¥ShuffleManagerè€ŒHashShuffleManageræœ‰ç€ä¸€ä¸ªéå¸¸ä¸¥é‡çš„å¼Šç«¯ï¼Œå°±æ˜¯ä¼šäº§ç”Ÿå¤§é‡çš„ä¸­é—´ç£ç›˜æ–‡ä»¶ï¼Œè¿›è€Œç”±å¤§é‡çš„ç£ç›˜IOæ“ä½œå½±å“äº†æ€§èƒ½ã€‚</p><p>å› æ­¤åœ¨<strong>Spark 1.2ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤çš„ShuffleManageræ”¹æˆäº†<code>SortShuffleManager</code>ã€‚</strong><u>SortShuffleManager</u>ç›¸è¾ƒäºHashShuffleManageræ¥è¯´ï¼Œæœ‰äº†ä¸€å®šçš„æ”¹è¿›ã€‚ä¸»è¦å°±åœ¨äºï¼Œ<u>æ¯ä¸ªTaskåœ¨è¿›è¡Œshuffleæ“ä½œæ—¶ï¼Œè™½ç„¶ä¹Ÿä¼šäº§ç”Ÿè¾ƒå¤šçš„ä¸´æ—¶ç£ç›˜æ–‡ä»¶ï¼Œä½†æ˜¯æœ€åä¼šå°†æ‰€æœ‰çš„ä¸´æ—¶æ–‡ä»¶åˆå¹¶ï¼ˆmergeï¼‰æˆä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå› æ­¤æ¯ä¸ªTaskå°±åªæœ‰ä¸€ä¸ªç£ç›˜æ–‡ä»¶ã€‚åœ¨ä¸‹ä¸€ä¸ªstageçš„shuffle read taskæ‹‰å–è‡ªå·±çš„æ•°æ®æ—¶ï¼Œåªè¦æ ¹æ®ç´¢å¼•è¯»å–æ¯ä¸ªç£ç›˜æ–‡ä»¶ä¸­çš„éƒ¨åˆ†æ•°æ®å³å¯ã€‚</u></p><p>ä¸‹é¢æˆ‘ä»¬è¯¦ç»†åˆ†æä¸€ä¸‹HashShuffleManagerå’ŒSortShuffleManagerçš„åŸç†ã€‚</p><h2 id="HashShuffleManagerè¿è¡ŒåŸç†"><a href="#HashShuffleManagerè¿è¡ŒåŸç†" class="headerlink" title="HashShuffleManagerè¿è¡ŒåŸç†"></a>HashShuffleManagerè¿è¡ŒåŸç†</h2><h3 id="æœªç»ä¼˜åŒ–çš„HashShuffleManager"><a href="#æœªç»ä¼˜åŒ–çš„HashShuffleManager" class="headerlink" title="æœªç»ä¼˜åŒ–çš„HashShuffleManager"></a>æœªç»ä¼˜åŒ–çš„HashShuffleManager</h3><p>ä¸‹å›¾è¯´æ˜äº†æœªç»ä¼˜åŒ–çš„HashShuffleManagerçš„åŸç†ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸ªå‡è®¾å‰æï¼šæ¯ä¸ªExecutoråªæœ‰1ä¸ªCPU coreï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºè¿™ä¸ªExecutorä¸Šåˆ†é…å¤šå°‘ä¸ªtaskçº¿ç¨‹ï¼ŒåŒä¸€æ—¶é—´éƒ½åªèƒ½æ‰§è¡Œä¸€ä¸ªtaskçº¿ç¨‹ã€‚</p><p>æˆ‘ä»¬å…ˆä»<code>shuffle write</code>å¼€å§‹è¯´èµ·ã€‚shuffle writeé˜¶æ®µï¼Œä¸»è¦å°±æ˜¯åœ¨ä¸€ä¸ªstageç»“æŸè®¡ç®—ä¹‹åï¼Œä¸ºäº†ä¸‹ä¸€ä¸ªstageå¯ä»¥æ‰§è¡Œshuffleç±»çš„ç®—å­ï¼ˆæ¯”å¦‚reduceByKeyï¼‰ï¼Œè€Œå°†æ¯ä¸ªtaskå¤„ç†çš„æ•°æ®æŒ‰keyè¿›è¡Œâ€œåˆ†ç±»â€ã€‚æ‰€è°“â€œåˆ†ç±»â€ï¼Œå°±æ˜¯å¯¹ç›¸åŒçš„keyæ‰§è¡Œhashç®—æ³•ï¼Œä»è€Œå°†ç›¸åŒkeyéƒ½å†™å…¥åŒä¸€ä¸ªç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œæ¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶éƒ½åªå±äºä¸‹æ¸¸stageçš„ä¸€ä¸ªtaskã€‚åœ¨å°†æ•°æ®å†™å…¥ç£ç›˜ä¹‹å‰ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥å†…å­˜ç¼“å†²ä¸­ï¼Œå½“å†…å­˜ç¼“å†²å¡«æ»¡ä¹‹åï¼Œæ‰ä¼šæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ã€‚</p><p>é‚£ä¹ˆ<strong>æ¯ä¸ªæ‰§è¡Œshuffle writeçš„task</strong>ï¼Œè¦ä¸ºä¸‹ä¸€ä¸ªstageåˆ›å»ºå¤šå°‘ä¸ªç£ç›˜æ–‡ä»¶å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œ<strong>ä¸‹ä¸€ä¸ªstageçš„taskæœ‰å¤šå°‘ä¸ªï¼Œå½“å‰stageçš„æ¯ä¸ªtaskå°±è¦åˆ›å»ºå¤šå°‘ä»½ç£ç›˜æ–‡ä»¶</strong>ã€‚ å¦‚æœå•çº¯æŒ‰ç…§ key æ¥ hash çš„è¯, æœ‰å¤šå°‘ä¸åŒçš„ key, ,æ¯ä¸ª task å°±ä¼šåˆ›å»ºå¤šå°‘ä»½ç£ç›˜æ–‡ä»¶.</p><p>æ¯”å¦‚ä¸‹ä¸€ä¸ªstageæ€»å…±æœ‰100ä¸ªtaskï¼Œé‚£ä¹ˆå½“å‰stageçš„æ¯ä¸ªtaskéƒ½è¦åˆ›å»º100ä»½ç£ç›˜æ–‡ä»¶ã€‚å¦‚æœå½“å‰stageæœ‰50ä¸ªtaskï¼Œæ€»å…±æœ‰10ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræ‰§è¡Œ5ä¸ªTaskï¼Œé‚£ä¹ˆæ¯ä¸ªExecutorä¸Šæ€»å…±å°±è¦åˆ›å»º500ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executorä¸Šä¼šåˆ›å»º5000ä¸ªç£ç›˜æ–‡ä»¶ã€‚ç”±æ­¤å¯è§ï¼Œæœªç»ä¼˜åŒ–çš„shuffle writeæ“ä½œæ‰€äº§ç”Ÿçš„ç£ç›˜æ–‡ä»¶çš„æ•°é‡æ˜¯æå…¶æƒŠäººçš„ã€‚</p><p>æ¥ç€æˆ‘ä»¬æ¥è¯´è¯´<code>shuffle read</code>ã€‚shuffle readï¼Œé€šå¸¸å°±æ˜¯ä¸€ä¸ªstageåˆšå¼€å§‹æ—¶è¦åšçš„äº‹æƒ…ã€‚æ­¤æ—¶è¯¥stageçš„æ¯ä¸€ä¸ªtaskå°±éœ€è¦å°†ä¸Šä¸€ä¸ªstageçš„è®¡ç®—ç»“æœä¸­çš„æ‰€æœ‰ç›¸åŒkeyï¼Œä»å„ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ç½‘ç»œéƒ½æ‹‰å–åˆ°è‡ªå·±æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼Œç„¶åè¿›è¡Œkeyçš„èšåˆæˆ–è¿æ¥ç­‰æ“ä½œã€‚ç”±äºshuffle writeçš„è¿‡ç¨‹ä¸­ï¼Œtaskç»™ä¸‹æ¸¸stageçš„æ¯ä¸ªtaskéƒ½åˆ›å»ºäº†ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå› æ­¤shuffle readçš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªtaskåªè¦ä»ä¸Šæ¸¸stageçš„æ‰€æœ‰taskæ‰€åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‹‰å–å±äºè‡ªå·±çš„é‚£ä¸€ä¸ªç£ç›˜æ–‡ä»¶å³å¯ã€‚</p><p>shuffle readçš„æ‹‰å–è¿‡ç¨‹æ˜¯ä¸€è¾¹æ‹‰å–ä¸€è¾¹è¿›è¡Œèšåˆçš„ã€‚æ¯ä¸ªshuffle read taskéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„bufferç¼“å†²ï¼Œæ¯æ¬¡éƒ½åªèƒ½æ‹‰å–ä¸bufferç¼“å†²ç›¸åŒå¤§å°çš„æ•°æ®ï¼Œç„¶åé€šè¿‡å†…å­˜ä¸­çš„ä¸€ä¸ªMapè¿›è¡Œèšåˆç­‰æ“ä½œã€‚èšåˆå®Œä¸€æ‰¹æ•°æ®åï¼Œå†æ‹‰å–ä¸‹ä¸€æ‰¹æ•°æ®ï¼Œå¹¶æ”¾åˆ°bufferç¼“å†²ä¸­è¿›è¡Œèšåˆæ“ä½œã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€åå°†æ‰€æœ‰æ•°æ®åˆ°æ‹‰å–å®Œï¼Œå¹¶å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚</p><p> <img src="https://tech.meituan.com/img/spark-tuning/hash-shuffle-common.png" alt="img"></p><h3 id="ä¼˜åŒ–åçš„HashShuffleManager"><a href="#ä¼˜åŒ–åçš„HashShuffleManager" class="headerlink" title="ä¼˜åŒ–åçš„HashShuffleManager"></a>ä¼˜åŒ–åçš„HashShuffleManager</h3><p>ä¸‹å›¾è¯´æ˜äº†ä¼˜åŒ–åçš„<code>HashShuffleManager</code>çš„åŸç†ã€‚è¿™é‡Œè¯´çš„<strong>ä¼˜åŒ–ï¼Œæ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå‚æ•°</strong>ï¼Œ<strong><code>spark.shuffle.consolidateFiles</code>ã€‚</strong>è¯¥å‚æ•°é»˜è®¤å€¼ä¸ºfalseï¼Œå°†å…¶<strong>è®¾ç½®ä¸ºtrueå³å¯å¼€å¯ä¼˜åŒ–æœºåˆ¶</strong>ã€‚é€šå¸¸æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨HashShuffleManagerï¼Œé‚£ä¹ˆéƒ½å»ºè®®å¼€å¯è¿™ä¸ªé€‰é¡¹ã€‚</p><p>å¼€å¯consolidateæœºåˆ¶ä¹‹åï¼Œåœ¨shuffle writeè¿‡ç¨‹ä¸­ï¼Œtaskå°±ä¸æ˜¯ä¸ºä¸‹æ¸¸stageçš„æ¯ä¸ªtaskåˆ›å»ºä¸€ä¸ªç£ç›˜æ–‡ä»¶äº†ã€‚æ­¤æ—¶ä¼šå‡ºç°shuffleFileGroupçš„æ¦‚å¿µï¼Œ<strong>æ¯ä¸ª<code>shuffleFileGroup</code>ä¼šå¯¹åº”ä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œç£ç›˜æ–‡ä»¶çš„æ•°é‡ä¸ä¸‹æ¸¸stageçš„taskæ•°é‡æ˜¯ç›¸åŒçš„ã€‚</strong>ä¸€ä¸ªExecutorä¸Šæœ‰å¤šå°‘ä¸ªCPU coreï¼Œå°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šå°‘ä¸ªtaskã€‚è€Œç¬¬ä¸€æ‰¹å¹¶è¡Œæ‰§è¡Œçš„æ¯ä¸ªtaskéƒ½ä¼šåˆ›å»ºä¸€ä¸ªshuffleFileGroupï¼Œå¹¶å°†æ•°æ®å†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶å†…ã€‚</p><p><strong>å½“Executorçš„CPU coreæ‰§è¡Œå®Œä¸€æ‰¹taskï¼Œæ¥ç€æ‰§è¡Œä¸‹ä¸€æ‰¹taskæ—¶ï¼Œä¸‹ä¸€æ‰¹taskå°±ä¼šå¤ç”¨ä¹‹å‰å·²æœ‰çš„shuffleFileGroupï¼ŒåŒ…æ‹¬å…¶ä¸­çš„ç£ç›˜æ–‡ä»¶ã€‚</strong>ä¹Ÿå°±æ˜¯è¯´, <strong>åŒä¸€ä¸ªExecutorçš„æ‰€æœ‰ task ä¸­, æ€»å…±æœ‰å¤šå°‘ä¸åŒçš„ key, å°±ä¼šåˆ›å»ºå¤šå°‘ä¸ªç£ç›˜æ–‡ä»¶, è¿™äº›ç£ç›˜æ–‡ä»¶éƒ½åœ¨åŒä¸€ä¸ªshuffleFileGroupä¸­.</strong> è€Œä¸ä¼šå‡ºç°, ç›¸åŒçš„ Executor çš„ä¸åŒ task ä¸­, å¦‚æœå­˜åœ¨ç›¸åŒçš„ key, è¿˜ä¼šå„è‡ªåˆ›å»ºè‡ªå·±çš„ç£ç›˜æ–‡ä»¶çš„æƒ…å†µ. </p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶taskä¼šå°†æ•°æ®å†™å…¥å·²æœ‰çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œä¸ä¼šå†™å…¥æ–°çš„ç£ç›˜æ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼Œconsolidateæœºåˆ¶å…è®¸ä¸åŒçš„taskå¤ç”¨åŒä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆå°†å¤šä¸ªtaskçš„ç£ç›˜æ–‡ä»¶è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„åˆå¹¶ï¼Œä»è€Œå¤§å¹…åº¦å‡å°‘ç£ç›˜æ–‡ä»¶çš„æ•°é‡ï¼Œè¿›è€Œæå‡shuffle writeçš„æ€§èƒ½ã€‚</p><p>å‡è®¾ç¬¬äºŒä¸ªstageæœ‰100ä¸ªtaskï¼Œç¬¬ä¸€ä¸ªstageæœ‰50ä¸ªtaskï¼Œæ€»å…±è¿˜æ˜¯æœ‰10ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræ‰§è¡Œ5ä¸ªtaskã€‚é‚£ä¹ˆåŸæœ¬ä½¿ç”¨æœªç»ä¼˜åŒ–çš„HashShuffleManageræ—¶ï¼Œæ¯ä¸ªExecutorä¼šäº§ç”Ÿ500ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executorä¼šäº§ç”Ÿ5000ä¸ªç£ç›˜æ–‡ä»¶çš„ã€‚ä½†æ˜¯æ­¤æ—¶ç»è¿‡ä¼˜åŒ–ä¹‹åï¼Œæ¯ä¸ªExecutoråˆ›å»ºçš„ç£ç›˜æ–‡ä»¶çš„æ•°é‡çš„è®¡ç®—å…¬å¼ä¸ºï¼šCPU coreçš„æ•°é‡ * ä¸‹ä¸€ä¸ªstageçš„taskæ•°é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªExecutoræ­¤æ—¶åªä¼šåˆ›å»º100ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executoråªä¼šåˆ›å»º1000ä¸ªç£ç›˜æ–‡ä»¶ã€‚</p><p> <img src="https://tech.meituan.com/img/spark-tuning/hash-shuffle-consolidate.png" alt="img"></p><h2 id="SortShuffleManagerè¿è¡ŒåŸç†"><a href="#SortShuffleManagerè¿è¡ŒåŸç†" class="headerlink" title="SortShuffleManagerè¿è¡ŒåŸç†"></a>SortShuffleManagerè¿è¡ŒåŸç†</h2><p><code>SortShuffleManager</code>çš„è¿è¡Œæœºåˆ¶ä¸»è¦åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯æ™®é€šè¿è¡Œæœºåˆ¶ï¼Œå¦ä¸€ç§æ˜¯bypassè¿è¡Œæœºåˆ¶ã€‚<strong>å½“shuffle read taskçš„æ•°é‡å°äºç­‰äºspark.shuffle.sort.bypassMergeThresholdå‚æ•°çš„å€¼æ—¶ï¼ˆé»˜è®¤ä¸º200ï¼‰ï¼Œå°±ä¼šå¯ç”¨bypassæœºåˆ¶ã€‚</strong></p><h3 id="æ™®é€šè¿è¡Œæœºåˆ¶"><a href="#æ™®é€šè¿è¡Œæœºåˆ¶" class="headerlink" title="æ™®é€šè¿è¡Œæœºåˆ¶"></a>æ™®é€šè¿è¡Œæœºåˆ¶</h3><p>ä¸‹å›¾è¯´æ˜äº†æ™®é€šçš„<code>SortShuffleManager</code>çš„åŸç†ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œ<strong>æ•°æ®ä¼šå…ˆå†™å…¥ä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„ä¸­ï¼Œæ­¤æ—¶æ ¹æ®ä¸åŒçš„shuffleç®—å­ï¼Œå¯èƒ½é€‰ç”¨ä¸åŒçš„æ•°æ®ç»“æ„</strong>ã€‚å¦‚æœæ˜¯<code>reduceByKey</code>è¿™ç§èšåˆç±»çš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼šé€‰ç”¨<code>Mapæ•°æ®ç»“æ„</code>ï¼Œä¸€è¾¹é€šè¿‡Mapè¿›è¡Œèšåˆï¼Œä¸€è¾¹å†™å…¥å†…å­˜ï¼›å¦‚æœæ˜¯<code>join</code>è¿™ç§æ™®é€šçš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼š<code>é€‰ç”¨Arrayæ•°æ®ç»“æ„</code>ï¼Œ<strong>ç›´æ¥å†™å…¥å†…å­˜</strong>ã€‚æ¥ç€ï¼Œ<u>æ¯å†™ä¸€æ¡æ•°æ®è¿›å…¥å†…å­˜æ•°æ®ç»“æ„ä¹‹åï¼Œå°±ä¼šåˆ¤æ–­ä¸€ä¸‹ï¼Œæ˜¯å¦è¾¾åˆ°äº†æŸä¸ªä¸´ç•Œé˜ˆå€¼</u>ã€‚å¦‚æœ<strong>è¾¾åˆ°ä¸´ç•Œé˜ˆå€¼</strong>çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå°è¯•<strong>å°†å†…å­˜æ•°æ®ç»“æ„ä¸­çš„æ•°æ®æº¢å†™åˆ°ç£ç›˜ï¼Œç„¶åæ¸…ç©ºå†…å­˜æ•°æ®ç»“æ„</strong>ã€‚</p><p><strong>åœ¨æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¹‹å‰ï¼Œä¼šå…ˆå¯¹å†…å­˜æ•°æ®ç»“æ„ä¸­å·²æœ‰çš„æ•°æ®, æ ¹æ®key, æŠŠ key å¯¹åº”çš„ value è¿›è¡Œæ’åº</strong>ã€‚æ’åºè¿‡åï¼Œä¼šåˆ†æ‰¹å°†æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚é»˜è®¤çš„batchæ•°é‡æ˜¯10000æ¡(10000ä¸ª key, ä¸€ä¸ª key ä¸€æ¡)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ’åºå¥½çš„æ•°æ®ï¼Œä¼šä»¥æ¯æ‰¹1ä¸‡æ¡æ•°æ®çš„å½¢å¼åˆ†æ‰¹å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚å†™å…¥ç£ç›˜æ–‡ä»¶æ˜¯é€šè¿‡Javaçš„BufferedOutputStreamå®ç°çš„ã€‚BufferedOutputStreamæ˜¯Javaçš„ç¼“å†²è¾“å‡ºæµï¼Œé¦–å…ˆä¼šå°†æ•°æ®ç¼“å†²åœ¨å†…å­˜ä¸­ï¼Œå½“å†…å­˜ç¼“å†²æ»¡æº¢ä¹‹åå†ä¸€æ¬¡å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç£ç›˜IOæ¬¡æ•°ï¼Œæå‡æ€§èƒ½ã€‚</p><p>ä¸€ä¸ªtaskå°†æ‰€æœ‰æ•°æ®å†™å…¥å†…å­˜æ•°æ®ç»“æ„çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿå¤šæ¬¡ç£ç›˜æº¢å†™æ“ä½œï¼Œä¹Ÿå°±ä¼šäº§ç”Ÿå¤šä¸ªä¸´æ—¶æ–‡ä»¶ã€‚æœ€åä¼šå°†ä¹‹å‰æ‰€æœ‰çš„ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½è¿›è¡Œåˆå¹¶ï¼Œè¿™å°±æ˜¯mergeè¿‡ç¨‹ï¼Œæ­¤æ—¶ä¼šå°†ä¹‹å‰æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œç„¶åä¾æ¬¡å†™å…¥æœ€ç»ˆçš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚æ­¤å¤–ï¼Œ<strong>ç”±äºä¸€ä¸ªtaskå°±åªå¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œä¹Ÿå°±æ„å‘³ç€è¯¥taskä¸ºä¸‹æ¸¸stageçš„taskå‡†å¤‡çš„æ•°æ®éƒ½åœ¨è¿™ä¸€ä¸ªæ–‡ä»¶ä¸­</strong>ï¼Œå› æ­¤<strong>è¿˜ä¼šå•ç‹¬å†™ä¸€ä»½ç´¢å¼•æ–‡ä»¶ï¼Œå…¶ä¸­æ ‡è¯†äº†ä¸‹æ¸¸å„ä¸ªtaskçš„æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„start offsetä¸end offsetã€‚</strong></p><p>SortShuffleManagerç”±äºæœ‰ä¸€ä¸ªç£ç›˜æ–‡ä»¶mergeçš„è¿‡ç¨‹ï¼Œå› æ­¤å¤§å¤§å‡å°‘äº†æ–‡ä»¶æ•°é‡ã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ªstageæœ‰50ä¸ªtaskï¼Œæ€»å…±æœ‰10ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræ‰§è¡Œ5ä¸ªtaskï¼Œè€Œç¬¬äºŒä¸ªstageæœ‰100ä¸ªtaskã€‚ç”±äº<strong>æ¯ä¸ªtaskæœ€ç»ˆåªæœ‰ä¸€ä¸ªç£ç›˜æ–‡ä»¶</strong>ï¼Œå› æ­¤æ­¤æ—¶æ¯ä¸ªExecutorä¸Šåªæœ‰5ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executoråªæœ‰50ä¸ªç£ç›˜æ–‡ä»¶ã€‚</p><p><strong>æ³¨æ„:</strong> </p><ul><li>æ’åºæ˜¯æŒ‡ key çš„ value æ’åº</li><li>batch å†™å…¥ç£ç›˜æ˜¯æŒ‡, é»˜è®¤ 10000 ä¸ª (k,v)å†™ä¸€æ¬¡.</li><li>æ˜¯å¦ä¼š hash? :TODO</li></ul><p><img src="https://tech.meituan.com/img/spark-tuning/sort-shuffle-common.png" alt="img"></p><h3 id="bypassè¿è¡Œæœºåˆ¶"><a href="#bypassè¿è¡Œæœºåˆ¶" class="headerlink" title="bypassè¿è¡Œæœºåˆ¶"></a>bypassè¿è¡Œæœºåˆ¶</h3><p>ä¸‹å›¾è¯´æ˜äº†bypass SortShuffleManagerçš„åŸç†ã€‚bypassè¿è¡Œæœºåˆ¶çš„è§¦å‘æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>shuffle map taskæ•°é‡å°äºspark.shuffle.sort.bypassMergeThresholdå‚æ•°çš„å€¼ã€‚</li><li><strong>å…¶å®bypass å°±æ˜¯ä¸€ä¸ªé«˜çº§çš„å‚æ•°, è®¾ç½®å, å¦‚æœå°äºæ­¤é˜ˆå€¼, key å¯¹åº”çš„ value å°±ä¸ä¼šè¿›è¡Œæ’åº</strong></li><li>ä¸æ˜¯èšåˆç±»çš„shuffleç®—å­ï¼ˆæ¯”å¦‚reduceByKeyï¼‰ã€‚</li></ul><p>æ­¤æ—¶taskä¼šä¸ºæ¯ä¸ªä¸‹æ¸¸taskéƒ½åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç£ç›˜æ–‡ä»¶ï¼Œå¹¶å°†æ•°æ®æŒ‰keyè¿›è¡Œhashç„¶åæ ¹æ®keyçš„hashå€¼ï¼Œå°†keyå†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚å½“ç„¶ï¼Œå†™å…¥ç£ç›˜æ–‡ä»¶æ—¶ä¹Ÿæ˜¯å…ˆå†™å…¥å†…å­˜ç¼“å†²ï¼Œç¼“å†²å†™æ»¡ä¹‹åå†æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶çš„ã€‚æœ€åï¼ŒåŒæ ·ä¼šå°†æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½åˆå¹¶æˆä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ã€‚</p><p>è¯¥è¿‡ç¨‹çš„ç£ç›˜å†™æœºåˆ¶å…¶å®è·Ÿæœªç»ä¼˜åŒ–çš„HashShuffleManageræ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå› ä¸ºéƒ½è¦åˆ›å»ºæ•°é‡æƒŠäººçš„ç£ç›˜æ–‡ä»¶ï¼Œåªæ˜¯åœ¨æœ€åä¼šåšä¸€ä¸ªç£ç›˜æ–‡ä»¶çš„åˆå¹¶è€Œå·²ã€‚å› æ­¤å°‘é‡çš„æœ€ç»ˆç£ç›˜æ–‡ä»¶ï¼Œä¹Ÿè®©è¯¥æœºåˆ¶ç›¸å¯¹æœªç»ä¼˜åŒ–çš„HashShuffleManageræ¥è¯´ï¼Œshuffle readçš„æ€§èƒ½ä¼šæ›´å¥½ã€‚</p><p>è€Œè¯¥æœºåˆ¶ä¸æ™®é€šSortShuffleManagerè¿è¡Œæœºåˆ¶çš„ä¸åŒåœ¨äºï¼šç¬¬ä¸€ï¼Œç£ç›˜å†™æœºåˆ¶ä¸åŒï¼›ç¬¬äºŒï¼Œä¸ä¼šè¿›è¡Œæ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ç”¨è¯¥æœºåˆ¶çš„æœ€å¤§å¥½å¤„åœ¨äºï¼Œshuffle writeè¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ’åºæ“ä½œï¼Œä¹Ÿå°±èŠ‚çœæ‰äº†è¿™éƒ¨åˆ†çš„æ€§èƒ½å¼€é”€ã€‚</p><p><img src="https://tech.meituan.com/img/spark-tuning/sort-shuffle-bypass.png" alt="img"></p><h2 id="shuffleç›¸å…³å‚æ•°è°ƒä¼˜"><a href="#shuffleç›¸å…³å‚æ•°è°ƒä¼˜" class="headerlink" title="shuffleç›¸å…³å‚æ•°è°ƒä¼˜"></a>shuffleç›¸å…³å‚æ•°è°ƒä¼˜</h2><p>ä»¥ä¸‹æ˜¯Shffuleè¿‡ç¨‹ä¸­çš„ä¸€äº›ä¸»è¦å‚æ•°ï¼Œè¿™é‡Œè¯¦ç»†è®²è§£äº†å„ä¸ªå‚æ•°çš„åŠŸèƒ½ã€é»˜è®¤å€¼ä»¥åŠåŸºäºå®è·µç»éªŒç»™å‡ºçš„è°ƒä¼˜å»ºè®®ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">Sparkconf</span>()</span><br><span class="line">conf.set(<span class="string">"spark.shuffle.manager"</span>,<span class="string">"hash"</span>)</span><br><span class="line">conf.set(<span class="string">"spark.shuffle.consolidateFiles"</span>,<span class="literal">true</span>)</span><br><span class="line">....</span><br><span class="line"><span class="comment">// ç±»ä¼¼äºè¿™æ ·è®¾ç½®</span></span><br></pre></td></tr></table></figure><h3 id="spark-shuffle-file-buffer"><a href="#spark-shuffle-file-buffer" class="headerlink" title="spark.shuffle.file.buffer"></a>spark.shuffle.file.buffer</h3><ul><li><strong>é»˜è®¤å€¼ï¼š32k</strong></li><li>å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°<strong>ç”¨äºè®¾ç½®<code>shuffle write task</code>çš„<code>BufferedOutputStream</code>çš„<code>buffer</code>ç¼“å†²å¤§å°</strong>ã€‚å°†æ•°æ®å†™åˆ°ç£ç›˜æ–‡ä»¶ä¹‹å‰ï¼Œä¼šå…ˆå†™å…¥bufferç¼“å†²ä¸­ï¼Œå¾…ç¼“å†²å†™æ»¡ä¹‹åï¼Œæ‰ä¼šæº¢å†™åˆ°ç£ç›˜ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šå¦‚æœä½œä¸šå¯ç”¨çš„å†…å­˜èµ„æºè¾ƒä¸ºå……è¶³çš„è¯ï¼Œå¯ä»¥é€‚å½“å¢åŠ è¿™ä¸ªå‚æ•°çš„å¤§å°ï¼ˆæ¯”å¦‚64kï¼‰ï¼Œä»è€Œå‡å°‘<code>shuffle write</code>è¿‡ç¨‹ä¸­æº¢å†™ç£ç›˜æ–‡ä»¶çš„æ¬¡æ•°ï¼Œä¹Ÿå°±å¯ä»¥å‡å°‘ç£ç›˜IOæ¬¡æ•°ï¼Œè¿›è€Œæå‡æ€§èƒ½ã€‚<strong>åœ¨å®è·µä¸­å‘ç°ï¼Œåˆç†è°ƒèŠ‚è¯¥å‚æ•°ï¼Œæ€§èƒ½ä¼šæœ‰1%~5%çš„æå‡ã€‚</strong></li></ul><h3 id="spark-reducer-maxSizeInFlight"><a href="#spark-reducer-maxSizeInFlight" class="headerlink" title="spark.reducer.maxSizeInFlight"></a>spark.reducer.maxSizeInFlight</h3><ul><li><strong>é»˜è®¤å€¼ï¼š48m</strong></li><li>å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®<strong>shuffle read taskçš„bufferç¼“å†²å¤§å°</strong>ï¼Œè€Œè¿™ä¸ªbufferç¼“å†²å†³å®šäº†æ¯æ¬¡èƒ½å¤Ÿæ‹‰å–å¤šå°‘æ•°æ®ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šå¦‚æœä½œä¸šå¯ç”¨çš„å†…å­˜èµ„æºè¾ƒä¸ºå……è¶³çš„è¯ï¼Œå¯ä»¥é€‚å½“å¢åŠ è¿™ä¸ªå‚æ•°çš„å¤§å°ï¼ˆæ¯”å¦‚96mï¼‰ï¼Œä»è€Œå‡å°‘æ‹‰å–æ•°æ®çš„æ¬¡æ•°ï¼Œä¹Ÿå°±å¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“çš„æ¬¡æ•°ï¼Œè¿›è€Œæå‡æ€§èƒ½ã€‚åœ¨å®è·µä¸­å‘ç°ï¼Œåˆç†è°ƒèŠ‚è¯¥å‚æ•°ï¼Œæ€§èƒ½ä¼šæœ‰1%~5%çš„æå‡ã€‚</li></ul><h3 id="spark-shuffle-io-maxRetries"><a href="#spark-shuffle-io-maxRetries" class="headerlink" title="spark.shuffle.io.maxRetries"></a>spark.shuffle.io.maxRetries</h3><ul><li><strong>é»˜è®¤å€¼ï¼š3</strong></li><li>å‚æ•°è¯´æ˜ï¼šshuffle read taskä»shuffle write taskæ‰€åœ¨èŠ‚ç‚¹æ‹‰å–å±äºè‡ªå·±çš„æ•°æ®æ—¶ï¼Œå¦‚æœå› ä¸ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ‹‰å–å¤±è´¥ï¼Œæ˜¯ä¼šè‡ªåŠ¨è¿›è¡Œé‡è¯•çš„ã€‚è¯¥å‚æ•°å°±ä»£è¡¨äº†<strong>å¯ä»¥é‡è¯•çš„æœ€å¤§æ¬¡æ•°</strong>ã€‚å¦‚æœåœ¨æŒ‡å®šæ¬¡æ•°ä¹‹å†…æ‹‰å–è¿˜æ˜¯æ²¡æœ‰æˆåŠŸï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´ä½œä¸šæ‰§è¡Œå¤±è´¥ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šå¯¹äºé‚£äº›åŒ…å«äº†ç‰¹åˆ«è€—æ—¶çš„shuffleæ“ä½œçš„ä½œä¸šï¼Œå»ºè®®å¢åŠ é‡è¯•æœ€å¤§æ¬¡æ•°ï¼ˆæ¯”å¦‚60æ¬¡ï¼‰ï¼Œä»¥é¿å…ç”±äºJVMçš„full gcæˆ–è€…ç½‘ç»œä¸ç¨³å®šç­‰å› ç´ å¯¼è‡´çš„æ•°æ®æ‹‰å–å¤±è´¥ã€‚åœ¨å®è·µä¸­å‘ç°ï¼Œ<strong>å¯¹äºé’ˆå¯¹è¶…å¤§æ•°æ®é‡ï¼ˆæ•°åäº¿~ä¸Šç™¾äº¿ï¼‰çš„shuffleè¿‡ç¨‹ï¼Œè°ƒèŠ‚è¯¥å‚æ•°å¯ä»¥å¤§å¹…åº¦æå‡ç¨³å®šæ€§ã€‚</strong></li></ul><h3 id="spark-shuffle-io-retryWait"><a href="#spark-shuffle-io-retryWait" class="headerlink" title="spark.shuffle.io.retryWait"></a>spark.shuffle.io.retryWait</h3><ul><li><strong>é»˜è®¤å€¼ï¼š5s</strong></li><li>å‚æ•°è¯´æ˜ï¼šå…·ä½“è§£é‡ŠåŒä¸Šï¼Œè¯¥å‚æ•°ä»£è¡¨äº†<strong>æ¯æ¬¡é‡è¯•æ‹‰å–æ•°æ®çš„ç­‰å¾…é—´éš”ï¼Œé»˜è®¤æ˜¯5sã€‚</strong></li><li>è°ƒä¼˜å»ºè®®ï¼š<strong>å»ºè®®åŠ å¤§é—´éš”æ—¶é•¿ï¼ˆæ¯”å¦‚60sï¼‰ï¼Œä»¥å¢åŠ shuffleæ“ä½œçš„ç¨³å®šæ€§ã€‚</strong></li></ul><h3 id="spark-shuffle-memoryFraction-1"><a href="#spark-shuffle-memoryFraction-1" class="headerlink" title="spark.shuffle.memoryFraction"></a>spark.shuffle.memoryFraction</h3><ul><li><strong>é»˜è®¤å€¼ï¼š0.2</strong></li><li>å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ä»£è¡¨äº†Executorå†…å­˜ä¸­ï¼Œåˆ†é…ç»™shuffle read taskè¿›è¡Œèšåˆæ“ä½œçš„å†…å­˜æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯20%ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šåœ¨èµ„æºå‚æ•°è°ƒä¼˜ä¸­è®²è§£è¿‡è¿™ä¸ªå‚æ•°ã€‚å¦‚æœå†…å­˜å……è¶³ï¼Œè€Œä¸”å¾ˆå°‘ä½¿ç”¨æŒä¹…åŒ–æ“ä½œï¼Œå»ºè®®è°ƒé«˜è¿™ä¸ªæ¯”ä¾‹ï¼Œç»™shuffle readçš„èšåˆæ“ä½œæ›´å¤šå†…å­˜ï¼Œä»¥é¿å…ç”±äºå†…å­˜ä¸è¶³å¯¼è‡´èšåˆè¿‡ç¨‹ä¸­é¢‘ç¹è¯»å†™ç£ç›˜ã€‚åœ¨å®è·µä¸­å‘ç°ï¼Œ<strong>åˆç†è°ƒèŠ‚è¯¥å‚æ•°å¯ä»¥å°†æ€§èƒ½æå‡10%å·¦å³ã€‚</strong></li></ul><h3 id="spark-shuffle-manager"><a href="#spark-shuffle-manager" class="headerlink" title="spark.shuffle.manager"></a>spark.shuffle.manager</h3><ul><li><strong>é»˜è®¤å€¼ï¼šsort</strong></li><li>å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°<strong>ç”¨äºè®¾ç½®ShuffleManagerçš„ç±»å‹</strong>ã€‚<strong><code>Spark 1.5</code>ä»¥åï¼Œæœ‰ä¸‰ä¸ªå¯é€‰é¡¹ï¼š<code>hash</code>ã€<code>sort</code>å’Œ<code>tungsten-sort</code>ã€‚</strong><code>HashShuffleManager</code>æ˜¯<code>Spark 1.2</code>ä»¥å‰çš„é»˜è®¤é€‰é¡¹ï¼Œä½†æ˜¯<code>Spark 1.2</code><strong>ä»¥åŠä¹‹å</strong>çš„ç‰ˆæœ¬<strong>é»˜è®¤éƒ½æ˜¯<code>SortShuffleManager</code>äº†</strong>ã€‚<code>tungsten-sort</code>ä¸sortç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨äº†tungstenè®¡åˆ’ä¸­çš„<strong>å †å¤–å†…å­˜ç®¡ç†æœºåˆ¶</strong>ï¼Œå†…å­˜ä½¿ç”¨æ•ˆç‡æ›´é«˜ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šç”±äºSortShuffleManageré»˜è®¤ä¼šå¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œå› æ­¤å¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘ä¸­<strong>éœ€è¦è¯¥æ’åºæœºåˆ¶</strong>çš„è¯ï¼Œåˆ™<strong>ä½¿ç”¨é»˜è®¤çš„SortShuffleManagerå°±å¯ä»¥</strong>ï¼›è€Œå¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘<strong>ä¸éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åº</strong>ï¼Œé‚£ä¹ˆå»ºè®®å‚è€ƒåé¢çš„å‡ ä¸ªå‚æ•°è°ƒä¼˜ï¼Œ<strong>é€šè¿‡bypassæœºåˆ¶æˆ–ä¼˜åŒ–çš„HashShuffleManageræ¥é¿å…æ’åºæ“ä½œ</strong>ï¼ŒåŒæ—¶æä¾›è¾ƒå¥½çš„ç£ç›˜è¯»å†™æ€§èƒ½ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œtungsten-sortè¦æ…ç”¨ï¼Œå› ä¸ºä¹‹å‰å‘ç°äº†ä¸€äº›ç›¸åº”çš„bugã€‚</li></ul><h3 id="spark-shuffle-sort-bypassMergeThreshold"><a href="#spark-shuffle-sort-bypassMergeThreshold" class="headerlink" title="spark.shuffle.sort.bypassMergeThreshold"></a>spark.shuffle.sort.bypassMergeThreshold</h3><ul><li><strong>é»˜è®¤å€¼ï¼š200</strong></li><li>å‚æ•°è¯´æ˜ï¼šå½“ShuffleManagerä¸ºSortShuffleManageræ—¶ï¼Œå¦‚æœshuffle read taskçš„æ•°é‡å°äºè¿™ä¸ªé˜ˆå€¼ï¼ˆé»˜è®¤æ˜¯200ï¼‰ï¼Œåˆ™shuffle writeè¿‡ç¨‹ä¸­ä¸ä¼šè¿›è¡Œæ’åºæ“ä½œï¼Œè€Œæ˜¯ç›´æ¥æŒ‰ç…§æœªç»ä¼˜åŒ–çš„HashShuffleManagerçš„æ–¹å¼å»å†™æ•°æ®ï¼Œä½†æ˜¯æœ€åä¼šå°†æ¯ä¸ªtaskäº§ç”Ÿçš„æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¼šåˆ›å»ºå•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šå½“ä½ <strong>ä½¿ç”¨<code>SortShuffleManager</code>æ—¶ï¼Œå¦‚æœçš„ç¡®<code>ä¸éœ€è¦</code>æ’åºæ“ä½œï¼Œé‚£ä¹ˆå»ºè®®å°†è¿™ä¸ªå‚æ•°è°ƒå¤§ä¸€äº›ï¼Œå¤§äºshuffle read taskçš„æ•°é‡</strong>ã€‚é‚£ä¹ˆæ­¤æ—¶å°±ä¼šè‡ªåŠ¨å¯ç”¨bypassæœºåˆ¶ï¼Œmap-sideå°±ä¸ä¼šè¿›è¡Œæ’åºäº†ï¼Œå‡å°‘äº†æ’åºçš„æ€§èƒ½å¼€é”€ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¸‹ï¼Œä¾ç„¶ä¼šäº§ç”Ÿå¤§é‡çš„ç£ç›˜æ–‡ä»¶ï¼Œå› æ­¤shuffle writeæ€§èƒ½æœ‰å¾…æé«˜ã€‚</li></ul><h3 id="spark-shuffle-consolidateFiles"><a href="#spark-shuffle-consolidateFiles" class="headerlink" title="spark.shuffle.consolidateFiles"></a>spark.shuffle.consolidateFiles</h3><ul><li><strong>é»˜è®¤å€¼ï¼šfalse</strong></li><li>å‚æ•°è¯´æ˜ï¼š<strong>å¦‚æœä½¿ç”¨HashShuffleManagerï¼Œè¯¥å‚æ•°æœ‰æ•ˆã€‚</strong>å¦‚æœè®¾ç½®ä¸º<strong>true</strong>ï¼Œé‚£ä¹ˆå°±ä¼š<strong>å¼€å¯consolidateæœºåˆ¶</strong>ï¼Œä¼š<strong>å¤§å¹…åº¦åˆå¹¶shuffle writeçš„è¾“å‡ºæ–‡ä»¶</strong>ï¼Œå¯¹äºshuffle read taskæ•°é‡ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥æå¤§åœ°å‡å°‘ç£ç›˜IOå¼€é”€ï¼Œæå‡æ€§èƒ½ã€‚</li><li>è°ƒä¼˜å»ºè®®ï¼šå¦‚æœçš„ç¡®ä¸éœ€è¦SortShuffleManagerçš„æ’åºæœºåˆ¶ï¼Œé‚£ä¹ˆé™¤äº†ä½¿ç”¨bypassæœºåˆ¶ï¼Œè¿˜<strong>å¯ä»¥å°è¯•å°†spark.shffle.managerå‚æ•°æ‰‹åŠ¨æŒ‡å®šä¸ºhashï¼Œä½¿ç”¨HashShuffleManagerï¼ŒåŒæ—¶å¼€å¯consolidateæœºåˆ¶ã€‚</strong>åœ¨å®è·µä¸­å°è¯•è¿‡ï¼Œå‘ç°<strong>å…¶æ€§èƒ½æ¯”å¼€å¯äº†bypassæœºåˆ¶çš„SortShuffleManagerè¦é«˜å‡º10%~30%ã€‚</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;Sparkæ•´å¥—è°ƒä¼˜æ–¹æ¡ˆä¸»è¦åˆ†ä¸ºå¼€å‘è°ƒä¼˜ã€èµ„æºè°ƒä¼˜ã€æ•°æ®å€¾æ–œè°ƒä¼˜ã€shuffleè°ƒä¼˜å‡ ä¸ªéƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¼€å‘è°ƒä¼˜å’Œèµ„æºè°ƒ
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="ç²¾è®²" scheme="https://airpoet.github.io/categories/Spark/%E7%B2%BE%E8%AE%B2/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>Sparké‡ç‚¹è§£æ(ä¸€) =&gt; SparkCore</title>
    <link href="https://airpoet.github.io/2018/07/25/Spark/Spark%E9%87%8D%E7%82%B9%E8%A7%A3%E6%9E%90(%E4%B8%80)%20=%3E%20SparkCore/"/>
    <id>https://airpoet.github.io/2018/07/25/Spark/Sparké‡ç‚¹è§£æ(ä¸€) =&gt; SparkCore/</id>
    <published>2018-07-25T06:58:04.056Z</published>
    <updated>2018-07-28T03:23:35.440Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-Spark-ä¸-MapReduce-åŒºåˆ«"><a href="#ä¸€-Spark-ä¸-MapReduce-åŒºåˆ«" class="headerlink" title="ä¸€. Spark ä¸ MapReduce åŒºåˆ«"></a>ä¸€. Spark ä¸ MapReduce åŒºåˆ«</h1><p><strong>Apache Sparkâ„¢</strong> is a fast and general engine for large-scale data processing.</p><p><strong>ä¸mapreduceæ¯”è¾ƒ </strong>ï¼š</p><ul><li><p>Sparkå¤§å¤šæ•°æ‰§è¡Œè¿‡ç¨‹æ˜¯åŸºäºå†…å­˜çš„è¿­ä»£</p></li><li><p>MapReduce çš„ ä¼˜ç‚¹, SparkCore éƒ½æœ‰</p></li><li><p>Hive èƒ½åšçš„æ“ä½œ, SparkSQL éƒ½èƒ½åš, å¯ä»¥å†™ SQL è¯­å¥è½¬æ¢ä¸º SparkCore ä»£ç </p></li><li><p>Spark Streaming æä¾›è¿‘å®æ—¶æµ</p></li><li><p>è¶…è¿‡80ä¸ªç±»ä¼¼äº map, reduce è¿™æ ·çš„æ“ä½œ</p></li><li><p>å¯ä»¥åœ¨<a href="http://www.alluxio.org/" target="_blank" rel="noopener">Tachyon</a>ï¼ˆåŸºäºå†…å­˜çš„åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿ (HDFS æ˜¯åŸºäºç£ç›˜)) ä¸Šè¿è¡ŒSpark, ä¼šæ›´å¿«</p></li></ul><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-25-070107.png" alt="image-20180725150106695"></p><hr><h1 id="äºŒ-ä»€ä¹ˆæ˜¯RDD"><a href="#äºŒ-ä»€ä¹ˆæ˜¯RDD" class="headerlink" title="äºŒ. ä»€ä¹ˆæ˜¯RDD"></a>äºŒ. ä»€ä¹ˆæ˜¯RDD</h1><p>1ã€RDDæ˜¯Sparkæä¾›çš„æ ¸å¿ƒ<strong>æŠ½è±¡</strong>ï¼Œå…¨ç§°ä¸ºResillient Distributed Datasetï¼Œå³<strong>å¼¹æ€§</strong>åˆ†å¸ƒå¼æ•°æ®é›†ã€‚</p><p>2ã€RDDåœ¨æŠ½è±¡ä¸Šæ¥è¯´æ˜¯ä¸€ç§å…ƒç´ é›†åˆï¼ŒåŒ…å«äº†æ•°æ®ã€‚å®ƒæ˜¯<strong>è¢«åˆ†åŒºçš„</strong>ï¼Œåˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºåˆ†å¸ƒåœ¨é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œä»è€Œè®©RDDä¸­çš„æ•°æ®å¯ä»¥è¢«å¹¶è¡Œæ“ä½œã€‚ï¼ˆåˆ†å¸ƒå¼æ•°æ®é›†ï¼‰</p><ul><li>å¦‚æœè¯»å–çš„æ–‡ä»¶æœ¬æ¥å°±å­˜åœ¨äº3ä¸ªåˆ†åŒº, è¿™äº›æ“ä½œä¼šå¹¶è¡Œæ“ä½œ, å¦‚ä½•å¹¶è¡Œæ“ä½œ?  :TODO</li><li>å¦‚æœå­˜åœ¨äº3ä¸ªåˆ†åŒº, æ‰‹åŠ¨è§„å®šäº†2ä¸ªåˆ†åŒº, é‚£ä¹ˆæ˜¯å¦‚ä½•å·¥ä½œçš„ ? :TODO</li></ul><p>3ã€RDDé€šå¸¸<strong>é€šè¿‡Hadoopä¸Šçš„æ–‡ä»¶</strong>ï¼Œå³HDFSæ–‡ä»¶æˆ–è€…Hiveè¡¨ï¼Œæ¥è¿›è¡Œ<strong>åˆ›å»º</strong>ï¼›æœ‰æ—¶ä¹Ÿå¯ä»¥<strong>é€šè¿‡åº”ç”¨ç¨‹åºä¸­çš„é›†åˆæ¥åˆ›å»º</strong>ã€‚</p><ul><li><strong>ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–</strong>: local æˆ– HDFS <code>sc.textFile(&quot;/Users/shixuanji/Documents/a.txt&quot;,2);</code></li><li>Hive è¡¨: : TODO</li><li>å¹¶è¡ŒåŒ–çš„æ–¹å¼åˆ›å»º(å¤šç”¨äºæµ‹è¯•): <code>val rdd = sc.makeRDD(1 to 10)</code>  æˆ–è€… <code>val rdd = sc.parallelize(arr);</code></li></ul><p>4ã€RDDæœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯ï¼Œæä¾›äº†<strong>å®¹é”™æ€§</strong>ï¼Œå¯ä»¥è‡ªåŠ¨ä»èŠ‚ç‚¹å¤±è´¥ä¸­æ¢å¤è¿‡æ¥ã€‚å³å¦‚æœæŸä¸ªèŠ‚ç‚¹ä¸Šçš„RDD partitionï¼Œå› ä¸ºèŠ‚ç‚¹æ•…éšœï¼Œå¯¼è‡´æ•°æ®ä¸¢äº†ï¼Œé‚£ä¹ˆ<strong>RDDä¼šè‡ªåŠ¨é€šè¿‡è‡ªå·±çš„æ•°æ®æ¥æºé‡æ–°è®¡ç®—è¯¥partition</strong>ã€‚è¿™ä¸€åˆ‡å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ã€‚</p><p>5ã€RDDçš„æ•°æ®<strong>é»˜è®¤</strong>æƒ…å†µä¸‹å­˜<strong>æ”¾åœ¨å†…å­˜</strong>ä¸­çš„ï¼Œä½†æ˜¯åœ¨<strong>å†…å­˜èµ„æºä¸è¶³æ—¶</strong>ï¼ŒSpark<strong>ä¼šè‡ªåŠ¨å°†RDDæ•°æ®å†™å…¥ç£ç›˜</strong>ã€‚ï¼ˆå¼¹æ€§ == çµæ´»ï¼‰</p><blockquote><p><strong>ä¸‹å›¾ä¸­ç”»æ©™è‰²æ¡†çš„éƒ½æ˜¯ RDD </strong></p></blockquote><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-25-070716.png" alt="image-20180725150715950"></p><h4 id="æºç ä¸­çš„æ³¨é‡Šè¯´æ˜"><a href="#æºç ä¸­çš„æ³¨é‡Šè¯´æ˜" class="headerlink" title="æºç ä¸­çš„æ³¨é‡Šè¯´æ˜"></a><strong>æºç ä¸­çš„æ³¨é‡Šè¯´æ˜</strong></h4><p>1ã€A list of partitionsï¼šä¸€ç»„åˆ†ç‰‡ï¼ˆPartitionï¼‰ï¼Œå³æ•°æ®é›†çš„åŸºæœ¬ç»„æˆå•ä½</p><p>2ã€A function for computing each splitï¼šä¸€ä¸ªè®¡ç®—æ¯ä¸ªåˆ†åŒºçš„å‡½æ•°</p><p>3ã€A list of dependencies on other RDDsï¼šRDD ä¹‹é—´çš„ä¾èµ–å…³ç³»</p><ul><li>NarrowDependency   å®Œå…¨ä¾èµ–, çª„ä¾èµ–</li><li>ShuffleDependency   éƒ¨åˆ†ä¾èµ–, â€˜â€™å®½ä¾èµ–â€™â€™</li></ul><p>4ã€Optionally, a Partitioner for <strong>key-value RDDs</strong> (e.g. to say that the RDD is hash-partitioned)ï¼š</p><ul><li>Partitioner: è‡ªå®šä¹‰åˆ†åŒºä½¿ç”¨</li></ul><p>5ã€Optionally, a list of preferred locations to compute each split on (e.g. block locations for an HDFS file)ï¼šä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜å‚¨å­˜å–æ¯ä¸ª Partition çš„ä¼˜å…ˆä½ç½®ï¼ˆpreferred locationï¼‰ã€‚</p><h4 id="Spark-ä¸­å…¶å®ƒé‡è¦æ¦‚å¿µ"><a href="#Spark-ä¸­å…¶å®ƒé‡è¦æ¦‚å¿µ" class="headerlink" title="Spark ä¸­å…¶å®ƒé‡è¦æ¦‚å¿µ"></a>Spark ä¸­å…¶å®ƒé‡è¦æ¦‚å¿µ</h4><p><strong>Cluster Manager</strong>ï¼šSpark çš„é›†ç¾¤ç®¡ç†å™¨ï¼Œä¸»è¦è´Ÿè´£èµ„æºçš„åˆ†é…ä¸ç®¡ç†ã€‚é›†ç¾¤ç®¡ç†å™¨åˆ†é…çš„èµ„ æºå±äºä¸€çº§åˆ†é…ï¼Œå®ƒå°†å„ä¸ª Worker ä¸Šçš„å†…å­˜ã€CPU ç­‰èµ„æºåˆ†é…ç»™åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯å¹¶ä¸è´Ÿè´£ å¯¹ Executor çš„èµ„æºåˆ†é…ã€‚ç›®å‰ï¼ŒStandaloneã€YARNã€Mesosã€K8Sï¼ŒEC2 ç­‰éƒ½å¯ä»¥ä½œä¸º Spark çš„é›†ç¾¤ç®¡ç†å™¨ã€‚</p><p><strong>Master</strong>ï¼šSpark é›†ç¾¤çš„ä¸»èŠ‚ç‚¹ã€‚</p><p><strong>Worker</strong>ï¼šSpark é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ã€‚å¯¹ Spark åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œç”±é›†ç¾¤ç®¡ç†å™¨åˆ†é…å¾—åˆ°èµ„æºçš„ Worker èŠ‚ç‚¹ä¸»è¦è´Ÿè´£ä»¥ä¸‹å·¥ä½œï¼šåˆ›å»º Executorï¼Œå°†èµ„æºå’Œä»»åŠ¡è¿›ä¸€æ­¥åˆ†é…ç»™ Executorï¼ŒåŒæ­¥ èµ„æºä¿¡æ¯ç»™ Cluster Managerã€‚</p><p><strong>Executor</strong>ï¼šæ‰§è¡Œè®¡ç®—ä»»åŠ¡çš„ä¸€äº›è¿›ç¨‹ã€‚ä¸»è¦è´Ÿè´£ä»»åŠ¡çš„æ‰§è¡Œä»¥åŠä¸ Workerã€Driver Application çš„ä¿¡æ¯åŒæ­¥ã€‚</p><p><strong>Driver Appicationï¼š</strong>å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼Œç”¨äºå°†ä»»åŠ¡ç¨‹åºè½¬æ¢ ä¸º RDD å’Œ DAGï¼Œå¹¶ä¸ Cluster Manager è¿›è¡Œé€šä¿¡ä¸è°ƒåº¦ã€‚</p><p><strong>å…³ç³»</strong>:</p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-093416.png" alt="image-20180726173416513"></p><hr><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-093433.png" alt="image-20180726173433286"></p><p>1ã€ç”¨æˆ·ä½¿ç”¨ SparkContext æä¾›çš„ APIï¼ˆå¸¸ç”¨çš„æœ‰ textFileã€sequenceFileã€runJobã€stop ç­‰ï¼‰ ç¼–å†™ Driver Application ç¨‹åºã€‚æ­¤å¤– SQLContextã€HiveContext åŠ StreamingContext å¯¹ SparkContext è¿›è¡Œå°è£…ï¼Œå¹¶æä¾›äº† SQLã€Hive åŠæµå¼è®¡ç®—ç›¸å…³çš„ APIã€‚</p><p>2ã€ä½¿ç”¨ SparkContext æäº¤çš„ç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œé¦–å…ˆä¼šä½¿ç”¨ BlockManager å’Œ BroadcastManager å°†ä»»åŠ¡çš„ Hadoop é…ç½®è¿›è¡Œå¹¿æ’­ã€‚ç„¶åç”± DAGScheduler å°†ä»»åŠ¡è½¬æ¢ä¸º RDD å¹¶ç»„ç»‡æˆ DAGï¼Œ DAG è¿˜å°†è¢«åˆ’åˆ†ä¸ºä¸åŒçš„ Stageã€‚<strong>æœ€åç”± TaskScheduler å€ŸåŠ© ActorSystem å°†ä»»åŠ¡æäº¤ç»™é›†ç¾¤ ç®¡ç†å™¨ï¼ˆCluster Managerï¼‰ã€‚</strong></p><p>3ã€é›†ç¾¤ç®¡ç†å™¨ï¼ˆClusterManagerï¼‰ç»™ä»»åŠ¡åˆ†é…èµ„æºï¼Œå³å°†å…·ä½“ä»»åŠ¡åˆ†é…åˆ° Worker ä¸Šï¼ŒWorker åˆ›å»º Executor æ¥å¤„ç†ä»»åŠ¡çš„è¿è¡Œã€‚Standaloneã€YARNã€Mesosã€EC2 ç­‰éƒ½å¯ä»¥ä½œä¸º Spark çš„é›† ç¾¤ç®¡ç†å™¨ã€‚</p><p><strong>æ³¨æ„:</strong>  å¦‚æœæ˜¯ â€“deploy-mode <strong>client</strong> æ¨¡å¼, <strong>client å°±æ˜¯ Driver</strong>,   â€“deploy-mode <strong>cluster</strong> æ¨¡å¼, <strong>Driver æ˜¯ç”±é›†ç¾¤åˆ†é…çš„ä¸€å° workerèŠ‚ç‚¹</strong></p><h1 id="ä¸‰-Spark-çš„æ¶æ„-standalone"><a href="#ä¸‰-Spark-çš„æ¶æ„-standalone" class="headerlink" title="ä¸‰. Spark çš„æ¶æ„(standalone)"></a>ä¸‰. Spark çš„æ¶æ„(standalone)</h1><p>æ¶‰åŠåˆ°çš„åè¯: <strong>Driver</strong>, <strong>Master</strong>, <strong>Worker</strong>, <strong>Executor</strong> , <strong>Task</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-25-075654.png" alt="image-20180725155654170"></p><hr><h1 id="å››-Spark-ä»»åŠ¡æäº¤"><a href="#å››-Spark-ä»»åŠ¡æäº¤" class="headerlink" title="å››. Spark ä»»åŠ¡æäº¤"></a>å››. Spark ä»»åŠ¡æäº¤</h1><p>å‚è€ƒå®˜ç½‘ <a href="http://spark.apache.org/docs/latest/submitting-applications.html" target="_blank" rel="noopener">http://spark.apache.org/docs/latest/submitting-applications.html</a></p><p><strong>Client</strong>æ¨¡å¼</p><p>ä¸æŒ‡å®š<code>deploy-mode</code> ,é»˜è®¤å°±æ˜¯<strong>client</strong>æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯<strong>å“ªä¸€å°æœåŠ¡å™¨æäº¤</strong>sparkä»£ç ï¼Œé‚£ä¹ˆ<strong>å“ªä¸€å°å°±æ˜¯driveræœåŠ¡å™¨</strong>ã€‚</p><p><strong>Cluster</strong>æ¨¡å¼</p><p>éœ€è¦æŒ‡å®š<code>deploy-mode</code>ï¼ŒdriveræœåŠ¡å™¨å¹¶ä¸æ˜¯æäº¤ä»£ç çš„é‚£ä¸€å°æœåŠ¡å™¨ï¼Œè€Œæ˜¯åœ¨æäº¤ä»£ç çš„æ—¶å€™ï¼Œåœ¨<strong>worker</strong>ä¸»æœºä¸Šï¼Œ<strong>éšæœºæŒ‘é€‰ä¸€å°ä½œä¸ºdriveræœåŠ¡å™¨</strong>ï¼Œé‚£ä¹ˆ<u>å¦‚æœæäº¤10ä¸ªåº”ç”¨ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½10å°driveræœåŠ¡å™¨</u>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run application locally on 8 cores</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master <span class="built_in">local</span>[8] \</span><br><span class="line">  /path/to/examples.jar \</span><br><span class="line">  100</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run on a Spark standalone cluster in client deploy mode</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master spark://207.184.161.138:7077 \</span><br><span class="line">  --executor-memory 20G \</span><br><span class="line">  --total-executor-cores 100 \</span><br><span class="line">  /path/to/examples.jar \</span><br><span class="line">  1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run on a Spark standalone cluster in cluster deploy mode with supervise</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master spark://207.184.161.138:7077 \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --supervise \</span><br><span class="line">  --executor-memory 20G \</span><br><span class="line">  --total-executor-cores 100 \</span><br><span class="line">  /path/to/examples.jar \</span><br><span class="line">  1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run on a YARN cluster</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=XXX</span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \  <span class="comment"># can be client for client mode</span></span><br><span class="line">  --executor-memory 20G \</span><br><span class="line">  --num-executors 50 \</span><br><span class="line">  /path/to/examples.jar \</span><br><span class="line">  1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a Python application on a Spark standalone cluster</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --master spark://207.184.161.138:7077 \</span><br><span class="line">  examples/src/main/python/pi.py \</span><br><span class="line">  1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run on a Mesos cluster in cluster deploy mode with supervise</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master mesos://207.184.161.138:7077 \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --supervise \</span><br><span class="line">  --executor-memory 20G \</span><br><span class="line">  --total-executor-cores 100 \</span><br><span class="line">  http://path/to/examples.jar \</span><br><span class="line">  1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run on a Kubernetes cluster in cluster deploy mode</span></span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --master k8s://xx.yy.zz.ww:443 \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory 20G \</span><br><span class="line">  --num-executors 50 \</span><br><span class="line">  http://path/to/examples.jar \</span><br><span class="line">  1000</span><br></pre></td></tr></table></figure><hr><h1 id="äº”-Transformationå’ŒactionåŸç†"><a href="#äº”-Transformationå’ŒactionåŸç†" class="headerlink" title="äº”. Transformationå’ŒactionåŸç†"></a>äº”. Transformationå’ŒactionåŸç†</h1><p><strong>Sparkæ”¯æŒä¸¤ç§RDDæ“ä½œï¼š<code>transformation</code>å’Œ<code>action</code></strong>ã€‚</p><ul><li><code>transformation</code>æ“ä½œä¼š<strong>é’ˆå¯¹å·²æœ‰çš„RDDåˆ›å»ºä¸€ä¸ªæ–°çš„RDD</strong>ï¼›</li><li>è€Œ<code>action</code>åˆ™ä¸»è¦æ˜¯å¯¹RDDè¿›è¡Œæœ€åçš„æ“ä½œï¼Œæ¯”å¦‚éå†ã€reduceã€ä¿å­˜åˆ°æ–‡ä»¶ç­‰ï¼Œå¹¶å¯ä»¥<strong>è¿”å›ç»“æœç»™Driverç¨‹åº</strong>ã€‚</li></ul><p>ä¾‹å¦‚ï¼Œmapå°±æ˜¯ä¸€ç§transformationæ“ä½œï¼Œå®ƒç”¨äºå°†å·²æœ‰RDDçš„æ¯ä¸ªå…ƒç´ ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°ï¼Œå¹¶è·å–ä¸€ä¸ªæ–°çš„å…ƒç´ ï¼Œç„¶åå°†æ‰€æœ‰çš„æ–°å…ƒç´ ç»„æˆä¸€ä¸ªæ–°çš„RDDã€‚è€Œreduceå°±æ˜¯ä¸€ç§actionæ“ä½œï¼Œå®ƒç”¨äºå¯¹RDDä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œèšåˆæ“ä½œï¼Œå¹¶è·å–ä¸€ä¸ªæœ€ç»ˆçš„ç»“æœï¼Œç„¶åè¿”å›ç»™Driverç¨‹åºã€‚</p><p><strong>transformationçš„ç‰¹ç‚¹å°±æ˜¯lazyç‰¹æ€§</strong>ã€‚lazyç‰¹æ€§æŒ‡çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªsparkåº”ç”¨ä¸­åªå®šä¹‰äº†transformationæ“ä½œï¼Œé‚£ä¹ˆå³ä½¿ä½ æ‰§è¡Œè¯¥åº”ç”¨ï¼Œè¿™äº›æ“ä½œä¹Ÿä¸ä¼šæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œtransformationæ˜¯ä¸ä¼šè§¦å‘sparkç¨‹åºçš„æ‰§è¡Œçš„ï¼Œå®ƒä»¬åªæ˜¯è®°å½•äº†å¯¹RDDæ‰€åšçš„æ“ä½œï¼Œä½†æ˜¯ä¸ä¼šè‡ªå‘çš„æ‰§è¡Œã€‚åªæœ‰å½“transformationä¹‹åï¼Œæ¥ç€æ‰§è¡Œäº†ä¸€ä¸ªactionæ“ä½œï¼Œé‚£ä¹ˆæ‰€æœ‰çš„transformationæ‰ä¼šæ‰§è¡Œã€‚<strong>Sparké€šè¿‡è¿™ç§lazyç‰¹æ€§ï¼Œæ¥è¿›è¡Œåº•å±‚çš„sparkåº”ç”¨æ‰§è¡Œçš„ä¼˜åŒ–ï¼Œ<u>é¿å…äº§ç”Ÿè¿‡å¤šä¸­é—´ç»“æœ</u>ã€‚</strong></p><p><strong>actionæ“ä½œæ‰§è¡Œï¼Œä¼šè§¦å‘ä¸€ä¸ª<code>spark job</code>çš„è¿è¡Œï¼Œä»è€Œè§¦å‘è¿™ä¸ªactionä¹‹å‰æ‰€æœ‰çš„transformationçš„æ‰§è¡Œã€‚</strong>è¿™æ˜¯actionçš„ç‰¹æ€§ã€‚</p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-25-084407.png" alt="image-20180725164407028"></p><hr><h1 id="å…­-Transformation-å’Œ-Action-ç®—å­"><a href="#å…­-Transformation-å’Œ-Action-ç®—å­" class="headerlink" title="å…­. Transformation å’Œ Action ç®—å­"></a>å…­. Transformation å’Œ Action ç®—å­</h1><h2 id="1-Transformation-ç®—å­"><a href="#1-Transformation-ç®—å­" class="headerlink" title="1.Transformation ç®—å­"></a>1.Transformation ç®—å­</h2><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/TransfromationOperation.java" target="_blank" rel="noopener">Java ç‰ˆä»£ç , è§è¿™é‡Œ &amp; ä¸Šå±‚ç›®å½•</a> </p><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/TransformationOperations.scala" target="_blank" rel="noopener">Scala ç‰ˆä»£ç , è§è¿™é‡Œ &amp; ä¸Šå±‚ç›®å½•</a></p><p><strong>æˆ– ../</strong></p><h4 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h4><p>å¯¹è°ƒç”¨mapçš„RDDæ•°æ®é›†ä¸­çš„æ¯ä¸ªelementéƒ½ä½¿ç”¨funcï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„RDD,è¿™ä¸ªè¿”å›çš„æ•°æ®é›†æ˜¯åˆ†å¸ƒå¼çš„æ•°æ®é›†</p><h4 id="filter"><a href="#filter" class="headerlink" title="filter:"></a>filter:</h4><p>å¯¹è°ƒç”¨filterçš„RDDæ•°æ®é›†ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä½¿ç”¨funcï¼Œç„¶åè¿”å›ä¸€ä¸ªåŒ…å«ä½¿funcä¸ºtrueçš„å…ƒç´ æ„æˆçš„RDD</p><h4 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap:"></a>flatMap:</h4><p>å’Œmapå·®ä¸å¤šï¼Œä½†æ˜¯flatMapç”Ÿæˆçš„æ˜¯å¤šä¸ªç»“æœ</p><h4 id="groupByKey-reduceByKey-sortByKey"><a href="#groupByKey-reduceByKey-sortByKey" class="headerlink" title="groupByKey, reduceByKey, sortByKey :"></a>groupByKey, reduceByKey, sortByKey :</h4><p>å‡¡æ˜¯è¿™ç§.. ByKey çš„, å¿…é¡»ä¼ å…¥ä¸€ä¸ªå¯¹å¶å…ƒç¥–,  Javaä¸­æ˜¯ JavaPairRdd</p><h4 id="cogroup-ä¸-join-ä¸-union-åŒºåˆ«"><a href="#cogroup-ä¸-join-ä¸-union-åŒºåˆ«" class="headerlink" title="cogroup ä¸ join ä¸ union åŒºåˆ«:"></a>cogroup ä¸ join ä¸ union åŒºåˆ«:</h4><p><a href="http://lxw1234.com/archives/2015/07/384.htm" target="_blank" rel="noopener">è¯¦æƒ…å¯å‚è€ƒ</a></p><ul><li><strong>cogroup</strong><ul><li>ç›¸å½“äºSQLä¸­çš„<strong>å…¨å¤–å…³è”full outer join</strong>ï¼Œè¿”å›å·¦å³RDDä¸­çš„è®°å½•ï¼Œ<strong>å…³è”ä¸ä¸Šçš„ä¸ºç©ºã€‚</strong></li><li>return:   JavaPairRDD[K, (JIterable[V], JIterable[W])</li><li>RDDçš„valueæ˜¯ä¸€ä¸ªPairçš„å®ä¾‹,è¿™ä¸ªå®ä¾‹åŒ…å«ä¸¤ä¸ªIterableçš„å€¼, <code>V</code>è¡¨ç¤ºçš„æ˜¯RDD1ä¸­ç›¸åŒKEYçš„å€¼, <code>W</code>è¡¨ç¤ºçš„æ˜¯RDD2ä¸­ç›¸åŒkeyçš„å€¼. </li></ul></li><li><strong>join</strong><ul><li>ç›¸å½“äºSQLä¸­çš„<strong>å†…å…³è”join</strong>ï¼Œ<strong>åªè¿”å›ä¸¤ä¸ªRDDæ ¹æ®Kå¯ä»¥å…³è”ä¸Šçš„ç»“æœ</strong>ï¼Œjoinåªèƒ½ç”¨äºä¸¤ä¸ªRDDä¹‹é—´çš„å…³è”ï¼Œå¦‚æœè¦å¤šä¸ªRDDå…³è”ï¼Œå¤šå…³è”å‡ æ¬¡å³å¯ã€‚</li></ul></li><li><strong>union</strong><ul><li>æ±‚rddå¹¶é›†ï¼Œä½†æ˜¯ä¸å»é‡</li></ul></li></ul><h4 id="Intersectionï¼ŒDistinctï¼ŒCartesian"><a href="#Intersectionï¼ŒDistinctï¼ŒCartesian" class="headerlink" title="Intersectionï¼ŒDistinctï¼ŒCartesian"></a>Intersectionï¼ŒDistinctï¼ŒCartesian</h4><ul><li><strong>intersection</strong> <ul><li>intersection <strong>æ±‚äº¤é›†</strong>,æå–ä¸¤ä¸ªrddä¸­éƒ½å«æœ‰çš„å…ƒç´ ã€‚</li><li>Returns a new RDD that contains the intersection of elements in the source dataset and the argument.</li></ul></li><li><strong>Distinct</strong> (ç‹¬ç‰¹çš„,æœ‰åŒºåˆ«çš„)<ul><li>å»é‡ </li><li>Return a new RDD containing the distinct elements in this RDD.</li></ul></li><li><strong>Cartesian</strong> (ç¬›å¡å°”ç§¯)<ul><li>ç¬›å¡å°”ç§¯, å…¨è¿æ¥, å‰åé›†åˆä¸ªæ•°ä¸ºa,b,  a x b  ç§ç»„åˆ</li></ul></li></ul><h4 id="mapPartitionï¼Œreparationï¼Œcoalesce"><a href="#mapPartitionï¼Œreparationï¼Œcoalesce" class="headerlink" title="mapPartitionï¼Œreparationï¼Œcoalesce"></a>mapPartitionï¼Œreparationï¼Œcoalesce</h4><ul><li><p><strong>mapPartition</strong></p><ul><li>è¯¥å‡½æ•°å’Œmapå‡½æ•°ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜ å°„å‡½æ•°çš„å‚æ•°<strong>ç”±RDDä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ </strong>å˜æˆäº†<strong><code>RDD</code>ä¸­æ¯ä¸€ä¸ªåˆ†åŒºçš„è¿­ä»£å™¨</strong>ã€‚å¦‚æœåœ¨æ˜ å°„çš„è¿‡ç¨‹ä¸­éœ€è¦é¢‘ç¹åˆ›å»ºé¢å¤–çš„å¯¹è±¡ï¼Œä½¿ç”¨mapPartitionsè¦æ¯”mapé«˜æ•ˆçš„å¤šã€‚ </li><li>æ¯”å¦‚ï¼Œå°†RDDä¸­çš„æ‰€æœ‰æ•°æ®é€šè¿‡JDBCè¿æ¥å†™å…¥æ•°æ®åº“ï¼Œå¦‚æœä½¿ç”¨mapå‡½æ•°ï¼Œå¯èƒ½è¦ä¸ºæ¯ä¸€ä¸ªå…ƒç´ éƒ½åˆ›å»ºä¸€ä¸ª<code>connection</code>ï¼Œè¿™æ ·å¼€é”€å¾ˆå¤§ï¼Œå¦‚æœä½¿ç”¨<code>mapPartitions</code>ï¼Œé‚£ä¹ˆåªéœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ªåˆ†åŒºå»ºç«‹ä¸€ä¸ª<code>connection</code>ã€‚ </li></ul></li><li><p><strong>coalesce</strong> </p><ul><li><strong>coalesce: åªèƒ½ç”¨äºå‡å°‘åˆ†åŒºçš„æ•°é‡</strong>ï¼Œè€Œä¸”<strong>å¯ä»¥é€‰æ‹©ä¸å‘ç”Ÿshuffle</strong> å…¶å®è¯´ç™½äº†ä»–å°±æ˜¯<strong>åˆå¹¶åˆ†åŒº</strong></li><li><strong>repartition:å¯ä»¥å¢åŠ åˆ†åŒºï¼Œä¹Ÿå¯ä»¥å‡å°‘åˆ†åŒº</strong>ï¼Œ<strong>å¿…é¡»ä¼šå‘ç”Ÿshuffle</strong>ï¼Œç›¸å½“äºå°±æ˜¯è¿›è¡Œ<strong>é‡æ–°åˆ†åŒº</strong></li></ul></li><li><p><strong>reparation</strong></p><ul><li>reparitionæ˜¯<code>coalesce shuffle</code>ä¸º<code>true</code>çš„ç®€æ˜“å®ç° </li></ul></li></ul><h4 id="sample-å’Œ-aggregateByKey"><a href="#sample-å’Œ-aggregateByKey" class="headerlink" title="sample   å’Œ  aggregateByKey"></a>sample   å’Œ  aggregateByKey</h4><ul><li><p><strong>sample</strong></p><ul><li><p>å¯¹RDDä¸­çš„é›†åˆå†…å…ƒç´ è¿›è¡Œé‡‡æ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°withReplacementæ˜¯trueè¡¨ç¤ºæœ‰æ”¾å›å–æ ·ï¼Œfalseè¡¨ç¤ºæ— æ”¾å›ã€‚ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ¯”ä¾‹ </p></li><li><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *- @param withReplacement can elements be sampled multiple times (replaced when sampled out)</span></span><br><span class="line"><span class="comment">    @param fraction expected size of the sample as a fraction of this RDD's size</span></span><br><span class="line"><span class="comment">       seed  æœ€å¥½ä¸è¦åŠ¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sample</span></span>(</span><br><span class="line">      withReplacement: <span class="type">Boolean</span>,</span><br><span class="line">      fraction: <span class="type">Double</span>,</span><br><span class="line">      seed: <span class="type">Long</span> = <span class="type">Utils</span>.random.nextLong): <span class="type">RDD</span>[<span class="type">T</span>]</span><br></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p><strong>aggregateByKey</strong></p><ul><li><code>aggregateByKey(zeroValue)(seqOp, combOp, [numTasks])</code>            //æŒ‰ç…§keyè¿›è¡Œèšåˆ </li><li>å…¶å®<code>reduceBykey</code> å°±æ˜¯<code>aggregateByKey</code>çš„ç®€åŒ–ç‰ˆã€‚  </li><li><code>aggregateByKey</code>å¤šæä¾›äº†ä¸€ä¸ªå‡½æ•° seqOp ç±»ä¼¼äºMapreduceçš„combineæ“ä½œï¼ˆå°±åœ¨mapç«¯æ‰§è¡Œreduceçš„æ“ä½œï¼‰</li></ul></li></ul><h4 id="mapPartitionsWithIndex-å’Œ-repartitionAndSortWithinPartitions"><a href="#mapPartitionsWithIndex-å’Œ-repartitionAndSortWithinPartitions" class="headerlink" title="mapPartitionsWithIndex å’Œ repartitionAndSortWithinPartitions"></a>mapPartitionsWithIndex å’Œ repartitionAndSortWithinPartitions</h4><ul><li><strong>mapPartitionsWithIndex</strong> <ul><li>è¯´ç™½äº†å°±æ˜¯å¯ä»¥æ‰“å°å‡ºå½“å‰æ‰€åœ¨åˆ†åŒºæ•°</li></ul></li><li><strong>repartitionAndSortWithinPartitions</strong><ul><li><strong>è¯¥æ–¹æ³•ä¾æ®partitionerå¯¹RDDè¿›è¡Œåˆ†åŒºï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªç»“æœåˆ†åŒºä¸­æŒ‰keyè¿›è¡Œæ’åºï¼›é€šè¿‡å¯¹æ¯”sortByKeyå‘ç°ï¼Œè¿™ç§æ–¹å¼æ¯”å…ˆåˆ†åŒºï¼Œç„¶ååœ¨æ¯ä¸ªåˆ†åŒºä¸­è¿›è¡Œæ’åºæ•ˆç‡é«˜ï¼Œè¿™æ˜¯å› ä¸ºå®ƒå¯ä»¥å°†æ’åºèå…¥åˆ°shuffleé˜¶æ®µã€‚</strong> </li></ul></li></ul><h2 id="2-Action-ç®—å­"><a href="#2-Action-ç®—å­" class="headerlink" title="2. Action ç®—å­"></a>2. Action ç®—å­</h2><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/ActionOperations.java" target="_blank" rel="noopener"><strong>Java ä»£ç è§è¿™é‡Œ</strong></a></p><h4 id="reduce"><a href="#reduce" class="headerlink" title="reduce();"></a>reduce();</h4><ul><li>def reduce(f: JFunction2[T, T, T]): T = rdd.reduce(f)</li></ul><h4 id="collect"><a href="#collect" class="headerlink" title="collect();"></a>collect();</h4><ul><li>Return an array that contains all of the elements in this RDD.</li><li>this method should only be used if the resulting array is expected to be small, as all the data is loaded into the driverâ€™s memory.</li></ul><h4 id="take-n"><a href="#take-n" class="headerlink" title="take(n);"></a>take(n);</h4><ul><li>Take the first num elements of the RDD. This currently scans the partitions <em>one by one</em>, so it will be slow if a lot of partitions are required. In that case, use collect() to get the  whole RDD instead.</li><li>this method should only be used if the resulting array is expected to be small, as all the data is loaded into the driverâ€™s memory.</li></ul><h4 id="count"><a href="#count" class="headerlink" title="count();"></a>count();</h4><ul><li>Return the number of elements in the RDD.</li></ul><h4 id="takeOrdered"><a href="#takeOrdered" class="headerlink" title="takeOrdered();"></a>takeOrdered();</h4><ul><li>Returns the <strong>first k (smallest)</strong> elements from this RDD using the  <strong>natural ordering</strong> for T while maintain the order.</li><li>top(n): è‡ªç„¶æ’åºå,æœ€å¤§çš„å‰ n</li></ul><h4 id="saveAsTextFile"><a href="#saveAsTextFile" class="headerlink" title="saveAsTextFile();"></a>saveAsTextFile();</h4><ul><li>Save this RDD as a text file, using string representations of elements.</li></ul><h4 id="countByKey"><a href="#countByKey" class="headerlink" title="countByKey();"></a>countByKey();</h4><ul><li>return  map&lt;String, Integer&gt;, key ä¸º key, value ä¸º key çš„æ•°é‡</li></ul><h4 id="takeSample"><a href="#takeSample" class="headerlink" title="takeSample();"></a>takeSample();</h4><ul><li>withReplacementï¼šå…ƒç´ å¯ä»¥å¤šæ¬¡(é‡å¤)æŠ½æ ·(åœ¨æŠ½æ ·æ—¶æ›¿æ¢) å¦‚æœä¸º false, åœ¨æŠ½æ ·æ•° &gt; æ ·æœ¬æ•°æ—¶, åªèƒ½è¿”å›æ ·æœ¬æ•°çš„æ ·æœ¬</li><li>numï¼šè¿”å›çš„æ ·æœ¬çš„å¤§å°</li><li>seedï¼šéšæœºæ•°ç”Ÿæˆå™¨çš„ç§å­</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">takeSample</span></span>(</span><br><span class="line">    withReplacement: <span class="type">Boolean</span>,</span><br><span class="line">    num: <span class="type">Int</span>,</span><br><span class="line">    seed: <span class="type">Long</span> = <span class="type">Utils</span>.random.nextLong): <span class="type">Array</span>[<span class="type">T</span>]</span><br></pre></td></tr></table></figure><hr><h1 id="ä¸ƒ-RDD-çš„æŒä¹…åŒ–"><a href="#ä¸ƒ-RDD-çš„æŒä¹…åŒ–" class="headerlink" title="ä¸ƒ. RDD çš„æŒä¹…åŒ–"></a>ä¸ƒ. RDD çš„æŒä¹…åŒ–</h1><p>å°†æ•°æ®é€šè¿‡æ“ä½œæŒä¹…åŒ–ï¼ˆæˆ–ç¼“å­˜ï¼‰åœ¨å†…å­˜ä¸­æ˜¯Sparkçš„é‡è¦èƒ½åŠ›ä¹‹ä¸€ã€‚å½“ä½ ç¼“å­˜äº†ä¸€ä¸ªRDDï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ç¼“å­˜äº†RDDçš„æ‰€æœ‰åˆ†åŒºã€‚è¿™æ ·å°±å¯ä»¥åœ¨å†…å­˜ä¸­è¿›è¡Œè®¡ç®—ã€‚è¿™æ ·å¯ä»¥ä½¿ä»¥ååœ¨RDDä¸Šçš„åŠ¨ä½œæ›´å¿«ï¼ˆé€šå¸¸å¯ä»¥æé«˜10å€ï¼‰ã€‚</p><p>ä½ å¯ä»¥å¯¹å¸Œæœ›ç¼“å­˜çš„RDDé€šè¿‡ä½¿ç”¨persistæˆ–cacheæ–¹æ³•è¿›è¡Œæ ‡è®°ã€‚å®ƒé€šè¿‡åŠ¨ä½œæ“ä½œç¬¬ä¸€æ¬¡åœ¨RDDä¸Šè¿›è¡Œè®¡ç®—åï¼Œå®ƒå°±ä¼šè¢«ç¼“å­˜åœ¨èŠ‚ç‚¹ä¸Šçš„å†…å­˜ä¸­ã€‚Sparkçš„ç¼“å­˜å…·æœ‰å®¹é”™æ€§ï¼Œå¦‚æœRDDçš„æŸä¸€åˆ†åŒºä¸¢å¤±ï¼Œå®ƒä¼šè‡ªåŠ¨ä½¿ç”¨æœ€åˆåˆ›å»ºRDDæ—¶çš„è½¬æ¢æ“ä½œè¿›è¡Œé‡æ–°è®¡ç®—ã€‚</p><p>å¦å¤–ï¼ŒRDDå¯ä»¥è¢«æŒä¹…åŒ–æˆä¸åŒçš„çº§åˆ«ã€‚æ¯”å¦‚ï¼Œå¯ä»¥å…è®¸ä½ å­˜å‚¨åœ¨ç£ç›˜ï¼Œå†…å­˜ï¼Œç”šè‡³æ˜¯åºåˆ—åŒ–çš„<strong>Java</strong>å¯¹è±¡ï¼ˆèŠ‚çœç©ºé—´ï¼‰ï¼Œå¤‡ä»½åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…å­˜å‚¨åœ¨åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»ŸTachyonä¸Šã€‚é€šè¿‡å‘persist()æ–¹æ³•ä¼ é€’StorageLevelå¯¹è±¡æ¥è®¾ç½®ã€‚cacheæ–¹æ³•æ˜¯ä½¿ç”¨é»˜è®¤çº§åˆ«<code>StorageLevel.MEMORY_ONLY</code>çš„æ–¹æ³•ã€‚</p><h4 id="é€‰æŒä¹…åŒ–æ–¹æ¡ˆå»ºè®®ï¼š"><a href="#é€‰æŒä¹…åŒ–æ–¹æ¡ˆå»ºè®®ï¼š" class="headerlink" title="é€‰æŒä¹…åŒ–æ–¹æ¡ˆå»ºè®®ï¼š"></a><strong>é€‰æŒä¹…åŒ–æ–¹æ¡ˆå»ºè®®ï¼š</strong></h4><ol><li>ä¼˜å…ˆé€‰æ‹©MEMORY_ONLYï¼Œå¦‚æœå¯ä»¥ç”¨å†…å­˜ç¼“å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æˆ‘çš„è®¡ç®—æ˜¯çº¯å†…å­˜çš„è®¡ç®—ï¼Œé€Ÿåº¦å½“ç„¶å¿«ã€‚ </li><li>å¦‚æœMEMORY_ONLY ç¼“å­˜ä¸äº†æ‰€æœ‰çš„æ•°æ®ï¼ŒMEMORY_ONLY_SER æŠŠæ•°æ®å®ç°åºåˆ—åŒ–ç„¶åè¿›è¡Œå­˜å‚¨ã€‚è¿™æ ·ä¹Ÿæ˜¯çº¯å†…å­˜æ“ä½œï¼Œé€Ÿåº¦ä¹Ÿå¿«ï¼Œåªä¸è¿‡éœ€è¦è€—è´¹ä¸€ç‚¹cpuèµ„æºéœ€è¦ååºåˆ—åŒ–ã€‚ </li><li>ä¹Ÿå¯ä»¥é€‰ç”¨å¸¦_2è¿™ç§æ–¹å¼, æ­¤æ–¹å¼ä¼šå­˜2ä»½, ä¸€ä»½å­˜åœ¨æœ¬åœ°, å¦ä¸€ä»½ä¼šå­˜åˆ°å¦å¤–çš„èŠ‚ç‚¹ã€‚æ¢å¤é€Ÿåº¦çš„æ—¶å€™å¯ä»¥ä½¿ç”¨å¤‡ä»½ã€‚</li><li>èƒ½ä¸èƒ½ä½¿ç”¨DISKçš„ï¼Œå°±ä¸ä½¿ç”¨DISKï¼Œæœ‰æ—¶å€™ä»ç£ç›˜è¯»ï¼Œè¿˜ä¸å¦‚ä»æ–°è®¡ç®—ä¸€æ¬¡ã€‚ </li></ol><h4 id="å…³äºtachyon"><a href="#å…³äºtachyon" class="headerlink" title="å…³äºtachyon "></a>å…³äº<strong><a href="http://www.alluxio.org/" target="_blank" rel="noopener">tachyon</a> </strong></h4><p>Spark2.0å¼€å§‹å°±ä¸æŠŠtachyon(ç°åœ¨æˆä¸ºalluxio)é›†æˆåœ¨è‡ªèº«å†…éƒ¨äº†, ä¾ç„¶å¯ä»¥ç›´æ¥ç”¨</p><p><strong>åŸºäºå†…å­˜çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</strong> </p><p><strong>å‡ºç°åŸå› </strong>:</p><ul><li>sparkè¿è¡Œä»¥ JVMä¸ºåŸºç¡€ï¼Œæ‰€ä»¥sparkçš„ä»»åŠ¡ä¼šæŠŠæ•°æ®å­˜å…¥JVMçš„å †ä¸­ï¼Œéšç€è®¡ç®—çš„è¿­ä»£ï¼ŒJVMå †ä¸­å­˜æ”¾çš„æ•°æ®é‡è¿…é€Ÿå¢å¤§ï¼Œå¯¹äºsparkè€Œè¨€ï¼Œsparkçš„è®¡ç®—å¼•æ“å’Œå­˜å‚¨å¼•æ“å¤„åœ¨åŒä¸€ä¸ªJVMä¸­ï¼Œæ‰€ä»¥ä¼šæœ‰é‡å¤çš„GCæ–¹é¢çš„å¼€é”€ã€‚è¿™æ ·å°±å¢å¤§äº†ç³»ç»Ÿçš„å»¶æ—¶ã€‚</li><li>å½“JVMå´©æºƒæ—¶ï¼Œç¼“å­˜åœ¨JVMå †ä¸­çš„æ•°æ®ä¹Ÿä¼šæ¶ˆå¤±ï¼Œè¿™ä¸ªæ—¶å€™sparkä¸å¾—ä¸æ ¹æ®RDDçš„è¡€ç¼˜å…³ç³»é‡æ–°è®¡ç®—æ•°æ®ã€‚</li><li>å¦‚æœsparkéœ€è¦å…¶ä»–çš„æ¡†æ¶çš„å…±äº«æ•°æ®ï¼Œæ¯”å¦‚å°±æ˜¯hadoopçš„Mapreduceï¼Œè¿™ä¸ªæ—¶å€™å°±å¿…é¡»é€šè¿‡ç¬¬ä¸‰æ–¹æ¥å…±äº«ï¼Œæ¯”å¦‚å€ŸåŠ©HDFSï¼Œé‚£ä¹ˆè¿™æ ·çš„è¯ï¼Œå°±éœ€è¦é¢å¤–çš„å¼€é”€ï¼Œå€ŸåŠ©çš„æ˜¯HDFSï¼Œé‚£ä¹ˆå°±éœ€è¦ç£ç›˜IOçš„å¼€é”€ã€‚</li><li>å› ä¸ºæˆ‘ä»¬åŸºäºå†…å­˜çš„åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶æœ‰ä»¥ä¸Šçš„é—®é¢˜ï¼Œé‚£ä¹ˆå°±ä¿ƒä½¿äº†å†…å­˜åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„è¯ç”Ÿï¼Œæ¯”å¦‚tachyonã€‚</li></ul><p><strong>Tachyonå¯ä»¥è§£å†³sparkçš„ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</strong></p><p>å¦‚æœæˆ‘ä»¬æŠŠæ•°æ®å­˜æ”¾åˆ°tachyonä¸Šé¢ï¼š</p><ul><li><strong>å‡å°‘Spark GCçš„å¼€é”€ã€‚</strong> </li><li><strong>å½“spark çš„JVMå´©æºƒçš„æ—¶å€™ï¼Œå­˜æ”¾åœ¨tachyonä¸Šçš„æ•°æ®ä¸å—å½±å“ã€‚</strong> </li><li><strong>sparkå¦‚æœè¦æƒ³è·Ÿè¢«çš„è®¡ç®—å·¥å…·å…±äº«æ•°æ®ï¼Œåªè¦é€šè¿‡tachyonçš„Clientå°±å¯ä»¥åšåˆ°äº†ã€‚å¹¶ä¸”å»¶è¿Ÿè¿œä½äºHDFSç­‰ç³»ç»Ÿã€‚</strong> </li></ul><hr><h1 id="å…«-å¹¿æ’­å˜é‡-å’Œ-ç´¯åŠ å™¨"><a href="#å…«-å¹¿æ’­å˜é‡-å’Œ-ç´¯åŠ å™¨" class="headerlink" title="å…«. å¹¿æ’­å˜é‡ å’Œ  ç´¯åŠ å™¨"></a>å…«. å¹¿æ’­å˜é‡ å’Œ  ç´¯åŠ å™¨</h1><h2 id="1-å¹¿æ’­å˜é‡"><a href="#1-å¹¿æ’­å˜é‡" class="headerlink" title="1. å¹¿æ’­å˜é‡"></a>1. å¹¿æ’­å˜é‡</h2><p>æ¯ä¸ª executor æ‹¥æœ‰ä¸€ä»½ï¼Œ è¿™ä¸ª executor å¯åŠ¨çš„ task ä¼šå…±äº«è¿™ä¸ªå˜é‡</p><p>ä½¿ç”¨äº†å¹¿æ’­å˜é‡ä¹‹å, executor ä¸­æ‰€æœ‰çš„ task éƒ½ä¼šå…±äº«æ­¤å˜é‡, å¦åˆ™æ¯ä¸ª task éƒ½ä¼šå‘ä¸€ä»½</p><p>åœ¨ Driver ç«¯å¯ä»¥ä¿®æ”¹å¹¿æ’­å˜é‡çš„å€¼ï¼Œåœ¨ Executor ç«¯æ— æ³•ä¿®æ”¹å¹¿æ’­å˜é‡çš„å€¼ã€‚</p><p><strong>ä½¿ç”¨:</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰</span></span><br><span class="line"><span class="keyword">val</span> a = <span class="number">3</span></span><br><span class="line"><span class="keyword">val</span> broadcast = sc.broadcast(a)</span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="keyword">val</span> c = broadcast.value</span><br></pre></td></tr></table></figure><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-090621.png" alt="image-20180726170621192"></p><h2 id="2-ç´¯åŠ å™¨"><a href="#2-ç´¯åŠ å™¨" class="headerlink" title="2. ç´¯åŠ å™¨"></a>2. ç´¯åŠ å™¨</h2><p><strong>ä½¿ç”¨åœºæ™¯</strong>: å¼‚å¸¸ç›‘æ§ï¼Œè°ƒè¯•ï¼Œè®°å½•ç¬¦åˆæŸç‰¹æ€§çš„æ•°æ®çš„æ•°ç›®ç­‰</p><p><strong>å¦‚æœä¸€ä¸ªå˜é‡ä¸è¢«å£°æ˜ä¸ºä¸€ä¸ªç´¯åŠ å™¨</strong>ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨ è¢«æ”¹å˜æ—¶ä¸ä¼šåœ¨ driver ç«¯è¿›è¡Œå…¨å±€æ±‡æ€»ï¼Œå³åœ¨<strong>åˆ†å¸ƒå¼è¿è¡Œæ—¶æ¯ä¸ª task è¿è¡Œçš„åªæ˜¯åŸå§‹å˜é‡çš„ä¸€ä¸ªå‰¯æœ¬</strong>ï¼Œå¹¶ä¸èƒ½æ”¹å˜åŸå§‹å˜é‡çš„å€¼</p><p>ä½†æ˜¯å½“è¿™ä¸ªå˜é‡è¢«å£°æ˜ä¸º<strong>ç´¯åŠ å™¨</strong>åï¼Œ<strong>è¯¥å˜é‡å°±ä¼šæœ‰åˆ†å¸ƒå¼è®¡æ•°çš„åŠŸèƒ½ã€‚</strong></p><p>ç´¯åŠ å™¨<strong>åœ¨ Driver ç«¯å®šä¹‰èµ‹åˆå§‹å€¼</strong>ï¼Œç´¯åŠ å™¨åªèƒ½åœ¨ <strong>Driver ç«¯è¯»å–æœ€åçš„å€¼</strong>ï¼Œåœ¨ <strong>Excutor ç«¯æ›´ æ–°</strong>ã€‚</p><p><strong>ä½¿ç”¨:</strong> </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰</span></span><br><span class="line"><span class="keyword">val</span> a = sc.longAccumulator(<span class="number">0</span>)</span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="keyword">val</span> b = a.value</span><br></pre></td></tr></table></figure><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-090907.png" alt="image-20180726170906622"></p><hr><h1 id="ä¹-Spark-on-Yarn-æ¨¡å¼"><a href="#ä¹-Spark-on-Yarn-æ¨¡å¼" class="headerlink" title="ä¹. Spark on Yarn æ¨¡å¼"></a>ä¹. Spark on Yarn æ¨¡å¼</h1><p><strong>é…ç½®</strong>: åªéœ€è¦åœ¨<code>conf/spark-env.sh</code> ä¸­é…ç½®<code>export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop</code> å°±å¯ä»¥äº†</p><p><strong>ä½¿ç”¨YARNæ¨¡å¼çš„æ—¶å€™ï¼Œä¸éœ€è¦å¯åŠ¨masterå’Œworkeräº†ã€‚</strong> </p><p><strong>åªéœ€è¦å¯åŠ¨HDFSå’ŒYARNå³å¯ã€‚</strong> </p><p><strong>ä¸ <code>Standalone</code>ä¸»è¦åŒºåˆ«æ˜¯</strong>: <code>spark-submit</code>åé¢çš„å‚æ•°ä¸­<code>--master</code>åé¢çš„ä¸æ˜¯ spark://â€¦.,   è€Œæ˜¯ <code>yarn</code>,  è¿™æ ·:<code>--master yarn</code></p><h4 id="â€“deploy-mode-client"><a href="#â€“deploy-mode-client" class="headerlink" title="â€“deploy-mode client"></a>â€“deploy-mode client</h4><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-165721.png" alt="image-20180727005721062"></p><h4 id="â€“deploy-mode-cluster"><a href="#â€“deploy-mode-cluster" class="headerlink" title="â€“deploy-mode cluster"></a>â€“deploy-mode cluster</h4><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-165858.png" alt="image-20180727005857420"></p><h1 id="å-å®½çª„ä¾èµ–"><a href="#å-å®½çª„ä¾èµ–" class="headerlink" title="å. å®½çª„ä¾èµ–"></a>å. å®½çª„ä¾èµ–</h1><p><strong>çª„ä¾èµ–æ˜¯æŒ‡çˆ¶RDDçš„æ¯ä¸ªåˆ†åŒºéƒ½åªè¢«å­RDDä¸€ä¸ªåˆ†åŒºä½¿ç”¨ã€‚</strong>(ç‹¬ç”Ÿ, NarrowDependency)</p><p><strong>å®½ä¾èµ–å°±æ˜¯æŒ‡çˆ¶RDDçš„åˆ†åŒºè¢«å¤šä¸ªå­RDDçš„åˆ†åŒºæ‰€ä¾èµ–ã€‚</strong> (è¶…ç”Ÿ, ShuffleDependency)</p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-170442.png" alt="image-20180727010441959"></p><h1 id="åä¸€-Stage-åˆ’åˆ†"><a href="#åä¸€-Stage-åˆ’åˆ†" class="headerlink" title="åä¸€. Stage åˆ’åˆ†"></a>åä¸€. Stage åˆ’åˆ†</h1><p>å¼€å‘å®Œä¸€ä¸ªåº”ç”¨ä»¥åï¼ŒæŠŠåº”ç”¨æäº¤åˆ°é›†ç¾¤ï¼Œé‚£ä¹ˆè¿™ä¸ªåº”ç”¨å°±å«åšApplication</p><p>è¿™ä¸ªåº”ç”¨é‡Œé¢æˆ‘ä»¬å¼€å‘äº†å¥½å¤šä»£ç ï¼Œè¿™äº›ä»£ç é‡Œé¢å‡¡æ˜¯é‡åˆ°ä¸€ä¸ªactionæ“ä½œï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªjobä»»åŠ¡ã€‚</p><p>ä¹Ÿå°±æ„å‘³ç€ï¼Œä¸€ä¸ªApplicationæœ‰ä¸€ä¸ªæˆ–è€…ä¸€ä¸ªä»¥ä¸Šçš„jobä»»åŠ¡ã€‚</p><p>ç„¶åè¿™äº›jobä»»åŠ¡åˆ’åˆ†ä¸ºä¸åŒstageå»æ‰§è¡Œï¼Œstageé‡Œé¢å°±æ˜¯è¿è¡Œä¸åŒçš„taskä»»åŠ¡ã€‚</p><p>é‡åˆ°ä¸€ä¸ª shuffle ç®—å­, å°±ä¼šä»ä¸­é—´åˆ†å¼€, åˆ’åˆ†ä¸º2ä¸ª stage</p><p>Taskè®¡ç®—çš„å°±æ˜¯åˆ†åŒºä¸Šé¢çš„æ•°æ®ã€‚</p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-172557.png" alt="image-20180727012556575"></p><h1 id="åäºŒ-Spark-ä»»åŠ¡è°ƒåº¦"><a href="#åäºŒ-Spark-ä»»åŠ¡è°ƒåº¦" class="headerlink" title="åäºŒ. Spark ä»»åŠ¡è°ƒåº¦"></a><strong>åäºŒ. Spark ä»»åŠ¡è°ƒåº¦</strong></h1><p><strong>Shuffle æœºåˆ¶è§ä¸‹ä¸€ç¯‡</strong></p><h2 id="1-ç®€ç‰ˆ"><a href="#1-ç®€ç‰ˆ" class="headerlink" title="1.ç®€ç‰ˆ"></a>1.ç®€ç‰ˆ</h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-173025.png" alt="image-20180727013025763"></p><h2 id="2-å®Œæ•´ç‰ˆ"><a href="#2-å®Œæ•´ç‰ˆ" class="headerlink" title="2.å®Œæ•´ç‰ˆ"></a>2.å®Œæ•´ç‰ˆ</h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-26-spark%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%A7%A3.png" alt=""></p><p><strong>æ³¨æ„:</strong> </p><ul><li>AppClient / clientActorï¼šåœ¨ Standalone æ¨¡å¼ä¸‹çš„å®ç°æ˜¯ <code>StandaloneAppClient</code> ç±»</li><li>dirverActor:  :TODO</li></ul><h1 id="åä¸‰-TopN-æ¡ˆä¾‹"><a href="#åä¸‰-TopN-æ¡ˆä¾‹" class="headerlink" title="åä¸‰. TopN æ¡ˆä¾‹"></a>åä¸‰. TopN æ¡ˆä¾‹</h1><p><strong>å¯¹ä¸€ä¸ªæ–‡ä»¶é‡Œé¢çš„å•è¯è¿›è¡Œå•è¯è®¡æ•°ï¼Œç„¶åå–å‰3ä¸ªå‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¸‰ä¸ªå•è¯ã€‚</strong> </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TopN</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">     <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"TopN"</span>)</span><br><span class="line">     <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">     <span class="keyword">val</span> file=sc.textFile(<span class="string">"file://..."</span>)</span><br><span class="line">     <span class="keyword">val</span> topN=file.flatMap &#123; line =&gt; line.split(<span class="string">"\t"</span>) &#125;</span><br><span class="line">     .map &#123; word =&gt; (word,<span class="number">1</span>) &#125;</span><br><span class="line">     .reduceByKey(_+_)  <span class="comment">//key word  value:count</span></span><br><span class="line">     .map(tuple =&gt;(tuple._2,tuple._1))<span class="comment">// swap k,v</span></span><br><span class="line">     .sortByKey(<span class="literal">false</span>)   <span class="comment">// sort the count</span></span><br><span class="line">     .take(<span class="number">3</span>)  <span class="comment">// take top 3</span></span><br><span class="line">     <span class="keyword">for</span>( i &lt;- topN)&#123;</span><br><span class="line">       println(i._2 + <span class="string">"  å‡ºç°æ¬¡æ•°ï¼š"</span>+i._1);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åå››-ç½‘ç«™è®¿é—®æ—¥å¿—åˆ†æ"><a href="#åå››-ç½‘ç«™è®¿é—®æ—¥å¿—åˆ†æ" class="headerlink" title="åå››. ç½‘ç«™è®¿é—®æ—¥å¿—åˆ†æ"></a>åå››. ç½‘ç«™è®¿é—®æ—¥å¿—åˆ†æ</h1><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p><strong>éœ€æ±‚ä¸€ ï¼š</strong></p><p>The average, min, and max content size of responses returned from the server.</p><p><strong>éœ€æ±‚äºŒï¼š </strong></p><p>A count of response codeâ€™s returned.</p><p><strong>éœ€æ±‚ä¸‰ï¼š </strong></p><p>All IPAddresses that have accessed this server more than N times.</p><p><strong>éœ€æ±‚å››ï¼š</strong></p><p>The top endpoints requested by count.  TopN æ‰¾å‡ºè¢«è®¿é—®æ¬¡æ•°æœ€å¤šçš„åœ°å€çš„å‰ä¸‰ä¸ª</p><h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log.txt</span><br><span class="line">------------</span><br><span class="line">10.0.0.153<span class="comment">#-#-#[12/Mar/2004:12:23:18-0800]#"GET /cgi-bin/mailgraph.cgi/mailgraph_3_err.png HTTP/1.1"#200#5554</span></span><br><span class="line">10.0.0.153<span class="comment">#-#-#[12/Mar/2004:12:23:40-0800]#"GET /dccstats/index.html HTTP/1.1"#304#2000</span></span><br><span class="line">10.0.0.153<span class="comment">#-#-#[12/Mar/2004:12:23:41-0800]#"GET /dccstats/stats-spam.1day.png HTTP/1.1"#200#2964</span></span><br></pre></td></tr></table></figure><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApacheAccesslog</span></span></span><br><span class="line"><span class="class"><span class="title">-----------------------</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">ApacheAccesslog</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    ipAddress:<span class="type">String</span>, // ipåœ°å€</span></span></span><br><span class="line"><span class="class"><span class="params">    clientIndentd:<span class="type">String</span>, //æ ‡è¯†ç¬¦</span></span></span><br><span class="line"><span class="class"><span class="params">    userId:<span class="type">String</span> ,//ç”¨æˆ·<span class="type">ID</span></span></span></span><br><span class="line"><span class="class"><span class="params">    dateTime:<span class="type">String</span> ,//æ—¶é—´</span></span></span><br><span class="line"><span class="class"><span class="params">    method:<span class="type">String</span> ,//è¯·æ±‚æ–¹å¼</span></span></span><br><span class="line"><span class="class"><span class="params">    endPoint:<span class="type">String</span> ,//ç›®æ ‡åœ°å€</span></span></span><br><span class="line"><span class="class"><span class="params">    protocol:<span class="type">String</span> ,//åè®®</span></span></span><br><span class="line"><span class="class"><span class="params">    responseCode:<span class="type">Int</span> ,//ç½‘é¡µè¯·æ±‚å“åº”ç±»å‹</span></span></span><br><span class="line"><span class="class"><span class="params">    contenSize:<span class="type">Long</span>   //å†…å®¹é•¿åº¦</span></span></span><br><span class="line"><span class="class"><span class="params">    </span></span></span><br><span class="line"><span class="class"><span class="params">    </span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">object</span> <span class="title">ApacheAccesslog</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parseLog</span></span>(log:<span class="type">String</span>):<span class="type">ApacheAccesslog</span>=&#123;</span><br><span class="line">  <span class="keyword">val</span> logArray= log.split(<span class="string">"#"</span>);</span><br><span class="line">  <span class="keyword">val</span> url=logArray(<span class="number">4</span>).split(<span class="string">" "</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="type">ApacheAccesslog</span>(logArray(<span class="number">0</span>),logArray(<span class="number">1</span>),logArray(<span class="number">2</span>),logArray(<span class="number">3</span>),url(<span class="number">0</span>),url(<span class="number">1</span>),url(<span class="number">2</span>),logArray(<span class="number">5</span>).toInt,logArray(<span class="number">6</span>).toLong);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogAnalyer</span></span></span><br><span class="line"><span class="class"><span class="title">--------------------</span></span></span><br><span class="line"><span class="class"><span class="title">import</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">SparkConf</span></span></span><br><span class="line"><span class="class"><span class="title">import</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">SparkContext</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">object</span> <span class="title">LogAnalyer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> conf=<span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"LogAnalyer"</span>)</span><br><span class="line">     <span class="keyword">val</span> sc=<span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line">     <span class="keyword">val</span> logsRDD=sc.textFile(<span class="string">"file://...."</span>)</span><br><span class="line">          .map &#123; line =&gt; <span class="type">ApacheAccesslog</span>.parseLog(line) &#125;</span><br><span class="line">          .cache()</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * éœ€æ±‚ä¸€ </span></span><br><span class="line"><span class="comment">      * The average, min, and max content size of responses returned from the server.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">val</span> contextSize=logsRDD.map &#123; log =&gt; log.contenSize &#125;</span><br><span class="line">        <span class="comment">// get max</span></span><br><span class="line">      <span class="keyword">val</span> maxSize=contextSize.max()</span><br><span class="line">       <span class="comment">//get min</span></span><br><span class="line">      <span class="keyword">val</span> minSize=contextSize.min()</span><br><span class="line">      <span class="comment">// total / count</span></span><br><span class="line">      <span class="comment">//get average</span></span><br><span class="line">      <span class="keyword">val</span> averageSize=contextSize.reduce(_+_)/contextSize.count()</span><br><span class="line">      println(<span class="string">"=============================éœ€æ±‚ä¸€-=============================="</span>);</span><br><span class="line">      println(<span class="string">"æœ€å¤§å€¼ï¼š"</span>+maxSize  + <span class="string">"  æœ€å°å€¼ï¼š"</span>+minSize + <span class="string">"   å¹³å‡å€¼ï¼š"</span>+averageSize);</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * éœ€æ±‚äºŒ</span></span><br><span class="line"><span class="comment">      * A count of response code's returned.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">        println(<span class="string">"=============================éœ€æ±‚äºŒ-=============================="</span>);</span><br><span class="line">     logsRDD.map &#123; log =&gt; (log.responseCode,<span class="number">1</span>) &#125;</span><br><span class="line">     .reduceByKey(_+_)</span><br><span class="line">     .foreach(result =&gt; println(<span class="string">" å“åº”çŠ¶æ€ï¼š"</span>+result._1 + <span class="string">"  å‡ºç°çš„æ¬¡æ•°ï¼š"</span>+result._2))</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * éœ€æ±‚ä¸‰</span></span><br><span class="line"><span class="comment">      * All IPAddresses that have accessed this server more than N times.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      println(<span class="string">"=============================éœ€æ±‚ä¸‰-=============================="</span>);</span><br><span class="line">     <span class="keyword">val</span> result= logsRDD.map &#123; log =&gt;( log.ipAddress,<span class="number">1</span>) &#125;</span><br><span class="line">     .reduceByKey(_+_)</span><br><span class="line">     .filter(result =&gt; result._2 &gt; <span class="number">1</span>)   <span class="comment">// &gt; 10000 </span></span><br><span class="line">     .take(<span class="number">2</span>)  <span class="comment">//  &gt;  10</span></span><br><span class="line">     <span class="keyword">for</span>( tuple &lt;- result)&#123;</span><br><span class="line">       println(<span class="string">"ip : "</span>+tuple._1 + <span class="string">"  å‡ºç°çš„æ¬¡æ•°ï¼š"</span>+tuple._2);</span><br><span class="line">     &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * éœ€æ±‚å››</span></span><br><span class="line"><span class="comment">      * The top endpoints requested by count.  TopN</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      println(<span class="string">"=============================éœ€æ±‚å››-=============================="</span>);</span><br><span class="line">     <span class="keyword">val</span> topN=logsRDD.map &#123; log =&gt; (log.endPoint,<span class="number">1</span>) &#125;</span><br><span class="line">     .reduceByKey(_+_)</span><br><span class="line">     .map(result =&gt; (result._2,result._1))</span><br><span class="line">     .sortByKey(<span class="literal">false</span>)</span><br><span class="line">     .take(<span class="number">2</span>)</span><br><span class="line">     <span class="keyword">for</span>(tuple &lt;- topN)&#123;</span><br><span class="line">        println(<span class="string">"ç›®æ ‡åœ°å€ : "</span>+tuple._2 + <span class="string">"  å‡ºç°çš„æ¬¡æ•°ï¼š"</span>+tuple._1);</span><br><span class="line">     &#125;</span><br><span class="line">     logsRDD.unpersist(<span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-Spark-ä¸-MapReduce-åŒºåˆ«&quot;&gt;&lt;a href=&quot;#ä¸€-Spark-ä¸-MapReduce-åŒºåˆ«&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. Spark ä¸ MapReduce åŒºåˆ«&quot;&gt;&lt;/a&gt;ä¸€. Spark ä¸ MapReduc
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="ç²¾è®²" scheme="https://airpoet.github.io/categories/Spark/%E7%B2%BE%E8%AE%B2/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>i-Spark-5</title>
    <link href="https://airpoet.github.io/2018/07/25/Spark/i-Spark-5/"/>
    <id>https://airpoet.github.io/2018/07/25/Spark/i-Spark-5/</id>
    <published>2018-07-25T03:36:06.050Z</published>
    <updated>2018-07-25T06:59:41.421Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-Spark-çš„é—­åŒ…å¤„ç†"><a href="#ä¸€-Spark-çš„é—­åŒ…å¤„ç†" class="headerlink" title="ä¸€. Spark çš„é—­åŒ…å¤„ç†"></a>ä¸€. Spark çš„é—­åŒ…å¤„ç†</h1><p><strong>RDD</strong>, <code>resilient distributed dataset</code>,å¼¹æ€§(å®¹é”™)åˆ†å¸ƒå¼æ•°æ®é›†ã€‚</p><p>åˆ†åŒºåˆ—è¡¨, function,dep Option(åˆ†åŒºç±», Pair[Key,Value]),é¦–é€‰ä½ç½®ã€‚</p><p><strong>è¿è¡Œjobæ—¶ï¼Œsparkå°†rddæ‰“ç¢å˜æ¢æˆtask</strong>,<strong>æ¯ä¸ªtaskç”±ä¸€ä¸ªexecutoræ‰§è¡Œ</strong>ã€‚</p><p>æ‰§è¡Œä¹‹å‰ï¼Œ<strong>sparkä¼šè¿›è¡Œtaskçš„é—­åŒ…(closure)è®¡ç®—ã€‚</strong></p><p>é—­åŒ…æ˜¯æŒ‡é’ˆå¯¹executorå¯è§çš„å˜é‡å’Œæ–¹æ³•,ä»¥å¤‡åœ¨rddçš„foreachä¸­è¿›è¡Œè®¡ç®—ã€‚</p><p><strong>é—­åŒ…å°±æ˜¯ä¸²è¡ŒåŒ–åå¹¶å‘é€ç»™æ¯ä¸ªexecutor.</strong></p><p><strong>localæ¨¡å¼ä¸‹</strong>ï¼Œæ‰€æœ‰sparkç¨‹åºè¿è¡Œåœ¨åŒä¸€JVMä¸­ï¼Œå…±äº«å¯¹è±¡ï¼Œ<strong>counteræ˜¯å¯ä»¥ç´¯åŠ çš„</strong>ã€‚</p><p>åŸå› æ˜¯æ‰€æœ‰executoræŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¼•ç”¨ã€‚</p><p><strong>clusteræ¨¡å¼ä¸‹ï¼Œä¸å¯ä»¥ï¼Œcounteræ˜¯é—­åŒ…å¤„ç†çš„ã€‚</strong></p><p>æ¯ä¸ªèŠ‚ç‚¹å¯¹driverä¸Šçš„counteræ˜¯ä¸å¯è§çš„ã€‚</p><p>åªèƒ½çœ‹åˆ°è‡ªå·±å†…éƒ¨ä¸²è¡ŒåŒ–çš„counterå‰¯æœ¬ã€‚</p><h1 id="äºŒ-Sparkçš„åº”ç”¨çš„-éƒ¨ç½²æ¨¡å¼"><a href="#äºŒ-Sparkçš„åº”ç”¨çš„-éƒ¨ç½²æ¨¡å¼" class="headerlink" title="äºŒ. Sparkçš„åº”ç”¨çš„ éƒ¨ç½²æ¨¡å¼"></a>äºŒ. Sparkçš„åº”ç”¨çš„ éƒ¨ç½²æ¨¡å¼</h1><h2 id="1-éƒ¨ç½²æ¨¡å¼æ¦‚è¿°"><a href="#1-éƒ¨ç½²æ¨¡å¼æ¦‚è¿°" class="headerlink" title="1. éƒ¨ç½²æ¨¡å¼æ¦‚è¿°"></a>1. éƒ¨ç½²æ¨¡å¼æ¦‚è¿°</h2><p><code>spark-submit --class xxx xx.jar --deploy-mode (client | cluster)</code></p><p>  <strong><code>--deploy-mode</code>æŒ‡å®šéƒ¨ç½²driverç¨‹åºåœ¨clientä¸»æœºä¸Šè¿˜æ˜¯åœ¨workerèŠ‚ç‚¹ä¸Šã€‚</strong> </p><p><strong>[client]</strong></p><ul><li>driverè¿è¡Œåœ¨clientä¸»æœºä¸Šã€‚</li><li>clientå¯ä»¥ä¸åœ¨cluster(é›†ç¾¤)ä¸­ã€‚ </li></ul><p><strong>[cluster]</strong></p><ul><li><code>driver</code>ç¨‹åºæäº¤ç»™<code>spark cluster</code>çš„æŸä¸ª<code>worker</code>èŠ‚ç‚¹æ¥æ‰§è¡Œã€‚</li><li>workeræ˜¯clusterä¸­çš„ä¸€å‘˜ã€‚</li><li>å¯¼å‡ºçš„jaréœ€è¦æ”¾ç½®åˆ°æ‰€æœ‰workerèŠ‚ç‚¹éƒ½å¯è§çš„ä½ç½®(å¦‚<code>hdfs</code>)æ‰å¯ä»¥ã€‚</li></ul><p><strong>ä¸è®ºå“ªç§æ–¹å¼ï¼Œrddçš„è¿ç®—éƒ½åœ¨workeræ‰§è¡Œ</strong></p><h2 id="2-deploy-modeéƒ¨ç½²æ¨¡å¼éªŒè¯"><a href="#2-deploy-modeéƒ¨ç½²æ¨¡å¼éªŒè¯" class="headerlink" title="2. deploy modeéƒ¨ç½²æ¨¡å¼éªŒè¯"></a>2. deploy modeéƒ¨ç½²æ¨¡å¼éªŒè¯</h2><h4 id="éƒ¨ç½²æ¨¡å¼åˆ’åˆ†"><a href="#éƒ¨ç½²æ¨¡å¼åˆ’åˆ†" class="headerlink" title="éƒ¨ç½²æ¨¡å¼åˆ’åˆ†"></a>éƒ¨ç½²æ¨¡å¼åˆ’åˆ†</h4><ul><li><strong>Client(å®¢æˆ·ç«¯æ¨¡å¼)</strong><ul><li><code>spark-submit --class com.rox.spark.scala.DeployModeTest --master [spark://cs1:7077](spark://s201:7077) --deploy-mode client SparkDemo-1-deploymode.jar</code></li><li>driverå°±æ˜¯è‡ªå·±, å¦‚æœåœ¨cs1ä¸Š, driver å°±æ˜¯cs1</li></ul></li><li><strong>Cluster(é›†ç¾¤æ¨¡å¼)</strong><ul><li><code>spark-submit --class com.it18zhang.spark.scala.DeployModeTest --master [spark://cs1:7077](spark://s201:7077) --deploy-mode cluster [hdfs://cs1:8020/user/centos/SparkDemo-1-deploymode.jar](hdfs://s201:8020/user/centos/SparkDemo1-1.0-SNAPSHOT.jar)</code></li><li>driveræ˜¯ç”± spark æŒ‘é€‰çš„,å¦‚æœæ˜¯ cs1ä¸Šæäº¤çš„,å› ä¸º cs1ä¹Ÿä¸æ˜¯ worker(slave), æ‰€ä»¥ driverå’Œ worker éƒ½è·Ÿcs1æ— å…³, æ³¨æ„, cluster æ¨¡å¼,åªè¦ä¸€æäº¤å®Œå°±ç»“æŸäº†, å› ä¸ºæ¥ä¸‹æ¥è·Ÿä»–è‡ªå·±æ²¡å…³ç³»äº† , æ‰€ä»¥æ­¤æ—¶åœ¨ cs1ä¸Šæ‰§è¡Œçš„éå¸¸å¿«</li><li>å¿…é¡»è¦å°†jaræ”¾ç½®åˆ°æ‰€æœ‰workeréƒ½èƒ½å¤Ÿçœ‹åˆ°çš„åœ°æ–¹æ‰å¯ä»¥ï¼Œä¾‹å¦‚hdfsã€‚</li></ul></li></ul><h4 id="ä»£ç è§£é‡Š"><a href="#ä»£ç è§£é‡Š" class="headerlink" title="ä»£ç è§£é‡Š"></a><strong>ä»£ç è§£é‡Š</strong></h4><ul><li>é€šè¿‡SocketæŠŠæ‰“å°çš„æ•°æ®, å‘é€åˆ°æŒ‡å®šæœºå™¨<code>cs5</code>ä¸Š</li><li>åœ¨<code>cs5</code>ä¸Š, å¼€å¯ <code>nc</code>ç«¯å£, ç›‘å¬æ¶ˆæ¯</li><li><code>standalone</code> å’Œ <code>yarn</code>æ¨¡å¼åˆ†åˆ«æ‰“æˆ <code>jaråŒ…</code>,  åœ¨spark ç¯å¢ƒä¸­æ‰§è¡Œ</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rox.spark.scala</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.&#123;<span class="type">InetAddress</span>, <span class="type">Socket</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DeployModeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * writeå†™å‡ºå»</span></span><br><span class="line"><span class="comment">    * ä»è¿è¡Œ æ­¤ç¨‹åºçš„èŠ‚ç‚¹, å†™åˆ° cs5 ä¸Š</span></span><br><span class="line"><span class="comment">    * @param str</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">printInfo</span></span>(str:<span class="type">String</span>):<span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ip = <span class="type">InetAddress</span>.getLocalHost.getHostAddress</span><br><span class="line">    <span class="keyword">val</span> sock = <span class="keyword">new</span> <span class="type">Socket</span>(<span class="string">"cs5"</span>,<span class="number">8888</span>)</span><br><span class="line">    <span class="keyword">val</span> out = sock.getOutputStream</span><br><span class="line">    out.write((ip + <span class="string">""</span> + str + <span class="string">"\r\n"</span>).getBytes())</span><br><span class="line">    out.flush()</span><br><span class="line">    sock.close()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">    conf.setAppName(<span class="string">"DeployModeTest"</span>)</span><br><span class="line">    <span class="comment">// standalone æ¨¡å¼</span></span><br><span class="line">    <span class="comment">//conf.setMaster("spark://cs1:7077")</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Yarnæ¨¡å¼</span></span><br><span class="line">    conf.setMaster(<span class="string">"yarn"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// local æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// conf.setMaster("local[4]")</span></span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">    printInfo(<span class="string">"hello guys---æˆ‘å°±æ˜¯Driver"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * Distribute a local Scala collection to form an RDD.</span></span><br><span class="line"><span class="comment">      * numSlices: the partition number of the new RDD.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> rdd1 = sc.parallelize(<span class="number">1</span> to <span class="number">10</span>,  <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°ç¬¬ä¸€æ¬¡map</span></span><br><span class="line">    <span class="keyword">val</span> rdd2 = rdd1.map(e =&gt; &#123;</span><br><span class="line">      printInfo(<span class="string">"ç›´æ¥å®šä¹‰3ä¸ªåˆ†åŒº, map1: "</span>+e)</span><br><span class="line">      e * <span class="number">2</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°åˆ†åŒºä¸º 2</span></span><br><span class="line">    <span class="keyword">val</span> rdd3 = rdd2.repartition(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">val</span> rdd4 = rdd3.map(e =&gt; &#123;</span><br><span class="line">      printInfo(<span class="string">"é‡åˆ†åŒºä¸º2å, map2: "</span> + e)</span><br><span class="line">      e</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> res = rdd4.reduce((a,b)=&gt;&#123;</span><br><span class="line">      printInfo(<span class="string">"æ±‚å’Œ, reduce: "</span> + a + <span class="string">","</span> + b)</span><br><span class="line">      a + b</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    println(res)</span><br><span class="line">    printInfo(<span class="string">"æœ€åå‘ç»™driver: "</span> + res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¸‰-Spark-é›†ç¾¤çš„è¿è¡Œæ–¹å¼"><a href="#ä¸‰-Spark-é›†ç¾¤çš„è¿è¡Œæ–¹å¼" class="headerlink" title="ä¸‰. Spark é›†ç¾¤çš„è¿è¡Œæ–¹å¼"></a>ä¸‰. Spark é›†ç¾¤çš„è¿è¡Œæ–¹å¼</h1><p><strong>ä¸»è¦æ˜¯<code>cluster manager</code>çš„åŒºåˆ«ã€‚</strong> </p><p><strong>[local]</strong> </p><ul><li>â€¦</li></ul><p><strong>[standalone]</strong> </p><ul><li>ä½¿ç”¨SparkMasterè¿›ç¨‹ä½œä¸ºç®¡ç†èŠ‚ç‚¹, éœ€è¦å¼€å¯Spark é›†ç¾¤</li></ul><p><strong>[mesos]</strong> </p><ul><li>ä½¿ç”¨mesosçš„masterä½œä¸ºç®¡ç†èŠ‚ç‚¹ã€‚ </li></ul><p><strong>[yarn]</strong> </p><ul><li><p>ä½¿ç”¨hadoopçš„ResourceManagerä½œä¸ºmasterèŠ‚ç‚¹ã€‚</p></li><li><p>ä¸ç”¨å¼€å¯ spark é›†ç¾¤ã€‚å› ä¸ºæ˜¯ä¾æ‰˜<code>yarn é›†ç¾¤</code>æ¥æ‰§è¡Œ<code>spark</code> application,  é«˜å¯ç”¨ä¹Ÿæ˜¯ä¾æ‰˜äº yarn çš„é«˜å¯ç”¨, ç¨‹åºåœ¨æ‰§è¡Œæ—¶, ä¼šæ‹·è´ ä¸€äº›spark ä¾èµ–ç¯å¢ƒåˆ° hdfs ä¸Š, äº‹åä¼šåˆ é™¤</p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-Spark-çš„é—­åŒ…å¤„ç†&quot;&gt;&lt;a href=&quot;#ä¸€-Spark-çš„é—­åŒ…å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. Spark çš„é—­åŒ…å¤„ç†&quot;&gt;&lt;/a&gt;ä¸€. Spark çš„é—­åŒ…å¤„ç†&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;RDD&lt;/strong&gt;, &lt;c
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="éƒ¨ç½²æ¨¡å¼" scheme="https://airpoet.github.io/categories/Spark/%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>Python &amp; Hadoop | Spark ç”Ÿæ€</title>
    <link href="https://airpoet.github.io/2018/07/23/Spark/Python%20&amp;%20Hadoop%7CSpark%E7%94%9F%E6%80%81/"/>
    <id>https://airpoet.github.io/2018/07/23/Spark/Python &amp; Hadoop|Sparkç”Ÿæ€/</id>
    <published>2018-07-23T06:27:10.923Z</published>
    <updated>2018-07-23T08:06:55.514Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-Python-è®¿é—®-MySQL"><a href="#ä¸€-Python-è®¿é—®-MySQL" class="headerlink" title="ä¸€. Python è®¿é—® MySQL"></a>ä¸€. Python è®¿é—® MySQL</h1><h2 id="1-å®‰è£…-pymysql-æ¨¡å—"><a href="#1-å®‰è£…-pymysql-æ¨¡å—" class="headerlink" title="1.å®‰è£… pymysql æ¨¡å—"></a>1.å®‰è£… pymysql æ¨¡å—</h2><p>1) <code>idea</code>ä¸­,  <code>import pymysql</code>, æ²¡æœ‰å®‰è£…çš„è¯, <code>option + return</code> å®‰è£…</p><h2 id="2-è®¿é—®-mysql-æµ‹è¯•"><a href="#2-è®¿é—®-mysql-æµ‹è¯•" class="headerlink" title="2. è®¿é—® mysql æµ‹è¯•"></a>2. è®¿é—® mysql æµ‹è¯•</h2><p>çœ‹çœ‹èƒ½å¦æ‰“å° <code>mysql</code> çš„ç‰ˆæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># å¼€å¯é“¾æ¥</span></span><br><span class="line">    conn = pymysql.connect(host=<span class="string">'localhost'</span>,user=<span class="string">'root'</span>,passwd=<span class="string">'123'</span>,</span><br><span class="line">                           db=<span class="string">'python'</span>,port=<span class="number">3306</span>,charset=<span class="string">'utf8'</span>)</span><br><span class="line">    <span class="comment"># æ‰“å¼€æ¸¸æ ‡</span></span><br><span class="line">    cur = conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰§è¡Œ sql</span></span><br><span class="line">    cur.execute(<span class="string">'select version()'</span>)</span><br><span class="line"></span><br><span class="line">    version = cur.fetchone()</span><br><span class="line"></span><br><span class="line">    print(version)</span><br><span class="line">    cur.close()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    print(<span class="string">"å‘ç”Ÿå¼‚å¸¸"</span>)</span><br></pre></td></tr></table></figure><h2 id="3-æŸ¥è¯¢-mysql"><a href="#3-æŸ¥è¯¢-mysql" class="headerlink" title="3. æŸ¥è¯¢ mysql"></a>3. æŸ¥è¯¢ mysql</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># å¼€å¯é“¾æ¥</span></span><br><span class="line">    conn = pymysql.connect(host=<span class="string">'localhost'</span>,user=<span class="string">'root'</span>,passwd=<span class="string">'123'</span>,</span><br><span class="line">                           db=<span class="string">'python'</span>,port=<span class="number">3306</span>,charset=<span class="string">'utf8'</span>)</span><br><span class="line">    <span class="comment"># æ‰“å¼€æ¸¸æ ‡</span></span><br><span class="line">    cur = conn.cursor()</span><br><span class="line"></span><br><span class="line">    sql = <span class="string">"select id, name,age from t1 where name like 'tom8%'"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰§è¡Œ sql</span></span><br><span class="line">    cur.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å–ç»“æœ</span></span><br><span class="line">    all = cur.fetchall()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> rec <span class="keyword">in</span> all:</span><br><span class="line">        print(rec)</span><br><span class="line">        <span class="comment"># print(str(rec[0]))</span></span><br><span class="line"></span><br><span class="line">    conn.commit()</span><br><span class="line">    cur.close()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    print(<span class="string">"å‘ç”Ÿå¼‚å¸¸"</span>)</span><br></pre></td></tr></table></figure><h2 id="4-å¤§æ‰¹é‡æ’å…¥-mysql"><a href="#4-å¤§æ‰¹é‡æ’å…¥-mysql" class="headerlink" title="4. å¤§æ‰¹é‡æ’å…¥ mysql"></a>4. å¤§æ‰¹é‡æ’å…¥ mysql</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># å¼€å¯é“¾æ¥</span></span><br><span class="line">    conn = pymysql.connect(host=<span class="string">'localhost'</span>,user=<span class="string">'root'</span>,passwd=<span class="string">'123'</span>,</span><br><span class="line">                           db=<span class="string">'python'</span>,port=<span class="number">3306</span>,charset=<span class="string">'utf8'</span>)</span><br><span class="line">    <span class="comment"># æ‰“å¼€æ¸¸æ ‡</span></span><br><span class="line">    cur = conn.cursor()</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">10000</span>:</span><br><span class="line">        sql = <span class="string">"insert into t1(name,age) VALUES ('%s','%d')"</span> % (<span class="string">'tom'</span> + str(i), i % <span class="number">100</span>)</span><br><span class="line">        print(sql)</span><br><span class="line">        cur.execute(sql)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    conn.commit()</span><br><span class="line">    cur.close()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    print(<span class="string">"å‘ç”Ÿå¼‚å¸¸"</span>)</span><br></pre></td></tr></table></figure><h2 id="5-æ‰§è¡Œäº‹åŠ¡"><a href="#5-æ‰§è¡Œäº‹åŠ¡" class="headerlink" title="5. æ‰§è¡Œäº‹åŠ¡"></a>5. æ‰§è¡Œäº‹åŠ¡</h2><p>å…³é—­ autocommit</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># å¼€å¯è¿æ¥</span></span><br><span class="line">    conn = pymysql.connect(host=<span class="string">'localhost'</span>,user=<span class="string">'root'</span>,passwd=<span class="string">'123'</span>,db=<span class="string">'python'</span>,port=<span class="number">3306</span>,charset=<span class="string">'utf8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…³é—­è‡ªåŠ¨æäº¤</span></span><br><span class="line">    conn.autocommit(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å¼€å¯äº‹åŠ¡</span></span><br><span class="line">    conn.begin()</span><br><span class="line">    <span class="comment"># æ‰“å¼€æ¸¸æ ‡</span></span><br><span class="line">    cur = conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ é™¤</span></span><br><span class="line">    sql = <span class="string">"delete from t1 WHERE id &gt; 20000"</span></span><br><span class="line">    <span class="comment"># æ”¹</span></span><br><span class="line">    sql = <span class="string">"update t1 set age = age -1 where age &gt;=50 "</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># èšåˆ</span></span><br><span class="line">    sql = <span class="string">"select count(*) from t1 where age &lt; 20"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰§è¡Œ sql</span></span><br><span class="line">    cur.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æœ‰ç»“æœçš„, æ‰§è¡Œå®Œåéœ€è¦fetchç»“æœ</span></span><br><span class="line">    res = cur.fetchone()</span><br><span class="line">    print(res[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æäº¤è¿æ¥</span></span><br><span class="line">    conn.commit()</span><br><span class="line">    <span class="comment"># å…³é—­æ¸¸æ ‡</span></span><br><span class="line">    cur.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    print(<span class="string">"å‘ç”Ÿå¼‚å¸¸"</span>)</span><br><span class="line">    conn.rollback()</span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure><h1 id="äºŒ-Spark-ç¯å¢ƒä½¿ç”¨-Python-æ“ä½œ-HBase"><a href="#äºŒ-Spark-ç¯å¢ƒä½¿ç”¨-Python-æ“ä½œ-HBase" class="headerlink" title="äºŒ. Spark ç¯å¢ƒä½¿ç”¨ Python æ“ä½œ HBase"></a>äºŒ. Spark ç¯å¢ƒä½¿ç”¨ Python æ“ä½œ HBase</h1><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. ç¯å¢ƒå‡†å¤‡"></a>1. ç¯å¢ƒå‡†å¤‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">0.å¯åŠ¨hbaseé›†ç¾¤</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">å¦‚æœæ—¶é’Ÿä¸åŒæ­¥ã€‚</span><br><span class="line">$&gt;su root</span><br><span class="line">$&gt;xcall.sh <span class="string">"ntpdate asia.pool.ntp.org"</span></span><br><span class="line">å½“ç„¶, ä¹Ÿå¯ä»¥è®¾ç½®è„šæœ¬è‡ªåŠ¨åŒæ­¥, è¯¦ç»†è§æˆ‘çš„ hadoopHA ç¯å¢ƒæ­å»º</span><br><span class="line"></span><br><span class="line">1.åœ¨ HBase ç›®å½•ä¸‹,å¯åŠ¨hbaseçš„thriftserverï¼Œæ»¡è¶³å’Œç¬¬ä¸‰æ–¹åº”ç”¨é€šä¿¡ã€‚</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">$&gt;hbase-daemon.sh start thrift2</span><br><span class="line"></span><br><span class="line">2.æŸ¥çœ‹WebUI</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">/<span class="comment"># webuiç«¯å£ , 9090 rpcç«¯å£</span></span><br><span class="line">http://cs1:9095/        </span><br><span class="line"></span><br><span class="line">3.å®‰è£…macä¸‹thriftçš„ç¼–è¯‘å™¨</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">brew install thrift</span><br><span class="line"></span><br><span class="line">4.ä¸‹è½½å¹¶å®‰è£…thriftçš„pythonæ¨¡å—.</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">import thrift  ==&gt;æ²¡æœ‰çš„è¯, option + <span class="built_in">return</span> å®‰è£…</span><br><span class="line"></span><br><span class="line">5.æ‰¾åˆ°hbase.thriftæ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œäº§ç”Ÿpythonæ–‡ä»¶ã€‚</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘</span><br><span class="line">cmd&gt; thrift  -o ./out -gen py hbase.thrift</span><br><span class="line">ç”Ÿæˆåçš„è·¯å¾„åœ¨è¿™é‡Œ: /Users/shixuanji/Documents/èµ„æº/JaråŒ…/HBase/out/gen-py</span><br><span class="line"></span><br><span class="line">6.åˆ›å»ºideaçš„ä¸‹çš„æ–°æ¨¡å—</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">7.åˆ›å»ºpythonæ–‡ä»¶Demo1.py</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">8.å¤åˆ¶ç”Ÿæˆpythonæ–‡ä»¶åˆ°ideaä¸‹ã€‚</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">mythrift/hbase/..</span><br><span class="line"></span><br><span class="line">9.æ§åˆ¶å°ç¯å¢ƒæµ‹è¯•</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    ç§»é™¤spark/conf/core-site.xml | hdfs-site.xml | hive-site.xmlæ–‡ä»¶</span><br><span class="line">    [scala] ~/apps/spark/bin</span><br><span class="line">    &lt;spark-shell&gt;</span><br><span class="line">    val rdd = sc.makeRDD(1 to 10)</span><br><span class="line">    rdd.map(e=&gt;(e,1))</span><br><span class="line"></span><br><span class="line">    [python] ~/apps/spark/bin</span><br><span class="line">    &lt;pyspark&gt;</span><br><span class="line">    arr = [1,2,3,4]</span><br><span class="line">    rdd = sc.parallelize(arr);</span><br><span class="line">    rdd.map(lambda e : (e,1))</span><br></pre></td></tr></table></figure><h2 id="2-å…·ä½“ä»£ç "><a href="#2-å…·ä½“ä»£ç " class="headerlink" title="2.å…·ä½“ä»£ç "></a>2.å…·ä½“ä»£ç </h2><h4 id="2-1-å¯¹-hbase-çš„å¢åˆ æ”¹æŸ¥"><a href="#2-1-å¯¹-hbase-çš„å¢åˆ æ”¹æŸ¥" class="headerlink" title="2.1 å¯¹ hbase çš„å¢åˆ æ”¹æŸ¥"></a>2.1 å¯¹ hbase çš„å¢åˆ æ”¹æŸ¥</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/HBasePythonDemo/BasicPyHbase.py" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/blob/master/Spark_Project/HBasePythonDemo/BasicPyHbase.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¼å…¥thriftçš„pythonæ¨¡å—</span></span><br><span class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¼å…¥è‡ªå·²ç¼–è¯‘ç”Ÿæˆçš„hbase pythonæ¨¡å—</span></span><br><span class="line"><span class="keyword">from</span> mythrift.hbase <span class="keyword">import</span> THBaseService</span><br><span class="line"><span class="keyword">from</span> mythrift.hbase.ttypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> mythrift.hbase.ttypes <span class="keyword">import</span> TResult</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ›å»ºSocketè¿æ¥ï¼Œåˆ°s201:9090</span></span><br><span class="line">transport = TSocket.TSocket(<span class="string">'cs1'</span>, <span class="number">9090</span>)</span><br><span class="line">transport = TTransport.TBufferedTransport(transport)</span><br><span class="line">protocol = TBinaryProtocol.TBinaryProtocol(transport)</span><br><span class="line">client = THBaseService.Client(protocol)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰“å¼€ä¼ è¾“ç«¯å£!!!</span></span><br><span class="line">transport.open()</span><br><span class="line"></span><br><span class="line"><span class="comment"># putæ“ä½œ</span></span><br><span class="line">table = <span class="string">b'ns1:t1'</span></span><br><span class="line">row = <span class="string">b'row1'</span></span><br><span class="line">v1 = TColumnValue(<span class="string">b'f1'</span>, <span class="string">b'id'</span>, <span class="string">b'101'</span>)</span><br><span class="line">v2 = TColumnValue(<span class="string">b'f1'</span>, <span class="string">b'name'</span>, <span class="string">b'tomas'</span>)</span><br><span class="line">v3 = TColumnValue(<span class="string">b'f1'</span>, <span class="string">b'age'</span>, <span class="string">b'12'</span>)</span><br><span class="line">vals = [v1, v2, v3]</span><br><span class="line">put = TPut(row, vals)</span><br><span class="line">client.put(table, put)</span><br><span class="line">print(<span class="string">"okkkk!!"</span>)</span><br><span class="line">transport.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#get</span></span><br><span class="line">table = <span class="string">b'ns1:t1'</span></span><br><span class="line">rowkey=<span class="string">b"row1"</span></span><br><span class="line">col_id = TColumn(<span class="string">b"f1"</span>,<span class="string">b"id"</span>)</span><br><span class="line">col_name = TColumn(<span class="string">b"f1"</span>,<span class="string">b"name"</span>)</span><br><span class="line">col_age = TColumn(<span class="string">b"f1"</span>,<span class="string">b"age"</span>)</span><br><span class="line"></span><br><span class="line">cols = [col_id,col_name,col_age]</span><br><span class="line">get = TGet(rowkey,cols)</span><br><span class="line">res = client.get(table,get)</span><br><span class="line">print(bytes.decode(res.columnValues[<span class="number">0</span>].qualifier))</span><br><span class="line">print(bytes.decode(res.columnValues[<span class="number">0</span>].family))</span><br><span class="line">print(res.columnValues[<span class="number">0</span>].timestamp)</span><br><span class="line">print(bytes.decode(res.columnValues[<span class="number">0</span>].value))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#delete</span></span><br><span class="line">table = <span class="string">b'ns1:t1'</span></span><br><span class="line">rowkey = <span class="string">b"row1"</span></span><br><span class="line">col_id = TColumn(<span class="string">b"f1"</span>, <span class="string">b"id"</span>)</span><br><span class="line">col_name = TColumn(<span class="string">b"f1"</span>, <span class="string">b"name"</span>)</span><br><span class="line">col_age = TColumn(<span class="string">b"f1"</span>, <span class="string">b"age"</span>)</span><br><span class="line">cols = [col_id, col_name]</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ„é€ åˆ é™¤å¯¹è±¡</span></span><br><span class="line">delete = TDelete(rowkey,cols)</span><br><span class="line">res = client.deleteSingle(table, delete)</span><br><span class="line">transport.close()</span><br><span class="line">print(<span class="string">"ok"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Scan</span></span><br><span class="line">table = <span class="string">b'ns1:t12'</span></span><br><span class="line">startRow = <span class="string">b'1530357094900-43dwMLjxI5-0'</span></span><br><span class="line">stopRow = <span class="string">b'1530357183537-43dwMLjxI5-6'</span></span><br><span class="line">payload = TColumn(<span class="string">b"f1"</span>, <span class="string">b"payload"</span>)</span><br><span class="line"></span><br><span class="line">cols = [payload]</span><br><span class="line"></span><br><span class="line">scan = TScan(startRow=startRow,stopRow=stopRow,columns=cols)</span><br><span class="line"><span class="comment"># è¿™é‡Œå¦‚æœä¸ä¼  stopRow å°±æ˜¯æ‰«æåˆ°ç»“å°¾</span></span><br><span class="line">scan = TScan(startRow=startRow, columns=cols)</span><br><span class="line">r = client.getScannerResults(table,scan,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> r:</span><br><span class="line">    print(<span class="string">"============"</span>)</span><br><span class="line">    print(bytes.decode(x.columnValues[<span class="number">0</span>].qualifier))</span><br><span class="line">    print(bytes.decode(x.columnValues[<span class="number">0</span>].family))</span><br><span class="line">    print(x.columnValues[<span class="number">0</span>].timestamp)</span><br><span class="line">    print(bytes.decode(x.columnValues[<span class="number">0</span>].value))</span><br></pre></td></tr></table></figure><h4 id="2-2-å°†çˆ¬è™«çˆ¬å–çš„ç½‘é¡µå­˜å…¥-hbase"><a href="#2-2-å°†çˆ¬è™«çˆ¬å–çš„ç½‘é¡µå­˜å…¥-hbase" class="headerlink" title="2.2 å°†çˆ¬è™«çˆ¬å–çš„ç½‘é¡µå­˜å…¥ hbase"></a>2.2 å°†çˆ¬è™«çˆ¬å–çš„ç½‘é¡µå­˜å…¥ hbase</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/HBasePythonDemo/Crawler2HBase.py" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/blob/master/Spark_Project/HBasePythonDemo/Crawler2HBase.py</a></p><blockquote><p> ï£¿ï£¿ï£¿ï£¿ï£¿  CrawerPageDao.py  ï£¿ï£¿ï£¿ï£¿ï£¿</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥thriftçš„pythonæ¨¡å—</span></span><br><span class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥è‡ªå·²ç¼–è¯‘ç”Ÿæˆçš„hbase pythonæ¨¡å—</span></span><br><span class="line"><span class="keyword">from</span> mythrift.hbase <span class="keyword">import</span> THBaseService</span><br><span class="line"><span class="keyword">from</span> mythrift.hbase.ttypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> mythrift.hbase.ttypes <span class="keyword">import</span> TResult</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">åˆ›å»ºSocketè¿æ¥ï¼Œåˆ°s201:9090</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">transport = TSocket.TSocket(<span class="string">'cs1'</span>, <span class="number">9090</span>)</span><br><span class="line">transport = TTransport.TBufferedTransport(transport)</span><br><span class="line">protocol = TBinaryProtocol.TBinaryProtocol(transport)</span><br><span class="line">client = THBaseService.Client(protocol)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">å®šä¹‰å‡½æ•°ï¼Œä¿å­˜ç½‘é¡µ</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">savePage</span><span class="params">(url,page)</span>:</span></span><br><span class="line">    <span class="comment">#å¼€å¯è¿æ¥</span></span><br><span class="line">    transport.open()</span><br><span class="line">    <span class="comment">#å¯¹urlè¿›è¡Œbase64ç¼–ç ï¼Œå½¢æˆbytes,ä½œä¸ºrowkey</span></span><br><span class="line">    urlBase64Bytes = base64.encodebytes(url.encode(<span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># putæ“ä½œ</span></span><br><span class="line">    table = <span class="string">b'ns1:pages'</span></span><br><span class="line">    rowkey = urlBase64Bytes</span><br><span class="line">    v1 = TColumnValue(<span class="string">b'f1'</span>, <span class="string">b'page'</span>, page)</span><br><span class="line">    vals = [v1]</span><br><span class="line">    put = TPut(rowkey, vals)</span><br><span class="line">    client.put(table, put)</span><br><span class="line">    transport.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">åˆ¤æ–­ç½‘é¡µæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exists</span><span class="params">(url)</span>:</span></span><br><span class="line">    transport.open()</span><br><span class="line">    <span class="comment"># å¯¹urlè¿›è¡Œbase64ç¼–ç ï¼Œå½¢æˆbytes,ä½œä¸ºrowkey</span></span><br><span class="line">    urlBase64Bytes = base64.encodebytes(url.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">    print(urlBase64Bytes)</span><br><span class="line"></span><br><span class="line">    table = <span class="string">b'ns1:pages'</span></span><br><span class="line">    rowkey = urlBase64Bytes</span><br><span class="line">    col_page = TColumn(<span class="string">b"f1"</span>,<span class="string">b"page"</span>)</span><br><span class="line"></span><br><span class="line">    cols = [col_page]</span><br><span class="line">    get = TGet(rowkey,cols)</span><br><span class="line">    res = client.get(table, get)</span><br><span class="line">    transport.close()</span><br><span class="line">    <span class="keyword">return</span> res.row <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure><blockquote><p>ï£¿ï£¿ï£¿ï£¿ï£¿  Crawler2HBase.py  ï£¿ï£¿ï£¿ï£¿ï£¿</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–å…ˆåˆ›å»º hbase è¡¨: pages</span></span><br><span class="line"><span class="comment"># $hbase&gt; create 'ns1:pages','f1'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> CrawerPageDao</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹è½½ç½‘é¡µæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment">#åˆ¤æ–­å½“å‰çš„ç½‘é¡µæ˜¯å¦å·²ç»ä¸‹è½½</span></span><br><span class="line">    resp = urllib.request.urlopen(url)</span><br><span class="line">    pageBytes = resp.read()</span><br><span class="line">    resp.close</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> CrawerPageDao.exists(url):</span><br><span class="line">        CrawerPageDao.savePage(url, pageBytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#è§£æç½‘é¡µçš„å†…å®¹</span></span><br><span class="line">        pageStr = pageBytes.decode(<span class="string">"utf-8"</span>);</span><br><span class="line">        <span class="comment">#è§£æhrefåœ°å€</span></span><br><span class="line">        pattern = <span class="string">u'&lt;a[\u0000-\uffff&amp;&amp;&lt;sup&gt;[href]]*href="([\u0000-\uffff&amp;&amp;&lt;/sup&gt;"]*?)"'</span></span><br><span class="line">        res = re.finditer(pattern, pageStr)</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">            addr = r.group(<span class="number">1</span>);</span><br><span class="line">            print(addr)</span><br><span class="line">            <span class="keyword">if</span> addr.startswith(<span class="string">"//"</span>):</span><br><span class="line">                addr = addr.replace(<span class="string">"//"</span>,<span class="string">"http://"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">#åˆ¤æ–­ç½‘é¡µä¸­æ˜¯å¦åŒ…å«è‡ªå·±çš„åœ°å€</span></span><br><span class="line">            <span class="keyword">if</span> addr.startswith(<span class="string">"http://"</span>) <span class="keyword">and</span> url != addr <span class="keyword">and</span> (<span class="keyword">not</span> CrawerPageDao.exists(addr)):</span><br><span class="line">                download(addr) ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        print(pageBytes.decode(<span class="string">"gbk"</span>, errors=<span class="string">'ignore'</span>));</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">download(<span class="string">"http://jd.com"</span>);</span><br></pre></td></tr></table></figure><hr><h1 id="ä¸‰-ä½¿ç”¨pythonå®ç°sparkçš„æ•°æ®åˆ†æ"><a href="#ä¸‰-ä½¿ç”¨pythonå®ç°sparkçš„æ•°æ®åˆ†æ" class="headerlink" title="ä¸‰. ä½¿ç”¨pythonå®ç°sparkçš„æ•°æ®åˆ†æ"></a>ä¸‰. ä½¿ç”¨pythonå®ç°sparkçš„æ•°æ®åˆ†æ</h1><p><strong>å‚è€ƒè¿™æœ¬ä¹¦, data ç­‰éƒ½æœ‰ä¸‹è½½åœ°å€</strong> </p><blockquote><p>Apache Spark 2 for Beginners</p></blockquote><h2 id="1-ç¯å¢ƒå‡†å¤‡-1"><a href="#1-ç¯å¢ƒå‡†å¤‡-1" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><p><strong>é¦–å…ˆå½“å‰pythonç¯å¢ƒå¿…é¡»å®‰è£…äº†è¿™äº›ç»„ä»¶, ç”±äºæˆ‘çš„macä¸Šå·²ç»è£…äº†, è¿™é‡Œå°±ä¸å†è£…äº†</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.numpy</span><br><span class="line">    cmd&gt;pip install -i https://pypi.tuna.tsinghua.edu.cn/simple numpy</span><br><span class="line"></span><br><span class="line">2.scipy</span><br><span class="line">    pip install -i https://pypi.tuna.tsinghua.edu.cn/simple scipy</span><br><span class="line"></span><br><span class="line">3.matplotpy</span><br><span class="line">    pip install -i https://pypi.tuna.tsinghua.edu.cn/simple matplotlib</span><br><span class="line">    python -m pip install -U pip setuptools</span><br><span class="line">    python -m pip install matplotlib</span><br></pre></td></tr></table></figure><h2 id="2-åœ¨-mac-ç¯å¢ƒçš„-Spark-ä¸‹"><a href="#2-åœ¨-mac-ç¯å¢ƒçš„-Spark-ä¸‹" class="headerlink" title="2.åœ¨ mac ç¯å¢ƒçš„ Spark ä¸‹"></a>2.åœ¨ mac ç¯å¢ƒçš„ Spark ä¸‹</h2><p>ä¹Ÿå¯ä»¥åœ¨ Linux ä¸‹çš„å›¾å½¢ç•Œé¢ä¸­é€šè¿‡ terminal æ“ä½œ.</p><p><strong>ç›®å½•å»ºè®®ä¸è¦æœ‰ä¸­æ–‡,  å¦åˆ™ä¼šæœ‰ä¸€äº›è­¦å‘Šç”šè‡³é”™è¯¯</strong></p><p><strong>æˆ‘çš„ç›®å½•åœ¨è¿™é‡Œ:</strong> <code>/Users/shixuanji/Documents/èµ„æº/JaråŒ…/Spark/spark-2.1.3-bin-hadoop2.7/bin/pyspark</code></p><p>è¿›å…¥æˆ‘çš„ <code>iTerm2</code>, è¿›å…¥<code>pyspark</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#å¯¼å…¥sql</span></span><br><span class="line">    <span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> Row</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">    <span class="keyword">import</span> pylab <span class="keyword">as</span> P</span><br><span class="line">    plt.rcdefaults()        <span class="comment"># Restore the rc params from Matplotlib's internal defaults</span></span><br><span class="line">    dataDir =<span class="string">"file:///home/centos/ml-data/ml-1m/users.dat"</span></span><br><span class="line">    lines = sc.textFile(dataDir)</span><br><span class="line">    splitLines = lines.map(<span class="keyword">lambda</span> l: l.split(<span class="string">"::"</span>))</span><br><span class="line">    usersRDD = splitLines.map(<span class="keyword">lambda</span> p: Row(id=p[<span class="number">0</span>],gender=p[<span class="number">1</span>],age=int(p[<span class="number">2</span>]), occupation=p[<span class="number">3</span>], zipcode=p[<span class="number">4</span>]))</span><br><span class="line">    usersDF = spark.createDataFrame(usersRDD)</span><br><span class="line">    usersDF.createOrReplaceTempView(<span class="string">"users"</span>)</span><br><span class="line">    usersDF.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”Ÿæˆç›´æ–¹å›¾</span></span><br><span class="line">    ageDF = spark.sql(<span class="string">"SELECT age FROM users"</span>)</span><br><span class="line">    ageList = ageDF.rdd.map(<span class="keyword">lambda</span> p: p.age).collect()</span><br><span class="line">    ageDF.describe().show()</span><br><span class="line"></span><br><span class="line">    plt.hist(ageList)</span><br><span class="line">    plt.title(<span class="string">"Age distribution of the users\n"</span>)</span><br><span class="line">    plt.xlabel(<span class="string">"Age"</span>)</span><br><span class="line">    plt.ylabel(<span class="string">"Number of users"</span>)</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯†åº¦å›¾</span></span><br><span class="line">    <span class="keyword">from</span> scipy.stats <span class="keyword">import</span> gaussian_kde</span><br><span class="line">    density = gaussian_kde(ageList)</span><br><span class="line">    xAxisValues = np.linspace(<span class="number">0</span>,<span class="number">100</span>,<span class="number">1000</span>)</span><br><span class="line">    density.covariance_factor = <span class="keyword">lambda</span> : <span class="number">.5</span></span><br><span class="line">    density._compute_covariance()</span><br><span class="line">    plt.title(<span class="string">"Age density plot of the users\n"</span>)</span><br><span class="line">    plt.xlabel(<span class="string">"Age"</span>)</span><br><span class="line">    plt.ylabel(<span class="string">"Density"</span>)</span><br><span class="line">    plt.plot(xAxisValues, density(xAxisValues))</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”ŸæˆåµŒå¥—å­å›¾</span></span><br><span class="line">    plt.subplot(<span class="number">121</span>)</span><br><span class="line">    plt.hist(ageList)</span><br><span class="line">    plt.title(<span class="string">"Age distribution of the users\n"</span>)</span><br><span class="line">    plt.xlabel(<span class="string">"Age"</span>)</span><br><span class="line">    plt.ylabel(<span class="string">"Number of users"</span>)</span><br><span class="line">    plt.subplot(<span class="number">122</span>)</span><br><span class="line">    plt.title(<span class="string">"Summary of distribution\n"</span>)</span><br><span class="line">    plt.xlabel(<span class="string">"Age"</span>)</span><br><span class="line">    plt.boxplot(ageList, vert=<span class="keyword">False</span>)</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ±çŠ¶å›¾</span></span><br><span class="line">    occ10 = spark.sql(<span class="string">"SELECT occupation, count(occupation) as usercount FROM users GROUP BY occupation ORDER BY usercount DESC LIMIT 10"</span>)</span><br><span class="line">    occ10.show()</span><br><span class="line"></span><br><span class="line">    occTuple = occ10.rdd.map(<span class="keyword">lambda</span> p:(p.occupation,p.usercount)).collect()</span><br><span class="line">    occList, countList = zip(*occTuple)</span><br><span class="line">    occList</span><br><span class="line"></span><br><span class="line">    y_pos = np.arange(len(occList))</span><br><span class="line">    plt.barh(y_pos, countList, align=<span class="string">'center'</span>, alpha=<span class="number">0.4</span>)</span><br><span class="line">    plt.yticks(y_pos, occList)</span><br><span class="line">    plt.xlabel(<span class="string">'Number of users'</span>)</span><br><span class="line">    plt.title(<span class="string">'Top 10 user types\n'</span>)</span><br><span class="line">    plt.gcf().subplots_adjust(left=<span class="number">0.15</span>)</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å †æ ˆæ¡å½¢å›¾</span></span><br><span class="line">    occGender = spark.sql(<span class="string">"SELECT occupation, gender FROM users"</span>)</span><br><span class="line">    occGender.show()</span><br><span class="line"></span><br><span class="line">    occCrossTab = occGender.stat.crosstab(<span class="string">"occupation"</span>,<span class="string">"gender"</span>)</span><br><span class="line">    occupationsCrossTuple = occCrossTab.rdd.map(<span class="keyword">lambda</span> p:(p.occupation_gender,p.M, p.F)).collect()</span><br><span class="line">    occList, mList, fList = zip(*occupationsCrossTuple)</span><br><span class="line">    N = len(occList)</span><br><span class="line">    ind = np.arange(N)</span><br><span class="line">    width = <span class="number">0.75</span></span><br><span class="line">    p1 = plt.bar(ind, mList, width, color=<span class="string">'r'</span>)</span><br><span class="line">    p2 = plt.bar(ind, fList, width, color=<span class="string">'y'</span>, bottom=mList)</span><br><span class="line">    plt.ylabel(<span class="string">'Count'</span>)</span><br><span class="line">    plt.title(<span class="string">'Gender distribution by occupation\n'</span>)</span><br><span class="line">    plt.xticks(ind + width/<span class="number">2.</span>, occList, rotation=<span class="number">90</span>)</span><br><span class="line">    plt.legend((p1[<span class="number">0</span>], p2[<span class="number">0</span>]), (<span class="string">'Male'</span>, <span class="string">'Female'</span>))</span><br><span class="line">    plt.gcf().subplots_adjust(bottom=<span class="number">0.25</span>)</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é¥¼å›¾</span></span><br><span class="line">    occupationsBottom10 = spark.sql(<span class="string">"SELECT occupation,count(occupation) as usercount FROM users GROUP BY occupation ORDER BY usercount LIMIT 10"</span>)</span><br><span class="line">    occupationsBottom10Tuple = occupationsBottom10.rdd.map(<span class="keyword">lambda</span> p:(p.occupation,p.usercount)).collect()</span><br><span class="line">    occupationsBottom10List, countBottom10List =zip(*occupationsBottom10Tuple)</span><br><span class="line">    explode = (<span class="number">0</span>, <span class="number">0.3</span>, <span class="number">0.2</span>, <span class="number">0.15</span>,<span class="number">0.1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>)</span><br><span class="line">    plt.pie(countBottom10List, explode=explode,labels=occupationsBottom10List, autopct=<span class="string">'%1.1f%%'</span>, shadow=<span class="keyword">True</span>,startangle=<span class="number">90</span>)</span><br><span class="line">    plt.title(<span class="string">'Bottom 10 user types\n'</span>)</span><br><span class="line">    plt.show(block=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-Python-è®¿é—®-MySQL&quot;&gt;&lt;a href=&quot;#ä¸€-Python-è®¿é—®-MySQL&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. Python è®¿é—® MySQL&quot;&gt;&lt;/a&gt;ä¸€. Python è®¿é—® MySQL&lt;/h1&gt;&lt;h2 id=&quot;1-å®‰
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>i-Spark-4</title>
    <link href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-4/"/>
    <id>https://airpoet.github.io/2018/07/20/Spark/i-Spark-4/</id>
    <published>2018-07-20T14:11:10.340Z</published>
    <updated>2018-07-23T06:20:44.679Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-æœºå™¨å­¦ä¹ åˆ†ç±»"><a href="#ä¸€-æœºå™¨å­¦ä¹ åˆ†ç±»" class="headerlink" title="ä¸€. æœºå™¨å­¦ä¹ åˆ†ç±»"></a>ä¸€. æœºå™¨å­¦ä¹ åˆ†ç±»</h1><h2 id="1-ç›‘ç£å­¦ä¹ "><a href="#1-ç›‘ç£å­¦ä¹ " class="headerlink" title="1.ç›‘ç£å­¦ä¹ "></a>1.ç›‘ç£å­¦ä¹ </h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-20-141755.png" alt="image-20180720221754476"></p><ul><li>æœ‰è®­ç»ƒæ•°æ®é›†ã€‚è§„èŒƒæ•°æ®ã€‚åˆè§„æ•°æ®ã€‚äº§ç”Ÿæ¨æ–­å‡½æ•°.ç„¶åå¯¹æ–°æ•°æ®åº”ç”¨å‡½æ•°ã€‚ </li><li>director actor edit         Label </li></ul><h2 id="2-éç›‘ç£å­¦ä¹ "><a href="#2-éç›‘ç£å­¦ä¹ " class="headerlink" title="2.éç›‘ç£å­¦ä¹ "></a>2.éç›‘ç£å­¦ä¹ </h2><ul><li>æ²¡æœ‰è®­ç»ƒæ•°æ®ã€‚ </li><li>åˆ†ç»„ã€‚ </li></ul><h2 id="3-æ¨è"><a href="#3-æ¨è" class="headerlink" title="3.æ¨è"></a>3.æ¨è</h2><ul><li>ååŒè¿‡æ»¤. </li><li>çŒœæµ‹ä½ å–œæ¬¢. </li><li>ç”µå•†ã€‚ </li></ul><hr><h1 id="äºŒ-Sparkæœºå™¨å­¦ä¹ åº“"><a href="#äºŒ-Sparkæœºå™¨å­¦ä¹ åº“" class="headerlink" title="äºŒ. Sparkæœºå™¨å­¦ä¹ åº“"></a>äºŒ. Sparkæœºå™¨å­¦ä¹ åº“</h1><p><strong>[Estimator]</strong></p><ul><li><p>è¿è¡Œåœ¨åŒ…å«äº†featureå’Œlabel(ç»“æœ)çš„dataFrameä¹‹ä¸Šï¼Œå¯¹æ•°æ®è¿›è¡Œè®­ç»ƒåˆ›å»ºmodelã€‚</p></li><li><p>è¯¥æ¨¡å‹ç”¨äºä»¥åçš„é¢„æµ‹ã€‚</p></li></ul><p><strong>[Transformer]</strong></p><ul><li>å°†åŒ…å«featureçš„Dataframeå˜æ¢æˆäº†åŒ…å«äº†é¢„æµ‹çš„dataframe.</li><li>ç”±Estimatoråˆ›å»ºçš„modelå°±æ˜¯Transformerã€‚</li></ul><p><strong>[Parameter]</strong></p><ul><li>Estimatorå’ŒTransformerä½¿ç”¨çš„æ•°æ®ï¼Œé€šå¸¸å’Œæœºå™¨å­¦ä¹ çš„ç®—æ³•ç›¸å…³ã€‚</li><li>Spark APIç»™å‡ºäº†ä¸€è‡´æ€§APIé’ˆå¯¹ç®—æ³•ã€‚</li></ul><p><strong>[Pipeline]</strong></p><ul><li>å°†Estimatorså’ŒTransformersç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœºå™¨å­¦ä¹ å·¥ä½œæµ.</li></ul><h4 id="æœºå™¨å­¦ä¹ åº”ç”¨æ­¥éª¤"><a href="#æœºå™¨å­¦ä¹ åº”ç”¨æ­¥éª¤" class="headerlink" title="æœºå™¨å­¦ä¹ åº”ç”¨æ­¥éª¤"></a>æœºå™¨å­¦ä¹ åº”ç”¨æ­¥éª¤</h4><ol><li>è¯»å–æ•°æ®æ–‡ä»¶å½¢æˆè®­ç»ƒæ•°æ®æ¡† </li><li>åˆ›å»ºLinearRegressionå¹¶è®¾ç½®å‚æ•° </li><li>å¯¹è®­ç»ƒæ•°æ®è¿›è¡Œæ¨¡å‹æ‹Ÿåˆï¼Œå®Œæˆè¯„ä¼°ç®¡çº¿. </li><li>åˆ›å»ºåŒ…å«æµ‹è¯•æ•°æ®çš„DataFrameï¼Œå…¸å‹åŒ…å«featureå’Œlabelï¼Œå¯ä»¥é€šè¿‡æ¯”è¾ƒé¢„æµ‹æ ‡ç­¾å’Œæµ‹è¯•æ ‡ç­¾ç¡®è®¤modelæ˜¯okï¼Œ </li><li>ä½¿ç”¨æ¨¡å‹ï¼Œå¯¹æµ‹è¯•æ•°æ®è¿›è¡Œå˜æ¢(åº”ç”¨æ¨¡å‹),æŠ½å–feature ï¼Œlabelï¼Œpredication. </li></ol><h1 id="ä¸‰-ä»£ç å®ä¾‹"><a href="#ä¸‰-ä»£ç å®ä¾‹" class="headerlink" title="ä¸‰. ä»£ç å®ä¾‹"></a>ä¸‰. ä»£ç å®ä¾‹</h1><h2 id="1-çº¿æ€§å›å½’"><a href="#1-çº¿æ€§å›å½’" class="headerlink" title="1. çº¿æ€§å›å½’"></a>1. çº¿æ€§å›å½’</h2><blockquote><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/SparkMLDemo1.scala" target="_blank" rel="noopener">æµ‹è¯•æ¡ˆä¾‹</a></p></blockquote><h2 id="2-é€»è¾‘å›å½’"><a href="#2-é€»è¾‘å›å½’" class="headerlink" title="2. é€»è¾‘å›å½’"></a>2. é€»è¾‘å›å½’</h2><blockquote><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/LogicRegressWineClassifyDemo.scala" target="_blank" rel="noopener">é…’è´¨é‡é¢„æµ‹</a></p></blockquote><blockquote><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/SpamFilterDemo1.scala" target="_blank" rel="noopener">åƒåœ¾é‚®ä»¶è¿‡æ»¤</a></p></blockquote><h2 id="3-ALS-æœ€å°äºŒä¹˜æ³•"><a href="#3-ALS-æœ€å°äºŒä¹˜æ³•" class="headerlink" title="3. ALS (æœ€å°äºŒä¹˜æ³•)"></a>3. ALS (æœ€å°äºŒä¹˜æ³•)</h2><blockquote><p>å•†å“æ¨è: <a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/RecommDemo.scala" target="_blank" rel="noopener">æ·»åŠ å‘æŒ‡å®šç”¨æˆ·æ¨ènæ¬¾å•†å“; å°†æŒ‡å®šçš„å•†å“æ¨èç»™nä¸ªç”¨æˆ·; å‘æ‰€æœ‰ç”¨æˆ·æ¨ènç§å•†å“</a></p></blockquote><blockquote><p>ç”µå½±æ¨è: <a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala/MovieRecommDemo.scala" target="_blank" rel="noopener">ALSç®—æ³•ç”µå½±æ¨è</a> </p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-æœºå™¨å­¦ä¹ åˆ†ç±»&quot;&gt;&lt;a href=&quot;#ä¸€-æœºå™¨å­¦ä¹ åˆ†ç±»&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. æœºå™¨å­¦ä¹ åˆ†ç±»&quot;&gt;&lt;/a&gt;ä¸€. æœºå™¨å­¦ä¹ åˆ†ç±»&lt;/h1&gt;&lt;h2 id=&quot;1-ç›‘ç£å­¦ä¹ &quot;&gt;&lt;a href=&quot;#1-ç›‘ç£å­¦ä¹ &quot; class=&quot;header
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="MLLib" scheme="https://airpoet.github.io/categories/Spark/MLLib/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/tags/Hadoop/"/>
    
      <category term="MLLib" scheme="https://airpoet.github.io/tags/MLLib/"/>
    
      <category term="æœºå™¨å­¦ä¹ " scheme="https://airpoet.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>i-Spark-3</title>
    <link href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-3/"/>
    <id>https://airpoet.github.io/2018/07/20/Spark/i-Spark-3/</id>
    <published>2018-07-20T12:06:12.974Z</published>
    <updated>2018-07-27T14:09:20.029Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-Spark-Streaming-ç®€ä»‹"><a href="#ä¸€-Spark-Streaming-ç®€ä»‹" class="headerlink" title="ä¸€. Spark Streaming ç®€ä»‹"></a>ä¸€. Spark Streaming ç®€ä»‹</h1><h2 id="1-ä»‹ç»"><a href="#1-ä»‹ç»" class="headerlink" title="1.ä»‹ç»"></a>1.ä»‹ç»</h2><ul><li>æ˜¯ <code>spark core</code> çš„æ‰©å±•ï¼Œé’ˆå¯¹å®æ—¶æ•°æ®æµå¤„ç†,å…·æœ‰å¯æ‰©å±•ã€é«˜ååé‡ã€å®¹é”™.</li><li>æ•°æ®å¯ä»¥æ˜¯æ¥è‡ªäº<code>kafka, flume, tcpsocket</code>,ä½¿ç”¨é«˜çº§å‡½æ•°(map reduce filter ,join , window)</li><li>å¤„ç†çš„æ•°æ®å¯ä»¥æ¨é€åˆ° <code>database</code>, <code>hdfs</code>, é’ˆå¯¹æ•°æ®æµå¤„ç†å¯ä»¥åº”ç”¨åˆ°æœºå™¨å­¦ä¹ å’Œå›¾è®¡ç®—ä¸­ã€‚</li></ul><h2 id="2-DStream-Discretized-Stream-ç¦»æ•£æµ"><a href="#2-DStream-Discretized-Stream-ç¦»æ•£æµ" class="headerlink" title="2. DStream (Discretized Stream ) ç¦»æ•£æµ"></a>2. DStream (Discretized Stream ) ç¦»æ•£æµ</h2><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ:"></a><strong>æ¦‚å¿µ:</strong></h4><ul><li>ç¦»æ•£æµ,è¡¨ç¤ºçš„æ˜¯è¿ç»­çš„æ•°æ®æµã€‚è¿ç»­çš„RDDåºåˆ—ã€‚å‡†å®æ—¶è®¡ç®—ã€‚</li><li>é€šè¿‡kafkaã€flumeç­‰è¾“å…¥æ•°æ®æµäº§ç”Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¯¹å…¶ä»–DStreamè¿›è¡Œé«˜é˜¶å˜æ¢äº§ç”Ÿã€‚</li><li>åœ¨å†…éƒ¨ï¼ŒDStreamè¡¨ç°ä¸ºRDDåºåˆ—ã€‚</li></ul><h4 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹:"></a><strong>æ³¨æ„äº‹é¡¹:</strong></h4><ul><li>å¯åŠ¨ä¸Šä¸‹æ–‡ä¹‹åï¼Œä¸èƒ½å¯åŠ¨æ–°çš„ç¦»æ•£æµ</li><li>ä¸Šä¸‹æ–‡åœæ­¢åä¸èƒ½restart</li><li>åŒä¸€ JVMåªæœ‰ä¸€ä¸ª active çš„ StreamingContext</li><li>åœæ­¢StreamingContextä¼šä¸€åŒstopæ‰SparkContextï¼Œå¦‚è‹¥åªåœæ­¢StreamingContext. <code>ssc.stop(false|true);</code> :TODO</li><li>SparkContextå¯ä»¥åˆ›å»ºå¤šä¸ªStreamingContext, åˆ›å»ºæ–°çš„ä¹‹å‰åœæ‰æ—§çš„ã€‚</li></ul><h4 id="DStreamå’ŒReceiver"><a href="#DStreamå’ŒReceiver" class="headerlink" title="DStreamå’ŒReceiver:"></a>DStreamå’ŒReceiver:</h4><ul><li><strong>ä»‹ç»</strong><ul><li>Receiveræ˜¯æ¥å—è€…ï¼Œä»sourceæ¥å—æ•°æ®ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ä¾›sparkå¤„ç†ã€‚</li></ul></li><li><strong>æº</strong><ul><li>åŸºæœ¬æº:fileSystem | socket,å†…ç½®APIæ”¯æŒã€‚</li><li>é«˜çº§æº:kafka | flume | â€¦ï¼Œéœ€è¦å¼•å…¥pom.xmlä¾èµ–.</li></ul></li><li><strong>æ³¨æ„</strong><ul><li>ä½¿ç”¨localæ¨¡å¼æ—¶ï¼Œä¸èƒ½ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹.ä½¿ç”¨çš„local[n]ï¼Œnéœ€è¦å¤§äºreceiverçš„ä¸ªæ•°ã€‚ </li></ul></li></ul><hr><h1 id="äºŒ-ä½“éªŒSpark-Streaming"><a href="#äºŒ-ä½“éªŒSpark-Streaming" class="headerlink" title="äºŒ. ä½“éªŒSpark Streaming"></a>äºŒ. ä½“éªŒSpark Streaming</h1><h2 id="1-å¼•å…¥-pom-ä¾èµ–"><a href="#1-å¼•å…¥-pom-ä¾èµ–" class="headerlink" title="1.å¼•å…¥ pom ä¾èµ–"></a>1.å¼•å…¥ pom ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-Scala-æ“ä½œä»£ç -in-IDEA"><a href="#2-Scala-æ“ä½œä»£ç -in-IDEA" class="headerlink" title="2. Scala æ“ä½œä»£ç  in IDEA"></a>2. Scala æ“ä½œä»£ç  in IDEA</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//local[n] n &gt; 1</span></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local[2]"</span>).setAppName(<span class="string">"NetworkWordCount"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºSparkæµä¸Šä¸‹æ–‡,æ‰¹æ¬¡æ—¶é•¿æ˜¯1s</span></span><br><span class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºsocketæ–‡æœ¬æµ</span></span><br><span class="line"><span class="keyword">val</span> lines = ssc.socketTextStream(<span class="string">"localhost"</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‹æ‰</span></span><br><span class="line"><span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//å˜æ¢æˆå¯¹å¶</span></span><br><span class="line"><span class="keyword">val</span> pairs = words.map((_,<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ–ç®€</span></span><br><span class="line"><span class="keyword">val</span> count = pairs.reduceByKey(_+_) ;</span><br><span class="line">count.print()</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯åŠ¨</span></span><br><span class="line">ssc.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç­‰å¾…ç»“æŸ</span></span><br><span class="line">ssc.awaitTermination()</span><br></pre></td></tr></table></figure><h2 id="3-é€šè¿‡-nc-ä¸-Spark-äº¤äº’"><a href="#3-é€šè¿‡-nc-ä¸-Spark-äº¤äº’" class="headerlink" title="3. é€šè¿‡ nc ä¸ Spark äº¤äº’"></a>3. é€šè¿‡ nc ä¸ Spark äº¤äº’</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1&gt; å¯åŠ¨ nc</span><br><span class="line">nc -lk 9999</span><br><span class="line"></span><br><span class="line">2&gt; è¿è¡Œ Spark Streaming ä»£ç , å¼€å¯ç›‘å¬ localhost:9999 </span><br><span class="line"></span><br><span class="line">3&gt; åœ¨ nc å‘½ä»¤è¡Œè¾“å…¥å•è¯ </span><br><span class="line">$&gt; hello world </span><br><span class="line">$&gt; ....</span><br><span class="line"></span><br><span class="line">$&gt; è§‚å¯Ÿ spark æ§åˆ¶å°æ‰“å°</span><br><span class="line"></span><br><span class="line">PS: æŠŠ log4j æ–‡ä»¶æ”¾åˆ°é¡¹ç›®çš„ resources ä¸‹, è®¾ç½®log4j çš„æ‰“å°çº§åˆ«ä¸º WARN, å¦åˆ™å¾ˆéš¾è§‚å¯Ÿæ¸…æ¥š</span><br></pre></td></tr></table></figure><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/resources/log4j.properties" target="_blank" rel="noopener">log4j æ–‡ä»¶è¯·å‚è€ƒ</a></p><h2 id="4-å¯¼å‡º-Spark-Streaming-ä¸º-jar-åŒ…-æ”¾åˆ°-Linux-ä¸‹è¿è¡Œ"><a href="#4-å¯¼å‡º-Spark-Streaming-ä¸º-jar-åŒ…-æ”¾åˆ°-Linux-ä¸‹è¿è¡Œ" class="headerlink" title="4.å¯¼å‡º Spark Streaming ä¸º jar åŒ…, æ”¾åˆ° Linux ä¸‹è¿è¡Œ"></a>4.å¯¼å‡º Spark Streaming ä¸º jar åŒ…, æ”¾åˆ° Linux ä¸‹è¿è¡Œ</h2><p><strong>æ³¨æ„: ç›´æ¥spark-submit   æˆ–è€… spark-submit â€“help , ä¼šå¼¹å‡ºå¸®åŠ©</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$&gt; spark-submit --name wcstreaming </span><br><span class="line">                --<span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">rox</span>.<span class="title">spark</span>.<span class="title">scala</span>.<span class="title">SparkStreamingDemo</span></span></span><br><span class="line"><span class="class">                <span class="title">--master</span> <span class="title">spark</span></span>:<span class="comment">//cs1:7077</span></span><br><span class="line">                <span class="type">SparkDemo1</span><span class="number">-1.0</span>-<span class="type">SNAPSHOT</span>.jar</span><br></pre></td></tr></table></figure><hr><h1 id="ä¸‰-Kafka-ä¸-Spark-Streaming-æ•´åˆ"><a href="#ä¸‰-Kafka-ä¸-Spark-Streaming-æ•´åˆ" class="headerlink" title="ä¸‰. Kafka ä¸ Spark Streaming æ•´åˆ"></a>ä¸‰. Kafka ä¸ Spark Streaming æ•´åˆ</h1><h2 id="1-å›å¿†Kafka"><a href="#1-å›å¿†Kafka" class="headerlink" title="1. å›å¿†Kafka"></a>1. <strong>å›å¿†Kafka</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1&gt; å¯åŠ¨ kafka,cs2~cs4  å‰æå…ˆå¯åŠ¨ zk</span><br><span class="line">$&gt; kafka-server-start.sh /home/ap/apps/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">2&gt; æŸ¥çœ‹ä¸»é¢˜: </span><br><span class="line">$&gt; kafka-topics.sh --zookeeper cs1:2181 --list</span><br><span class="line"></span><br><span class="line">3&gt; å¼€å¯æ¶ˆè´¹è€…</span><br><span class="line">[ap@cs4]~%&gt;  kafka-console-consumer.sh --zookeeper cs3:2181 --topic kafka-test</span><br><span class="line"></span><br><span class="line">4&gt; å¼€å¯ç”Ÿäº§è€…</span><br><span class="line">[ap@cs2]~%&gt;  kafka-console-producer.sh --broker-list cs4:9092 --topic kafka-test </span><br><span class="line"></span><br><span class="line">&gt;&gt; åœ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯, æŸ¥çœ‹æ¶ˆè´¹è€…</span><br></pre></td></tr></table></figure><h2 id="2-ä½¿ç”¨-Javaç¼–å†™-Kafka-SparkStreaming-ä»£ç "><a href="#2-ä½¿ç”¨-Javaç¼–å†™-Kafka-SparkStreaming-ä»£ç " class="headerlink" title="2. ä½¿ç”¨ Javaç¼–å†™ Kafka-SparkStreaming ä»£ç "></a>2. ä½¿ç”¨ Javaç¼–å†™ Kafka-SparkStreaming ä»£ç </h2><p><a href="https://github.com/airpoet/bigdata/blob/068fbf3e23f6514fadcef10cef5b6ce8d87318d8/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/KafkaSparkstreamingDemo.java" target="_blank" rel="noopener">å…·ä½“è§ github</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rox.spark.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.TaskContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.Seconds;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.api.java.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.TopicPartition;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaSparkstreamingDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">        conf.setAppName(<span class="string">"KafkaSparkstreamingDemo"</span>);</span><br><span class="line">        conf.setMaster(<span class="string">"local[4]"</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºSparkæµåº”ç”¨ä¸Šä¸‹æ–‡</span></span><br><span class="line">        JavaStreamingContext streamingContext = <span class="keyword">new</span> JavaStreamingContext(conf, Seconds.apply(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; kafkaParams = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        kafkaParams.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"cs2:9092,cs3:9092"</span>);</span><br><span class="line">        kafkaParams.put(<span class="string">"key.deserializer"</span>, StringDeserializer.class);</span><br><span class="line">        kafkaParams.put(<span class="string">"value.deserializer"</span>, StringDeserializer.class);</span><br><span class="line">        kafkaParams.put(<span class="string">"group.id"</span>, <span class="string">"g6"</span>);</span><br><span class="line">        kafkaParams.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"latest"</span>);</span><br><span class="line">        kafkaParams.put(<span class="string">"enable.auto.commit"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        Collection&lt;String&gt; topics = Arrays.asList(<span class="string">"kafka-test"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å–å‡º kafka stream</span></span><br><span class="line">        <span class="keyword">final</span> JavaInputDStream&lt;ConsumerRecord&lt;String, String&gt;&gt; stream =</span><br><span class="line">                KafkaUtils.createDirectStream(</span><br><span class="line">                        streamingContext,</span><br><span class="line">                        LocationStrategies.PreferConsistent(),</span><br><span class="line">                        ConsumerStrategies.&lt;String, String&gt;Subscribe(topics, kafkaParams)</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‹æ‰</span></span><br><span class="line">        JavaDStream&lt;String&gt; wordDS = stream.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;ConsumerRecord&lt;String, String&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterator&lt;String&gt; <span class="title">call</span><span class="params">(ConsumerRecord&lt;String, String&gt; r)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String value = r.value();</span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                String[] arr = value.split(<span class="string">" "</span>);</span><br><span class="line">                <span class="keyword">for</span> (String s : arr) &#123;</span><br><span class="line">                    list.add(s);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> list.iterator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ˜ å°„æˆå…ƒç¥– (æ‹¼1)</span></span><br><span class="line">        JavaPairDStream&lt;String,Integer&gt; pairDS = wordDS.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, Integer&gt;(s,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">              </span><br><span class="line">        <span class="comment">// èšåˆ</span></span><br><span class="line">        JavaPairDStream&lt;String, Integer&gt; countDS = pairDS.reduceByKey(<span class="keyword">new</span> Function2&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(Integer v1, Integer v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v1 + v2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°è®¡ç®—ç»“æœ</span></span><br><span class="line">        countDS.print();</span><br><span class="line"></span><br><span class="line">        streamingContext.start();</span><br><span class="line"></span><br><span class="line">        streamingContext.awaitTermination();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å››-è·¨å•ä½æ—¶é—´-å•ä½è·ç¦»-Window-è·¨æ‰¹æ¬¡-updateStateByKey"><a href="#å››-è·¨å•ä½æ—¶é—´-å•ä½è·ç¦»-Window-è·¨æ‰¹æ¬¡-updateStateByKey" class="headerlink" title="å››.  è·¨å•ä½æ—¶é—´,å•ä½è·ç¦» (Window) ,  è·¨æ‰¹æ¬¡(updateStateByKey)"></a>å››.  è·¨å•ä½æ—¶é—´,å•ä½è·ç¦» (Window) ,  è·¨æ‰¹æ¬¡(updateStateByKey)</h1><h2 id="1-Window"><a href="#1-Window" class="headerlink" title="1. Window"></a>1. Window</h2><h4 id="å…³é”®å‚æ•°"><a href="#å…³é”®å‚æ•°" class="headerlink" title="å…³é”®å‚æ•°:"></a><strong>å…³é”®å‚æ•°</strong>:</h4><p><strong>batch interval</strong> </p><ul><li>æ‰¹æ¬¡çš„é—´éš”. </li></ul><p><strong>windows length</strong></p><ul><li>çª—å£é•¿åº¦,è·¨æ‰¹æ¬¡ã€‚æ˜¯æ‰¹æ¬¡çš„æ•´æ•°å€ã€‚ </li></ul><p><strong>slide interval</strong> </p><ul><li>æ»‘åŠ¨é—´éš”,çª—å£è®¡ç®—çš„é—´éš”æ—¶é—´ï¼Œæœ‰æ—¶æ‰¹æ¬¡intervalçš„æ•´å€æ•°ã€‚ </li></ul><p><br></p><h4 id="å…³é”®ä»£ç ç¤ºä¾‹"><a href="#å…³é”®ä»£ç ç¤ºä¾‹" class="headerlink" title="å…³é”®ä»£ç ç¤ºä¾‹:"></a>å…³é”®ä»£ç ç¤ºä¾‹:</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/WCSparkStreamWindowApp.java" target="_blank" rel="noopener">å…·ä½“æŸ¥çœ‹ github</a></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//èšåˆ</span></span><br><span class="line"><span class="comment">/** ç»Ÿè®¡åŒä¸€ window ä¸‹çš„ key çš„èšåˆ (ç”¨çš„æ¯”è¾ƒå¤š...)</span></span><br><span class="line"><span class="comment">     def reduceByKeyAndWindow(reduceFunc: Function2[V, V, V],</span></span><br><span class="line"><span class="comment">             windowDuration: Duration,</span></span><br><span class="line"><span class="comment">             slideDuration: Duration): JavaPairDStream[K, V]</span></span><br><span class="line"><span class="comment">    &gt;&gt;&gt; Return a new DStream by applying `reduceByKey` over a sliding window</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">JavaPairDStream</span>&lt;<span class="type">String</span>,<span class="type">Integer</span>&gt; countDS = pairDS.reduceByKeyAndWindow(<span class="keyword">new</span> <span class="type">Function2</span>&lt;<span class="type">Integer</span>, <span class="type">Integer</span>, <span class="type">Integer</span>&gt;() &#123;</span><br><span class="line">    public <span class="type">Integer</span> call(<span class="type">Integer</span> v1, <span class="type">Integer</span> v2) &#123;</span><br><span class="line">        <span class="keyword">return</span> v1 + v2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="type">Seconds</span>.apply(<span class="number">6</span>),<span class="type">Seconds</span>.apply(<span class="number">4</span>));</span><br></pre></td></tr></table></figure><h2 id="2-updateStateByKey"><a href="#2-updateStateByKey" class="headerlink" title="2. updateStateByKey"></a>2. updateStateByKey</h2><p><strong><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/WordCountSparkStreamingJava.java" target="_blank" rel="noopener">è·¨æ‰¹æ¬¡ç»Ÿè®¡, ä¼šä¸€ç›´ç´¯åŠ , å…·ä½“æŸ¥çœ‹ github</a></strong></p><h4 id="å…³é”®ä»£ç ç¤ºä¾‹-1"><a href="#å…³é”®ä»£ç ç¤ºä¾‹-1" class="headerlink" title="å…³é”®ä»£ç ç¤ºä¾‹"></a>å…³é”®ä»£ç ç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨äºè·¨æ‰¹æ¬¡ç»Ÿè®¡ updateStateByKeya</span></span><br><span class="line">JavaPairDStream&lt;String,Integer&gt; jps = pairDS.updateStateByKey(<span class="keyword">new</span> Function2&lt;List&lt;Integer&gt;, Optional&lt;Integer&gt;, Optional&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;Integer&gt; <span class="title">call</span><span class="params">(List&lt;Integer&gt; v1, Optional&lt;Integer&gt; v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Integer newCount = v2.isPresent() ? v2.get() : <span class="number">0</span>  ;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"old value : "</span> + newCount);</span><br><span class="line">        <span class="keyword">for</span>(Integer i : v1)&#123;</span><br><span class="line">            System.out.println(<span class="string">"new value : "</span> + i);</span><br><span class="line">            newCount = newCount +  i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(newCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h1 id="äº”-spark-streamingä¸­çš„å®¹é”™å®ç°-â€»"><a href="#äº”-spark-streamingä¸­çš„å®¹é”™å®ç°-â€»" class="headerlink" title="äº”. spark streamingä¸­çš„å®¹é”™å®ç° â€»"></a>äº”. spark streamingä¸­çš„å®¹é”™å®ç° â€»</h1><h2 id="1-ç”Ÿäº§ç¯å¢ƒä¸­spark-streamingçš„jobçš„æ³¨æ„äº‹é¡¹"><a href="#1-ç”Ÿäº§ç¯å¢ƒä¸­spark-streamingçš„jobçš„æ³¨æ„äº‹é¡¹" class="headerlink" title="1.ç”Ÿäº§ç¯å¢ƒä¸­spark streamingçš„jobçš„æ³¨æ„äº‹é¡¹"></a>1.ç”Ÿäº§ç¯å¢ƒä¸­spark streamingçš„jobçš„æ³¨æ„äº‹é¡¹</h2><p><strong>é¿å…å•ç‚¹æ•…éšœã€‚</strong></p><p><strong>Driver</strong>               </p><ul><li>é©±åŠ¨,è¿è¡Œç”¨æˆ·ç¼–å†™çš„ç¨‹åºä»£ç çš„ä¸»æœºã€‚ </li></ul><p><strong>Executors</strong>        </p><ul><li>æ‰§è¡Œçš„spark driveræäº¤çš„job,å†…éƒ¨å«æœ‰é™„åŠ ç»„ä»¶æ¯”å¦‚receiver</li><li>receiveræ¥å—æ•°æ®å¹¶ä»¥blockæ–¹å¼ä¿å­˜åœ¨memoryä¸­ï¼ŒåŒæ—¶ï¼Œå°†æ•°æ®å—å¤åˆ¶åˆ°å…¶ä»–executorä¸­ï¼Œä»¥å¤‡å®¹é”™ã€‚</li><li>æ¯ä¸ªæ‰¹æ¬¡æœ«ç«¯ä¼šå½¢æˆæ–°çš„DStreamï¼Œäº¤ç»™ ä¸‹æ¸¸å¤„ç†ã€‚</li><li>å¦‚æœreceiveræ•…éšœï¼Œå…¶ä»–æ‰§è¡Œå™¨ä¸­çš„receiverä¼šå¯åŠ¨è¿›è¡Œæ•°æ®çš„æ¥æ”¶ã€‚ </li></ul><p><strong>checkpoint</strong></p><ul><li>æ£€æŸ¥ç‚¹</li><li>ç”¨äºå®¹é”™å¤„ç†, è®¾ç½®å, ä¼šæŠŠæ•°æ®å­˜å‚¨åˆ°æ£€æŸ¥ç‚¹ç›®å½•,   å½“å‡ºé—®é¢˜å,  ä»æ£€æŸ¥ç‚¹æ¢å¤.</li></ul><h2 id="2-é€šè¿‡checkpoint-å®ç°-Spark-Streaming-çš„å®¹é”™"><a href="#2-é€šè¿‡checkpoint-å®ç°-Spark-Streaming-çš„å®¹é”™" class="headerlink" title="2. é€šè¿‡checkpoint å®ç° Spark Streaming çš„å®¹é”™"></a>2. é€šè¿‡<strong>checkpoint</strong> å®ç° Spark Streaming çš„å®¹é”™</h2><p>å¦‚æœ<strong>executoræ•…éšœ</strong>ï¼Œæ‰€æœ‰æœªè¢«å¤„ç†çš„æ•°æ®éƒ½ä¼šä¸¢å¤±ï¼Œè§£å†³åŠæ³•å¯ä»¥é€šè¿‡wal (hbase,hdfs/WALs)æ–¹å¼å°†æ•°æ®é¢„å…ˆå†™å…¥åˆ°hdfsæˆ–è€…s3.</p><p>å¦‚æœ<strong>Driveræ•…éšœ</strong>ï¼Œdriverç¨‹åºå°±ä¼šåœæ­¢ï¼Œæ‰€æœ‰executoréƒ½æ˜¯ä¸¢å¤±è¿æ¥ï¼Œåœæ­¢è®¡ç®—è¿‡ç¨‹ã€‚</p><p><strong>è§£å†³åŠæ³•éœ€è¦é…ç½®å’Œç¼–ç¨‹ã€‚</strong></p><ul><li>é…ç½®Driverç¨‹åºè‡ªåŠ¨é‡å¯ï¼Œä½¿ç”¨ç‰¹å®šçš„clustermanagerå®ç°ã€‚ :TODO   how?</li><li><strong>é‡å¯æ—¶ï¼Œä»å®•æœºçš„åœ°æ–¹è¿›è¡Œé‡å¯ï¼Œé€šè¿‡æ£€æŸ¥ç‚¹æœºåˆ¶å¯ä»¥å®ç°è¯¥åŠŸèƒ½ã€‚</strong><ul><li>æ£€æŸ¥ç‚¹ç›®å½•å¯ä»¥æ˜¯æœ¬åœ°ï¼Œå¯ä»¥æ˜¯hdfs, <strong>ç”Ÿäº§ä¸­ä¸€èˆ¬éƒ½æ˜¯ hdfs</strong></li><li><strong>ä¸å†ä½¿ç”¨newæ–¹å¼</strong>åˆ›å»º<code>SparkStreamContext</code>å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡å·¥å‚æ–¹å¼<code>JavaStreamingContext.getOrCreate()</code>æ–¹æ³•åˆ›å»º</li><li>ä¸Šä¸‹æ–‡å¯¹è±¡,é¦–å…ˆä¼šæ£€æŸ¥æ£€æŸ¥ç‚¹ç›®å½•ï¼Œçœ‹æ˜¯å¦æœ‰jobè¿è¡Œï¼Œæ²¡æœ‰å°±newæ–°çš„ã€‚</li></ul></li><li>ç¼–å†™å®¹é”™æµ‹è¯•ä»£ç ,è®¡ç®—è¿‡ç¨‹ç¼–å†™åˆ° <code>Function0</code> çš„<code>call</code>æ–¹æ³•ä¸­ã€‚ </li></ul><p><strong>çŸ¥è¯†ç‚¹</strong>: Function0, 1, 2, 3, 4</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºä½•è¦ä½¿ç”¨ Function0?</span><br><span class="line">    å› ä¸º JavaStreamingContext.getOrCreate(path,function0) çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ Function0</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A zero-argument function that returns an R.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Function0</span>&lt;<span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="function">R <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/SparkStreamingCheckpointDemo.java" target="_blank" rel="noopener">Java ä»£ç , å…·ä½“è§ github</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.rox.spark.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function0;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.Duration;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.api.java.JavaDStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.api.java.JavaStreamingContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparkStreamingCheckpointDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Create a factory object that can create and setup a new JavaStreamingContext</span></span><br><span class="line"><span class="comment">         * å¯ä»¥ä½¿ç”¨ Function0</span></span><br><span class="line"><span class="comment">         * A zero-argument function that returns an R.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Function0&lt;JavaStreamingContext&gt; contextFactory = <span class="keyword">new</span> Function0&lt;JavaStreamingContext&gt;()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">// é¦–æ¬¡åˆ›å»º context æ—¶, è°ƒç”¨æ­¤æ–¹æ³•</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> JavaStreamingContext <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">                conf.setMaster(<span class="string">"local[4]"</span>);</span><br><span class="line">                conf.setAppName(<span class="string">"SparkStreamingCheckpointDemo"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ›å»ºæµä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">                JavaStreamingContext jsc = <span class="keyword">new</span> JavaStreamingContext(conf, <span class="keyword">new</span> Duration(<span class="number">2</span> * <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Create an input stream from network source hostname:port.</span></span><br><span class="line">                JavaDStream&lt;String&gt; lines = jsc.socketTextStream(<span class="string">"localhost"</span>, <span class="number">10086</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// =============== å˜æ¢ä»£ç  ===============</span></span><br><span class="line">                <span class="comment">// è®¾ç½®ä¸€ä¸ªçª—å£æ—¶é•¿ä¸º1å¤©, æ»šåŠ¨é—´éš”ä¸º 2s</span></span><br><span class="line">                JavaDStream&lt;Long&gt; longJavaDStream = lines.countByWindow(<span class="keyword">new</span> Duration(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>), <span class="keyword">new</span> Duration(<span class="number">2</span> * <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">                longJavaDStream.print();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¾ç½®æ£€æŸ¥ç‚¹ ç›®å½•</span></span><br><span class="line">                jsc.checkpoint(<span class="string">"file:///Users/shixuanji/Documents/Code/temp/check"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è¿”å›æµä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">return</span> jsc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *   def getOrCreate(</span></span><br><span class="line"><span class="comment">         checkpointPath: String,</span></span><br><span class="line"><span class="comment">         creatingFunc: JFunction0[JavaStreamingContext]</span></span><br><span class="line"><span class="comment">         ): JavaStreamingContext</span></span><br><span class="line"><span class="comment">         æ³¨æ„: ç¬¬2ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª Function0å¯¹è±¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// å¤±è´¥å, é‡æ–°åˆ›å»ºæ—¶, ä¼šç»è¿‡æ£€æŸ¥ç‚¹</span></span><br><span class="line">        JavaStreamingContext context = JavaStreamingContext.getOrCreate(<span class="string">"file:///Users/shixuanji/Documents/Code/temp/check"</span>, contextFactory);</span><br><span class="line"></span><br><span class="line">        context.start();</span><br><span class="line">        context.awaitTermination();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-Spark-Streaming-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ä¸€-Spark-Streaming-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. Spark Streaming ç®€ä»‹&quot;&gt;&lt;/a&gt;ä¸€. Spark Streaming ç®€ä»‹&lt;/h1
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="SparkStreaming" scheme="https://airpoet.github.io/categories/Spark/SparkStreaming/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
      <category term="SparkStreaming" scheme="https://airpoet.github.io/tags/SparkStreaming/"/>
    
  </entry>
  
  <entry>
    <title>i-Spark-2</title>
    <link href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-2/"/>
    <id>https://airpoet.github.io/2018/07/20/Spark/i-Spark-2/</id>
    <published>2018-07-20T09:03:11.064Z</published>
    <updated>2018-07-30T17:37:10.515Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-Spark-æ ¸å¿ƒ-API"><a href="#ä¸€-Spark-æ ¸å¿ƒ-API" class="headerlink" title="ä¸€. Spark æ ¸å¿ƒ API"></a>ä¸€. Spark æ ¸å¿ƒ API</h1><p><strong>[SparkContext]</strong></p><ul><li>è¿æ¥åˆ°sparké›†ç¾¤,å…¥å£ç‚¹.</li></ul><p><strong>[HadoopRDD]</strong></p><ul><li>è¯»å–hadoopä¸Šçš„æ•°æ®ï¼Œ</li></ul><p><strong>[MapPartitionsRDD]</strong></p><ul><li>é’ˆå¯¹çˆ¶RDDçš„æ¯ä¸ªåˆ†åŒºæä¾›äº†å‡½æ•°æ„æˆçš„æ–°ç±»å‹RDD.</li></ul><p><strong>[PairRDDFunctions]</strong></p><ul><li>å¯¹å¶RDDå‡½æ•°ç±»ã€‚</li><li>å¯ç”¨äºKVç±»å‹RDDçš„é™„åŠ å‡½æ•°ã€‚å¯ä»¥é€šè¿‡éšå¼è½¬åŒ–å¾—åˆ°.</li></ul><p><strong>[ShuffleRDD]</strong></p><ul><li>ä»Shuffleä¸­è®¡ç®—ç»“æœçš„RDD.</li></ul><p><strong>[RDD]</strong></p><ul><li>æ˜¯åˆ†åŒºçš„é›†åˆ, å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†, ä¸å¯å˜çš„æ•°æ®åˆ†åŒºé›†åˆ.</li><li>åŸºæœ¬æ“ä½œ(map filter , persist)</li><li><strong>ç‰¹ç‚¹:</strong> <ul><li>åˆ†åŒºåˆ—è¡¨                    //æ•°æ®</li><li>åº”ç”¨ç»™æ¯ä¸ªåˆ‡ç‰‡çš„è®¡ç®—å‡½æ•°    //è¡Œä¸º</li><li>åˆ°å…¶ä»–RDDçš„ä¾èµ–åˆ—è¡¨            //ä¾èµ–å…³ç³»</li><li>(å¯é€‰)é’ˆå¯¹kvç±»å‹RDDçš„åˆ†åŒºç±»</li><li>(å¯é€‰)é¦–é€‰ä½ç½®åˆ—è¡¨</li></ul></li></ul><p><strong>[DAGScheduler]</strong></p><ul><li>é«˜çº§è°ƒåº¦å™¨å±‚é¢ï¼Œå®ç°æŒ‰ç…§é˜¶æ®µ(stage) è¿›è¡Œ shuffle</li><li>å¯¹æ¯ä¸ªJOBçš„å„é˜¶æ®µ(stage)è®¡ç®—æœ‰å‘æ— ç¯å›¾(DAG)ï¼Œå¹¶ä¸”è·Ÿè¸ªRDDå’Œæ¯ä¸ªé˜¶æ®µçš„è¾“å‡ºã€‚</li><li>æ‰¾å‡ºæœ€å°è°ƒåº¦è¿è¡Œä½œä¸š, å°†Stageå¯¹è±¡ä»¥TaskSetæ–¹å¼æäº¤ç»™åº•å±‚çš„è°ƒåº¦å™¨ã€‚</li><li>åº•å±‚è°ƒåº¦å™¨å®ç°TaskScheduler, è¿›è€Œåœ¨clusterä¸Šè¿è¡Œjob.</li><li>TaskSetå·²ç»åŒ…å«äº†å…¨éƒ¨çš„å•ç‹¬çš„taskï¼Œè¿™äº›Taskéƒ½èƒ½å¤ŸåŸºäºclusterçš„æ•°æ®è¿›è¡Œæ­£ç¡®è¿è¡Œã€‚</li><li>Stageé€šè¿‡åœ¨éœ€è¦shuffleçš„è¾¹ç•Œå¤„å°†RDDæ‰“ç¢æ¥åˆ›å»ºStageå¯¹è±¡ã€‚</li><li>å…·æœ‰<code>çª„ä¾èµ–</code>çš„RDDæ“ä½œ(æ¯”å¦‚map /filter)è¢«ç®¡é“åŒ–è‡³ä¸€ä¸ªtasksetä¸­.</li><li>è€Œå…·æœ‰shuffleä¾èµ–çš„æ“ä½œåˆ™åŒ…å«å¤šä¸ªStage(ä¸€ä¸ªè¿›è¡Œè¾“å‡ºï¼Œå¦ä¸€ä¸ªè¿›è¡Œè¾“å…¥)</li><li>æœ€åï¼Œæ¯ä¸ªstageéƒ½æœ‰ä¸€ä¸ªé’ˆå¯¹å…¶ä»–stageçš„shuffleä¾èµ–ï¼Œå¯ä»¥è®¡ç®—å¤šä¸ªæ“ä½œã€‚</li><li>DAGè°ƒåº¦å™¨æ£€æµ‹é¦–é€‰ä½ç½®æ¥è¿è¡Œtaskï¼Œé€šè¿‡åŸºäºå½“å‰çš„ç¼“å­˜çŠ¶æ€ï¼Œå¹¶ä¼ é€’ç»™åº•å±‚çš„taskè°ƒåº¦å™¨æ¥å®ç°ã€‚æ ¹æ®shuffleçš„è¾“å‡ºæ˜¯å¦ä¸¢å¤±å¤„ç†æ•…éšœé—®é¢˜ã€‚</li><li>ä¸æ˜¯å› ä¸ºéšæœºæ–‡ä»¶ä¸¢å¤±é€ æˆçš„æ•…éšœä¼šç”±ä»»åŠ¡è°ƒåº¦ç¨‹åºå¤„ç†ï¼Œå®ƒåœ¨å–æ¶ˆæ•´ä¸ªstageå‰èŠ±ä¸€å°æ®µæ—¶é—´é‡è¯•æ¯ä¸ªä»»åŠ¡</li><li>ä¸ºäº†å®¹é”™ï¼ŒåŒä¸€stageå¯èƒ½ä¼šè¿è¡Œå¤šæ¬¡ï¼Œç§°ä¹‹ä¸ºâ€attemptsâ€,å¦‚æœtaskè°ƒåº¦å™¨æŠ¥å‘Šäº†ä¸€ä¸ªæ•…éšœ(è¯¥æ•…éšœæ˜¯ç”±äºä¸Šä¸€ä¸ªstageä¸¢å¤±è¾“å‡ºæ–‡ä»¶è€Œå¯¼è‡´çš„)DAGè°ƒåº¦å°±ä¼šé‡æ–°æäº¤ä¸¢å¤±çš„stageã€‚è¿™ä¸ªé€šè¿‡å…·æœ‰ FetchFailedçš„CompletionEventå¯¹è±¡æˆ–è€…ExecutorLostè¿›è¡Œæ£€æµ‹çš„ã€‚</li><li>DAGè°ƒåº¦å™¨ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´çœ‹å…¶ä»–èŠ‚ç‚¹æˆ–taskæ˜¯å¦å¤±è´¥ï¼Œç„¶åå¯¹ä¸¢å¤±çš„stageé‡æ–°æäº¤tasksetï¼Œè®¡ç®—ä¸¢å¤±çš„taskã€‚</li></ul><p><br></p><h4 id="æœ¯è¯­ä»‹ç»"><a href="#æœ¯è¯­ä»‹ç»" class="headerlink" title="æœ¯è¯­ä»‹ç»"></a><strong>æœ¯è¯­ä»‹ç»</strong></h4><p><strong>[ job ]</strong></p><ul><li>æäº¤ç»™è°ƒåº¦çš„é¡¶å±‚çš„å·¥ä½œé¡¹ç›®ï¼Œç”± <strong>ActiveJob</strong> è¡¨ç¤ºã€‚</li><li>æ˜¯Stageé›†åˆã€‚</li></ul><p><u><strong>[Stage]</strong></u></p><ul><li>æ˜¯taskçš„é›†åˆï¼Œè®¡ç®—jobä¸­çš„ä¸­é—´ç»“æœã€‚åŒä¸€RDDçš„æ¯ä¸ªåˆ†åŒºéƒ½ä¼šåº”ç”¨ç›¸åŒçš„è®¡ç®—å‡½æ•°ã€‚</li><li>åœ¨shuffleçš„è¾¹ç•Œå¤„è¿›è¡Œéš”ç¦»(å› æ­¤å¼•å…¥äº†éš”æ–­ï¼Œéœ€è¦ä¸Šä¸€ä¸ªstageå®Œæˆåï¼Œæ‰èƒ½å¾—åˆ°outputç»“æœ)</li><li><strong>Stageæœ‰ä¸¤ä¸ªå­ç±»:</strong><ul><li>1) ResultStageï¼Œç”¨äºæ‰§è¡ŒactionåŠ¨ä½œçš„æœ€ç»ˆstageã€‚</li><li>2) ShuffleMapStage,  å¯¹shuffleè¿›è¡Œè¾“å‡ºæ–‡ä»¶çš„å†™æ“ä½œçš„ã€‚å¦‚æœjobé‡ç”¨äº†åŒä¸€ä¸ªrddçš„è¯ï¼Œstageé€šå¸¸å¯ä»¥è·¨è¶Šå¤šä¸ªjobå®ç°å…±äº«ã€‚</li></ul></li><li>å¹¶è¡Œä»»åŠ¡çš„é›†åˆï¼Œéƒ½ä¼šè®¡ç®—åŒä¸€å‡½æ•°ã€‚æ‰€æœ‰taskæœ‰ç€åŒæ ·çš„shuffleä¾èµ–ï¼Œè°ƒåº¦å™¨è¿è¡Œçš„task DAG åœ¨shuffleè¾¹ç•Œå¤„åˆ’åˆ†æˆä¸åŒé˜¶æ®µã€‚è°ƒåº¦å™¨ä»¥æ‹“æ‰‘é¡ºåºæ‰§è¡Œ.</li><li>æ¯ä¸ªstageå¯ä»¥shuffleMapStage,è¯¥é˜¶æ®µä¸‹è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªstageçš„è¾“å…¥ï¼Œä¹Ÿå¯ä»¥æ˜¯resultStage,è¯¥é˜¶æ®µ taskç›´æ¥æ‰§è¡Œspark actionã€‚å¯¹äºshuffleMapStageï¼Œéœ€è¦è·Ÿè¸ªæ¯ä¸ªè¾“å‡ºåˆ†åŒºæ‰€åœ¨çš„èŠ‚ç‚¹ã€‚</li><li>æ¯ä¸ªstageéƒ½æœ‰FirstJobId,åŒºåˆ†äºé¦–æ¬¡æäº¤çš„id</li></ul><p><strong>[ShuffleMapStage]</strong></p><ul><li>äº§ç”Ÿè¾“å‡ºæ•°æ®ï¼Œåœ¨æ¯æ¬¡shuffleä¹‹å‰å‘ç”Ÿã€‚å†…éƒ¨å«æœ‰shuffleDepå­—æ®µ,æœ‰ç›¸å…³å­—æ®µè®°å½•äº§ç”Ÿå¤šå°‘è¾“å‡ºä»¥åŠå¤šå°‘è¾“å‡ºå¯ç”¨</li><li>DAGScheduler.submitMapStage()æ–¹æ³•å¯ä»¥å•ç‹¬æäº¤submitMapStage().</li></ul><p><strong>[ResultStage]</strong></p><ul><li>è¯¥é˜¶æ®µåœ¨RDDçš„ä¸€äº›åˆ†åŒºä¸­åº”ç”¨å‡½æ•°æ¥è®¡ç®—Actionçš„ç»“æœã€‚æœ‰äº›stageå¹¶ä¸ä¼šåœ¨æ‰€æœ‰åˆ†åŒºä¸Šæ‰§è¡Œã€‚ä¾‹å¦‚first(),lookup();</li></ul><p><u><strong>[Task]</strong></u></p><ul><li>å•ç‹¬çš„å·¥ä½œå•å…ƒï¼Œæ¯ä¸ªå‘é€ç»™ä¸€å°ä¸»æœºã€‚</li></ul><p><strong>[Cache tracking]</strong></p><ul><li>Dagè°ƒåº¦å™¨æ‰¾å‡ºå“ªäº›RDDè¢«ç¼“å­˜ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—ï¼ŒåŒæ—¶ï¼Œä¹Ÿä¼šè®°ä½å“ªäº›shuffleMapå·²ç»è¾“å‡ºäº†ç»“æœï¼Œé¿å…mapç«¯shuffleçš„é‡å¤å¤„ç†ã€‚</li></ul><p><strong>[Preferred locations]</strong></p><ul><li>dagè°ƒåº¦å™¨æ ¹æ®rddçš„ä¸­é¦–é€‰ä½ç½®å±æ€§è®¡ç®—taskåœ¨å“ªé‡Œè¿è¡Œã€‚</li></ul><p><strong>[Cleanup]</strong></p><ul><li>è¿è¡Œçš„jobå¦‚æœå®Œæˆå°±ä¼šæ¸…æ¥šæ•°æ®ç»“æ„é¿å…å†…å­˜æ³„æ¼ï¼Œä¸»è¦æ˜¯é’ˆå¯¹è€—æ—¶åº”ç”¨ã€‚</li></ul><p><strong>[ActiveJob]</strong></p><ul><li>åœ¨Dagè°ƒåº¦å™¨ä¸­è¿è¡Œjobã€‚ä½œä¸šåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œ<ul><li>1) result jobï¼Œè®¡ç®—ResultStageæ¥æ‰§è¡Œaction.</li><li>2 )map-state job,ä¸ºshuffleMapStateç»“ç®—è®¡ç®—è¾“å‡ºç»“æœä»¥ä¾›ä¸‹æ¸¸stageä½¿ç”¨ã€‚ä¸»è¦ä½¿ç”¨finalStageå­—æ®µè¿›è¡Œç±»å‹åˆ’åˆ†ã€‚</li></ul></li><li>jobåªè·Ÿè¸ªå®¢æˆ·ç«¯æäº¤çš„â€leafâ€ stageï¼Œé€šè¿‡è°ƒç”¨Dagè°ƒåº¦å™¨çš„submitjobæˆ–è€…- submitMapStage()æ–¹æ³•å®ç°.</li><li>jobç±»å‹å¼•å‘ä¹‹å‰stageçš„æ‰§è¡Œï¼Œè€Œä¸”å¤šä¸ªjobå¯ä»¥å…±äº«ä¹‹å‰çš„stageã€‚è¿™äº›ä¾èµ–å…³ç³»ç”±DAGè°ƒåº¦å™¨å†…éƒ¨ç®¡ç†ã€‚</li></ul><p><strong>[LiveListenerBus]</strong></p><ul><li>å¼‚æ­¥ä¼ è¾“sparkç›‘å¬äº‹ä»¶åˆ°ç›‘å¬å™¨äº‹ä»¶é›†åˆä¸­ã€‚</li></ul><p><strong>[EventLoop]</strong></p><ul><li>ä»calleræ¥å—äº‹ä»¶ï¼Œåœ¨å•ç‹¬çš„äº‹ä»¶çº¿ç¨‹ä¸­å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œè¯¥ç±»çš„å”¯ä¸€å­ç±»æ˜¯DAGSchedulerEventProcessLoopã€‚</li></ul><p><strong>[LiveListenerBus]</strong></p><ul><li>ç›‘å¬å™¨æ€»çº¿ï¼Œå­˜æ”¾Sparkç›‘å¬å™¨äº‹ä»¶çš„é˜Ÿåˆ—ã€‚ç”¨äºç›‘æ§ã€‚</li></ul><p><strong>[OutputCommitCoordinator]</strong></p><ul><li>è¾“å‡ºæäº¤åè°ƒå™¨.å†³å®šæäº¤çš„è¾“å‡ºæ˜¯å¦è¿›å…¥hdfsã€‚</li></ul><p><strong>[TaskScheduler]</strong></p><ul><li>åº•å±‚çš„è°ƒåº¦å™¨ï¼Œå”¯ä¸€å®ç°TaskSchedulerImplã€‚å¯æ’æ‹”ï¼ŒåŒDagè°ƒåº¦å™¨æ¥å—taskï¼Œå‘é€ç»™clusterï¼Œè¿è¡Œä»»åŠ¡ï¼Œå¤±è´¥é‡è¯•ï¼Œè¿”å›äº‹ä»¶ç»™DAGè°ƒåº¦å™¨ã€‚</li></ul><p><strong>[TaskSchedulerImpl]</strong></p><ul><li>TaskSchedulerè°ƒåº¦å™¨çš„å”¯ä¸€å®ç°ï¼Œé€šè¿‡BackendScheduler(åå°è°ƒåº¦å™¨)å®ç°å„ç§ç±»å‹é›†ç¾¤çš„ä»»åŠ¡è°ƒåº¦ã€‚</li></ul><p><strong>[SchedulerBackend]</strong></p><ul><li><p>å¯æ’æ‹”çš„åå°è°ƒåº¦ç³»ç»Ÿï¼Œæœ¬åœ°è°ƒåº¦ï¼Œmesosè°ƒåº¦ï¼Œã€‚ã€‚ã€‚</p></li><li><p>åœ¨SchedulerBackendä¸‹æ–¹ï¼Œå®ç°æœ‰ä¸‰ç§</p><ul><li>LocalSchedulerBackend  æœ¬åœ°åå°è°ƒåº¦å™¨,å¯åŠ¨task.</li><li><p>StandaloneSchedulerBackend  ç‹¬ç«‹åå°è°ƒåº¦å™¨</p></li><li><p>CoarseGrainedSchedulerBackend    ç²—ç²’åº¦åå°è°ƒåº¦å™¨</p></li></ul></li></ul><p><strong>[Executor]</strong></p><ul><li>sparkç¨‹åºæ‰§è¡Œè€…ï¼Œé€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><p><strong>[Dependency]:ä¾èµ–</strong></p><ul><li><p><strong>NarrowDependency</strong>:    å­RDDçš„æ¯ä¸ªåˆ†åŒºä¾èµ–äºçˆ¶RDDçš„å°‘é‡åˆ†åŒº, ä¹Ÿå«å®Œå…¨ä¾èµ–</p><p>â€‹         | </p><p>â€‹        / \ </p><p>â€‹        â€” </p><p>â€‹         |â€”-    OneToOneDependency        //çˆ¶å­RDDä¹‹é—´çš„åˆ†åŒºå­˜åœ¨ä¸€å¯¹ä¸€å…³ç³»ã€‚ </p><p>â€‹         |â€”-    RangeDependency            //çˆ¶RDDçš„ä¸€ä¸ªåˆ†åŒºèŒƒå›´å’Œå­RDDå­˜åœ¨ä¸€å¯¹ä¸€å…³ç³»ã€‚ </p><p>â€‹         |â€”-    PruneDependency            // åœ¨PartitionPruningRDDå’Œå…¶çˆ¶RDDä¹‹é—´çš„ä¾èµ–,   å­RDDåŒ…å«äº†çˆ¶RDDçš„åˆ†åŒºå­é›†ã€‚ </p></li><li><p><strong>ShuffleDependency</strong>:    åœ¨shuffleé˜¶æ®µè¾“å‡ºæ—¶çš„ä¸€ç§ä¾èµ–, å±äºä¸€ç§å®½ä¾èµ–, ä¹Ÿå«éƒ¨åˆ†ä¾èµ–</p></li></ul><h1 id="äºŒ-Spark-å…¶å®ƒæ¦‚å¿µ"><a href="#äºŒ-Spark-å…¶å®ƒæ¦‚å¿µ" class="headerlink" title="äºŒ. Spark å…¶å®ƒæ¦‚å¿µ"></a>äºŒ. Spark å…¶å®ƒæ¦‚å¿µ</h1><h2 id="1-åˆ›å»º-Spark-ä¸Šä¸‹æ–‡-Context"><a href="#1-åˆ›å»º-Spark-ä¸Šä¸‹æ–‡-Context" class="headerlink" title="1. åˆ›å»º Spark ä¸Šä¸‹æ–‡(Context)"></a>1. åˆ›å»º Spark ä¸Šä¸‹æ–‡(Context)</h2><p><strong>[æœ¬åœ°æ¨¡å¼,é€šè¿‡çº¿ç¨‹æ¨¡æ‹Ÿ]</strong></p><blockquote><p>â€‹    æœ¬åœ°åå°è°ƒåº¦å™¨ </p><p>â€‹    spark local </p><p>â€‹    spark local[3]                            //3çº¿ç¨‹,æ¨¡æ‹Ÿclusteré›†ç¾¤ </p><p>â€‹    spark local[*]                            //åŒ¹é…cpuä¸ªæ•°ï¼Œ </p><p>â€‹    spark local[3,2]                        //3:3ä¸ªçº¿ç¨‹ï¼Œ2ä¸ºmaxFailuresã€‚ </p><ul><li>// local[*, M] means the number of cores on the computer with M failures</li><li>// local[N, M] means exactly N threads with M failures </li><li>0å’Œ1ç­‰ä»·ï¼Œåªæ‰§è¡Œä¸€æ¬¡, å¤±è´¥åä¸ä¼šé‡è¯•</li></ul></blockquote><p><strong>[ç›¸å½“äºä¼ªåˆ†å¸ƒå¼]</strong></p><blockquote><p>â€‹    StandaloneSchedulerBackend </p><p>â€‹    spark local-cluster[N, cores, memory]    //æ¨¡æ‹Ÿsparké›†ç¾¤ã€‚  </p></blockquote><p><strong>[å®Œå…¨åˆ†å¸ƒå¼]</strong></p><blockquote><p>â€‹    StandaloneSchedulerBackend </p><p>â€‹    spark <a href="spark://cs1:7077" target="_blank" rel="noopener">spark://cs1:7077</a>                    //è¿æ¥åˆ°sparké›†ç¾¤ä¸Š. </p></blockquote><h2 id="2-RDD-æŒä¹…åŒ–"><a href="#2-RDD-æŒä¹…åŒ–" class="headerlink" title="2. RDD æŒä¹…åŒ–"></a>2. RDD æŒä¹…åŒ–</h2><ul><li><p>è·¨æ“ä½œè¿›è¡ŒRDDçš„å†…å­˜å¼å­˜å‚¨ã€‚ </p></li><li><p>æŒä¹…åŒ–RDDæ—¶ï¼ŒèŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªåˆ†åŒºéƒ½ä¼šä¿å­˜æ“å†…å­˜ä¸­,ä»¥å¤‡åœ¨å…¶ä»–æ“ä½œä¸­è¿›è¡Œé‡ç”¨ã€‚ </p></li><li><p>ç¼“å­˜æŠ€æœ¯æ˜¯è¿­ä»£å¼è®¡ç®—å’Œäº¤äº’å¼æŸ¥è¯¢çš„é‡è¦å·¥å…·ã€‚ </p></li><li><p>ä½¿ç”¨persist()å’Œcache()è¿›è¡Œrddçš„æŒä¹…åŒ–ã€‚ </p></li><li><p>cache()æ˜¯persist()ä¸€ç§. </p></li><li><p>actionç¬¬ä¸€æ¬¡è®¡ç®—æ—¶ä¼šå‘ç”Ÿpersist(). </p></li><li><p>sparkçš„cacheæ˜¯å®¹é”™çš„ï¼Œå¦‚æœrddçš„ä»»ä½•ä¸€ä¸ªåˆ†åŒºä¸¢å¤±äº†ï¼Œéƒ½å¯ä»¥é€šè¿‡æœ€åˆåˆ›å»ºrddçš„è¿›è¡Œé‡æ–°è®¡ç®—ã€‚ </p></li><li><p>persistå¯ä»¥ä½¿ç”¨ä¸åŒçš„å­˜å‚¨çº§åˆ«è¿›è¡ŒæŒä¹…åŒ–ã€‚ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MEMORY_ONLY            //åªåœ¨å†…å­˜</span><br><span class="line">MEMORY_AND_DISK</span><br><span class="line">MEMORY_ONLY_SER        //å†…å­˜å­˜å‚¨(ä¸²è¡ŒåŒ–)</span><br><span class="line">MEMORY_AND_DISK_SER </span><br><span class="line">DISK_ONLY            //ç¡¬ç›˜                        // é»˜è®¤çš„è·¯å¾„ä¼¼ä¹åœ¨ç¨‹åºæ‰§è¡Œå®Œåè‡ªå·±ä¼šåˆ æ‰??</span><br><span class="line">MEMORY_ONLY_2        //å¸¦æœ‰å‰¯æœ¬ </span><br><span class="line">MEMORY_AND_DISK_2    //å¿«é€Ÿå®¹é”™ã€‚</span><br><span class="line">OFF_HEAP             // ç¦»å †å†…å­˜</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤æŒä¹…åŒ–æ•°æ® <code>rdd.unpersist();</code></p></li></ul><h2 id="3-æ•°æ®ä¼ é€’"><a href="#3-æ•°æ®ä¼ é€’" class="headerlink" title="3.æ•°æ®ä¼ é€’"></a>3.æ•°æ®ä¼ é€’</h2><ul><li>map(),filter()é«˜çº§å‡½æ•°ä¸­è®¿é—®çš„å¯¹è±¡è¢«ä¸²è¡ŒåŒ–åˆ°å„ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä»½æ‹·è´ã€‚ </li><li>å˜é‡å€¼å¹¶ä¸ä¼šå›ä¼ åˆ°driverç¨‹åºã€‚ </li></ul><h2 id="4-å…±äº«å˜é‡"><a href="#4-å…±äº«å˜é‡" class="headerlink" title="4.å…±äº«å˜é‡"></a>4.å…±äº«å˜é‡</h2><p> <strong>sparké€šè¿‡å¹¿æ’­å˜é‡å’Œç´¯åŠ å™¨å®ç°å…±äº«å˜é‡ã€‚</strong></p><p><br></p><p><strong>[å¹¿æ’­å˜é‡]</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå¹¿æ’­å˜é‡</span></span><br><span class="line"><span class="keyword">val</span> bc1 = sc.broadcast(<span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>))</span><br><span class="line">bc1.value</span><br></pre></td></tr></table></figure><p><strong>[ç´¯åŠ å™¨]</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºç´¯åŠ å™¨</span></span><br><span class="line"><span class="keyword">val</span> ac1 = sc.longaccumulator(<span class="string">"ac1"</span>)</span><br><span class="line">ac1.value</span><br><span class="line">sc.parallelize(<span class="number">1</span> to <span class="number">10</span>).map(_ * <span class="number">2</span>).map(e=&gt;&#123;ac1.add(<span class="number">1</span>) ; e&#125;).reduce(_+_)</span><br><span class="line">ac1.value            <span class="comment">//10</span></span><br></pre></td></tr></table></figure><h2 id="5-é€šè¿‡-Spark-å®ç°-PI-çš„åˆ†å¸ƒå¼è®¡ç®—"><a href="#5-é€šè¿‡-Spark-å®ç°-PI-çš„åˆ†å¸ƒå¼è®¡ç®—" class="headerlink" title="5.é€šè¿‡ Spark å®ç° PI çš„åˆ†å¸ƒå¼è®¡ç®—"></a>5.é€šè¿‡ Spark å®ç° PI çš„åˆ†å¸ƒå¼è®¡ç®—</h2><p>:TODO è®¡ç®—å‡ºæ¥çš„ç»“æœä¸ç²¾å‡† ??</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sc.parallelize(<span class="number">1</span> to <span class="number">100000000</span>).map(e=&gt;&#123;</span><br><span class="line">    <span class="keyword">val</span> a = <span class="number">1</span>f / (<span class="number">2</span> * e - <span class="number">1</span>) ;</span><br><span class="line">    <span class="keyword">val</span> b = <span class="keyword">if</span> (e % <span class="number">2</span> == <span class="number">0</span>) <span class="number">-1</span> <span class="keyword">else</span> <span class="number">1</span> ;</span><br><span class="line">    a * b * <span class="number">4</span></span><br><span class="line">&#125;).reduce(_+_)</span><br><span class="line"></span><br><span class="line">res25: <span class="type">Float</span> = <span class="number">3.1415968</span>  </span><br><span class="line">==&gt; ç”¨äº†ä¸€ä¸ªäº¿ç®—å‡ºæ¥è¿™ä¸ª...</span><br></pre></td></tr></table></figure><h1 id="ä¸‰-SparkSQL"><a href="#ä¸‰-SparkSQL" class="headerlink" title="ä¸‰. SparkSQL"></a>ä¸‰. SparkSQL</h1><blockquote><p>Hive                  //hadoop mr sql<br>pheonix            //hbaseä¹‹ä¸Šæ„å»ºsqläº¤äº’è¿‡ç¨‹<br>DataFrame        //æ”¶æ®æ¡†.è¡¨.è¯¥æ¨¡å—èƒ½åœ¨sparkè¿è¡Œsqlè¯­å¥ã€‚<br>SparkSQL        //SQL | DataFrame API.</p></blockquote><h2 id="1-Spark-SQL-Shell-æ“ä½œ"><a href="#1-Spark-SQL-Shell-æ“ä½œ" class="headerlink" title="1.Spark SQL  Shell æ“ä½œ"></a>1.<strong>Spark SQL  Shell æ“ä½œ</strong></h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºæ ·ä¾‹ç±»</span></span><br><span class="line">$scala&gt;<span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span>(<span class="params">id:<span class="type">Int</span>,name:<span class="type">String</span>,age:<span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">//æ„é€ æ•°æ®</span></span></span><br><span class="line"><span class="class"><span class="title">$scala&gt;val</span> <span class="title">arr</span> </span>= <span class="type">Array</span>(<span class="string">"1,tom,12"</span>,<span class="string">"2,tomas,13"</span>,<span class="string">"3,tomasLee,14"</span>)</span><br><span class="line">$scala&gt;<span class="keyword">val</span> rdd1 = parallelize(arr)</span><br><span class="line"><span class="comment">//åˆ›å»ºå¯¹è±¡rdd</span></span><br><span class="line">$scala&gt;<span class="keyword">val</span> rdd2 = rdd1.map(e=&gt;&#123;e.split(<span class="string">","</span>) ; <span class="type">Customer</span>(arr(<span class="number">0</span>).toInt,arr(<span class="number">1</span>),arr(<span class="number">2</span>).toInt)&#125;)</span><br><span class="line"><span class="comment">//é€šè¿‡rddåˆ›å»ºæ•°æ®æ¡†</span></span><br><span class="line">$scala&gt;<span class="keyword">val</span> df = spark.createDataFrame(rdd2);</span><br><span class="line"><span class="comment">//æ‰“å°è¡¨ç»“æ„</span></span><br><span class="line">$scala&gt;df.printSchema</span><br><span class="line">$scala&gt;df.show            <span class="comment">//æ’å™æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸´æ—¶è§†å›¾</span></span><br><span class="line">$scala&gt;df.createTempView(<span class="string">"customers"</span>)</span><br><span class="line">$scala&gt;<span class="keyword">val</span> df2 = spark.sql(<span class="string">"select * from customers"</span>)</span><br><span class="line">$scala&gt;spark.sql(<span class="string">"select * from customers"</span>).show        <span class="comment">//ä½¿ç”¨sqlè¯­å¥</span></span><br><span class="line">$scala&gt;<span class="keyword">val</span> df1 = spark.sql(<span class="string">"select * from cusotmers where id &lt; 2"</span>);</span><br><span class="line">$scala&gt;<span class="keyword">val</span> df2 = spark.sql(<span class="string">"select * from cusotmers where id &gt; 2"</span>);</span><br><span class="line">$scala&gt;df1.createTempView(<span class="string">"c1"</span>)</span><br><span class="line">$scala&gt;df2.createTempView(<span class="string">"c2"</span>)</span><br><span class="line">$scala&gt;spark.sql(<span class="string">"select * from c1 union select * from c2"</span>).show</span><br><span class="line">$scala&gt;df1.union(df2);</span><br><span class="line">$scala&gt;spark.sql(<span class="string">"select id,name from customers"</span>).show</span><br><span class="line">$scala&gt;df.selectExpr(<span class="string">"id"</span>,<span class="string">"name"</span>)</span><br><span class="line">$scala&gt; spark.sql(<span class="string">"select * from cus where name like 't%' order by name desc"</span>).show</span><br><span class="line">$scala&gt;df.where(<span class="string">"name like 't%'"</span>).show</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜ å°„</span></span><br><span class="line">$scala&gt;df.map(_.getAs[<span class="type">Int</span>](<span class="string">"age"</span>)).reduce(_+_)            <span class="comment">//èšåˆæ“ä½œDataSet[Int]</span></span><br><span class="line">$scala&gt;df.agg(sum(<span class="string">"age"</span>),max(<span class="string">"age"</span>),min(<span class="string">"age"</span>))            <span class="comment">//èšåˆå‡½æ•°</span></span><br></pre></td></tr></table></figure><h2 id="2-IDEA-æ“ä½œ-SQL"><a href="#2-IDEA-æ“ä½œ-SQL" class="headerlink" title="2. IDEA æ“ä½œ SQL"></a>2. IDEA æ“ä½œ SQL</h2><p><a href="https://github.com/airpoet/bigdata/tree/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java" target="_blank" rel="noopener">å…·ä½“æŸ¥çœ‹æˆ‘çš„ Github</a></p><h4 id="1-gt-é€šè¿‡è¯»å†™æ–‡ä»¶å®ŒæˆåŸºæœ¬-SQL-æ“ä½œ"><a href="#1-gt-é€šè¿‡è¯»å†™æ–‡ä»¶å®ŒæˆåŸºæœ¬-SQL-æ“ä½œ" class="headerlink" title="1&gt; é€šè¿‡è¯»å†™æ–‡ä»¶å®ŒæˆåŸºæœ¬ SQL æ“ä½œ"></a>1&gt; é€šè¿‡è¯»å†™æ–‡ä»¶å®ŒæˆåŸºæœ¬ SQL æ“ä½œ</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/SQLJava.java" target="_blank" rel="noopener">è§æˆ‘çš„ Github ä»£ç </a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç  ==&gt; //DataFrame ç±»ä¼¼äºtableæ“ä½œã€‚</span></span><br><span class="line">type DataFrame = Dataset[Row]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>&gt; é€šè¿‡RDDåˆ›å»º DataFrame</span><br><span class="line">    df = sc.createDataFrame(rdd);</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>&gt; DataFrame è½¬å›ä¸º RDD</span><br><span class="line">JavaRDD&lt;Row&gt; rdd = df1.toJavaRDD();</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>&gt; SparkSession å¯¹è±¡,é€šè¿‡è¯»å– json æ–‡ä»¶, åˆ›å»º DataSet</span><br><span class="line">Dataset&lt;Row&gt; df = session.read().json(<span class="string">"file:///tmp/test.json"</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>&gt; ä¿å­˜sparkçš„sqlè®¡ç®—ç»“æœä¸º json æ–‡ä»¶</span><br><span class="line"><span class="comment">//ä¿å­˜æˆjsonæ–‡ä»¶ã€‚ æ¨¡å¼ä¸ºæ·»åŠ æ¨¡å¼</span></span><br><span class="line">    df.write().mode(SaveMode.Append).json(<span class="string">"file://..."</span>)</span><br></pre></td></tr></table></figure><h4 id="2-gt-é€šè¿‡-JDBC-æ“ä½œ-MySQL"><a href="#2-gt-é€šè¿‡-JDBC-æ“ä½œ-MySQL" class="headerlink" title="2&gt; é€šè¿‡ JDBC æ“ä½œ MySQL"></a>2&gt; é€šè¿‡ JDBC æ“ä½œ MySQL</h4><ol><li><p>æ·»åŠ  pom ä¾èµ– <code>mysql-connector-java</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/SQLJDBCJava.java" target="_blank" rel="noopener">ç¼–å†™ä»£ç , è§æˆ‘çš„ Github</a></p></li></ol><h2 id="3-æ•´åˆ-Hive"><a href="#3-æ•´åˆ-Hive" class="headerlink" title="3.æ•´åˆ Hive"></a>3.æ•´åˆ Hive</h2><h4 id="1-é…ç½®-amp-Spark-shell-æ“ä½œ"><a href="#1-é…ç½®-amp-Spark-shell-æ“ä½œ" class="headerlink" title="1.é…ç½® &amp; Spark-shell æ“ä½œ"></a>1.é…ç½® &amp; Spark-shell æ“ä½œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1&gt; .hiveçš„ç±»åº“éœ€è¦åœ¨spark workerèŠ‚ç‚¹ã€‚</span><br><span class="line">----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">2&gt; .å¤åˆ¶hive-site.xml(hive) åˆ° spark/confä¸‹ã€‚</span><br><span class="line">----------------------------------------------------------------------------------</span><br><span class="line">(core-site.xml(hdfs) + hdfs-site.xml(hdfs) å°±ä¸ç”¨å¤åˆ¶äº†, åœ¨ conf/spark-env.sh ä¸­, é…ç½®äº† HADOOP_CONF_DIR å°±å¯ä»¥äº†)</span><br><span class="line"></span><br><span class="line">3&gt; .å¤åˆ¶mysqlé©±åŠ¨ç¨‹åºåˆ°/soft/spark/jarsä¸‹ (Hive çš„ metadata å­˜åœ¨ mysql)</span><br><span class="line">----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">4&gt; .å¯åŠ¨spark-shell,æŒ‡å®šå¯åŠ¨æ¨¡å¼</span><br><span class="line">----------------------------------------------------------------------------------</span><br><span class="line">spark-shell --master <span class="built_in">local</span>[4]</span><br><span class="line"><span class="comment"># åˆ›å»º Hive è¡¨</span></span><br><span class="line"><span class="variable">$scala</span>&gt;create table tt(id int,name string , age int) </span><br><span class="line">row format delimited fields terminated by <span class="string">','</span> </span><br><span class="line">lines terminated by <span class="string">'\n'</span> </span><br><span class="line">stored as textfile</span><br><span class="line"></span><br><span class="line">//åŠ è½½æ•°æ®åˆ°hiveè¡¨</span><br><span class="line"><span class="variable">$scala</span>&gt;spark.sql(<span class="string">"load data local inpath 'file:///home/centos/data.txt' into table mydb.tt"</span>);</span><br></pre></td></tr></table></figure><h4 id="2-Javaç‰ˆSparkSQL-æ“ä½œ-Hive-è¡¨"><a href="#2-Javaç‰ˆSparkSQL-æ“ä½œ-Hive-è¡¨" class="headerlink" title="2. Javaç‰ˆSparkSQL æ“ä½œ Hive è¡¨"></a>2. Javaç‰ˆSparkSQL æ“ä½œ Hive è¡¨</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/pom.xml" target="_blank" rel="noopener">æ‰€æœ‰çš„ pom æ–‡ä»¶é…ç½®</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>Java ä»£ç </p><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/SQLHiveJava.java" target="_blank" rel="noopener">è¯¦ç»†ä»£ç è§github</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">conf.setMaster(<span class="string">"local"</span>) ;</span><br><span class="line">conf.setAppName(<span class="string">"SQLJava"</span>);</span><br><span class="line">SparkSession sess = SparkSession.builder()</span><br><span class="line">    .appName(<span class="string">"HiveSQLJava"</span>)</span><br><span class="line">    .config(<span class="string">"spark.master"</span>,<span class="string">"local"</span>)</span><br><span class="line">    .getOrCreate();</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; df = sess.sql(<span class="string">"create table mytt(id int)"</span>);</span><br><span class="line">df.show();</span><br></pre></td></tr></table></figure><h4 id="3-Sparkä¸‹-åˆ†å¸ƒå¼è®¿é—®-Hive-Spark-Shell-â€”â€“-å¼€å¯thriftserver-é€šè¿‡-beeline-è®¿é—®-hive"><a href="#3-Sparkä¸‹-åˆ†å¸ƒå¼è®¿é—®-Hive-Spark-Shell-â€”â€“-å¼€å¯thriftserver-é€šè¿‡-beeline-è®¿é—®-hive" class="headerlink" title="3. Sparkä¸‹ åˆ†å¸ƒå¼è®¿é—® Hive (Spark-Shell) â€”â€“ å¼€å¯thriftserver, é€šè¿‡ beeline è®¿é—® hive"></a>3. Sparkä¸‹ åˆ†å¸ƒå¼è®¿é—® Hive (Spark-Shell) â€”â€“ å¼€å¯thriftserver, é€šè¿‡ beeline è®¿é—® hive</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&gt; åœ¨é»˜è®¤åº“ä¸‹åˆ›å»ºhiveçš„æ•°æ®è¡¨ã€‚</span><br><span class="line">    $&gt;hive -e <span class="string">"create table tt(id int,name string , age int) row format delimited fields terminated by ',' lines terminated by '\n' stored as textfile"</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>&gt; åŠ è½½æ•°æ®åˆ°hiveè¡¨ä¸­.</span><br><span class="line">    $&gt;hive -e <span class="string">"load data local inpath 'file:///home/ap/stu' into table tt"</span></span><br><span class="line">    $&gt;hive -e <span class="string">"select * from tt"</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>&gt; å¯åŠ¨ thriftserver æœåŠ¡å™¨</span><br><span class="line"># å¯åŠ¨ thriftServer</span><br><span class="line">    [ap<span class="meta">@cs</span>1]~/apps/spark/sbin%&gt; start-thriftserver.sh --master spark:<span class="comment">//cs1:7077</span></span><br><span class="line"></span><br><span class="line">#  æŸ¥çœ‹</span><br><span class="line">    netstat -anop | grep <span class="number">10000</span> </span><br><span class="line"></span><br><span class="line"><span class="number">4</span>&gt; å¯åŠ¨ beeline</span><br><span class="line"># è¿æ¥beeline, è®°å¾—ä¸€å®šè¦åŠ ä¸Šç”¨æˆ·å!!!!  -n ap</span><br><span class="line"># ä¸‹é¢çš„æƒ…å†µæ˜¯, cs1æ˜¯è£…äº† hive çš„</span><br><span class="line">[ap<span class="meta">@cs</span>1]~/apps/spark%&gt; bin/beeline -u jdbc:hive2:<span class="comment">//localhost:10000 -n ap -d org.apache.hive.jdbc.HiveDriver</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>&gt; æ¥ä¸‹æ¥, è·Ÿç›´æ¥åœ¨hive ä¸­, é€šè¿‡ beeline è®¿é—® hive, æ˜¯ä¸€æ ·çš„æ“ä½œ, å°±æ˜¯ç›´æ¥æ“ä½œ hive</span><br></pre></td></tr></table></figure><h4 id="4-ä½¿ç”¨-Java-é€šè¿‡-ThreadServer-ä½¿ç”¨-JDBC-è®¿é—®-Hive"><a href="#4-ä½¿ç”¨-Java-é€šè¿‡-ThreadServer-ä½¿ç”¨-JDBC-è®¿é—®-Hive" class="headerlink" title="4. ä½¿ç”¨ Java é€šè¿‡ ThreadServer, ä½¿ç”¨ JDBC è®¿é—® Hive"></a>4. ä½¿ç”¨ Java é€šè¿‡ ThreadServer, ä½¿ç”¨ JDBC è®¿é—® Hive</h4><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/ThriftServerClientJava.java" target="_blank" rel="noopener">è¯¦æƒ…çœ‹ä»£ç </a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">"org.apache.hive.jdbc.HiveDriver"</span>);</span><br><span class="line"></span><br><span class="line">Connection conn = DriverManager.getConnection(<span class="string">"jdbc:hive2://cs1:10000"</span>,<span class="string">"ap"</span>,<span class="string">"123"</span>);</span><br><span class="line"></span><br><span class="line">Statement st = conn.createStatement();</span><br><span class="line"></span><br><span class="line">ResultSet rs = st.executeQuery(<span class="string">"select * from tt where age &gt; 12 ORDER BY age DESC "</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">    <span class="keyword">int</span> id = rs.getInt(<span class="number">1</span>);</span><br><span class="line">    String name = rs.getString(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> age = rs.getInt(<span class="number">3</span>);</span><br><span class="line">    System.out.println(id + <span class="string">","</span> + name + <span class="string">","</span> + age);</span><br><span class="line">&#125;</span><br><span class="line">rs.close();</span><br></pre></td></tr></table></figure><h4 id="5-ç›´æ¥ä½¿ç”¨-SPARK-HOME-bin-spark-sql-è„šæœ¬è®¿é—®-hive"><a href="#5-ç›´æ¥ä½¿ç”¨-SPARK-HOME-bin-spark-sql-è„šæœ¬è®¿é—®-hive" class="headerlink" title="5. ç›´æ¥ä½¿ç”¨  $SPARK_HOME/bin/spark-sql è„šæœ¬è®¿é—® hive"></a>5. ç›´æ¥ä½¿ç”¨  <code>$SPARK_HOME/bin/spark-sql</code> è„šæœ¬è®¿é—® hive</h4><p><strong>1.é…ç½® <code>hive-site.xml</code>, åˆ†å‘åˆ°å„ä¸ªèŠ‚ç‚¹</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--åŠ ä¸Šä¸€ä¸‹é…ç½®, æŒ‡æ˜è®¿é—® hive çš„ metadata æœåŠ¡--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>thrift://cs2:9083<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>2.åœ¨è£…æœ‰ hive &amp; mysql çš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ hive çš„ metastore æœåŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup hive --service metastore 1&gt;/home/ap/logs/hive_thriftserver.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p><strong>3.åœ¨ cs1èŠ‚ç‚¹å¯åŠ¨ <code>spark-sql</code>æœåŠ¡, å³å¯è¿›å…¥ <code>spark-sql</code> å‘½ä»¤è¡Œæ¨¡å¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cs1</span>&gt; spark-sql</span><br></pre></td></tr></table></figure><p><strong>4.åœ¨ idea ä¸Šç›´æ¥æ“ä½œ hive æœ‰é—®é¢˜</strong></p><p>spark-hive_2.1.1 pom å¯¼å…¥å¤±è´¥</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-Spark-æ ¸å¿ƒ-API&quot;&gt;&lt;a href=&quot;#ä¸€-Spark-æ ¸å¿ƒ-API&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. Spark æ ¸å¿ƒ API&quot;&gt;&lt;/a&gt;ä¸€. Spark æ ¸å¿ƒ API&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;[SparkContex
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="SparkSQL" scheme="https://airpoet.github.io/categories/Spark/SparkSQL/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
      <category term="SparkSQL" scheme="https://airpoet.github.io/tags/SparkSQL/"/>
    
      <category term="Sparkæºç " scheme="https://airpoet.github.io/tags/Spark%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>i-Spark-1</title>
    <link href="https://airpoet.github.io/2018/07/20/Spark/i-Spark-1/"/>
    <id>https://airpoet.github.io/2018/07/20/Spark/i-Spark-1/</id>
    <published>2018-07-20T02:05:35.625Z</published>
    <updated>2018-07-25T14:34:33.915Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Tips:</p><blockquote><p> <strong>å¹¶è¡Œ</strong></p></blockquote><p>é›†ç¾¤è®¡ç®—ã€‚ </p><p>å¹¶è¡Œè®¡ç®—ã€‚ </p><p>ç¡¬ä»¶æ–¹é¢çš„æ¦‚å¿µ </p><blockquote><p><strong>å¹¶å‘</strong></p></blockquote><p>å¹¶å‘æ‰§è¡Œã€‚  </p><p>çº¿ç¨‹æ–¹é¢çš„æ¦‚å¿µ </p></blockquote><h1 id="ä¸€-Spark-ç®€ä»‹"><a href="#ä¸€-Spark-ç®€ä»‹" class="headerlink" title="ä¸€. Spark ç®€ä»‹"></a>ä¸€. Spark ç®€ä»‹</h1><h2 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1.æ¦‚å¿µ"></a>1.æ¦‚å¿µ</h2><p>Lightning-fast cluster computingã€‚ </p><p><strong>å¿«å¦‚é—ªç”µçš„é›†ç¾¤è®¡ç®—ã€‚</strong> </p><p><strong>å¤§è§„æ¨¡å¿«é€Ÿé€šç”¨çš„è®¡ç®—å¼•æ“ã€‚</strong> </p><p><strong>é€Ÿåº¦:</strong>    æ¯”hadoop 100x,ç£ç›˜è®¡ç®—å¿«10x </p><p><strong>ä½¿ç”¨:</strong>    java / Scala /R /python    </p><p>â€‹                æä¾›80+ç®—å­(æ“ä½œç¬¦)ï¼Œå®¹æ˜“æ„å»ºå¹¶è¡Œåº”ç”¨ã€‚ </p><p><strong>é€šç”¨:</strong>    ç»„åˆSQL ï¼Œæµè®¡ç®— + å¤æ‚åˆ†æã€‚ </p><p><strong>DAG:</strong>     direct acycle graph,æœ‰å‘æ— ç¯å›¾ã€‚</p><p><strong>Spark ä¸ MR å…³ç³»</strong>:     åŸºäºhadoopçš„mrï¼Œæ‰©å±•MRæ¨¡å‹é«˜æ•ˆä½¿ç”¨MRæ¨¡å‹ï¼Œå†…å­˜å‹é›†ç¾¤è®¡ç®—ï¼Œæé«˜appå¤„ç†é€Ÿåº¦ã€‚ </p><h2 id="2-Spark-æ¨¡å—"><a href="#2-Spark-æ¨¡å—" class="headerlink" title="2.Spark æ¨¡å—"></a>2.Spark æ¨¡å—</h2><blockquote><p>Spark core                //æ ¸å¿ƒæ¨¡å— ,é€šç”¨æ‰§è¡Œå¼•æ“ï¼Œæä¾›å†…å­˜è®¡ç®—å’Œå¯¹å¤–éƒ¨æ•°æ®é›†çš„å¼•ç”¨ã€‚RDD</p><p>Spark SQL               //SQL ,æ„å»ºåœ¨coreä¹‹ä¸Šï¼Œå¼•å…¥æ–°çš„æŠ½è±¡SchemaRDDï¼Œæä¾›äº†ç»“æ„åŒ–å’ŒåŠç»“æ„åŒ–æ”¯æŒã€‚</p><p>Spark Streaming       //æµè®¡ç®—  DStream</p><p>Spark MLlib                //æœºå™¨å­¦ä¹  </p><p>Spark graph             //å›¾è®¡ç®— </p></blockquote><h2 id="3-RDD"><a href="#3-RDD" class="headerlink" title="3.RDD"></a>3.RDD</h2><p>æ˜¯sparkçš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸å¯å˜æ•°æ®é›†ã€‚</p><p>RDDä¸­çš„æ•°æ®é›†è¿›è¡Œé€»è¾‘åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯ä»¥å•ç‹¬åœ¨é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œè®¡ç®—ã€‚</p><p>å¯ä»¥åŒ…å«ä»»ä½•java,scalaï¼Œpythonå’Œè‡ªå®šä¹‰ç±»å‹ã€‚ </p><p>RDDæ˜¯åªè¯»çš„è®°å½•åˆ†åŒºé›†åˆã€‚RDDå…·æœ‰å®¹é”™æœºåˆ¶ã€‚ </p><p><strong>åˆ›å»ºRDDæ–¹å¼:</strong>  1)å¹¶è¡ŒåŒ–ä¸€ä¸ªç°æœ‰é›†åˆ.  2) ç”±å¦ä¸€ä¸ª RDD è½¬æ¢</p><p>hadoop èŠ±è´¹90%æ—¶é—´ read, writeã€‚ </p><p>å†…å­˜å¤„ç†è®¡ç®—ã€‚åœ¨jobé—´è¿›è¡Œæ•°æ®å…±äº«ã€‚å†…å­˜çš„IOé€Ÿç‡é«˜äºç½‘ç»œå’Œdiskçš„10 ~ 100ä¹‹é—´ã€‚ </p><h2 id="4-Spark-RDD-å†…éƒ¨åŒ…å«5ä¸ªä¸»è¦å±æ€§"><a href="#4-Spark-RDD-å†…éƒ¨åŒ…å«5ä¸ªä¸»è¦å±æ€§" class="headerlink" title="4. Spark RDD å†…éƒ¨åŒ…å«5ä¸ªä¸»è¦å±æ€§"></a>4. Spark RDD å†…éƒ¨åŒ…å«5ä¸ªä¸»è¦å±æ€§</h2><ol><li>åˆ†åŒºåˆ—è¡¨</li><li>é’ˆå¯¹æ¯ä¸ªsplitçš„è®¡ç®—å‡½æ•°ã€‚ </li><li>å¯¹å…¶ä»–rddçš„ä¾èµ–åˆ—è¡¨ </li><li>å¯é€‰ï¼Œå¦‚æœæ˜¯KeyValueRDDçš„è¯ï¼Œå¯ä»¥å¸¦åˆ†åŒºç±»ã€‚ </li><li>å¯é€‰ï¼Œé¦–é€‰å—ä½ç½®åˆ—è¡¨(hdfs block location); </li></ol><hr><h1 id="äºŒ-Spark-å®‰è£…"><a href="#äºŒ-Spark-å®‰è£…" class="headerlink" title="äºŒ. Spark å®‰è£…"></a>äºŒ. Spark å®‰è£…</h1><h2 id="1-localæ¨¡å¼"><a href="#1-localæ¨¡å¼" class="headerlink" title="1. localæ¨¡å¼"></a>1. localæ¨¡å¼</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1).ä¸‹è½½spark-2.1.3-bin-hadoop2.7.tgz</span><br><span class="line"></span><br><span class="line">2).è§£å‹åˆ°/home/ap/apps</span><br><span class="line">  åˆ›å»ºç¬¦å·è¿æ¥ :  ln -s spark-2.1.3-bin-hadoop2.7 spark</span><br><span class="line"></span><br><span class="line">3).ç¯å¢ƒå˜é‡</span><br><span class="line">    [.zshrc]</span><br><span class="line">    SPARK_HOME=/home/ap/apps/spark</span><br><span class="line">    PATH=<span class="variable">$PATH</span>:<span class="variable">$SPARK_HOME</span>/bin:<span class="variable">$SPARK_HOME</span>/sbin</span><br><span class="line"></span><br><span class="line">[<span class="built_in">source</span>]</span><br><span class="line">$&gt;<span class="built_in">source</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line">4).éªŒè¯spark</span><br><span class="line">    $&gt;<span class="built_in">cd</span> apps/spark/sbin</span><br><span class="line">    $&gt;./spark-shell</span><br><span class="line"></span><br><span class="line">5).webui</span><br><span class="line">http://cs1:4040/</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS : å¯åŠ¨æœ¬åœ°æ¨¡å¼,ç™»å½•4040 webUIç«¯å£, åªéœ€è¦å¯åŠ¨spark-shell. è¦æŠŠmaster æˆ–è€… worker å…³æ‰</span></span><br></pre></td></tr></table></figure><h2 id="2-Stand-alone-åˆ†å¸ƒå¼"><a href="#2-Stand-alone-åˆ†å¸ƒå¼" class="headerlink" title="2. Stand alone åˆ†å¸ƒå¼"></a>2. Stand alone åˆ†å¸ƒå¼</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1). é…ç½®å…¶ä»–ä¸»æœºçš„æ‰€æœ‰ç¯å¢ƒå˜é‡, å‘é€cs1ä¸Šçš„.zshrc åˆ°å…¶å®ƒæœºå™¨</span><br><span class="line">--------------------</span><br><span class="line">    <span class="comment"># å‘é€</span></span><br><span class="line">    &lt;sub&gt;&gt; xsync.sh &lt;/sub&gt;/.zshrc</span><br><span class="line">    <span class="comment"># source</span></span><br><span class="line">    &lt;sub&gt;&gt; xcall.sh <span class="string">"source &lt;/sub&gt;/.zshrc"</span></span><br><span class="line"></span><br><span class="line">2). é…ç½®masterèŠ‚ç‚¹çš„slaves</span><br><span class="line">--------------------</span><br><span class="line">    [/soft/spark/conf/slaves]</span><br><span class="line">    cs2</span><br><span class="line">    cs3</span><br><span class="line">    cs4</span><br><span class="line">    cs5</span><br><span class="line"></span><br><span class="line">3). å‘é€æ–‡ä»¶åˆ°å…¶å®ƒèŠ‚ç‚¹</span><br><span class="line">--------------------</span><br><span class="line">    ~&gt; xsync.sh apps/spark</span><br><span class="line"></span><br><span class="line">4). å¯åŠ¨sparké›†ç¾¤</span><br><span class="line">--------------------</span><br><span class="line">    ~&gt; apps/spark/sbin/start-all.sh</span><br><span class="line"></span><br><span class="line">5). æŸ¥çœ‹è¿›ç¨‹</span><br><span class="line">--------------------</span><br><span class="line">    $&gt;xcall.jps jps</span><br><span class="line">    master        //cs1</span><br><span class="line">    worker        //cs2</span><br><span class="line">    worker        //cs3</span><br><span class="line">    worker        //cs4</span><br><span class="line"></span><br><span class="line">6). æŸ¥çœ‹ webUI</span><br><span class="line">--------------------</span><br><span class="line">    http://cs1:8080</span><br></pre></td></tr></table></figure><h2 id="3-Stand-alone-HA-æ¨¡å¼"><a href="#3-Stand-alone-HA-æ¨¡å¼" class="headerlink" title="3. Stand alone HA æ¨¡å¼"></a>3. Stand alone HA æ¨¡å¼</h2><blockquote><p><strong>è§„åˆ’:</strong> </p><p>cs1, cs6 ä¸º master</p><p>cs2~cs5 ä¸º worker</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1). é…ç½® HADOOP_CONF_DIR, ç›®çš„æ˜¯æ‰¾åˆ° hdfs-site.xml å’Œ core-site.xml</span><br><span class="line">--------------<span class="comment"># conf/spark-env.sh ä¸­----------------</span></span><br><span class="line">    <span class="comment"># é… HADOOP_CONF_DIR, è¿™æ ·å°±ä¸ç”¨æ‹·è´hdfs-site.xml å’Œ core-site.xml åˆ° conf ç›®å½•äº†</span></span><br><span class="line">    <span class="built_in">export</span> HADOOP_CONF_DIR=<span class="variable">$HADOOP_HOME</span>/etc/hadoop</span><br><span class="line"></span><br><span class="line">    ps: ä¹Ÿå¯ä»¥ç›´æ¥å¤åˆ¶ hdfs-site.xml å’Œ core-site.xml åˆ° spark/conf ä¸‹, å¯èƒ½è¿˜å¾—åœ¨ conf/defaults.confä¸­æŒ‡å®š </span><br><span class="line">    spark.files  file:///home/ap/apps/spark/conf/hdfs-site.xml,file:///home/ap/apps/spark/conf/core-site.xml ,ä½†æ˜¯ä¸æ¨èè¿™æ ·</span><br><span class="line"></span><br><span class="line">2). é…ç½® JAVA_HOME &amp; zookeeper</span><br><span class="line">--------------<span class="comment"># conf/spark-env.sh ä¸­----------------</span></span><br><span class="line">    <span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_73</span><br><span class="line">    <span class="built_in">export</span> SPARK_DAEMON_JAVA_OPTS=<span class="string">"-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=cs1,cs2,cs3  -Dspark.deploy.zookeeper.dir=/spark"</span></span><br><span class="line"></span><br><span class="line">3) åˆ†å‘æ•´ä¸ª conf ç›®å½•æ–‡ä»¶åˆ°é›†ç¾¤</span><br><span class="line">------------------------------------------------</span><br><span class="line"><span class="variable">$cs1</span> &lt;sub&gt;&gt; xsync.sh &lt;/sub&gt;/apps/spark/conf</span><br><span class="line"></span><br><span class="line">4) å¯åŠ¨é›†ç¾¤</span><br><span class="line">------------------------------------------------</span><br><span class="line">cs1&gt; ~/apps/spark/sbin/start-all.sh</span><br><span class="line">cs6&gt; ~/apps/spark/sbin/start-master.sh</span><br><span class="line">æŸ¥çœ‹&gt; </span><br><span class="line">http://cs1:8080</span><br><span class="line">http://cs6:8080</span><br><span class="line"></span><br><span class="line">5) æµ‹è¯•: å¯åŠ¨spark-shell,è¿æ¥sparké›†ç¾¤ä¸Š</span><br><span class="line">------------------------------------------------ </span><br><span class="line">$&gt; spark-shell --master spark://cs1:7077</span><br><span class="line">$&gt; sc.textFile(<span class="string">"hdfs://mycluster/user/ap/a.txt"</span>).collect();</span><br></pre></td></tr></table></figure><h2 id="4-Spark-å†å²æœåŠ¡å™¨-å¯é€‰"><a href="#4-Spark-å†å²æœåŠ¡å™¨-å¯é€‰" class="headerlink" title="4. Spark å†å²æœåŠ¡å™¨(å¯é€‰)"></a>4. Spark å†å²æœåŠ¡å™¨(å¯é€‰)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€æ­¥ï¼š</span><br><span class="line">------------------------------------------------ </span><br><span class="line"><span class="built_in">cd</span> /home/hadoop/apps/spark-2.3.0-bin-hadoop2.7/conf</span><br><span class="line">cp spark-defaults.conf.template    spark-defaults.conf</span><br><span class="line"></span><br><span class="line">åœ¨æ–‡ä»¶é‡Œé¢æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</span><br><span class="line">spark.eventLog.enabled        <span class="literal">true</span></span><br><span class="line">spark.eventLog.dir            hdfs://mycluster/sparklog</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒæ­¥ï¼š</span><br><span class="line">------------------------------------------------ </span><br><span class="line">åœ¨ spark-env.sh çš„æ–‡ä»¶é‡Œé¢æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</span><br><span class="line"><span class="built_in">export</span> SPARK_HISTORY_OPTS=<span class="string">"-Dspark.history.ui.port=18080 -Dspark.history.retainedApplications=30 -Dspark.history.fs.logDirectory=hdfs://mycluster/sparklog"</span></span><br><span class="line"></span><br><span class="line">ç¬¬ä¸‰æ­¥ï¼š</span><br><span class="line">------------------------------------------------ </span><br><span class="line">åœ¨å¯åŠ¨ HistorServer æœåŠ¡ä¹‹å‰ hdfs://mycluster/sparklog ç›®å½•è¦æå‰åˆ›å»º</span><br><span class="line">hadoop fs -mkdir -p hdfs://mycluster/sparklog</span><br><span class="line"></span><br><span class="line">ç¬¬å››æ­¥ï¼šå¯åŠ¨ Spark HistoryServer</span><br><span class="line">------------------------------------------------ </span><br><span class="line">$&gt; SPARK_HOME/sbin/start-history-server.sh</span><br><span class="line"></span><br><span class="line">ç¬¬äº”æ­¥ï¼šè®¿é—® Spark History WebUI</span><br><span class="line">------------------------------------------------ </span><br><span class="line">http://cs1:18080/</span><br></pre></td></tr></table></figure><h2 id="5-yarn-æ¨¡å¼"><a href="#5-yarn-æ¨¡å¼" class="headerlink" title="5. yarn æ¨¡å¼"></a>5. yarn æ¨¡å¼</h2><p>â€¦</p><hr><h1 id="ä¸‰-Spark-ç®€å•ä½“éªŒ"><a href="#ä¸‰-Spark-ç®€å•ä½“éªŒ" class="headerlink" title="ä¸‰. Spark ç®€å•ä½“éªŒ"></a>ä¸‰. Spark ç®€å•ä½“éªŒ</h1><h2 id="1-API"><a href="#1-API" class="headerlink" title="1. API"></a>1. API</h2><p><strong>[SparkContext]</strong></p><ul><li>SparkåŠŸèƒ½çš„ä¸»è¦å…¥å£ç‚¹ã€‚ä»£è¡¨åˆ°Sparké›†ç¾¤çš„è¿æ¥ï¼Œå¯ä»¥åˆ›å»ºRDDã€ç´¯åŠ å™¨å’Œå¹¿æ’­å˜é‡. </li><li>æ¯ä¸ªJVMåªèƒ½æ¿€æ´»ä¸€ä¸ªSparkContextå¯¹è±¡ï¼Œåœ¨åˆ›å»ºscä¹‹å‰éœ€è¦stopæ‰activeçš„scã€‚ </li></ul><p><strong>[RDD]</strong></p><ul><li>resilient distributed dataset,å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ã€‚ç­‰ä»·äºé›†åˆã€‚ </li></ul><p><strong>[SparkConf]</strong></p><ul><li>sparké…ç½®å¯¹è±¡ï¼Œè®¾ç½®Sparkåº”ç”¨å„ç§å‚æ•°ï¼Œkvå½¢å¼ã€‚ </li></ul><h2 id="2-Spark-å®ç°-WordCount"><a href="#2-Spark-å®ç°-WordCount" class="headerlink" title="2. Spark å®ç° WordCount"></a>2. Spark å®ç° WordCount</h2><h4 id="2-1-spark-shell"><a href="#2-1-spark-shell" class="headerlink" title="2.1 spark-shell"></a>2.1 spark-shell</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç™»å½• shell </span></span><br><span class="line">spark-shell --master spark:<span class="comment">//cs1:7077</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠ è½½æ–‡æœ¬æ–‡ä»¶,ä»¥æ¢è¡Œç¬¦æ–¹å¼åˆ‡å‰²æ–‡æœ¬.Array(hello  world2,hello world2 ,...)</span></span><br><span class="line"><span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"/home/ap/a.txt"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å•è¯ç»Ÿè®¡1 =&gt; åˆ†æ­¥éª¤</span></span><br><span class="line">    $scala&gt;<span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"/home/centos/test.txt"</span>)</span><br><span class="line">    $scala&gt;<span class="keyword">val</span> rdd2 = rdd1.flatMap(line=&gt;line.split(<span class="string">" "</span>))</span><br><span class="line">    $scala&gt;<span class="keyword">val</span> rdd3 = rdd2.map(word = &gt; (word,<span class="number">1</span>))</span><br><span class="line">    $scala&gt;<span class="keyword">val</span> rdd4 = rdd3.reduceByKey(_ + _)</span><br><span class="line">    $scala&gt;rdd4.collect</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€å¥è¯</span></span><br><span class="line">    scala&gt; sc.textFile(<span class="string">"/home/ap/a.txt"</span>).flatMap(_.split(<span class="string">" "</span>)).map((_,<span class="number">1</span>)).reduceByKey(_+_).collect</span><br><span class="line">    res6: <span class="type">Array</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = <span class="type">Array</span>((world2,<span class="number">1</span>), (world1,<span class="number">1</span>), (world4,<span class="number">1</span>), (<span class="string">""</span>,<span class="number">1</span>), (hello,<span class="number">4</span>), (world3,<span class="number">1</span>))</span><br></pre></td></tr></table></figure><h4 id="2-2-idea-ç¼–ç¨‹"><a href="#2-2-idea-ç¼–ç¨‹" class="headerlink" title="2.2 idea ç¼–ç¨‹"></a>2.2 idea ç¼–ç¨‹</h4><blockquote><p><strong>[pomä¾èµ–æ–‡ä»¶]</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>Scala ç‰ˆ</strong></p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WordCountDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºSparké…ç½®å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>();</span><br><span class="line">        conf.setAppName(<span class="string">"WordCountSpark"</span>)</span><br><span class="line">        <span class="comment">//è®¾ç½®masterå±æ€§</span></span><br><span class="line">        conf.setMaster(<span class="string">"local"</span>) ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€šè¿‡confåˆ›å»ºsc</span></span><br><span class="line">        <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŠ è½½æ–‡æœ¬æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">val</span> rdd1 = sc.textFile(<span class="string">"d:/scala/test.txt"</span>);</span><br><span class="line">        <span class="comment">//å‹æ‰</span></span><br><span class="line">        <span class="keyword">val</span> rdd2 = rdd1.flatMap(line =&gt; line.split(<span class="string">" "</span>)) ;</span><br><span class="line">        <span class="comment">//æ˜ å°„w =&gt; (w,1)</span></span><br><span class="line">        <span class="keyword">val</span> rdd3 = rdd2.map((_,<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">val</span> rdd4 = rdd3.reduceByKey(_ + _)</span><br><span class="line">        <span class="keyword">val</span> r = rdd4.collect()</span><br><span class="line">        r.foreach(println)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Java ç‰ˆ</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function2;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * javaç‰ˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCountJava2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºSparkConfå¯¹è±¡</span></span><br><span class="line">        SparkConf conf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">        conf.setAppName(<span class="string">"WordCountJava2"</span>);</span><br><span class="line">        conf.setMaster(<span class="string">"local"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºjava sc</span></span><br><span class="line">        JavaSparkContext sc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">        <span class="comment">//åŠ è½½æ–‡æœ¬æ–‡ä»¶</span></span><br><span class="line">        JavaRDD&lt;String&gt; rdd1 = sc.textFile(<span class="string">"d:/scala//test.txt"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‹æ‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; rdd2 = rdd1.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterator&lt;String&gt; <span class="title">call</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                String[] arr = s.split(<span class="string">" "</span>);</span><br><span class="line">                <span class="keyword">for</span>(String ss :arr)&#123;</span><br><span class="line">                    list.add(ss);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> list.iterator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ˜ å°„,word -&gt; (word,1)</span></span><br><span class="line">        JavaPairRDD&lt;String,Integer&gt; rdd3 = rdd2.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, Integer&gt;(s,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//reduceåŒ–ç®€</span></span><br><span class="line">        JavaPairRDD&lt;String,Integer&gt; rdd4 = rdd3.reduceByKey(<span class="keyword">new</span> Function2&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(Integer v1, Integer v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v1 + v2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        List&lt;Tuple2&lt;String,Integer&gt;&gt; list = rdd4.collect();</span><br><span class="line">        <span class="keyword">for</span>(Tuple2&lt;String, Integer&gt; t : list)&#123;</span><br><span class="line">            System.out.println(t._1() + <span class="string">" : "</span> + t._2());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æäº¤ä½œä¸šåˆ° Spark é›†ç¾¤è¿è¡Œ</strong></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">======================================æäº¤åˆ°æœ¬æœº</span><br><span class="line">1) å¯¼å‡ºjaråŒ…</span><br><span class="line">-------------------------------</span><br><span class="line">2) spark-submitæäº¤å‘½ä»¤è¿è¡Œjob</span><br><span class="line">-------------------------------</span><br><span class="line">    <span class="comment"># scala ç‰ˆ wordcount</span></span><br><span class="line">    spark-submit --master <span class="built_in">local</span> --name MyWordCount --class MyWordCount_Scala SparkDemo-1-1.0-SNAPSHOT.jar /home/ap/a.txt</span><br><span class="line"></span><br><span class="line">    <span class="comment"># java ç‰ˆ wordcount</span></span><br><span class="line">    spark-submit --master <span class="built_in">local</span> --name MyWordCountJava --class  com.rox.spark.WordCountJava SparkDemo-1-1.0-SNAPSHOT.jar /home/ap/a.txt</span><br><span class="line"></span><br><span class="line">======================================æäº¤åˆ°Sparké›†ç¾¤</span><br><span class="line">1) ä»£ç ä¸­æŠŠtextFileæ”¹ä¸º args[0]</span><br><span class="line"></span><br><span class="line">2) å°†æºæ–‡ä»¶ä¼ åˆ° hdfs ä¸Š</span><br><span class="line"></span><br><span class="line">3) è¿è¡Œspark-submit</span><br><span class="line">    $&gt; spark-submit  --master  spark://cs1:7077 --name MyWordCount2 --class MyWordCount_Scala  SparkDemo-1-1.0-SNAPSHOT.jar hdfs://cs1:8020/user/ap/a.txt</span><br></pre></td></tr></table></figure><h2 id="3-spark-sbin-ä¸‹è„šæœ¬åˆ†æ"><a href="#3-spark-sbin-ä¸‹è„šæœ¬åˆ†æ" class="headerlink" title="3. spark/sbin ä¸‹è„šæœ¬åˆ†æ"></a>3. spark/sbin ä¸‹è„šæœ¬åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[start-all.sh]</span><br><span class="line">-------------------------------</span><br><span class="line">    sbin/spark-config.sh</span><br><span class="line">    sbin/spark-master.sh        //å¯åŠ¨masterè¿›ç¨‹</span><br><span class="line">    sbin/spark-slaves.sh        //å¯åŠ¨workerè¿›ç¨‹</span><br><span class="line"></span><br><span class="line">[start-master.sh]</span><br><span class="line">-------------------------------</span><br><span class="line">    sbin/spark-config.sh</span><br><span class="line">    org.apache.spark.deploy.master.Master</span><br><span class="line">    spark-daemon.sh start org.apache.spark.deploy.master.Master --host --port --webui-port ...</span><br><span class="line"></span><br><span class="line">[spark-slaves.sh]</span><br><span class="line">-------------------------------</span><br><span class="line">    sbin/spark-config.sh</span><br><span class="line">    slaves.sh                //conf/slaves</span><br><span class="line"></span><br><span class="line">[slaves.sh]</span><br><span class="line">-------------------------------</span><br><span class="line">    <span class="keyword">for</span> conf/slaves &#123;</span><br><span class="line">     ssh host start-slave.sh ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[start-slave.sh]</span><br><span class="line">-------------------------------</span><br><span class="line">    CLASS=<span class="string">"org.apache.spark.deploy.worker.Worker"</span></span><br><span class="line">    sbin/spark-config.sh</span><br><span class="line">    <span class="keyword">for</span> ((  .. )) ; <span class="keyword">do</span></span><br><span class="line">    start_instance $(( 1 + <span class="variable">$i</span> )) <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">    <span class="keyword">done</span> </span><br><span class="line"></span><br><span class="line">    $&gt;<span class="built_in">cd</span> /soft/spark/sbin</span><br><span class="line">    $&gt;./stop-all.sh                //åœæ‰æ•´ä¸ªsparké›†ç¾¤.</span><br><span class="line">    $&gt;./start-master.sh            //åœæ‰æ•´ä¸ªsparké›†ç¾¤.</span><br><span class="line">    $&gt;./start-master.sh            //å¯åŠ¨masterèŠ‚ç‚¹</span><br><span class="line">    $&gt;./start-slaves.sh            //å¯åŠ¨æ‰€æœ‰workerèŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line">    $&gt;./stop-slave.sh --<span class="built_in">help</span>  // æŸ¥çœ‹å¸®åŠ©, å…¶å®ƒçš„æŸ¥çœ‹å¸®åŠ©ä¹Ÿæ˜¯è¿™æ ·, å‘½ä»¤åé¢åŠ ä¸Š --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h2 id="4-è§£å†³æ•°æ®å€¾æ–œé—®é¢˜-å¤šæ¬¡-map-reduce"><a href="#4-è§£å†³æ•°æ®å€¾æ–œé—®é¢˜-å¤šæ¬¡-map-reduce" class="headerlink" title="4. è§£å†³æ•°æ®å€¾æ–œé—®é¢˜ (å¤šæ¬¡ map-reduce)"></a>4. è§£å†³æ•°æ®å€¾æ–œé—®é¢˜ (å¤šæ¬¡ map-reduce)</h2><blockquote><p> è§£å†³æ•°æ®å€¾æ–œ:</p><p>1&gt; å…ˆå¯¹æ¯ä¸ª word æ·»åŠ  ä¸ªæ•° (word,1)</p><p>2&gt; å–å‡º word, åœ¨ wordåéšæœºæ‹¼æ¥ _num, ç„¶åå†ä¸ v ç»„æˆ (newK, v)å…ƒç¥–</p><p>3&gt; å¯¹æ–°çš„ (k,v)è¿›è¡Œ reduceByKey, ç»Ÿè®¡å‡ºæ¯ä¸ª k çš„ä¸ªæ•° (newK, count)</p><p>4&gt; å¯¹ç»“æœç»§ç»­è¿›è¡Œ map, å»æ‰ _num, æŠŠåŸæœ¬çš„ k å–å‡ºæ¥, å†è·Ÿ count ç»„æˆæ–°çš„å…ƒç¥– (k,count)</p><p>5&gt; ç»§ç»­è¿›è¡Œ reduceByKey, æ­¤æ—¶å¹¶å‘é‡æœ€å¤šä¹Ÿåªæ˜¯éšæœºæ•°çš„ä¸ªæ•°äº†, ä¸ä¼šäº§ç”Ÿä¸¥é‡çš„æ•°æ®å€¾æ–œ, è®¡ç®—å‡ºæœ€ç»ˆçš„ç»“æœ</p><p>6&gt; å­˜åˆ°æ–‡ä»¶ä¸­ saveAsTextFile</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œé˜²æ­¢æ•°æ®å€¾æ–œçš„ MR, æœ€åå­˜åˆ° hdfs ä¸Š</span></span><br><span class="line">sc.textFile(<span class="string">"hdfs://mycluster/user/ap/a.txt"</span>,<span class="number">4</span>).flatMap(_.split(<span class="string">" "</span>)).map((_,<span class="number">1</span>)).map(t =&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> w1 = t._1; </span><br><span class="line">  <span class="keyword">import</span> scala.util.<span class="type">Random</span>;</span><br><span class="line">  <span class="keyword">val</span> n = <span class="type">Random</span>.nextInt(<span class="number">100</span>); </span><br><span class="line">  (w1 + <span class="string">"_"</span> + n, t._2);</span><br><span class="line">&#125;).reduceByKey(_ + _,<span class="number">4</span>).map(t =&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> w2 = t._1; </span><br><span class="line">  <span class="keyword">val</span> count = t._2; </span><br><span class="line">  <span class="keyword">val</span> w3 = w2.split(<span class="string">"_"</span>)(<span class="number">0</span>); </span><br><span class="line">  (w3, count);</span><br><span class="line">&#125;).reduceByKey(_ + _,<span class="number">4</span>).saveAsTextFile(<span class="string">"/user/ap/scala/DataSkew"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥çœ‹ hdfs ä¸Šçš„æ•°æ®</span></span><br><span class="line">[ap<span class="meta">@cs</span>2]~/apps/spark/conf% hdfs dfs -text /user/ap/scala/<span class="type">DataSkew</span>/part<span class="number">-00000</span></span><br><span class="line">(world2,<span class="number">1</span>)</span><br><span class="line">(,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œçš„ DAG(æœ‰å‘æ— ç¯å›¾)</p></blockquote><p><img src="" alt=""> </p><hr><h1 id="å››-RDD-çš„-transform-amp-action"><a href="#å››-RDD-çš„-transform-amp-action" class="headerlink" title="å››. RDD  çš„ transform &amp; action"></a>å››. RDD  çš„ transform &amp; action</h1><p><a href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations" target="_blank" rel="noopener">è¯¦ç»†çš„è§å®˜æ–¹æ–‡æ¡£</a> </p><p><a href="https://github.com/airpoet/bigdata/tree/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/scala" target="_blank" rel="noopener">æˆ‘çš„githubä»£ç </a></p><h2 id="1-å˜æ¢-transform"><a href="#1-å˜æ¢-transform" class="headerlink" title="1. å˜æ¢ (transform )"></a>1. å˜æ¢ (transform )</h2><p><strong>æ³¨æ„:  ç›´åˆ°é‡åˆ°ä¸€ä¸ªä¸æ˜¯è¿”å› RDD å¯¹è±¡çš„æ–¹æ³•/å‡½æ•°,  æ‰ä¼šå¼€å§‹è®¡ç®—</strong></p><p>Spark is lazy, so nothing will be executed unless you call some transformation or action that will trigger job creation and execution. Look at the following snippet of the word-count example. </p><p><strong>å˜æ¢: è¿”å›æŒ‡å‘æ–°rddçš„æŒ‡é’ˆï¼Œåœ¨rddä¹‹é—´åˆ›å»ºä¾èµ–å…³ç³»ã€‚æ¯ä¸ªrddéƒ½æœ‰è®¡ç®—å‡½æ•°å’ŒæŒ‡å‘çˆ¶RDDçš„æŒ‡é’ˆã€‚</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">map()                                    <span class="comment">//å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œå˜æ¢ï¼Œåº”ç”¨å˜æ¢å‡½æ•°</span></span><br><span class="line">                                         <span class="comment">//(T)=&gt;V</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line">filter()                                 <span class="comment">//è¿‡æ»¤å™¨,(T)=&gt;Boolean</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line">flatMap()                                <span class="comment">//å‹æ‰,T =&gt; TraversableOnce[U]</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">mapPartitions()                          <span class="comment">//å¯¹æ¯ä¸ªåˆ†åŒºè¿›è¡Œåº”ç”¨å˜æ¢ï¼Œè¾“å…¥çš„Iterator,è¿”å›æ–°çš„è¿­ä»£å™¨ï¼Œå¯ä»¥å¯¹åˆ†åŒºè¿›è¡Œå‡½æ•°å¤„ç†ã€‚</span></span><br><span class="line">                                         <span class="comment">//Iterator&lt;T&gt; =&gt; Iterator&lt;U&gt;</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">mapPartitionsWithIndex(func)             <span class="comment">//åŒä¸Šï¼Œ(Int, Iterator&lt;T&gt;) =&gt; Iterator&lt;U&gt;</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">sample(withReplacement, fraction, seed)    <span class="comment">//é‡‡æ ·è¿”å›é‡‡æ ·çš„RDDå­é›†ã€‚</span></span><br><span class="line">                                        <span class="comment">//withReplacement å…ƒç´ æ˜¯å¦å¯ä»¥å¤šæ¬¡é‡‡æ ·.</span></span><br><span class="line">                                        <span class="comment">//fraction : æœŸæœ›é‡‡æ ·æ•°é‡.[0,1]</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">union()                                    <span class="comment">//ç±»ä¼¼äºmysql unionæ“ä½œã€‚</span></span><br><span class="line">                                        <span class="comment">//select * from persons where id &lt; 10 </span></span><br><span class="line">                                        <span class="comment">//union select * from id persons where id &gt; 29 ;</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">intersection                            <span class="comment">//äº¤é›†,æå–ä¸¤ä¸ªrddä¸­éƒ½å«æœ‰çš„å…ƒç´ ã€‚</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">distinct([numTasks]))                    <span class="comment">//å»é‡,å»é™¤é‡å¤çš„å…ƒç´ ã€‚</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">groupByKey()                            <span class="comment">//(K,V) =&gt; (K,Iterable&lt;V&gt;)</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">reduceByKey(*)                            <span class="comment">//æŒ‰keyèšåˆã€‚ </span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">aggregateByKey(zeroValue)(seqOp, combOp, [numTasks])      <span class="comment">//æŒ‰ç…§keyè¿›è¡Œèšåˆ  :TODO æ²¡å®Œå…¨æ¸…æ¥š</span></span><br><span class="line">key:<span class="type">String</span> <span class="type">U</span>:<span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">å…¶å®reduceBykeyå°±æ˜¯aggregateByKeyçš„ç®€åŒ–ç‰ˆã€‚ </span><br><span class="line">å°±æ˜¯aggregateByKeyå¤šæä¾›äº†ä¸€ä¸ªå‡½æ•° seqOp</span><br><span class="line">ç±»ä¼¼äº<span class="type">Mapreduce</span>çš„combineæ“ä½œï¼ˆå°±åœ¨mapç«¯æ‰§è¡Œreduceçš„æ“ä½œï¼‰</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">sortByKey                                <span class="comment">//æ’åº</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">join(otherDataset, [numTasks])            <span class="comment">//è¿æ¥,(K,V).join(K,W) =&gt;(K,(V,W)) </span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">cogroup                                    <span class="comment">//ååˆ†ç»„</span></span><br><span class="line">                                        <span class="comment">//(K,V).cogroup(K,W) =&gt;(K,(Iterable&lt;V&gt;,Iterable&lt;!-- &lt;W&gt; --&gt;)) </span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">cartesian(otherDataset)                    <span class="comment">//ç¬›å¡å°”ç§¯,RR[T] RDD[U] =&gt; RDD[(T,U)]</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line">pipe                                    <span class="comment">//å°†rddçš„å…ƒç´ ä¼ é€’ç»™è„šæœ¬æˆ–è€…å‘½ä»¤ï¼Œæ‰§è¡Œç»“æœè¿”å›å½¢æˆæ–°çš„RDD</span></span><br><span class="line"><span class="comment">//ä¾‹å­:  åœ¨ spark-shell ä¸‹</span></span><br><span class="line">scala&gt; sc.parallelize(<span class="type">Array</span>(<span class="string">"/home/ap"</span>)).pipe(<span class="string">"ls"</span>).collect</span><br><span class="line">res0: <span class="type">Array</span>[<span class="type">String</span>] = <span class="type">Array</span>(apps, a.txt, calllog, dump.rdb, flumedata, hadoopdata, ihivedata, jars, kafka, logs, python, softs, <span class="type">SparkDemo</span><span class="number">-1</span><span class="number">-1.0</span>-<span class="type">SNAPSHOT</span>.jar, spool, zookeeper, zookeeper.out)</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">coalesce(numPartitions)                    <span class="comment">//å‡å°‘åˆ†åŒº</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">repartition                                <span class="comment">//å¯å¢å¯å‡</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line">repartitionAndSortWithinPartitions(partitioner)              <span class="comment">//å†åˆ†åŒºå¹¶åœ¨åˆ†åŒºå†…è¿›è¡Œæ’åº</span></span><br></pre></td></tr></table></figure><h2 id="2-äº§ç”Ÿä½œä¸š-Actions"><a href="#2-äº§ç”Ÿä½œä¸š-Actions" class="headerlink" title="2. äº§ç”Ÿä½œä¸š Actions"></a>2. äº§ç”Ÿä½œä¸š Actions</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">collect()                                <span class="comment">//æ”¶é›†rddå…ƒç´ å½¢æˆæ•°ç»„.</span></span><br><span class="line"></span><br><span class="line">count()                                    <span class="comment">//ç»Ÿè®¡rddå…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">reduce()                                 <span class="comment">//èšåˆ,è¿”å›ä¸€ä¸ªå€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">first                                    <span class="comment">//å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´ take(1)</span></span><br><span class="line"></span><br><span class="line">take                                     <span class="comment">// take(n) , æ˜¯ä¸€ä¸ªé›†åˆ, éœ€è¦è¿­ä»£æ‰“å°</span></span><br><span class="line"></span><br><span class="line">takeSample (withReplacement,num, [seed])</span><br><span class="line"></span><br><span class="line">takeOrdered(n, [ordering])               <span class="comment">// è¿”å›å‰ n ä¸ªæ’åºçš„å…ƒç´ (å¯é»˜è®¤, å¯è‡ªå®šä¹‰æ’åº)</span></span><br><span class="line"></span><br><span class="line">saveAsTextFile(path)                    <span class="comment">//ä¿å­˜åˆ°æ–‡ä»¶                    ç”Ÿäº§ä¸­ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line">saveAsSequenceFile(path)                <span class="comment">//ä¿å­˜æˆåºåˆ—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">saveAsObjectFile(path) (<span class="type">Java</span> and <span class="type">Scala</span>)</span><br><span class="line"></span><br><span class="line">countByKey()                            <span class="comment">//æŒ‰ç…§key,ç»Ÿè®¡æ¯ä¸ªkeyä¸‹valueçš„ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">reduceByKey()                           <span class="comment">//æŒ‰ç…§ key, è®¡ç®— key åçš„ value </span></span><br><span class="line"></span><br><span class="line">æ³¨æ„ : rdd2.map((_, <span class="number">1</span>)) å’Œ rdd2.map((_, <span class="number">2</span>)) é’ˆå¯¹äº å‰ä¸¤è€…çš„è®¡ç®—ç»“æœæ˜¯ä¸ä¸€æ ·çš„</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Tips:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; &lt;strong&gt;å¹¶è¡Œ&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;é›†ç¾¤è®¡ç®—ã€‚ &lt;/p&gt;
&lt;p&gt;å¹¶è¡Œè®¡ç®—ã€‚ &lt;/p&gt;
&lt;p&gt;ç¡¬ä»¶æ–¹é¢çš„æ¦‚å¿µ &lt;/p&gt;
&lt;blockquote&gt;
&lt;p
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
      <category term="SparkCore" scheme="https://airpoet.github.io/categories/Spark/SparkCore/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
      <category term="SparkCore" scheme="https://airpoet.github.io/tags/SparkCore/"/>
    
  </entry>
  
  <entry>
    <title>Sparkä¸­Bugé›†é”¦</title>
    <link href="https://airpoet.github.io/2018/07/13/Spark/Spark%E4%B8%ADBug%E9%9B%86%E9%94%A6/"/>
    <id>https://airpoet.github.io/2018/07/13/Spark/Sparkä¸­Bugé›†é”¦/</id>
    <published>2018-07-13T06:22:08.652Z</published>
    <updated>2018-07-25T09:30:34.264Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-åˆ›å»º-SparkContext-æ—¶-é‡åˆ°çš„é—®é¢˜"><a href="#1-åˆ›å»º-SparkContext-æ—¶-é‡åˆ°çš„é—®é¢˜" class="headerlink" title="1.åˆ›å»º SparkContext æ—¶, é‡åˆ°çš„é—®é¢˜"></a>1.åˆ›å»º SparkContext æ—¶, é‡åˆ°çš„é—®é¢˜</h4><p><strong>é”™è¯¯æè¿°:</strong> <code>A master URL must be set in your configuration</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»º spark é…ç½®å¯¹è±¡</span></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">conf.setAppName(<span class="string">"MyWordCount_Scala"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½® master å±æ€§</span></span><br><span class="line">conf.setMaster(<span class="string">"local"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ conf åˆ›å»º sc (æ³¨æ„, è¿™é‡Œä¸€å®šè¦ä¼ å…¥ conf, å¦åˆ™å°±ä¼šæŠ¥ä¸‹é¢è¿™ä¸ªé”™è¯¯)</span></span><br><span class="line"><span class="comment">// A master URL must be set in your configuration</span></span><br><span class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br></pre></td></tr></table></figure><h4 id="2-é…ç½®-Spark-ç‹¬ç«‹æ¨¡å¼æ—¶-æ‰¾ä¸åˆ°-JAVA-HOME"><a href="#2-é…ç½®-Spark-ç‹¬ç«‹æ¨¡å¼æ—¶-æ‰¾ä¸åˆ°-JAVA-HOME" class="headerlink" title="2. é…ç½® Spark ç‹¬ç«‹æ¨¡å¼æ—¶, æ‰¾ä¸åˆ° JAVA_HOME"></a>2. é…ç½® Spark ç‹¬ç«‹æ¨¡å¼æ—¶, æ‰¾ä¸åˆ° JAVA_HOME</h4><p><strong>é”™è¯¯æè¿°: <code>JAVA_HOME is not set</code></strong></p><p><em>è§£å†³æ–¹æ³•</em>: </p><ul><li><strong>åœ¨ <code>sbin</code>ç›®å½•ä¸­,  åœ¨<code>spark-config.sh</code>ä¸­åŠ ä¸Š</strong> <strong><code>export JAVA_HOME=...</code></strong></li><li>åˆ†å‘åˆ°å…¶å®ƒä¸»æœº</li></ul><h4 id="3-ä¸€ä¸ª-JVM-ä¸­å¦‚æœå­˜åœ¨å¤šä¸ª-SparkContext"><a href="#3-ä¸€ä¸ª-JVM-ä¸­å¦‚æœå­˜åœ¨å¤šä¸ª-SparkContext" class="headerlink" title="3.ä¸€ä¸ª JVM ä¸­å¦‚æœå­˜åœ¨å¤šä¸ª SparkContext"></a>3.ä¸€ä¸ª JVM ä¸­å¦‚æœå­˜åœ¨å¤šä¸ª SparkContext</h4><p>Exception in thread â€œmainâ€ org.apache.spark.SparkException: Only one SparkContext may be running in this JVM (see SPARK-2243). To ignore this error, set spark.driver.allowMultipleContexts = true. The currently running SparkContext was created at:</p><p>åŸå› æ˜¯å› ä¸º, æ¯ä¸ª static æ–¹æ³•ä¸­, éƒ½åˆ›å»ºäº† sc, å½“ç„¶, è¿™é‡Œåªæ˜¯æµ‹è¯•ç”¨, å¯å¿½ç•¥, è§è¿™é‡Œ: </p><p><a href="https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/TransfromationOperation.java" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/blob/master/Spark_Project/SparkDemo-1/src/main/java/com/rox/spark/java/TransfromationOperation.java</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-åˆ›å»º-SparkContext-æ—¶-é‡åˆ°çš„é—®é¢˜&quot;&gt;&lt;a href=&quot;#1-åˆ›å»º-SparkContext-æ—¶-é‡åˆ°çš„é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;1.åˆ›å»º SparkContext æ—¶, é‡åˆ°çš„é—®é¢˜&quot;&gt;&lt;/a&gt;1.åˆ›å»º Spark
      
    
    </summary>
    
      <category term="Spark" scheme="https://airpoet.github.io/categories/Spark/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Spark" scheme="https://airpoet.github.io/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>i-Scala</title>
    <link href="https://airpoet.github.io/2018/07/12/Hadoop/12_Scala/i-Scala/"/>
    <id>https://airpoet.github.io/2018/07/12/Hadoop/12_Scala/i-Scala/</id>
    <published>2018-07-12T02:05:03.898Z</published>
    <updated>2018-07-17T01:45:44.012Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-æ¦‚è§ˆ"><a href="#ä¸€-æ¦‚è§ˆ" class="headerlink" title="ä¸€. æ¦‚è§ˆ"></a>ä¸€. <strong>æ¦‚è§ˆ</strong></h1><p><strong>scala</strong> : javaè¯­è¨€çš„è„šæœ¬åŒ–ã€‚          </p><p><strong>Scala çš„ç±»å…³ç³»å›¾</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-12-061916.png" alt="image-20180712141916222"></p><p><strong>æ•°æ®ç±»å‹æ³¨æ„ç‚¹</strong></p><p>1ã€ Any æ˜¯æ‰€æœ‰ç±»çš„çˆ¶ç±»ï¼ŒåŒ…æ‹¬å€¼ç±»å‹ AnyValï¼Œå’Œå¼•ç”¨ç±»å‹ AnyRef<br>2ã€ AnyVal æ˜¯æ‰€æœ‰å€¼ç±»å‹çš„çˆ¶ç±»ï¼ŒåŒ…æ‹¬ Intï¼ŒDoubleï¼ŒBooleanï¼ŒUnit ç­‰ç­‰<br>3ã€ AnyRef æ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹çš„çˆ¶ç±»ï¼ŒåŒ…æ‹¬ Null<br>4ã€ Null æ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹çš„å­ç±»<br>5ã€ Nothing æ˜¯æ‰€æœ‰ç±»çš„å­ç±»<br>6ã€ Unit ç±»å‹åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ˜¯()ï¼Œç›¸å½“äº java ä¸­çš„ voidï¼Œæ²¡æœ‰ä»»ä½•çš„å®è´¨æ„ä¹‰<br>7ã€ Null ä¹Ÿåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ˜¯ nullï¼Œç›¸å½“äº java ä¸­çš„ nullï¼Œèƒ½èµ‹å€¼ç»™ä»»ä½•å¼•ç”¨ç±»å‹å˜é‡ï¼Œä¸<br>èƒ½èµ‹å€¼ç»™å€¼ç±»å‹å˜é‡</p><p><strong>æ–¹æ³•çš„è¿”å›å€¼:</strong> </p><ul><li>å¦‚æœæ²¡æœ‰æ˜¾ç¤ºå®šä¹‰è¿”å›å€¼, ä¼šè¿”å› <strong>æœ‰å¯èƒ½è¿”å› çš„ å€¼</strong> <strong>çš„</strong>å…±åŒç±»å‹(<strong>çˆ¶ç±»</strong>)</li></ul><p><strong>å®šä¹‰æ–¹æ³•</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-12-081734.png" alt="image-20180712161733886"></p><p><strong>å®šä¹‰å‡½æ•°</strong></p><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-12-152103.png" alt="image-20180712232102657"></p><h4 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h4> <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å˜é‡</span></span><br><span class="line">scala&gt;<span class="keyword">var</span> a = <span class="number">100</span>            <span class="comment">//å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¸¸é‡</span></span><br><span class="line">scala&gt;<span class="keyword">val</span> a = <span class="number">100</span>            <span class="comment">//å¸¸é‡ï¼Œä¸èƒ½é‡æ–°èµ‹å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ç±»å‹  //val å¸¸é‡, ä¸èƒ½å†é‡æ–°èµ‹å€¼</span></span><br><span class="line">scala&gt;<span class="keyword">val</span> a:<span class="type">String</span> = <span class="string">"hello"</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ“ä½œç¬¦é‡è½½ </span></span><br><span class="line">    scala&gt;<span class="number">1</span> + <span class="number">2</span></span><br><span class="line">    scala&gt;<span class="number">1.</span>+(<span class="number">2</span>)          </span><br><span class="line"></span><br><span class="line"><span class="comment">//scalaæ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨</span></span><br><span class="line">    scala&gt;<span class="keyword">import</span> scala.math._        <span class="comment">//_ ===&gt; * ä¸‹åˆ’çº¿æ˜¯é€šé…çš„æ„æ€</span></span><br><span class="line">    scala&gt;min(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//apply</span></span><br><span class="line">    scala&gt;<span class="string">"hello"</span>.apply(<span class="number">1</span>)            <span class="comment">//ç­‰ä»·äºxxx.apply()</span></span><br><span class="line">    scala&gt;<span class="string">"hello"</span>(<span class="number">1</span>)                 </span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¡ä»¶è¡¨è¾¾å¼,scalaçš„è¡¨è¾¾å¼æœ‰å€¼,æ˜¯æœ€åä¸€æ¡è¯­å¥çš„å€¼ã€‚</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> x = <span class="number">1</span> ;</span><br><span class="line">scala&gt;<span class="keyword">val</span> b = <span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">-1</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Any æ˜¯Intå’ŒStringçš„è¶…ç±»ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç±»å‹è½¬æ¢</span></span><br><span class="line">    scala&gt;<span class="number">1.</span>toString()</span><br><span class="line">    scala&gt;<span class="string">"100"</span>.toInt()                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç©ºå€¼   </span></span><br><span class="line">   scala&gt; <span class="keyword">val</span> y = ()  <span class="comment">//y:Unit= ()ç±»ä¼¼äºjava void.</span></span><br><span class="line">   y: <span class="type">Unit</span> = ()</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç²˜è´´å¤åˆ¶</span></span><br><span class="line">    <span class="comment">// æœ‰å·¦å¤§æ‹¬å·çš„è¯, å›è½¦ä¼šç›´æ¥æ¢è¡Œ</span></span><br><span class="line"><span class="comment">// è¿›å…¥ paste æ¨¡å¼</span></span><br><span class="line">    scala&gt;:paste</span><br><span class="line">            ....</span><br><span class="line">    ctrl + d                    <span class="comment">//ç»“æŸç²˜è´´æ¨¡å¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// scala çš„ç¼–è¯‘</span></span><br><span class="line">    javac               java</span><br><span class="line">    *.java --------&gt; *.<span class="keyword">class</span>  --------&gt;ç¨‹åº</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡º</span></span><br><span class="line">    scala&gt;print(<span class="string">"hello"</span>)</span><br><span class="line">    scala&gt;println(<span class="string">"hello"</span>)</span><br><span class="line">    scala&gt;printf(<span class="string">"name is %s , age is %d"</span>, <span class="string">"tom"</span>,<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»è¡Œ</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> password = readLine(<span class="string">"è¯·è¾“å…¥å¯†ç  : "</span>) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥çœ‹å¸®åŠ©</span></span><br><span class="line">    scala&gt;:help</span><br></pre></td></tr></table></figure><hr><h1 id="äºŒ-å¾ªç¯"><a href="#äºŒ-å¾ªç¯" class="headerlink" title="äºŒ. å¾ªç¯"></a>äºŒ. å¾ªç¯</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ™®é€šå¾ªç¯</span></span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span> ;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; <span class="number">10</span> )&#123;</span><br><span class="line">        println(i) ;</span><br><span class="line">        i += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">// 99è¡¨æ ¼</span></span><br><span class="line">    <span class="keyword">var</span> row = <span class="number">1</span> ; </span><br><span class="line">    <span class="keyword">while</span>(row &lt;= <span class="number">9</span> )&#123;</span><br><span class="line">        <span class="keyword">var</span> col = <span class="number">1</span> ; </span><br><span class="line">        <span class="keyword">while</span>(col &lt;= row)&#123;</span><br><span class="line">            printf(<span class="string">"%d x %d = %d\t"</span>,col,row,(row * col)) ;</span><br><span class="line">            col += <span class="number">1</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        println();</span><br><span class="line">        row += <span class="number">1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">// ç™¾é’±ä¹°ç™¾é¸¡é—®é¢˜</span></span><br><span class="line">    <span class="comment">// 100å—é’±èƒ½å„ä¹°3ç§ğŸ“, å„ä¹°å¤šå°‘ç§</span></span><br><span class="line">    <span class="comment">// å…¬é¸¡:5å—/åª</span></span><br><span class="line">    <span class="comment">// æ¯é¸¡:3å—/åª</span></span><br><span class="line">    <span class="comment">// å°é¸¡:1å—/3åª</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å…¬é¸¡</span></span><br><span class="line"><span class="keyword">var</span> cock = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">while</span>(cock &lt;= <span class="number">20</span>)&#123;</span><br><span class="line">    <span class="comment">//æ¯é¸¡</span></span><br><span class="line">    <span class="keyword">var</span> hen = <span class="number">0</span> ;</span><br><span class="line">    <span class="keyword">while</span>(hen &lt;= <span class="number">100</span>/<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="comment">// å°é¸¡ğŸ¥</span></span><br><span class="line">        <span class="keyword">var</span> chicken = <span class="number">0</span> ;</span><br><span class="line">        <span class="keyword">while</span>(chicken &lt;= <span class="number">100</span>)&#123;</span><br><span class="line">            <span class="comment">// é’±æ•°</span></span><br><span class="line">            <span class="keyword">var</span> money = cock * <span class="number">5</span> + hen * <span class="number">3</span> + chicken / <span class="number">3</span> ;</span><br><span class="line">            <span class="comment">// ä¸ªæ•°</span></span><br><span class="line">            <span class="keyword">var</span> mount = cock + hen + chicken ;</span><br><span class="line">            <span class="keyword">if</span>(money == <span class="number">100</span> &amp;&amp; mount == <span class="number">100</span>)&#123;</span><br><span class="line">                printf(<span class="string">"cock : %d , hen : %d , chicken : %d\n"</span>,cock,hen,chicken) ;</span><br><span class="line">            &#125;</span><br><span class="line">            chicken += <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hen += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cock += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">//forå¾ªç¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// to </span></span><br><span class="line"><span class="comment">// æ³¨æ„:  &lt;- æ˜¯å†™åœ¨ä¸€èµ·çš„ </span></span><br><span class="line">scala&gt; <span class="keyword">for</span> (x  &lt;-  <span class="number">1</span> to <span class="number">10</span>)&#123;</span><br><span class="line">    println(x) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="comment">// until   [1,...10)</span></span><br><span class="line"><span class="comment">// å·¦é—­å³å¼€ </span></span><br><span class="line"><span class="keyword">for</span> (x &lt;- <span class="number">1</span> until <span class="number">10</span>)&#123;</span><br><span class="line">    println(x) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// step ä¸º2 </span></span><br><span class="line"><span class="keyword">for</span> (x &lt;- <span class="number">1</span> until (<span class="number">10</span>,<span class="number">2</span>))&#123;</span><br><span class="line">    println(x) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å€’åºæ‰“å°</span></span><br><span class="line"><span class="keyword">for</span> (str &lt;- (<span class="number">1</span> to <span class="number">10</span>).reverse)&#123;</span><br><span class="line">println(str)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ•°ç»„ä¸‹æ ‡çš„æ–¹å¼è¿›è¡Œæ‰“å°</span></span><br><span class="line"><span class="keyword">for</span> (i &lt;- <span class="number">0</span> to arr.length - <span class="number">1</span>)&#123;</span><br><span class="line">println(arr(i))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="comment">//scalaæ²¡æœ‰break continueè¯­å¥ã€‚å¯ä»¥ä½¿ç”¨Breakså¯¹è±¡çš„break()æ–¹æ³•ã€‚</span></span><br><span class="line">scala&gt; <span class="keyword">import</span> scala.util.control.<span class="type">Breaks</span>._</span><br><span class="line">scala&gt; <span class="keyword">for</span>(x &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;<span class="keyword">if</span> (x&gt;<span class="number">8</span>) <span class="keyword">break</span>() ; print(x)&#125; ;</span><br><span class="line">eg: scala&gt; <span class="keyword">for</span>(x &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123; println(x); <span class="keyword">if</span>(x == <span class="number">5</span>)<span class="keyword">break</span>;&#125;  </span><br><span class="line"><span class="number">12345</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">//forå¾ªç¯é«˜çº§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒå¾ªç¯,å®ˆå«æ¡ä»¶</span></span><br><span class="line">scala&gt; <span class="keyword">for</span>(i &lt;- <span class="number">1</span> to <span class="number">3</span> ; j &lt;- <span class="number">1</span> to <span class="number">4</span> <span class="keyword">if</span> i != j ) &#123;printf(<span class="string">"i = %d, j = %d , res = %d \n"</span>,i,j,i*j);&#125; ;    </span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="comment">//yieldï¼Œæ˜¯å¾ªç¯ä¸­å¤„ç†æ¯ä¸ªå…ƒç´ ï¼Œäº§ç”Ÿæ–°é›†åˆ</span></span><br><span class="line">scala&gt;<span class="keyword">for</span> (x &lt;- <span class="number">1</span> to <span class="number">10</span> ) <span class="keyword">yield</span> x % <span class="number">2</span> ;</span><br></pre></td></tr></table></figure><h1 id="ä¸‰-å®šä¹‰å‡½æ•°"><a href="#ä¸‰-å®šä¹‰å‡½æ•°" class="headerlink" title="ä¸‰. å®šä¹‰å‡½æ•°"></a>ä¸‰. å®šä¹‰å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹å¼1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>):<span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> c = a + b  ;</span><br><span class="line">    <span class="keyword">return</span> c  ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹å¼2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>):<span class="type">Int</span> =  a + b</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment">//scalaå®ç°é€’å½’</span></span><br><span class="line"></span><br><span class="line">æ ¸å¿ƒ:  n! = n * (n - <span class="number">1</span>)!  <span class="comment">// n çš„é˜¶ä¹˜ = n-1çš„é˜¶ä¹˜, å¹¶ä¸” å‡ºå£æ˜¯ n=1</span></span><br><span class="line"><span class="number">4</span>!  = <span class="number">4</span> x <span class="number">3</span>!</span><br><span class="line"><span class="number">4</span>!  = <span class="number">4</span> x <span class="number">3</span> x <span class="number">2</span>!</span><br><span class="line"><span class="number">4</span>!  = <span class="number">4</span> x <span class="number">3</span> x <span class="number">2</span> x <span class="number">1</span>!</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€’å½’å‡½æ•°å¿…é¡»æ˜¾å¼å®šä¹‰è¿”å›ç±»å‹</span></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">fac</span></span>(n:<span class="type">Int</span>):<span class="type">Int</span> = <span class="keyword">if</span>(n == <span class="number">1</span>) <span class="number">1</span> <span class="keyword">else</span> n * fac(n<span class="number">-1</span>) ;</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">//å‡½æ•°çš„é»˜è®¤å€¼å’Œå‘½åå‚æ•°</span></span><br><span class="line">scala&gt;<span class="function"><span class="keyword">def</span> <span class="title">decorate</span></span>(prefix:<span class="type">String</span> = <span class="string">"[["</span>,str:<span class="type">String</span>,suffix:<span class="type">String</span> = <span class="string">"]]"</span>) = &#123;</span><br><span class="line">        prefix + str + suffix </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœéƒ½æŒ‡å®šäº†é»˜è®¤å€¼, è°ƒç”¨çš„æ—¶å€™ å¯ä»¥ä¸ä¼ å‚æ•°</span></span><br><span class="line"><span class="comment">// ä¹Ÿå¯ä»¥ä¸æŒ‡å®šå‚æ•°å ä¼ ä»»æ„ä¸ªæ•° çš„å‚æ•°, ä¼šä»ç¬¬ä¸€ä¸ªå¼€å§‹åŒ¹é…</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorate</span></span>(prefix:<span class="type">String</span>=<span class="string">"[["</span>, str:<span class="type">String</span>=<span class="string">"ğŸ‘Œ"</span>, suffix:<span class="type">String</span>=<span class="string">"]]"</span>)=&#123;</span><br><span class="line">    prefix + str + suffix</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----è°ƒç”¨</span><br><span class="line">scala&gt;decorate(str=<span class="string">"hello"</span>)</span><br><span class="line">scala&gt;decorate(str=<span class="string">"hello"</span>,prefix=<span class="string">"&lt;&lt;"</span>)</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment">//å˜é•¿å‚æ•° (å°±ç›¸å½“äºå¯ä»¥ä¼ å¤šä¸ªå€¼)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(a:<span class="type">Int</span>*) = &#123;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(x &lt;- a) s += x;</span><br><span class="line">    s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">sum (<span class="number">1</span> to <span class="number">4</span>:_*)  <span class="comment">// å°†1 to 4å½“åšåºåˆ—å¤„ç†</span></span><br><span class="line"><span class="comment">// ä¸¤è€…æ˜¯ä¸€æ ·çš„æ•ˆæœ</span></span><br><span class="line"></span><br><span class="line">sum(<span class="number">1</span> to <span class="number">4</span>) <span class="comment">// wrong, è¿™æ ·æ˜¯é”™è¯¯çš„</span></span><br><span class="line"></span><br><span class="line">------------------------------------------------</span><br><span class="line"><span class="comment">// é€’å½’ç›¸åŠ (è·Ÿä¸Šé¢å˜é•¿å‚æ•°å¾ªç¯éå†çš„æ•ˆæœä¸€æ ·)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(args:<span class="type">Int</span>*):<span class="type">Int</span> = &#123;<span class="keyword">if</span> (args.length == <span class="number">0</span>) <span class="number">0</span> <span class="keyword">else</span> args.head + sum(args.tail:_*)&#125;</span><br><span class="line">----è°ƒç”¨</span><br><span class="line">sum (<span class="number">1</span> to <span class="number">4</span>:_*) </span><br><span class="line">===================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿‡ç¨‹ (æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰=å·)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">out</span></span>(a:<span class="type">Int</span>)&#123;println(a)&#125;</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">out</span></span>(a:<span class="type">Int</span>)=&#123;println(a)&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">out</span></span>(a:<span class="type">Int</span>):<span class="type">Unit</span> = &#123;println(a)&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt; ä»¥ä¸Š<span class="number">3</span>ç§æ–¹å¼ç­‰ä»·</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">//lazyå»¶è¿Ÿè®¡ç®—</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">lazy</span> <span class="keyword">val</span> x = scala.io.<span class="type">Source</span>.fromFile(<span class="string">"/Users/shixuanji/Documents/IDEs/iTerm2/scala/buyChicked.scala"</span>).mkString</span><br><span class="line">x: <span class="type">String</span> = &lt;<span class="keyword">lazy</span>&gt;</span><br><span class="line">scala&gt; x  </span><br><span class="line">res63: <span class="type">String</span> = <span class="string">"...è¿™é‡Œå°±æ˜¯åŠ è½½å‡ºæ¥çš„çš„æ–‡ä»¶å†…å®¹"</span></span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line"><span class="comment">//å¼‚å¸¸</span></span><br><span class="line">scala&gt;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="string">"hello"</span>.toInt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>&#123;                    <span class="comment">//äº¤ç»™</span></span><br><span class="line">            <span class="keyword">case</span> _:<span class="type">Exception</span>    =&gt; print(<span class="string">"xxxx"</span>) ;</span><br><span class="line">            <span class="keyword">case</span> ex:java.io.<span class="type">IOException</span> =&gt; print(ex)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">-----&gt; æœ€ç®€å•çš„å¼‚å¸¸</span><br><span class="line">scala&gt; <span class="keyword">try</span> &#123; <span class="number">1</span>/<span class="number">0</span> &#125; <span class="keyword">catch</span> &#123; <span class="keyword">case</span> _: <span class="type">Exception</span> =&gt; println(<span class="string">"é”™å•¦....."</span>) &#125;</span><br><span class="line">é”™å•¦.....</span><br><span class="line">res76: <span class="type">AnyVal</span> = ()</span><br><span class="line"></span><br><span class="line"><span class="comment">// _ çš„æ„ä¹‰</span></span><br><span class="line"><span class="number">1</span>&gt; é€šé…ç›¸å½“äº*</span><br><span class="line"><span class="number">2</span>&gt; <span class="number">1</span> to <span class="number">10</span> :_*    ,è½¬æˆåºåˆ—</span><br><span class="line"><span class="number">3</span>&gt; <span class="keyword">case</span> _:<span class="type">Exception</span>    =&gt; print(<span class="string">"xxxx"</span>) ;</span><br></pre></td></tr></table></figure><hr><h1 id="å››-æ•°ç»„"><a href="#å››-æ•°ç»„" class="headerlink" title="å››. æ•°ç»„"></a>å››. æ•°ç»„</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šé•¿</span></span><br><span class="line">---------------</span><br><span class="line">    java&gt; int[] arr = int int[<span class="number">4</span>] ;</span><br><span class="line">    scala&gt;<span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Int</span>](<span class="number">10</span>);            <span class="comment">//apply(10)</span></span><br><span class="line">    scala&gt;<span class="keyword">var</span> arr = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);                <span class="comment">//æ¨æ–­</span></span><br><span class="line">    scala&gt;arr(<span class="number">0</span>)                                   <span class="comment">//æŒ‰ç…§ä¸‹æ ‡è®¿é—®å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ +: æ·»åŠ å…ƒç´ , ä½¿ç”¨ ++: æ·»åŠ æ•°ç»„, ç»“æœæ˜¯ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> arr = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">arr: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">var</span> arr2 = arr :+ <span class="number">2</span></span><br><span class="line">arr2: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; arr2</span><br><span class="line">res2: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; arr</span><br><span class="line">    res3: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å˜é•¿æ•°ç»„</span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt;<span class="keyword">import</span> scala.collection.mutable.<span class="type">ArrayBuffer</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> buf = <span class="type">ArrayBuffer</span>[<span class="type">Int</span>]();            <span class="comment">//åˆ›å»ºæ•°ç»„ç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//+=åœ¨æœ«å°¾è¿½åŠ </span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt; buf += <span class="number">3</span></span><br><span class="line">    res156: buf.<span class="keyword">type</span> = <span class="type">ArrayBuffer</span>(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; buf .+= (<span class="number">23</span>)</span><br><span class="line">    res157: buf.<span class="keyword">type</span> = <span class="type">ArrayBuffer</span>(<span class="number">3</span>, <span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; buf ++= <span class="type">Array</span>(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line">    res158: buf.<span class="keyword">type</span> = <span class="type">ArrayBuffer</span>(<span class="number">3</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//trimEnd,ä»æœ«å°¾ç§»é™¤å…ƒç´ </span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt;buf.trimStart(<span class="number">2</span>)</span><br><span class="line">    scala&gt;buf.trimEnd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//removeæŒ‰ç…§ç´¢å¼•ç§»é™¤</span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt;buf.remove(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//insert,åœ¨0å…ƒç´ ä½ç½®æ’å…¥åç»­æ•°æ®</span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt;buf.insert(<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//toArray</span></span><br><span class="line">-------------------</span><br><span class="line">    scala&gt;buf.toArray</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=================================æ•°ç»„æ“ä½œ==================================</span><br><span class="line"><span class="comment">//æ•°ç»„æ“ä½œ</span></span><br><span class="line">  <span class="comment">// éœ€æ±‚: æ„é€ å‡º20ä»¥å†…, 4çš„å€æ•°çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">// æ–¹å¼1</span></span><br><span class="line">    scala&gt; (<span class="keyword">for</span>(x &lt;- <span class="number">1</span> to <span class="number">10</span> <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>) <span class="keyword">yield</span> x * <span class="number">2</span>).toArray</span><br><span class="line">    res107: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹å¼2</span></span><br><span class="line">    scala&gt; <span class="type">Array</span>(<span class="number">1</span> to <span class="number">10</span>:_*).filter(_ % <span class="number">2</span> == <span class="number">0</span>).map(_ * <span class="number">2</span>)</span><br><span class="line">    res109: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line"><span class="comment">// mapå‡½æ•°, å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°, å‡½æ•°çš„å‚æ•°å¿…é¡»ä¸è°ƒç”¨è€…çš„å‚æ•°æ„æˆä¸€è‡´</span></span><br><span class="line"><span class="comment">// æ¯æ¬¡æ‹¿å‡ºä¸€ä¸ªå‚æ•°å‡ºæ¥ç®—</span></span><br><span class="line"><span class="symbol">'ma</span>p':    æŠŠä¸€æ‰¹å…ƒç´ ç»è¿‡æ“ä½œä»¥åæ˜ å°„å‡ºå¦ä¸€æ‰¹å…ƒç´ , kv è¿›, kv å‡º </span><br><span class="line"><span class="comment">// filter å‡½æ•°, åŒä¸Š</span></span><br><span class="line"><span class="symbol">'filte</span>r': è¿‡æ»¤, æŠŠä¸ç¬¦åˆæ¡ä»¶çš„å…ƒç´ è¿‡æ»¤æ‰</span><br><span class="line">==========================================</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"><span class="comment">//æ•°ç»„å¸¸ç”¨æ–¹æ³•</span></span><br><span class="line">--------------------</span><br><span class="line">    scala&gt;arr.sum</span><br><span class="line">    scala&gt;arr.min</span><br><span class="line">    scala&gt;arr.max</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ’åº</span></span><br><span class="line">--------------------</span><br><span class="line">    scala&gt;<span class="keyword">import</span> scala.util.<span class="type">Sorting</span>._</span><br><span class="line">    scala&gt;<span class="keyword">val</span> arr = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">    scala&gt;quickSort(arr)                <span class="comment">//arræœ‰åº</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Array.mkString =&gt; array è½¬ä¸º string</span></span><br><span class="line">--------------------</span><br><span class="line">    scala&gt; <span class="keyword">val</span> arr = <span class="type">Array</span>(<span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">21</span>)</span><br><span class="line">    arr: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">21</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; arr</span><br><span class="line">    res164: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">21</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; arr.mkString(<span class="string">"&lt;&lt;"</span>,<span class="string">","</span>,<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    res165: <span class="type">String</span> = &lt;&lt;<span class="number">3</span>,<span class="number">4</span>,<span class="number">14</span>,<span class="number">21</span>&gt;&gt;</span><br><span class="line">===================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤šç»´æ•°ç»„</span></span><br><span class="line">--------------------</span><br><span class="line"><span class="comment">// å®šä¹‰æ–¹å¼1</span></span><br><span class="line">    scala&gt; <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Array</span>[<span class="type">Int</span>]](<span class="number">4</span>)</span><br><span class="line">    arr: <span class="type">Array</span>[<span class="type">Array</span>[<span class="type">Int</span>]] = <span class="type">Array</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">    scala&gt; arr(<span class="number">0</span>) = <span class="type">Array</span>(<span class="number">1</span>)</span><br><span class="line">    scala&gt; arr(<span class="number">1</span>) = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">    scala&gt; arr(<span class="number">2</span>) = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    scala&gt; arr(<span class="number">3</span>) = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; arr</span><br><span class="line">    res128: <span class="type">Array</span>[<span class="type">Array</span>[<span class="type">Int</span>]] = <span class="type">Array</span>(<span class="type">Array</span>(<span class="number">1</span>), <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰æ–¹å¼2</span></span><br><span class="line">    <span class="comment">//äºŒç»´æ•°ç»„,3è¡Œ4åˆ—</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> arr = <span class="type">Array</span>.ofDim[<span class="type">Int</span>](<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    <span class="comment">//ä¸‹æ ‡è®¿é—®æ•°ç»„å…ƒç´ </span></span><br><span class="line">    scala&gt;arr(<span class="number">0</span>)(<span class="number">1</span>)</span><br><span class="line">    scala&gt;arr.length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ•°ç»„çš„éå†</span></span><br><span class="line">--------------------</span><br><span class="line">    scala&gt; a</span><br><span class="line">    res178: <span class="type">String</span> = hello</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">for</span>(i &lt;- <span class="number">0</span> until a.length) println(i+<span class="string">":"</span>+a(i))</span><br><span class="line">    <span class="number">0</span>:h</span><br><span class="line">    <span class="number">1</span>:e</span><br><span class="line">    <span class="number">2</span>:l</span><br><span class="line">    <span class="number">3</span>:l</span><br><span class="line">    <span class="number">4</span>:o</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¿åˆ°æ¯ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ (è·Ÿä¸Šé¢çš„éå†ç»“æœä¸€æ ·)</span></span><br><span class="line">--------------------</span><br><span class="line">    scala&gt; arr</span><br><span class="line">    res179: <span class="type">Array</span>[<span class="type">Array</span>[<span class="type">Int</span>]] = <span class="type">Array</span>(<span class="type">Array</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="type">Array</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="type">Array</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">for</span>(i &lt;- <span class="number">0</span> until arr.length) println(i+<span class="string">":"</span>+arr(i))</span><br><span class="line">    <span class="number">0</span>:[<span class="type">I</span>@<span class="number">36081062</span></span><br><span class="line">    <span class="number">1</span>:[<span class="type">I</span>@<span class="number">70</span>c6f11a</span><br><span class="line">    <span class="number">2</span>:[<span class="type">I</span>@<span class="number">378953</span>bd</span><br><span class="line">     </span><br><span class="line"><span class="comment">//å’Œjavaå¯¹è±¡äº¤äº’ï¼Œå¯¼å…¥è½¬æ¢ç±»å‹,ä½¿ç”¨çš„éšå¼è½¬æ¢</span></span><br><span class="line">--------------------</span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>.bufferAsJavaList</span><br><span class="line"><span class="keyword">val</span> buf = <span class="type">ArrayBuffer</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">val</span> list:java.util.<span class="type">List</span>[<span class="type">Int</span>] = buf ; <span class="comment">// scala è¯­æ³•ä¸­, æ³›å‹æ—¶åœ¨ ä¸­æ‹¬å·ä¸­</span></span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line"><span class="comment">// æ‰“å°å¼•ç”¨ç±»å‹</span></span><br><span class="line">println(result.toBuffer)<span class="comment">// æ‰“å°å¼•ç”¨ç±»å‹çš„å€¼</span></span><br><span class="line">println(result.mkString(<span class="string">","</span>))<span class="comment">// ä»¥',' åˆ†éš”ç¬¦æ‰“å°</span></span><br><span class="line">println(arr2.mkString(<span class="string">"&lt;"</span>,<span class="string">":"</span>,<span class="string">"&gt;"</span>))      <span class="comment">// å‰åç¼€ å’Œ åˆ†éš”ç¬¦ æ‰“å°</span></span><br><span class="line">       </span><br><span class="line">println(foreach(println))<span class="comment">// å¾ªç¯æ‰“å°</span></span><br></pre></td></tr></table></figure><hr><h1 id="äº”-Map-æ˜ å°„"><a href="#äº”-Map-æ˜ å°„" class="headerlink" title="äº”. Map æ˜ å°„"></a>äº”. Map æ˜ å°„</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ä¸å¯å˜ immutable</span></span><br><span class="line">=============================================================================</span><br><span class="line">    <span class="comment">//scala.collection.immutable.Map[Int,String] =&gt;ä¸å¯å˜é›†åˆ</span></span><br><span class="line">scala&gt;<span class="keyword">val</span> map = <span class="type">Map</span>(<span class="number">100</span>-&gt;<span class="string">"tom"</span>,<span class="number">200</span>-&gt;<span class="string">"tomas"</span>,<span class="number">300</span>-&gt;<span class="string">"tomasLee"</span>)</span><br><span class="line">map: scala.collection.immutable.<span class="type">Map</span>[<span class="type">Int</span>,<span class="type">String</span>] = <span class="type">Map</span>(<span class="number">100</span> -&gt; tom, <span class="number">200</span> -&gt; tomas, <span class="number">300</span> -&gt; tomasLee)</span><br><span class="line">    <span class="comment">//é€šè¿‡keyè®¿é—®value</span></span><br><span class="line">    scala&gt;map(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">æ³¨æ„:</span><br><span class="line">    <span class="number">1</span>) å¦‚æœæ˜¯ immutable çš„ map çš„ <span class="keyword">val</span> è¦æ”¹å˜, åªèƒ½èµ‹å€¼ç»™æ–°çš„ <span class="keyword">val</span> , æ·»åŠ åªèƒ½ç”¨ + å·</span><br><span class="line">    <span class="number">2</span>) å¦‚æœæ˜¯ immutable çš„ map çš„ <span class="keyword">var</span> å¯ä»¥ç›´æ¥ä½¿ç”¨ +=, -= </span><br><span class="line">      <span class="keyword">val</span> newmap = map + (<span class="number">4</span>-&gt;<span class="string">"ttt"</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// å¯å˜ mutable</span></span><br><span class="line">=============================================================================</span><br><span class="line"><span class="comment">// ç›´æ¥å®šä¹‰ hashMap å¹¶èµ‹å€¼</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">    <span class="keyword">import</span> scala.collection.mutable.<span class="type">HashMap</span></span><br><span class="line">    <span class="keyword">var</span> map1 = <span class="type">HashMap</span>(<span class="number">1</span>-&gt;<span class="number">22</span>, <span class="string">"dd"</span>-&gt;<span class="number">33</span>)<span class="comment">//æ³¨æ„, è¿™é‡Œå­—ç¬¦ä¸²åªèƒ½ä½¿ç”¨ åŒå¼•å· </span></span><br><span class="line">    $scala&gt; map1</span><br><span class="line">    res145: scala.collection.mutable.<span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>(<span class="number">2</span> -&gt; <span class="number">33</span>, <span class="number">1</span> -&gt; <span class="number">22</span>)</span><br><span class="line">    scala&gt; map1(<span class="string">"dd"</span>)</span><br><span class="line">    res197: <span class="type">Int</span> = <span class="number">33</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆå®šä¹‰ç©ºhashmap</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">    scala&gt; <span class="keyword">var</span> map2 = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>]</span><br><span class="line">    map2: scala.collection.mutable.<span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>()</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">var</span> map3 = <span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>]()  <span class="comment">// è¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨äº† apply()</span></span><br><span class="line">    map3: scala.collection.mutable.<span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// hashMap èµ‹å€¼</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">æ³¨æ„: += / -= ä¼šæ”¹å˜åŸå€¼,  + / - ä¸ä¼šæ”¹å˜åŸå€¼,åªä¼šæ”¹å˜å½“æ¬¡è¿”å›å€¼</span><br><span class="line">---------------------------------------------</span><br><span class="line"><span class="comment">///æ·»åŠ å…ƒç´ : += (k-&gt;v) æ³¨æ„: è¦ä¸å®šä¹‰æ—¶ç±»å‹ä¸€è‡´</span></span><br><span class="line">    scala&gt; map2 += (<span class="number">1</span>-&gt;<span class="number">100</span>,<span class="number">2</span>-&gt;<span class="number">200</span>)</span><br><span class="line">    res150: scala.collection.mutable.<span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>(<span class="number">2</span> -&gt; <span class="number">200</span>, <span class="number">1</span> -&gt; <span class="number">100</span>)</span><br><span class="line">    ====&gt; æ³¨æ„: æ­¤æ—¶ mutable de  <span class="keyword">var</span> çš„  '+=' å’Œ '+', æ•ˆæœæ˜¯ä¸€æ ·çš„</span><br><span class="line">    =====&gt; map2 = map2 + (<span class="number">1</span>-&gt;<span class="number">100</span>,<span class="number">2</span>-&gt;<span class="number">200</span>)  <span class="comment">// è¿™ä¸ªå†™æ³•æ˜¯é”™è¯¯çš„, è¦ä¹ˆç”¨+, è¦ä¹ˆç”¨+=</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///åˆ é™¤å…ƒç´ : -= k</span></span><br><span class="line">    scala&gt; map2 -= <span class="number">1</span></span><br><span class="line">    res151: scala.collection.mutable.<span class="type">HashMap</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>(<span class="number">2</span> -&gt; <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">==&gt;  æ³¨æ„: å¦‚æœkey ä¸€æ ·, ä¼šè¦†ç›–æ‰å‰é¢çš„èµ‹å€¼, ç›¸å½“äºä¿®æ”¹</span><br><span class="line">==&gt;  å½“ç„¶, ä¹Ÿå¯ä»¥è¿™æ ·ä¿®æ”¹: &gt;&gt;&gt;  map2(<span class="number">1</span>) = <span class="number">500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿­ä»£map</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">scala&gt;<span class="keyword">for</span> ((k,v) &lt;- map) println(k + <span class="string">":::"</span> + v);</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">for</span> ((k,v) &lt;- map) println(k +<span class="string">":::::"</span> + v)</span><br><span class="line"><span class="number">1</span>:::::<span class="number">33</span></span><br><span class="line"><span class="number">2</span>:::::<span class="number">44</span></span><br><span class="line"><span class="number">3</span>:::::<span class="number">55</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨yieldæ“ä½œè¿›è¡Œå€’æ’åº(kvå¯¹è°ƒ)</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">scala&gt; <span class="keyword">for</span> ((k,v) &lt;- map) <span class="keyword">yield</span> (v,k)</span><br><span class="line">res210: scala.collection.immutable.<span class="type">Map</span>[<span class="type">Int</span>,<span class="type">Int</span>] = <span class="type">Map</span>(<span class="number">33</span> -&gt; <span class="number">1</span>, <span class="number">44</span> -&gt; <span class="number">2</span>, <span class="number">55</span> -&gt; <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// mapæ–¹æ³•:</span></span><br><span class="line">æ­¤æ–¹æ³•åªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°, è¿™ä¸ªå‚æ•°æ˜¯å‡½æ•°</span><br><span class="line">æ­¤å‚æ•°å‡½æ•°, ä¹Ÿåªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°, æ­¤å‚æ•°çš„ç±»å‹, å’Œæ•°ç»„ä¸­çš„å…ƒç´ ç±»å‹ä¸€è‡´</span><br><span class="line">æ­¤å‚æ•°å‡½æ•°æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªå€¼, å€¼çš„ç±»å‹å¯ä»¥è‡ªå®šä¹‰</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> add1 = (x : <span class="type">Int</span>) =&gt; x+<span class="number">1</span> </span><br><span class="line">arr.map(add1)</span><br><span class="line"></span><br><span class="line">arr.map( (x : <span class="type">Int</span>) =&gt; x+<span class="number">1</span> )</span><br><span class="line">arr. map(x =&gt; x +<span class="number">1</span>)</span><br><span class="line">arr.map(_ + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å–å€¼</span></span><br><span class="line">map.get(<span class="string">"xx"</span>)      <span class="comment">//æ²¡æœ‰çš„è¯å°±è¿”å›ç©º</span></span><br><span class="line">scala&gt; m.getOrElse(<span class="number">0</span>,<span class="string">"no"</span>)   <span class="comment">// æ²¡æœ‰çš„è¯å°±è¿”å›åé¢æŒ‡å®šçš„å…ƒç´ </span></span><br></pre></td></tr></table></figure><hr><h1 id="å…­-å…ƒç»„tuple-æœ€å¤§Tuple22"><a href="#å…­-å…ƒç»„tuple-æœ€å¤§Tuple22" class="headerlink" title="å…­. å…ƒç»„tuple, æœ€å¤§Tuple22"></a>å…­. å…ƒç»„tuple, æœ€å¤§Tuple22</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äºŒå…ƒå…ƒç¥– å« å¯¹å¶</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">å…ƒç»„çš„å®šä¹‰: ç”¨å°æ‹¬å·åŒ…èµ·æ¥</span><br><span class="line">---------------------------------------------</span><br><span class="line">    scala&gt; <span class="keyword">val</span> t = (<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>) ;</span><br><span class="line">    scala&gt; t</span><br><span class="line">    res216: (<span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>) = (<span class="number">1</span>,tom,<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">val</span> t = (<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>)</span><br><span class="line">    t: (<span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>) = (<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>,tom,<span class="number">12</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">val</span> t = (<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">    &lt;console&gt;:<span class="number">1</span>: error: too many elements <span class="keyword">for</span> tuple: <span class="number">23</span>, allowed: <span class="number">22</span></span><br><span class="line">           <span class="keyword">val</span> t = (<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">"tom"</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">æ³¨æ„: error: too many elements <span class="keyword">for</span> tuple: <span class="number">23</span>, allowed: <span class="number">22</span>  å…ƒç¥–æœ€å¤š<span class="number">22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¿é—®å…ƒç»„æŒ‡å®šå…ƒ</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">==&gt; æ³¨æ„: å…ƒç¥–åºåˆ—ä» <span class="number">1</span> å¼€å§‹</span><br><span class="line">scala&gt; <span class="keyword">val</span> t = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>) ;        <span class="comment">//å…ƒç»„</span></span><br><span class="line">scala&gt;t._2</span><br><span class="line">scala&gt;t _2 (ä¸æ¨è)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> (a,b,c) = t</span><br><span class="line">==&gt; ç›¸å½“äºä¸€ä¸‹å£°æ˜äº†<span class="number">3</span>ä¸ªå˜é‡, a,b,c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›´æ¥å–å‡ºå…ƒç»„ä¸­çš„å„åˆ†é‡</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">scala&gt; <span class="keyword">val</span> t = (<span class="number">132</span>,<span class="string">"d4"</span>,<span class="number">3</span>)</span><br><span class="line">t: (<span class="type">Int</span>, <span class="type">String</span>, <span class="type">Int</span>) = (<span class="number">132</span>,d4,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">æ³¨æ„: å‰åçš„å…ƒæ•°å¿…é¡»ç›¸ç­‰</span><br><span class="line">scala&gt; <span class="keyword">val</span> (a,b,c) = t</span><br><span class="line">a: <span class="type">Int</span> = <span class="number">132</span></span><br><span class="line">b: <span class="type">String</span> = d4</span><br><span class="line">c: <span class="type">Int</span> = <span class="number">3</span></span><br><span class="line">==&gt; è¿™é‡Œå°±ç›¸å½“äºç›´æ¥å®šä¹‰äº† a,b,c ä¸‰ä¸ªå˜é‡</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ•°ç»„çš„zip</span></span><br><span class="line">---------------------------------------------</span><br><span class="line"><span class="comment">//è¥¿é—¨åº† -&gt; æ½˜é‡‘è²  ç‰›éƒ -&gt; ä¾„å¥³  ,</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> hus = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">hus: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> wife = <span class="type">Array</span>(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">wife: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; hus.zip(wife)</span><br><span class="line">res226: <span class="type">Array</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = <span class="type">Array</span>((<span class="number">1</span>,<span class="number">4</span>), (<span class="number">2</span>,<span class="number">5</span>), (<span class="number">3</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">æ³¨æ„: ä¸ªæ•°å¯¹ä¸ä¸Šçš„å°±ç æ‰äº†</span><br></pre></td></tr></table></figure><hr><h1 id="ä¸ƒ-OOP"><a href="#ä¸ƒ-OOP" class="headerlink" title="ä¸ƒ. OOP"></a>ä¸ƒ. OOP</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ç±» &amp; åŸºæœ¬æ“ä½œ</span></span><br><span class="line">===============================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰å˜é‡, ç§æœ‰ç±»å‹, å¿…é¡»åˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// .class ä¸­ç§æœ‰æ–¹æ³•æŸ¥çœ‹: javap -private xxx.class</span></span><br><span class="line">    <span class="comment">// getter/setter ä¹Ÿç§æœ‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// p.name  =&gt; getter</span></span><br><span class="line">    <span class="comment">// p.name_=(xx) =&gt; setter </span></span><br><span class="line">    <span class="comment">// p.name = xx  =&gt; setter</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆç§æœ‰å±æ€§, å’Œå…±æœ‰çš„ getter/setter æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">"tom"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// val åªæœ‰ getter, æ²¡æœ‰setter, å®šä¹‰çš„æ˜¯ val å¸¸é‡</span></span><br><span class="line">    <span class="keyword">val</span> age = <span class="number">100</span>; </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">incre</span></span>(a:<span class="type">Int</span>) = &#123;id += a&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœå®šä¹‰æ—¶ï¼Œæ²¡æœ‰(),è°ƒç”¨å°±ä¸èƒ½åŠ ()</span></span><br><span class="line">    <span class="comment">// æœ‰çš„è¯, è°ƒç”¨çš„æ—¶å€™å°±å¯åŠ å¯ä¸åŠ </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">current</span></span>() = id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------</span><br><span class="line">-&gt;è°ƒç”¨</span><br><span class="line"></span><br><span class="line">    scala&gt;<span class="keyword">var</span> p = <span class="keyword">new</span> <span class="type">Person</span>();</span><br><span class="line">    scala&gt;p.current()</span><br><span class="line">    scala&gt;p.current</span><br><span class="line">    scala&gt;p.incr(<span class="number">100</span>)</span><br><span class="line">    scala&gt;p.name</span><br><span class="line">    scala&gt;p.name_=(<span class="string">"kkkk"</span>)</span><br><span class="line">    scala&gt;p.name = <span class="string">"kkkk"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// private[this]ä½œç”¨,æ§åˆ¶æˆå‘˜åªèƒ½åœ¨è‡ªå·±çš„å¯¹è±¡ä¸­è®¿é—®ã€‚ (å¯¹è±¡ç§æœ‰)</span></span><br><span class="line">===============================================================</span><br><span class="line"><span class="number">1</span>) <span class="type">Scala</span>ä¸­(<span class="type">Java</span>å’Œ <span class="type">C</span>++ ä¹Ÿä¸€æ ·), æ–¹æ³•å¯ä»¥è®¿é—®è¯¥ç±»çš„æ‰€æœ‰å¯¹è±¡çš„ç§æœ‰å­—æ®µ</span><br><span class="line"><span class="number">2</span>) <span class="keyword">private</span>[<span class="keyword">this</span>], æ˜¯ <span class="type">Counter</span> ç±»çš„æ–¹æ³•, åªèƒ½è®¿é—®åˆ°å½“å‰å¯¹è±¡çš„ value æ–¹æ³•, è€Œä¸èƒ½è®¿é—®åŒæ ·æ˜¯ <span class="type">Counter</span> ç±»å‹çš„å…¶ä»–å¯¹è±¡çš„è¯¥å­—æ®µ.</span><br><span class="line"><span class="number">3</span>) è¿™æ ·çš„è®¿é—®è¢«ç§°ä¸º å¯¹è±¡ç§æœ‰çš„</span><br><span class="line"><span class="number">4</span>) å¯¹äºç±»ç§æœ‰çš„å­—æ®µ, <span class="type">Scala</span> ç”Ÿæˆç§æœ‰çš„ getter å’Œ setter æ–¹æ³•;</span><br><span class="line">    ä½†å¯¹äºå¯¹è±¡ç§æœ‰çš„å­—æ®µ, <span class="type">Scala</span> æ ¹æœ¬ä¸ä¼šç”Ÿæˆ getter å’Œ setter æ–¹æ³•</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="keyword">var</span> value =  <span class="number">0</span> ;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">incre</span></span>(n:<span class="type">Int</span>)&#123;value += n&#125;</span><br><span class="line">        <span class="comment">// ç±»ä¼šå®šä¹‰å¤±è´¥, ä¸‹é¢è¿™å¥ä¸èƒ½è®¿é—®åˆ«ç±»å¯¹è±¡çš„ value</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isLess</span></span>(other:<span class="type">Counter</span>) = value &lt; other.value ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰BeanPropertyæ³¨è§£ :TODO</span></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">===============================================================</span><br><span class="line">&gt; è¾…åŠ©æ„é€ </span><br><span class="line">----------------------</span><br><span class="line">&gt;&gt; å®šä¹‰</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">        <span class="keyword">var</span> id = <span class="number">1</span> ;</span><br><span class="line">        <span class="keyword">var</span> name = <span class="string">"tom"</span> ;</span><br><span class="line">        <span class="keyword">var</span> age = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¸€ä¸ªè¾…åŠ©æ„é€ å™¨</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>();  <span class="comment">// è°ƒç”¨ä¸»æ„é€ å™¨</span></span><br><span class="line">            <span class="keyword">this</span>.name = name ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦ä¸€ä¸ªè¾…åŠ©æ„é€ </span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>(name:<span class="type">String</span>,age:<span class="type">Int</span>)&#123;</span><br><span class="line">            <span class="comment">//è°ƒç”¨å‰ä¸€ä¸ªè¾…åŠ©æ„é€ å™¨</span></span><br><span class="line">            <span class="keyword">this</span>(name) ;</span><br><span class="line">            <span class="keyword">this</span>.age = age ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt; ä½¿ç”¨</span><br><span class="line">scala&gt; <span class="keyword">var</span> p = <span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"tm"</span>)</span><br><span class="line">p: <span class="type">Person</span> = <span class="type">Person</span>@<span class="number">2492</span>f6fb</span><br><span class="line"></span><br><span class="line">scala&gt; p.name</span><br><span class="line">res9: <span class="type">String</span> = tm</span><br><span class="line"></span><br><span class="line">scala&gt; p = <span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"jr"</span>,<span class="number">23</span>)   <span class="comment">// æ³¨æ„: æ­¤ p éä¸Šé¢çš„ p äº†</span></span><br><span class="line">p: <span class="type">Person</span> = <span class="type">Person</span>@<span class="number">2536</span>edc3</span><br><span class="line"></span><br><span class="line">scala&gt; p.name</span><br><span class="line">res11: <span class="type">String</span> = jr</span><br><span class="line"></span><br><span class="line">scala&gt; p.age</span><br><span class="line">res12: <span class="type">Int</span> = <span class="number">23</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; ä¸»æ„é€ å‡½æ•°</span><br><span class="line">---------------------------------------------</span><br><span class="line">    <span class="comment">//val ===&gt; åªè¯»</span></span><br><span class="line">    <span class="comment">//var ==&gt; get/set</span></span><br><span class="line">    <span class="comment">//none ==&gt; none</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„:  id å‰é¢æ²¡æœ‰ä¿®é¥°çš„è¯, åªæœ‰åœ¨è°ƒç”¨åæ‰å‡çº§ä¸ºæˆå‘˜å˜é‡, å¦åˆ™åœ¨ .class æ–‡ä»¶ä¸­ä¸ä¼šå‡ºç°</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">val name:<span class="type">String</span>, var age:<span class="type">Int</span>, id :<span class="type">Int</span></span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span>() = println(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;ç¼–è¯‘åç”Ÿæˆçš„æ–‡ä»¶</span><br><span class="line">javap -<span class="keyword">private</span> <span class="type">Person</span>.<span class="keyword">class</span> -&gt; æ˜¾ç¤ºç¼–è¯‘åçš„ <span class="keyword">private</span> æˆå‘˜</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;                <span class="comment">// id è°ƒç”¨åæ‰å‡çº§ä¸ºæˆå‘˜å˜é‡</span></span><br><span class="line">  <span class="keyword">private</span> int age;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> int id;              </span><br><span class="line">  public java.lang.<span class="type">String</span> name();    <span class="comment">// getter</span></span><br><span class="line">  public int age();                  <span class="comment">// getter</span></span><br><span class="line">  public void age_$eq(int);          <span class="comment">// setter</span></span><br><span class="line">  public void hello();               </span><br><span class="line">  public <span class="type">Person</span>(java.lang.<span class="type">String</span>, int, int);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// object</span></span><br><span class="line">===============================================================</span><br><span class="line">è¯´æ˜ï¼šscalaæ²¡æœ‰é™æ€çš„æ¦‚å¿µï¼Œ'å¦‚æœéœ€è¦å®šä¹‰é™æ€æˆå‘˜ï¼Œå¯ä»¥é€šè¿‡<span class="class"><span class="keyword">object</span><span class="title">å®ç°ã€‚</span>'</span></span><br><span class="line"><span class="class">   <span class="title">ç¼–è¯‘å®Œæˆåï¼Œä¼šç”Ÿæˆå¯¹åº”çš„ç±»ï¼Œæ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œéé™æ€æˆå‘˜å¯¹åº”åˆ°å•ä¾‹ç±»ä¸­</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">å•ä¾‹ç±»ä»¥Util$ä½œä¸ºç±»åç§°ã€‚</span>   </span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">é™æ€æ–¹æ³•ç±»</span> <span class="title">ä»¥</span> <span class="title">Util</span> <span class="title">ä¸ºç±»åç§°</span>.</span></span><br><span class="line"><span class="class">    <span class="title">scala&gt;object</span> <span class="title">Util</span></span>&#123;</span><br><span class="line">        <span class="comment">//è¢«ç¼–è¯‘ä¸ºå•ä¾‹ç±»ä¸­.(Util$)</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> brand = <span class="string">"benz"</span> ;</span><br><span class="line">        <span class="comment">//è¢«ç¼–è¯‘ä¸º å•ç‹¬Util ç±»ä¸­çš„ é™æ€æ–¹æ³• </span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span>() = println(<span class="string">"hello world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">âœ  scala javap -<span class="keyword">private</span> <span class="type">Util</span></span><br><span class="line"><span class="type">Compiled</span> from <span class="string">"util.scala"</span></span><br><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Util</span> </span>&#123;</span><br><span class="line">  public static void hello();</span><br><span class="line">&#125;</span><br><span class="line">âœ  scala javap -<span class="keyword">private</span> <span class="type">Util</span>$</span><br><span class="line"><span class="type">Compiled</span> from <span class="string">"util.scala"</span></span><br><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Util$</span> </span>&#123;</span><br><span class="line">  public static <span class="type">Util</span>$ <span class="type">MODULE</span>$;</span><br><span class="line">  <span class="keyword">private</span> java.lang.<span class="type">String</span> brand;</span><br><span class="line">  public static &#123;&#125;;</span><br><span class="line">  <span class="keyword">private</span> java.lang.<span class="type">String</span> brand();</span><br><span class="line">  <span class="keyword">private</span> void brand_$eq(java.lang.<span class="type">String</span>);</span><br><span class="line">  public void hello();</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Util</span>$();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼´ç”Ÿå¯¹è±¡(companions object)</span></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="number">1.</span> ç±»åå’Œ<span class="class"><span class="keyword">object</span><span class="title">åç§°ç›¸åŒï¼Œè€Œä¸”å¿…é¡»åœ¨ä¸€ä¸ªscalaæ–‡ä»¶ä¸­å®šä¹‰ã€‚</span></span></span><br><span class="line"><span class="class">2. <span class="title">ç¼–è¯‘å</span>, <span class="title">ä¼šäº§ç”Ÿ2ä¸ªæ–‡ä»¶</span>, <span class="title">Car</span>.<span class="title">class</span> <span class="title">å’Œ</span> <span class="title">Car$</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">3. <span class="title">é™æ€æ–¹æ³•ä¼šè¢«ç¼–è¯‘åˆ°</span> <span class="title">Car</span>.<span class="title">class</span> <span class="title">ä¸­å»</span>, <span class="title">é™æ€æ–¹å¼å¯ç›´æ¥ç”¨ç±»è°ƒç”¨</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">stop</span></span>() = println(<span class="string">"stop...."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Car</span></span>&#123;   <span class="comment">// ä¼´ç”Ÿå¯¹è±¡, ç›®çš„å°±æ˜¯ä¸ºäº†äº§ç”Ÿé™æ€æ–¹æ³•</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() = println(<span class="string">"run..."</span>)</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line">&gt; ç¼–è¯‘å</span><br><span class="line">âœ  scala javap -<span class="keyword">private</span> <span class="type">Car</span></span><br><span class="line"><span class="type">Compiled</span> from <span class="string">"companionsObject.scala"</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  public static void run();</span><br><span class="line">  public void stop();</span><br><span class="line">  public <span class="type">Car</span>();</span><br><span class="line">&#125;</span><br><span class="line">âœ  scala javap -<span class="keyword">private</span> <span class="type">Car</span>$</span><br><span class="line"><span class="type">Compiled</span> from <span class="string">"companionsObject.scala"</span></span><br><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Car$</span> </span>&#123;</span><br><span class="line">  public static <span class="type">Car</span>$ <span class="type">MODULE</span>$;</span><br><span class="line">  public static &#123;&#125;;</span><br><span class="line">  public void run();</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Car</span>$();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> å› ä¸º main å‡½æ•°æ˜¯é™æ€æ–¹æ³•, æ‰€ä»¥å†™åœ¨ä¼´ç”Ÿå¯¹è±¡ä¸­</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">val name:<span class="type">String</span>, var age:<span class="type">Int</span>, id : <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span>() = println(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args:<span class="type">Array</span>[<span class="type">String</span>]) = println(<span class="string">"hello world"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">âœ  scala scala main.scala  <span class="comment">// ç›´æ¥ scala xx.scala ä¼šå…ˆç¼–è¯‘å†è¿è¡Œ</span></span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ½è±¡ &amp; é™æ€ </span></span><br><span class="line">===============================================================</span><br><span class="line">âœ æŠ½è±¡ &amp; é™æ€ test</span><br><span class="line"></span><br><span class="line">âœå®šä¹‰ç±»</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ½è±¡ç±»</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a</span></span>():<span class="type">Unit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objectç­‰ä»·äºjavaä¸­çš„é™æ€ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Jing8</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é‡å†™æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">a</span></span>():<span class="type">Unit</span>= println(<span class="string">"hello"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zangao</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">a</span></span>():<span class="type">Unit</span> = println(<span class="string">"è€å­æ˜¯ä¸ªğŸ¶??"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">âœ è°ƒç”¨</span><br><span class="line">scala&gt; <span class="type">Jing8</span>.a            <span class="comment">// é™æ€æ–¹æ³•è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Jing8</span>.a</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">var</span> za = <span class="keyword">new</span> <span class="type">Zangao</span>()  <span class="comment">// ç±»åˆ›å»ºå¯¹è±¡è°ƒç”¨</span></span><br><span class="line">za: <span class="type">Zangao</span> = <span class="type">Zangao</span>@<span class="number">77505</span>c0e</span><br><span class="line"></span><br><span class="line">scala&gt; za.a</span><br><span class="line">è€å­æ˜¯ä¸ªğŸ¶??</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// apply</span></span><br><span class="line">===============================================================</span><br><span class="line"><span class="number">1</span>) ä½¿ç”¨</span><br><span class="line"><span class="comment">// å®šä¹‰: </span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Util</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(s:<span class="type">String</span>) = println(s) ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è°ƒç”¨: ä¸‹é¢2è€…æ˜¯ä¸€ä¸ªæ„æ€</span></span><br><span class="line"><span class="type">Util</span>(<span class="string">"hello world"</span>);</span><br><span class="line"><span class="type">Util</span>.apply(<span class="string">"hello world"</span>);</span><br><span class="line">&gt; è¿è¡Œç»“æœ: hello world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) æ³¨æ„ç‚¹</span><br><span class="line"><span class="comment">// æ³¨æ„ä¸€ä¸‹2è€…çš„åŒºåˆ«</span></span><br><span class="line">scala&gt; <span class="keyword">var</span> arr = <span class="type">Array</span>(<span class="number">10</span>)</span><br><span class="line">arr: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; arr</span><br><span class="line">res18: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="type">Array</span>(<span class="number">10</span>)</span><br><span class="line">arr: <span class="type">Array</span>[<span class="type">Nothing</span>] = <span class="type">Array</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»ˆç«¯ç¼–è¯‘è¿è¡Œ scalaæ–‡ä»¶</span></span><br><span class="line">===============================================================</span><br><span class="line">scalacç¼–è¯‘scalaæ–‡ä»¶ï¼Œäº§ç”Ÿ<span class="class"><span class="keyword">class</span><span class="title">æ–‡ä»¶ã€‚</span></span></span><br><span class="line"><span class="class"><span class="title">------------------------------------</span></span></span><br><span class="line"><span class="class">    <span class="title">cmd&gt;scalac</span> <span class="title">xxxx</span>.<span class="title">scala</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">è¿è¡Œclassç¨‹åº</span></span></span><br><span class="line"><span class="class"><span class="title">--------------------</span></span></span><br><span class="line"><span class="class">    <span class="title">cmd&gt;scala</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">ä¸€æ­¥åˆ°ä½</span></span></span><br><span class="line"><span class="class"><span class="title">-------------------</span></span></span><br><span class="line"><span class="class">    <span class="title">cmd&gt;scala</span> <span class="title">Person</span>.<span class="title">scala</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">trait</span>  (<span class="params">ç±»ä¼¼äº <span class="type">Java</span> ä¸­çš„ interface </span>)</span></span><br><span class="line"><span class="class"><span class="title">===============================================================</span></span></span><br><span class="line"><span class="class">    <span class="title">traint</span> <span class="title">HelloService</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒ…å¯¹è±¡ï¼Œç¼–è¯‘å®Œä¹‹åç”Ÿæˆä»¥ /a/a1/aa1/people/xxx.class..., ä¸€å±‚ä¸€å±‚æ–‡ä»¶å¤¹</span></span><br><span class="line">===============================================================</span><br><span class="line"><span class="keyword">package</span> a.a1.aa1;</span><br><span class="line"><span class="keyword">package</span> <span class="class"><span class="keyword">object</span> <span class="title">people</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> name = <span class="string">"hello world"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¦æŸå¯è§æ€§ã€‚</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="keyword">private</span>[<span class="keyword">package</span>|<span class="keyword">this</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ…çš„å¯¼å…¥</span></span><br><span class="line">--------------</span><br><span class="line"><span class="keyword">import</span> java.io.<span class="type">Exception</span></span><br><span class="line"><span class="keyword">import</span> java.io.&#123;<span class="type">A</span>,<span class="type">B</span>,<span class="type">C</span>&#125;            <span class="comment">//åŒä¸€åŒ…ä¸‹çš„ä¸åŒç±», å¯ä»¥ç”¨å¤§æ‹¬å·åŒ…èµ·æ¥</span></span><br><span class="line"><span class="keyword">import</span> java.io.&#123;<span class="type">A</span> =&gt; <span class="type">A0</span>&#125;        <span class="comment">//åˆ«å</span></span><br></pre></td></tr></table></figure><hr><h1 id="å…«-ç»§æ‰¿-inheritance"><a href="#å…«-ç»§æ‰¿-inheritance" class="headerlink" title="å…«. ç»§æ‰¿ inheritance"></a>å…«. ç»§æ‰¿ inheritance</h1><p><strong>extends</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ç»§æ‰¿/æ‰©å±•</span><br><span class="line">-------------------------------</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">        <span class="comment">//é‡å†™,è¦†ç›–</span></span><br><span class="line">        <span class="comment">//overload</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>()=&#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§æ‰¿å®ä¾‹</span><br><span class="line">------------------------------</span><br><span class="line">$scala&gt;<span class="class"><span class="keyword">class</span> <span class="title">Animal</span>(<span class="params">val name:<span class="type">String</span></span>)</span>&#123;&#125;</span><br><span class="line">$scala&gt;<span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">name:<span class="type">String</span>,val age:<span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Animal</span>(<span class="params">name</span>)</span>&#123;&#125;</span><br><span class="line">$scala&gt;<span class="class"><span class="keyword">class</span> <span class="title">Duck</span>(<span class="params">override val name:<span class="type">String</span>, val age:<span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Animal</span>(<span class="params">name:<span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">æ³¨æ„</span></span>: å¦‚æœåœ¨æ„é€ é‡Œä¸ºç»§æ‰¿çš„çˆ¶ç±»ä¼ å‚, åˆ›å»ºçš„å­ç±»å¯¹è±¡ç›´æ¥ä¼šæœ‰å€¼</span><br><span class="line">scala&gt; <span class="class"><span class="keyword">class</span> <span class="title">Duck</span>(<span class="params">name:<span class="type">String</span>, val age:<span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Animal</span>(<span class="params">"aa"</span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Duck</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">var</span> <span class="title">dd</span> </span>= <span class="keyword">new</span> <span class="type">Duck</span>(<span class="string">"cc"</span>,<span class="number">32</span>)</span><br><span class="line">dd: <span class="type">Duck</span> = <span class="type">Duck</span>@<span class="number">12</span>a63c27</span><br><span class="line"></span><br><span class="line">scala&gt; dd.name</span><br><span class="line">res33: <span class="type">String</span> = aa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç±»å‹æ£€æŸ¥å’Œè½¬æ¢</span><br><span class="line">------------------------------</span><br><span class="line">    $scala&gt;<span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;&#125;</span><br><span class="line">    $scala&gt;<span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;&#125;</span><br><span class="line">    $scala&gt;<span class="keyword">val</span> d = <span class="keyword">new</span> <span class="type">Dog</span>();</span><br><span class="line">    $scala&gt;d.isInstanceOf[<span class="type">Animal</span>]            <span class="comment">//true,===&gt; instanceOf</span></span><br><span class="line">    $scala&gt;<span class="keyword">val</span> a = d.asInstanceOf[<span class="type">Animal</span>]    <span class="comment">//å¼ºè½¬,===&gt; (Animal)d</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¾—åˆ°å¯¹è±¡çš„ç±» å¯¹è±¡ç±»å‹ å¾—åˆ°ç±»å‹</span></span><br><span class="line">    $scala&gt;d.getClass                        <span class="comment">//d.getClass(); è·å–å¯¹è±¡ç±»å‹</span></span><br><span class="line">    $scala&gt;d.getClass == classOf[<span class="type">Dog</span>]        <span class="comment">//ç²¾ç¡®åŒ¹é…</span></span><br></pre></td></tr></table></figure><hr><h1 id="ä¹-abstract-trait-file-apply-æ“ä½œç¬¦"><a href="#ä¹-abstract-trait-file-apply-æ“ä½œç¬¦" class="headerlink" title="ä¹. abstract , trait, file, apply, æ“ä½œç¬¦"></a>ä¹. abstract , trait, file, apply, æ“ä½œç¬¦</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//æŠ½è±¡ç±» abstract </span></span><br><span class="line">================================================</span><br><span class="line">$scala&gt;<span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span>(<span class="params">val name:<span class="type">String</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//æŠ½è±¡å­—æ®µï¼Œæ²¡æœ‰åˆå§‹åŒ–ã€‚</span></span><br><span class="line">    <span class="keyword">val</span> id:<span class="type">Int</span>  ;</span><br><span class="line">    <span class="comment">//æŠ½è±¡æ–¹æ³•ï¼Œæ²¡æœ‰æ–¹æ³•ä½“ï¼Œä¸éœ€è¦æŠ½è±¡å…³é”®å­—ä¿®é¥°ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// scalaç±»å‹æ ‘  :TODO</span></span><br><span class="line">================================================</span><br><span class="line">    <span class="type">Any</span></span><br><span class="line">     |</span><br><span class="line">    /|\</span><br><span class="line">     |------------<span class="type">AnyVal</span> &lt;|------<span class="type">Int</span>|<span class="type">Boolean</span>|...|<span class="type">Unit</span></span><br><span class="line">     |------------<span class="type">AnyRef</span> &lt;|------<span class="class"><span class="keyword">class</span> ...</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">è¯»å–æ–‡ä»¶</span> <span class="title">file</span></span></span><br><span class="line"><span class="class"><span class="title">================================================</span></span></span><br><span class="line"><span class="class"><span class="title">-----------in</span> <span class="title">idea</span></span></span><br><span class="line"><span class="class">    <span class="title">import</span> <span class="title">scala</span>.<span class="title">io</span>.<span class="title">Source</span> </span>;</span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">FileDemo</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">            <span class="keyword">val</span> s = <span class="type">Source</span>.fromFile(<span class="string">"d:/hello.txt"</span>) ;</span><br><span class="line">            <span class="keyword">val</span> lines = s.getLines();</span><br><span class="line">            <span class="keyword">for</span>(line &lt;- lines)&#123;</span><br><span class="line">                println(line)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------in terminal</span><br><span class="line">    scala&gt; scala.io.<span class="type">Source</span>.fromFile(<span class="string">"/Users/shixuanji/Documents/IDEs/iTerm2/scala/util.scala"</span>).mkString</span><br><span class="line"><span class="comment">// ä¸‹é¢æ˜¯ä¸Šé¢æ‰§è¡Œçš„ç»“æœ</span></span><br><span class="line">    res34: <span class="type">String</span> =</span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">Util</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> brand = <span class="string">"benz"</span>;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span>() = println(<span class="string">"hello world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡æ­£åˆ™ (å…·ä½“çš„æŸ¥çœ‹ dash çš„ jdk)</span></span><br><span class="line">\s : ç©ºç™½å­—ç¬¦ï¼š[ \t\n\x0B\f\r]</span><br><span class="line">\<span class="type">S</span> : éç©ºç™½å­—ç¬¦ï¼š[^\s]</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> str = <span class="type">Source</span>.fromFile(<span class="string">"/hello.txt"</span>).mkString</span><br><span class="line"><span class="keyword">val</span> it = str.split(<span class="string">"\\s+"</span>)     <span class="comment">// è¿‡æ»¤æ‰æ‰€æœ‰ä¸å¯è§å­—ç¬¦åˆ†å‰²</span></span><br><span class="line"><span class="keyword">for</span>(i &lt;- it)&#123;</span><br><span class="line">    println(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// trait æ¥å£</span></span><br><span class="line">================================================</span><br><span class="line">&gt;  javaä¸­, å®ç°æ¥å£, ç”¨implement ,  scala ä¸­ç”¨ <span class="keyword">extends</span></span><br><span class="line">&gt;  å¦‚æœåªæœ‰ä¸€ä¸ª<span class="class"><span class="keyword">trait</span><span class="title">ä½¿ç”¨extendsè¿›è¡Œæ‰©å±•ï¼Œå¦‚æœå¤šä¸ªï¼Œä½¿ç”¨withå¯¹å‰©ä½™çš„traitè¿›è¡Œæ‰©å±•ã€‚</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">trait</span> <span class="title">logger1</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">log1</span></span>() = println(<span class="string">"hello log1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">logger2</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">log2</span></span>() = println(<span class="string">"hello log2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&gt;  <span class="class"><span class="keyword">trait</span>(<span class="params">æ¥å£</span>)<span class="title">ä¹‹é—´ä¹Ÿå¯ä»¥å­˜åœ¨æ‰©å±•ã€‚</span>     </span></span><br><span class="line"><span class="class">    <span class="title">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">logger1</span> <span class="keyword">with</span> <span class="title">logger2</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªèº«ç±»å‹ :TODO  è¿˜ä¸æ˜ç™½æ˜¯å•¥æ„æ€, æœ‰ç©ºçœ‹çœ‹  ä¹¦ : 10.13 Self Types &amp; 18.10</span></span><br><span class="line">================================================</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">logger</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>:<span class="type">Dog</span> =&gt; </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() = println(<span class="string">"run...."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">Dog</span> </span>&#123;&#125;</span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">Jing8</span> <span class="keyword">extends</span> <span class="title">Dog</span> <span class="keyword">with</span> <span class="title">logger</span></span>&#123;&#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">logger</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ“ä½œç¬¦</span></span><br><span class="line">================================================</span><br><span class="line">    <span class="comment">//ä¸­ç½®æ“ä½œç¬¦</span></span><br><span class="line">    scala&gt; <span class="number">1</span> + <span class="number">2</span>            <span class="comment">//</span></span><br><span class="line">    scala&gt; <span class="number">1.</span>+(<span class="number">2</span>)            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å•å…ƒæ“ä½œç¬¦</span></span><br><span class="line">    scala&gt; <span class="number">1</span> toString        <span class="comment">//+: -:å–å !:booleanå–å ~:æŒ‰ä½å–å</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//èµ‹å€¼æ“ä½œç¬¦ </span></span><br><span class="line">    $scala&gt;+= , -= , *=,  /=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//:è¡¨ç¤ºå³ç»“åˆ,åªæœ‰:ç»“å°¾çš„æ“ä½œç¬¦æ˜¯å³ç»“åˆ,ä¼˜å…ˆçº§ä»å³ä¾§å¼€å§‹</span></span><br><span class="line">----&gt; ç”¨äºæ„é€ åˆ—è¡¨çš„æ“ä½œç¬¦ :: æ˜¯å³ç»“åˆçš„</span><br><span class="line">    scala&gt;<span class="keyword">val</span> l = <span class="type">Nil</span>        <span class="comment">//æ„é€ ç©ºé›†åˆ.</span></span><br><span class="line">    scala&gt;<span class="number">1</span>::<span class="number">2</span>::<span class="type">Nil</span>            <span class="comment">//1::(2::Nil), å…ˆåˆ›å»ºåŒ…å«2çš„åˆ—è¡¨, è¿™ä¸ªåˆ—è¡¨åˆè¢«ä½œä¸ºä¸ºå˜›é¢‘é“ä»¥1ä¸ºå¤´éƒ¨çš„åˆ—è¡¨ä¸­</span></span><br><span class="line">    scala&gt;<span class="type">Nil</span>.::(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// apply()/update()   --&gt; å…¶å®å°±æ˜¯åœ¨ç­‰å·ä¸¤ä¾§çš„é—®é¢˜</span></span><br><span class="line">================================================</span><br><span class="line">    <span class="keyword">var</span> arr = <span class="type">Array</span>(<span class="number">100</span>)            <span class="comment">//Array.apply(100);</span></span><br><span class="line">    arr(<span class="number">0</span>) = <span class="number">200</span>            <span class="comment">//arr.update(0,1234)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// apply(), æ¥å—çš„æ˜¯å±æ€§å‚æ•°, è¿”å›çš„æ˜¯å¯¹è±¡, å†…éƒ¨å°±æ˜¯ new äº†ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="comment">//unapply(),æ˜¯applyçš„é€†å‘è¿‡ç¨‹,æ¥å—çš„æ˜¯å¯¹è±¡, è¿”å›çš„æ˜¯å‚æ•°(å¯¹è±¡ä¸­çš„å±æ€§å€¼), å¦‚æœç”¨ä¸€ä¸ªå…ƒç¥–ä¸­, ä¼ å…¥ç›¸åº”çš„å˜é‡å, å°±ç›¸å½“äºç»™è¿™äº›å˜é‡èµ‹å€¼äº†</span></span><br><span class="line">    <span class="comment">//å®šä¹‰ç±»</span></span><br><span class="line">------------</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fraction</span>(<span class="params">val n:<span class="type">Int</span>,val d:<span class="type">Int</span></span>)</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Fraction</span></span>&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(n : <span class="type">Int</span>,d:<span class="type">Int</span>)= <span class="keyword">new</span> <span class="type">Fraction</span>(n,d) </span><br><span class="line">    <span class="comment">//é€†å‘è¿‡ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unapply</span></span>(f:<span class="type">Fraction</span>) = <span class="type">Some</span>(f.n,f.d)</span><br><span class="line">&#125;</span><br><span class="line">-------------</span><br><span class="line"><span class="comment">// å› ä¸ºå®šä¹‰äº† apply, æ‰€ä»¥ç›´æ¥è°ƒç”¨  Fraction(1,2) å°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">    scala&gt; <span class="keyword">val</span> f = <span class="type">Fraction</span>(<span class="number">1</span>,<span class="number">2</span>)            <span class="comment">//apply(...)</span></span><br><span class="line">&gt; æ‰§è¡Œç»“æœ</span><br><span class="line">    scala&gt; f</span><br><span class="line">    res254: <span class="type">Fraction</span> = <span class="type">Fraction</span>@<span class="number">30</span>d2895e</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠå®šä¹‰çš„å‡½æ•° è¿˜åŸæˆ Fraction, æ­¤æ—¶, å°±ç›¸å½“äºå®šä¹‰äº† a,b</span></span><br><span class="line">    scala&gt; <span class="keyword">val</span> <span class="type">Fraction</span>(a,b) = f            <span class="comment">//unapply(...)</span></span><br><span class="line">&gt; æ‰§è¡Œç»“æœ</span><br><span class="line">    a: <span class="type">Int</span> = <span class="number">1</span></span><br><span class="line">    b: <span class="type">Int</span> = <span class="number">2</span></span><br></pre></td></tr></table></figure><hr><h1 id="å-é«˜é˜¶å‡½æ•°"><a href="#å-é«˜é˜¶å‡½æ•°" class="headerlink" title="å. é«˜é˜¶å‡½æ•°"></a>å. é«˜é˜¶å‡½æ•°</h1><p><a href="https://www.jianshu.com/p/d5ce4c683703" target="_blank" rel="noopener">â€”&gt; å‡½æ•° Function å’Œ  æ–¹æ³• Method çš„åŒºåˆ«, è§è¿™é‡Œ</a></p><p><strong>æŸ¥çœ‹å‡½æ•°</strong>: ç›´æ¥è¾“å…¥å‡½æ•°å</p><p><strong>æŸ¥çœ‹æ–¹æ³•</strong>: è¾“å…¥æ–¹æ³•åä¹‹å, æŒ‰ tab é”®æç¤º, ä¹Ÿä¼šå±•ç¤ºæ–¹æ³•</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">åŸºæœ¬å‡½æ•°å®šä¹‰</span><br><span class="line">           å‚æ•°&amp;ç±»å‹       =&gt; å®ç°</span><br><span class="line"><span class="keyword">val</span> f1 = (x: <span class="type">Int</span>, y: <span class="type">Int</span>) =&gt; x + y</span><br><span class="line"><span class="keyword">val</span> f2 = (a:<span class="type">Double</span>)=&gt;a*a</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰é«˜é˜¶å‡½æ•° ä¾‹å­1</span></span><br><span class="line">================================================================</span><br><span class="line">    <span class="comment">// f æŒ‡å‚æ•°, fçš„ç±»å‹æ˜¯ (Double)=&gt;Double å‡½æ•°</span></span><br><span class="line">   <span class="comment">//  è¿™é‡Œçš„å‚æ•° f å¯ä»¥æ˜¯ä»»ä½•æ¥å— Double å¹¶è¿”å› Double çš„å‡½æ•°, valueAtOneQuarter å‡½æ•°, å°†è®¡ç®—é‚£ä¸ªå‡½æ•°åœ¨ 0.25ä½ç½®çš„å€¼</span></span><br><span class="line"><span class="comment">// æ³¨æ„: è¿™é‡Œåªæ¥å—ä¸€ä¸ª Double å‚æ•°</span></span><br><span class="line"><span class="keyword">import</span> scala.math._  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">valueAtOneQuarter</span></span>(f:<span class="type">Double</span>=&gt;<span class="type">Double</span>) = f(<span class="number">0.25</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// å¾€å•å‡½æ•°å‚æ•°çš„å‡½æ•° çš„ å‚æ•°ä¸­, ä¼ ä¸€ä¸ªå‡½æ•°, æ­¤å‡½æ•°ç¬¦åˆ (Double)=&gt;Double) çš„ç‰¹å¾, ç„¶åå¾€æ­¤å‡½æ•°ä¸­, ä¼ å€¼ 0.25</span></span><br><span class="line"><span class="keyword">val</span> f2 = (a:<span class="type">Double</span>)=&gt;a*</span><br><span class="line">valueAtOneQuarter(f2)   <span class="comment">// æ‰§è¡Œæ—¶, ä¼šæŠŠåé¢çš„ 0.25ä¼ å…¥åˆ°</span></span><br><span class="line">valueAtOneQuarter(cail _)<span class="comment">// cail å‡½æ•°: å¤§äºä¼ å…¥å€¼çš„æœ€å°æ•´æ•°</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜é˜¶å‡½æ•°ä¾‹å­2</span></span><br><span class="line">================================================================</span><br><span class="line">    <span class="comment">//              å‚æ•°       =  å‡½æ•°ä½“(å‡½æ•°) </span></span><br><span class="line"><span class="comment">//    å‚æ•°      =&gt;  è¿”å›å€¼  </span></span><br><span class="line"><span class="comment">// æ–¹æ³•çš„å®ç°æ˜¯ä¸€ä¸ªå‡½æ•°, æ­¤å‡½æ•°æœ‰è‡ªå·±å®šä¹‰çš„å‚æ•°, æœ‰ä»æ–¹æ³•ä½“ä¸­ä¼ æ¥çš„å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mulby</span></span>(factor : <span class="type">Double</span>) = (x:<span class="type">Double</span>) =&gt; x * factor</span><br><span class="line">    mulby(<span class="number">2</span>)</span><br><span class="line">    scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">mulby</span></span>(factor : <span class="type">Double</span>) = (x:<span class="type">Double</span>) =&gt; x * factor</span><br><span class="line">    mulby: (factor: <span class="type">Double</span>)<span class="type">Double</span> =&gt; <span class="type">Double</span></span><br><span class="line"></span><br><span class="line">    scala&gt; mulby(<span class="number">2</span>)</span><br><span class="line">    res9: <span class="type">Double</span> =&gt; <span class="type">Double</span> = $$<span class="type">Lambda</span>$<span class="number">1165</span>/<span class="number">745462106</span>@<span class="number">3</span>d3e9163</span><br><span class="line"></span><br><span class="line">    scala&gt; mulby(<span class="number">2</span>)(<span class="number">2</span>)</span><br><span class="line">    res10: <span class="type">Double</span> = <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; æ¥ä¸‹æ¥æŠŠæ¬¡mulby æ–¹æ³•, è½¬æˆå‡½æ•°è¯•è¯•</span><br><span class="line">    scala&gt; <span class="keyword">val</span> f_mulby = mulby _</span><br><span class="line">    f_mulby: <span class="type">Double</span> =&gt; (<span class="type">Double</span> =&gt; <span class="type">Double</span>) = $$<span class="type">Lambda</span>$<span class="number">1364</span>/<span class="number">1154393787</span>@<span class="number">6307382</span></span><br><span class="line">&gt;&gt;&gt; è°ƒç”¨æ–¹å¼è¿˜æ˜¯ä¸€æ ·çš„</span><br><span class="line">f_mulby(<span class="number">2</span>)(<span class="number">2</span>)</span><br><span class="line">-------------------------</span><br><span class="line">    scala&gt;<span class="function"><span class="keyword">def</span> <span class="title">multi</span></span>(n:<span class="type">Int</span>) = n * <span class="number">2</span></span><br><span class="line">    scala&gt;<span class="function"><span class="keyword">def</span> <span class="title">f</span> </span>= multi _                <span class="comment">// _ è¡¨ç¤º:æŠŠmulti è½¬ä¸ºå‡½æ•°</span></span><br><span class="line">    scala&gt;<span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>).map(f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒ¿åå‡½æ•°</span></span><br><span class="line">    scala&gt;(n:<span class="type">Double</span>)=&gt;<span class="number">3</span> * n                <span class="comment">// åŒ¿åå‡½æ•°</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> f = (n:<span class="type">Double</span>)=&gt;<span class="number">3</span> * n     <span class="comment">// å˜é‡å¼•ç”¨åŒ¿åå‡½æ•°</span></span><br><span class="line">    scala&gt;<span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>).map( (x) =&gt; x * <span class="number">3</span> );    <span class="comment">//æŠŠåŒ¿åå‡½æ•°ä¼ é€’ç»™ map æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰é«˜é˜¶å‡½æ•° ä¾‹å­3</span></span><br><span class="line">==============================================================================</span><br><span class="line"><span class="comment">// å®šä¹‰ call æ–¹æ³•, å…¶ä¸­2ä¸ªå‚æ•°ä¹Ÿä¸ºå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span></span>(a:<span class="type">Int</span>, b:<span class="type">Int</span>, f1:(<span class="type">Int</span>,<span class="type">Int</span>)=&gt; <span class="type">Int</span>, f2:(<span class="type">Int</span>,<span class="type">Int</span>)=&gt; <span class="type">Int</span>) = &#123;</span><br><span class="line">    <span class="keyword">if</span>(a &gt; <span class="number">0</span>)  f1(a,b);</span><br><span class="line">    <span class="keyword">else</span>       f2(a,b);</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt;&gt;&gt; call: (a: <span class="type">Int</span>, b: <span class="type">Int</span>, f1: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>, f2: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -------&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  å®šä¹‰æ–¹æ³•, å†æŠŠæ–¹æ³•è½¬ä¸ºå‡½æ•°</span></span><br><span class="line"><span class="comment">// å®šä¹‰2ä¸ªå‚æ•°çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>) = a+b</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>) = a-b</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•è½¬ä¸º f1, f2  (å½“ç„¶, ä¹Ÿå¯ä»¥ç›´æ¥å®šä¹‰å‡½æ•°)</span></span><br><span class="line"><span class="keyword">val</span> f1 = add _</span><br><span class="line"><span class="keyword">val</span> f2 = sub _</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  ç›´æ¥å®šä¹‰å‡½æ•°</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> f1 = (a : <span class="type">Int</span>, b : <span class="type">Int</span>) =&gt; &#123; a + b &#125;</span><br><span class="line">f1: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = $$<span class="type">Lambda</span>$<span class="number">1388</span>/<span class="number">1164150759</span>@<span class="number">4</span>d41b630</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> f2 = (a : <span class="type">Int</span>, b : <span class="type">Int</span>) =&gt; &#123; a - b &#125;</span><br><span class="line">f2: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = $$<span class="type">Lambda</span>$<span class="number">1389</span>/<span class="number">1260221930</span>@<span class="number">37</span>dc38cc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨, å¯ä»¥ç”¨f1,f2,  ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ–¹æ³•åè°ƒç”¨, ä¼šé»˜è®¤è½¬ä¸ºå‡½æ•° :TODO äº†è§£åŸç†</span></span><br><span class="line">call(<span class="number">-1</span>,<span class="number">2</span>,f1,f2)</span><br><span class="line">call(<span class="number">1</span>,<span class="number">2</span>,add _, sub _)</span><br><span class="line">call(<span class="number">1</span>,<span class="number">2</span>,add,sub)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// call å‡½æ•°æå‡</span></span><br><span class="line">============================================================</span><br><span class="line">éœ€æ±‚: ä»¥ call å‡½æ•°çš„è¿”å›å€¼<span class="number">3</span>ä¸ºç³»æ•°, ç„¶åä¼ å¦ä¸€ä¸ªæ•° x åˆ°  å‡½æ•°y = <span class="number">3</span> * x ä¸­, å¾—åˆ° y</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">    <span class="keyword">val</span> f = call(<span class="number">1</span>,<span class="number">2</span>,f1,f2)</span><br><span class="line">    f(<span class="number">100</span>) = <span class="number">300</span> ;</span><br><span class="line">    call(<span class="number">1</span>,<span class="number">2</span>,add _,sub _)(<span class="number">100</span>) = <span class="number">300</span></span><br><span class="line"></span><br><span class="line">--&gt;&gt; å®šä¹‰</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>,f1:(<span class="type">Int</span>,<span class="type">Int</span>)=&gt;<span class="type">Int</span>,f2:(<span class="type">Int</span>,<span class="type">Int</span>)=&gt;<span class="type">Int</span>)= &#123;</span><br><span class="line">        <span class="keyword">var</span> n = <span class="number">0</span> ;</span><br><span class="line">        <span class="keyword">if</span>(a &gt; <span class="number">0</span>) n = f1(a,b) ;</span><br><span class="line">        <span class="keyword">else</span>      n = f2(a,b) ;</span><br><span class="line">        <span class="comment">// å®šä¹‰æ–¹æ³•</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">multi</span></span>(x:<span class="type">Int</span>) = x * n ;</span><br><span class="line">        <span class="comment">// è½¬ä¸ºå‡½æ•°</span></span><br><span class="line">        multi _</span><br><span class="line">    &#125;</span><br><span class="line">âœ </span><br><span class="line">call: (a: <span class="type">Int</span>, b: <span class="type">Int</span>, f1: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>, f2: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>)<span class="type">Int</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">âœ è°ƒç”¨</span><br><span class="line">    scala&gt; call(<span class="number">1</span>,<span class="number">2</span>,add _, sub _)(<span class="number">100</span>)</span><br><span class="line">    res4: <span class="type">Int</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line">âœ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨å‡½æ•°, ä¼ çš„æ˜¯å‡½æ•°çš„å®å‚, å‡½æ•°çš„å®ç°:</span><br><span class="line"><span class="comment">// f1 çš„å®ç°æ˜¯ a+b, f2 çš„å®ç°æ˜¯ a-b, è€Œè°ƒç”¨f1æˆ–f2 åœ¨ call æ–¹æ³•å®šä¹‰çš„æ—¶å€™</span></span><br><span class="line"><span class="comment">// å°±å·²ç»æŒ‡å®šäº†, è€Œå‚æ•°ä¹Ÿç”±å‰é¢çš„ a, b ä¼ è¿›æ¥, æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨äº†.</span></span><br><span class="line"><span class="comment">// æ­¤callæ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°, æ­¤å‡½æ•°éœ€è¦2ä¸ªå‚æ•°, ä¸€ä¸ªæ˜¯å‰é¢çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line"><span class="comment">// ä¸€ä¸ªæ˜¯éœ€è¦è°ƒç”¨è€…ä¼ è¿›æ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿå¯ä»¥æŠŠ callæ–¹æ³• çš„è¿”å›å€¼èµ‹å€¼ç»™ä¸€ä¸ª å‡½æ•°å˜é‡, å†ç»™è¿™ä¸ªå‡½æ•°å˜é‡ä¼ å€¼</span></span><br><span class="line"><span class="keyword">val</span> f = call(<span class="number">1</span>,<span class="number">2</span>,(a:<span class="type">Int</span>,b:<span class="type">Int</span>) =&gt; a+b,(a:<span class="type">Int</span>,b:<span class="type">Int</span>) =&gt; a-b)</span><br><span class="line">scala&gt; f(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">ä¹Ÿå¯ä»¥ç›´æ¥åœ¨åé¢æ¥ä¸Š <span class="number">100</span>, ç›´æ¥ä¼ å‚</span><br><span class="line">call(<span class="number">1</span>,<span class="number">2</span>,(a:<span class="type">Int</span>,b:<span class="type">Int</span>) =&gt; a+b,(a:<span class="type">Int</span>,b:<span class="type">Int</span>) =&gt; a-b)(<span class="number">100</span>)</span><br><span class="line">res7: <span class="type">Int</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹å‚æ•°å¯ä»¥å»æ‰, å› ä¸ºä½¿ç”¨çš„å‚æ•°å¯ä»¥è‡ªåŠ¨æ¨å¯¼å‡ºå‚æ•°çš„ç±»å‹</span></span><br><span class="line">    call(<span class="number">1</span>,<span class="number">2</span>,(a:<span class="type">Int</span>,b:<span class="type">Int</span>)=&gt;a + b , (a:<span class="type">Int</span>,b:<span class="type">Int</span>)=&gt; a- b)(<span class="number">100</span>)</span><br><span class="line"><span class="comment">// ç²¾ç®€è¿‡å</span></span><br><span class="line">    call(<span class="number">1</span>,<span class="number">2</span>,(a,b)=&gt;a + b , (a,b)=&gt; a- b)(<span class="number">100</span>)            </span><br><span class="line"></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ âœâœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨æ–­</span></span><br><span class="line"><span class="comment">// å¾ˆæ˜¾ç„¶, æ­¤æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°, å‡½æ•°åªæœ‰ä¸€ä¸ªå‚æ•°, å‚æ•°\è¿”å›å€¼éƒ½æ˜¯ Double ç±»å‹</span></span><br><span class="line"><span class="comment">// æ³¨æ„: é‡Œé¢çš„å‡½æ•°æ˜¯ å½¢å‚, ä¹Ÿå°±æ˜¯è¯´ åªæ˜¯é¡¶ä¸€ä¸ªä¸€ä¸ª f å‡½æ•°, å‚æ•°&amp;è¿”å›å€¼ç±»å‹ä¸º Double, å¹¶æ²¡æœ‰å®šä¹‰å®ç°, åœ¨ä¼ å‡½æ•°çš„æ—¶å€™, è¦ç»™å‡ºå®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">valueAt</span></span>(f:(<span class="type">Double</span>)=&gt;<span class="type">Double</span>) = f(<span class="number">0.25</span>)</span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">    valueAt((x:<span class="type">Double</span>)=&gt;x * <span class="number">3</span>)                <span class="comment">//å®šä¹‰ç±»å‹</span></span><br><span class="line">    valueAt((x)=&gt;x * <span class="number">3</span>)                       <span class="comment">//æ¨æ–­ç±»å‹</span></span><br><span class="line">    valueAt(x=&gt;x * <span class="number">3</span>)                         <span class="comment">//çœç•¥()</span></span><br><span class="line">    valueAt(<span class="number">3</span> * _)                            <span class="comment">//å‚æ•°åœ¨å³ä¾§å‡ºç°1æ¬¡ï¼Œå°±å¯ä»¥ä½¿ç”¨_ä»£æ›¿ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//é«˜çº§å‡½æ•°</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">    scala&gt; <span class="keyword">val</span> arr = <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    scala&gt; arr.map(<span class="number">2</span> * _);                    <span class="comment">//æ¯ä¸ªå…ƒç´ x2</span></span><br><span class="line">    scala&gt; arr.map((e:<span class="type">Int</span>)=&gt; e * <span class="number">2</span>);           <span class="comment">//æ¯ä¸ªå…ƒç´ x2</span></span><br><span class="line">    scala&gt; arr.map(_ * <span class="number">2</span>);                    <span class="comment">//æ¯ä¸ªå…ƒç´ x2</span></span><br><span class="line">scala&gt; arr.filter(_ % <span class="number">2</span> == <span class="number">0</span>)<span class="comment">// è¿‡æ»¤å‡ºé›†åˆä¸­çš„å¶æ•°</span></span><br><span class="line">res55: scala.collection.immutable.<span class="type">IndexedSeq</span>[<span class="type">Int</span>] = <span class="type">Vector</span>(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶å®ƒçš„ç®€å•åº”ç”¨</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"><span class="comment">// åœ¨å…ƒç´  * 3å‰å…ˆæ‰“å°</span></span><br><span class="line">    scala&gt; <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>).map(e =&gt; &#123;println(e); e * <span class="number">3</span>&#125;)</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">    <span class="number">2</span></span><br><span class="line">    <span class="number">3</span></span><br><span class="line">res56: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// filter è¿‡æ»¤</span></span><br><span class="line">    scala&gt; <span class="type">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>).filter(e =&gt; e%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    res14: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1-10 å…ˆæ‰©å¤§3å€, å†è¿‡æ»¤å‡ºå¶æ•°</span></span><br><span class="line">    scala&gt; <span class="type">Array</span>(<span class="number">1</span> to <span class="number">10</span>:_*).map(<span class="number">3</span> * _).filter(_ % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    res16: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">6</span>, <span class="number">12</span>, <span class="number">18</span>, <span class="number">24</span>, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºä¸‰è§’å½¢ foreach å‡½æ•°</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">    scala&gt;(<span class="number">1</span> to <span class="number">9</span>).map(<span class="string">"*"</span> * _).foreach(println)</span><br><span class="line">    scala&gt;(<span class="number">1</span> to <span class="number">9</span>).map(<span class="string">"*"</span> * _).foreach(println _)</span><br><span class="line">    scala&gt;(<span class="number">1</span> to <span class="number">9</span>).map(<span class="string">"*"</span> * _).foreach(println (_))</span><br><span class="line">    scala&gt; <span class="type">Array</span>(<span class="number">1</span> to <span class="number">9</span>:_*).map(<span class="string">"*"</span> * _).foreach(println _)</span><br><span class="line"></span><br><span class="line"><span class="comment">// reduceLeft / reduceRight å‡½æ•°</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"><span class="comment">//reduceLeft,ç”±å·¦è‡³å³, æ¯æ¬¡è¿›2ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">val</span> r = (<span class="number">1</span> to <span class="number">10</span>)</span><br><span class="line">    scala&gt; r.reduceLeft(_ + _)</span><br><span class="line">    scala&gt; r.reduceLeft(_ - _)</span><br><span class="line">...</span><br><span class="line">â†’ æ‰§è¡Œæµç¨‹</span><br><span class="line"><span class="comment">//1,2,3 ==&gt; (1 - 2) -3)    = -4</span></span><br><span class="line"></span><br><span class="line"><span class="type">MR</span>:<span class="type">MapTask</span> + reduceTask,æ˜ å°„åŒ–ç®€.</span><br><span class="line"></span><br><span class="line"><span class="comment">//reduceRight,ç”±å³è‡³å·¦</span></span><br><span class="line">scala&gt; r.reduceRight(_-_)</span><br><span class="line">...</span><br><span class="line">â†’ æ‰§è¡Œæµç¨‹</span><br><span class="line">    <span class="comment">//1,2,3 ==&gt;1 - (2 - 3)= 2</span></span><br><span class="line">    <span class="comment">//1,2,3,4 ==&gt; 1 - (2 - (3 - 4)) = -2</span></span><br><span class="line">    <span class="comment">//1,2,3,4 ==&gt; 1 - (2 - (3 - 4)) = -2</span></span><br></pre></td></tr></table></figure><hr><h1 id="åä¸€-æŸ¯é‡ŒåŒ–"><a href="#åä¸€-æŸ¯é‡ŒåŒ–" class="headerlink" title="åä¸€. æŸ¯é‡ŒåŒ–"></a>åä¸€. æŸ¯é‡ŒåŒ–</h1><p><strong>æ¦‚å¿µ:</strong>  ä»¥é€»è¾‘å­¦å®¶ Haskell Brooks Curry çš„åå­—å‘½å </p><p><strong>å°†åŸæ¥æ¥å—2ä¸ªå‚æ•°çš„å‡½æ•°, å˜æˆæ–°çš„æ¥å—ä¸€ä¸ªå‚æ•°çš„å‡½æ•°çš„è¿‡ç¨‹.</strong> </p><p><strong>æ–°çš„å‡½æ•°è¿”å›ä¸€ä¸ªä»¥åŸæœ‰ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°</strong> </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â†’ åŸå‡½æ•°</span><br><span class="line">scala&gt;<span class="function"><span class="keyword">def</span> <span class="title">mul</span></span>(a:<span class="type">Int</span>,b:<span class="type">Int</span>) = a  * b;</span><br><span class="line">scala&gt;mul(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">â†’ æŸ¯é‡ŒåŒ–</span><br><span class="line">scala&gt;<span class="function"><span class="keyword">def</span> <span class="title">mulone</span></span>(a:<span class="type">Int</span>) = &#123;(x:<span class="type">Int</span>) =&gt; a * x ;&#125;</span><br><span class="line">scala&gt;mulone(<span class="number">1</span>)(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">â†’â†’â†’â†’â†’â†’â†’ æŸ¯é‡ŒåŒ–æµ‹è¯•</span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">mulone</span></span>(a:<span class="type">Int</span>) = &#123;(x:<span class="type">Int</span>) =&gt; a * x&#125;</span><br><span class="line">mulone: (a: <span class="type">Int</span>)<span class="type">Int</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¦–å…ˆä¼ å…¥ä¸€ä¸ªå‚æ•°, å¾—åˆ°çš„æ˜¯å¦ä¸€å‡½æ•° x:Int =&gt; x * 2 (ä¹Ÿå°±æ˜¯åŸæ–¹æ³•çš„æ–¹æ³•ä½“)</span></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">f</span> </span>= mulone(<span class="number">2</span>)</span><br><span class="line">f: <span class="type">Int</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤æ—¶æ¥ç€å†ä¼ å…¥å‚æ•° 4, å¾—åˆ° 4*2 =&gt; 8 </span></span><br><span class="line">scala&gt; f(<span class="number">4</span>)</span><br><span class="line">res33: <span class="type">Int</span> = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥ä¼ å…¥2ä¸ªå‚æ•°å¯ç›´æ¥è°ƒç”¨æ­¤æ–¹æ³•, è¿”å›ç»“æœ</span></span><br><span class="line">scala&gt; mulone(<span class="number">2</span>)(<span class="number">4</span>)</span><br><span class="line">res34: <span class="type">Int</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure><p><strong>ä¸æŸ¯é‡ŒåŒ–ç›¸å…³çš„çŸ¥è¯†ç‚¹(æ–¹æ³•å‘å‡½æ•°çš„è½¬æ¢)</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) å¤šä¸ªå‚æ•°çš„æ–¹æ³•å¯ä»¥è½¬æ¢ä¸ºå¤šå…ƒå‡½æ•°</span><br><span class="line">-------------------</span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">plus</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = x + y</span><br><span class="line">plus: (x: <span class="type">Int</span>, y: <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line">scala&gt; plus _</span><br><span class="line">res63: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = $$<span class="type">Lambda</span>$<span class="number">1495</span>/<span class="number">772136419</span>@<span class="number">16</span>b54416</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) å¤šä¸ªå‚æ•°çš„æ–¹æ³•å˜æˆæŸ¯é‡Œå‡½æ•° ---&gt;  æ–¹æ³•å®šä¹‰çš„æ—¶å€™, ä¸åŒçš„å‚æ•°ç”¨ '()' åˆ†å¼€</span><br><span class="line">---------------------</span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">plus</span></span>(x: <span class="type">Int</span>)(y: <span class="type">Int</span>): <span class="type">Int</span> = x + y</span><br><span class="line">plus: (x: <span class="type">Int</span>)(y: <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line">scala&gt; plus _</span><br><span class="line">res64: <span class="type">Int</span> =&gt; (<span class="type">Int</span> =&gt; <span class="type">Int</span>) = $$<span class="type">Lambda</span>$<span class="number">1496</span>/<span class="number">662093445</span>@<span class="number">51927988</span></span><br></pre></td></tr></table></figure><hr><h1 id="åäºŒ-æ§åˆ¶æŠ½è±¡"><a href="#åäºŒ-æ§åˆ¶æŠ½è±¡" class="headerlink" title="åäºŒ. æ§åˆ¶æŠ½è±¡"></a>åäºŒ. æ§åˆ¶æŠ½è±¡</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ä¼¼äº OC ä¸­çš„ block, æ­¤ block æ— å‚æ•°æ— è¿”å›å€¼ :TODO æ˜¯æ§åˆ¶</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"><span class="number">1</span>) å®šä¹‰è¿‡ç¨‹ï¼Œå¯åŠ¨åˆ†çº¿ç¨‹æ‰§è¡Œblockä»£ç . æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ª block æ— å‚æ— è¿”å‡½æ•°</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">newThread</span></span>(block: () =&gt; <span class="type">Unit</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span>() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">          block();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">-----------------</span><br><span class="line"><span class="number">2</span>) è°ƒç”¨ newThreadæ–¹æ³•, å¹¶ç»™ block ä¼ å€¼ <span class="symbol">'newThread</span>(()=&gt;&#123;...&#125;)'</span><br><span class="line">    newThread(() =&gt; &#123;</span><br><span class="line">      (<span class="number">1</span> to <span class="number">10</span>).foreach(e =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> tname = <span class="type">Thread</span>.currentThread.getName();</span><br><span class="line">        println(tname + <span class="string">" : "</span> + e);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    );</span><br><span class="line">-------æ‰“å°ç»“æœ----------</span><br><span class="line">scala&gt; <span class="type">Thread</span><span class="number">-3</span> : <span class="number">1</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">2</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">3</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">4</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">5</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">6</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">7</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">8</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">9</span></span><br><span class="line"><span class="type">Thread</span><span class="number">-3</span> : <span class="number">10</span></span><br><span class="line"></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line"><span class="type">PS</span>: åœ¨ å®šä¹‰æ–¹æ³•çš„æ—¶å€™, å¯çœç•¥<span class="symbol">'newThread</span>(()=&gt;&#123;...&#125;)'å‰é¢çš„æ‹¬å·, å› ä¸ºæ²¡æœ‰å‚æ•°</span><br><span class="line">   åœ¨è°ƒç”¨æ–¹æ³•, å†™ block ä¸­çš„å†…å®¹æ—¶ <span class="symbol">'newThread</span>(() =&gt; &#123;&#125;)', å¯ä»¥ç›´æ¥å†™å¤§æ‹¬å·&#123;&#125;ä¸­çš„ä»£ç é€»è¾‘, å…¶å®è¿™ç©æ„å„¿å°±æ˜¯ è¯­æ³•ç³–</span><br></pre></td></tr></table></figure><hr><h1 id="åä¸‰-é›†åˆ"><a href="#åä¸‰-é›†åˆ" class="headerlink" title="åä¸‰. é›†åˆ"></a>åä¸‰. é›†åˆ</h1><h4 id="List-é›†åˆ"><a href="#List-é›†åˆ" class="headerlink" title="List é›†åˆ"></a>List é›†åˆ</h4><p><strong>List åœ¨æ·»åŠ å…ƒç´ æ—¶æ³¨æ„ç‚¹,è¯¦ç»†ä»£ç è§ä¸‹é¢:</strong> </p><ul><li>ä½¿ç”¨ <code>+:</code>  æˆ–<code>:=</code>æ·»åŠ å•ä¸ªå…ƒç´ æ—¶,  <code>:</code>å¿…é¡»é ç€ list ä¸€ä¾§, <code>+</code> å¿…é¡»é ç€ å•ä¸ªå…ƒç´  </li><li>å¦‚æœ2è¾¹éƒ½æ˜¯ list é›†åˆ, å¿…é¡»ç”¨  <code>++:</code>æˆ–è€… <code>:::</code>  æˆ–è€… <code>++</code></li><li>ä¸ç®¡æ˜¯ <code>+: , :+ ,  ++:</code>,  éƒ½ä¸ä¼šæ”¹å˜åŸ list çš„å€¼ </li><li>è¦æ·»åŠ çš„ <code>å…ƒç´  / list</code> åœ¨åŸ list çš„å“ªè¾¹, å°±æ·»åŠ åˆ° list çš„ é‚£è¾¹</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Nil (Listç©ºé›†åˆ)</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line">scala&gt; <span class="number">1</span>::<span class="number">2</span>::<span class="type">Nil</span></span><br><span class="line">res71: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">var</span> l1 = <span class="number">1</span>::<span class="number">2</span>::<span class="type">Nil</span></span><br><span class="line">l1: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; l1</span><br><span class="line">res72: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="number">9</span>::l1</span><br><span class="line">res73: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">9</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// List æ±‚å’Œ</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line">æ–¹å¼<span class="number">1</span>-é€’å½’</span><br><span class="line">-----------</span><br><span class="line">å®šä¹‰&gt;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(list:<span class="type">List</span>[<span class="type">Int</span>]) : <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span>(list == <span class="type">Nil</span>) <span class="number">0</span> <span class="keyword">else</span> list.head + sum(list.tail)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">sum: (list: <span class="type">List</span>[<span class="type">Int</span>])<span class="type">Int</span></span><br><span class="line"></span><br><span class="line">è°ƒç”¨&gt;</span><br><span class="line">    scala&gt; <span class="keyword">val</span> list = <span class="number">1</span>::<span class="number">2</span>::<span class="number">3</span>::<span class="number">4</span>::<span class="type">Nil</span></span><br><span class="line">    list: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; sum(list)</span><br><span class="line">res41: <span class="type">Int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">æ–¹å¼<span class="number">2</span>-æ¨¡å¼åŒ¹é…</span><br><span class="line">-----------</span><br><span class="line">å…¶å®æœ¬è´¨ä¸Šä¹Ÿæ˜¯é€’å½’</span><br><span class="line">å®šä¹‰&gt;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(list:<span class="type">List</span>[<span class="type">Int</span>]) : <span class="type">Int</span> = list <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Nil</span> =&gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">case</span> a::b =&gt; a + sum(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ³¨æ„: ::å°†åˆ—è¡¨ ææ„ æˆå¤´éƒ¨å’Œå°¾éƒ¨</span><br><span class="line">é€’å½’ä¹‹æ‰€ä»¥é‚£ä¹ˆè‡ªç„¶, å› ä¸ºåˆ—è¡¨çš„å°¾éƒ¨æ­£å¥½åˆæ˜¯ä¸€ä¸ªåˆ—è¡¨</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">scala ç±»åº“çš„ sum</span><br><span class="line"><span class="type">List</span>(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>).sum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// List æ·»åŠ å…ƒç´ </span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ </span><br><span class="line">æ³¨æ„ç‚¹: <span class="number">1</span>) ä½¿ç”¨ +:  æˆ– := æ·»åŠ å•ä¸ªå…ƒç´ æ—¶,  : å¿…é¡»é ç€ list ä¸€ä¾§, + å¿…é¡»é ç€ å•ä¸ªå…ƒç´ </span><br><span class="line">        <span class="number">2</span>) å¦‚æœ<span class="number">2</span>è¾¹éƒ½æ˜¯ list, å¿…é¡»ç”¨  ++: </span><br><span class="line">        <span class="number">3</span>) ä¸ç®¡æ˜¯ +:  :+   ++:,  éƒ½ä¸ä¼šæ”¹å˜åŸ list çš„å€¼</span><br><span class="line">    <span class="number">4</span>) è¦æ·»åŠ çš„ å…ƒç´  / list åœ¨å“ªè¾¹, å°±æ·»åŠ åˆ°æ•°ç»„çš„å“ªè¾¹</span><br><span class="line">    scala&gt; <span class="keyword">var</span> list2 = <span class="number">1</span>::<span class="number">2</span>::<span class="number">3</span>::<span class="number">5</span>::<span class="number">4</span>::<span class="type">Nil</span></span><br><span class="line">    list2: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; list2</span><br><span class="line">    res46: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; list2 :+ <span class="number">3</span></span><br><span class="line">    res81: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="number">3</span> +: list2</span><br><span class="line">    res82: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; list2</span><br><span class="line">    res88: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; list2 ++: <span class="type">List</span>(<span class="number">99</span>)</span><br><span class="line">    res86: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="type">List</span>(<span class="number">78</span>) ++: list2</span><br><span class="line">    res87: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">78</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ++ æ·»åŠ  å®ç°2é›†åˆåˆå¹¶</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> l1 = <span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">    scala&gt;<span class="keyword">val</span> l2 = <span class="type">List</span>(<span class="number">3</span>,<span class="number">4</span>)  </span><br><span class="line">    scala&gt;l1 ++ l2               ++  ä¸          :: æ•ˆæœç›¸åŒ     <span class="comment">// æ˜¯åœ¨l1çš„åé¢åŠ ä¸Šl2</span></span><br><span class="line">    scala&gt;l1 ++: l2              ++: ä¸ :::  æ•ˆæœç›¸åŒ          <span class="comment">// æ˜¯åœ¨ l2çš„å‰é¢åŠ ä¸Šl1</span></span><br></pre></td></tr></table></figure><h4 id="Set-é›†åˆ"><a href="#Set-é›†åˆ" class="headerlink" title="Set é›†åˆ"></a>Set é›†åˆ</h4><p><strong>æ³¨æ„:</strong> </p><ul><li><strong>ä¸å¯å˜ Set</strong> æ·»åŠ çš„æ˜¯ <strong>å…ƒç¥–</strong>, ä½¿ç”¨<code>+=</code>  äº§ç”Ÿæ–°é›†åˆ, <strong>è‡ªèº«æ— æ³•æ”¹å˜</strong>, å¯ä»¥èµ‹å€¼ç»™æ–°çš„å¸¸é‡ val</li><li><strong>å¯å˜ Set ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>+=</code> æ·»åŠ  å…ƒç¥–</strong>, <strong>æ”¹å˜è‡ªèº«</strong>,  è¿˜å¯ä»¥<strong>ä½¿ç”¨ <code>++=</code> æ·»åŠ å…¶ä»–é›†åˆ, æ¯”å¦‚ List, Array, Range(1 to 10) ç­‰â€¦</strong></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set å¯å˜é›†åˆçš„æ“ä½œ(é»˜è®¤)</span></span><br><span class="line">------------------------------------------------------------</span><br><span class="line"><span class="comment">// Set æ·»åŠ æˆå‘˜(å…ƒç¥–, ä¼šè‡ªåŠ¨å»é‡, æ— åº)</span></span><br><span class="line">    scala&gt;<span class="keyword">val</span> set = <span class="type">Set</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    scala&gt;set + (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">    scala&gt;set - (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    scala&gt;<span class="keyword">val</span> s1 = <span class="type">Set</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    scala&gt;<span class="keyword">val</span> s2 = <span class="type">Set</span>(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    scala&gt;s1 | s2                   <span class="comment">//å¹¶é›†</span></span><br><span class="line">    scala&gt;s1 &amp; s2                  <span class="comment">//äº¤é›†</span></span><br><span class="line">    scala&gt;s1 &amp;~ s2                <span class="comment">//å·®é›†(1,2,3) - (2,3,4) = (1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set ä¸å¯å˜é›†åˆçš„æ“ä½œ</span></span><br><span class="line">------------------------------------------------------------</span><br><span class="line"># å¯¼åŒ…</span><br><span class="line">scala&gt;<span class="keyword">import</span> scala.collection.mutable.&#123;<span class="type">Set</span> =&gt; <span class="type">MSet</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ += æ·»åŠ å…ƒç¥–</span></span><br><span class="line">scala&gt; mset += <span class="number">3</span></span><br><span class="line">res129: mset.<span class="keyword">type</span> = <span class="type">Set</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="number">45</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">98</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">43</span>, ğŸ˜</span><br><span class="line"></span><br><span class="line">scala&gt; mset += (<span class="number">24</span>,<span class="number">25</span>,<span class="number">26</span>)</span><br><span class="line">res132: mset.<span class="keyword">type</span> = <span class="type">Set</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="number">45</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">24</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">25</span>, <span class="number">4</span>, <span class="number">98</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">7</span>, <span class="number">43</span>, ğŸ˜</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ ++= æ·»åŠ  Array, List, Range...</span></span><br><span class="line">scala&gt; mset ++= <span class="type">Array</span>(<span class="number">3</span>,<span class="number">45</span>)</span><br><span class="line">res125: mset.<span class="keyword">type</span> = <span class="type">Set</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="number">45</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">4</span>, ğŸ˜</span><br><span class="line"></span><br><span class="line">scala&gt; mset ++= <span class="type">List</span>(<span class="number">43</span>,<span class="number">98</span>)</span><br><span class="line">res128: mset.<span class="keyword">type</span> = <span class="type">Set</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="number">45</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">98</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">43</span>, ğŸ˜</span><br><span class="line"></span><br><span class="line">scala&gt; mset ++= (<span class="number">0</span> to <span class="number">10</span>)</span><br><span class="line">res123: mset.<span class="keyword">type</span> = <span class="type">Set</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">4</span>, ğŸ˜</span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–çš„ä¸€äº›æ“ä½œ"><a href="#å…¶ä»–çš„ä¸€äº›æ“ä½œ" class="headerlink" title="å…¶ä»–çš„ä¸€äº›æ“ä½œ"></a>å…¶ä»–çš„ä¸€äº›æ“ä½œ</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»è¦æ˜¯ ArrayBufferçš„</span></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">scala&gt; <span class="keyword">import</span> scala.collection.mutable._</span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> buf = <span class="type">ArrayBuffer</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">buf: scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>] = <span class="type">ArrayBuffer</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="number">2</span> +=: buf</span><br><span class="line">res138: buf.<span class="keyword">type</span> = <span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–å‰2ä¸ªå…ƒç´ , buf æœ¬èº«ä¸å˜</span></span><br><span class="line">scala&gt; buf.take(<span class="number">2</span>)</span><br><span class="line">res139: scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>] = <span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤å‰2ä¸ªå…ƒç´ , buf æœ¬èº«ä¸å˜</span></span><br><span class="line">scala&gt; buf.drop(<span class="number">2</span>)</span><br><span class="line">res141: scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>] = <span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; buf</span><br><span class="line">res142: scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>] = <span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æŒ‡å®šä½ç½®è¿›è¡Œåˆ‡å‰²ï¼Œå½¢æˆä¸¤ä¸ªæ–°é›†åˆã€‚</span></span><br><span class="line">scala&gt; buf.splitAt(<span class="number">2</span>)</span><br><span class="line">res143: (scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>], scala.collection.mutable.<span class="type">ArrayBuffer</span>[<span class="type">Int</span>]) = (<span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">1</span>),<span class="type">ArrayBuffer</span>(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> b1 = <span class="type">ArrayBuffer</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">scala&gt; <span class="keyword">val</span> b2 = <span class="type">ArrayBuffer</span>(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// èˆå¼ƒæ‰å°‘çš„</span></span><br><span class="line">scala&gt; b1.zip(b2)</span><br><span class="line">res145: scala.collection.mutable.<span class="type">ArrayBuffer</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = <span class="type">ArrayBuffer</span>((<span class="number">1</span>,<span class="number">3</span>), (<span class="number">2</span>,<span class="number">4</span>), (<span class="number">3</span>,<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//  b1ä¸å¤Ÿ, ç”¨-1è¡¥, b2ä¸å¤Ÿ, ç”¨-2è¡¥</span></span><br><span class="line">scala&gt; b1.zipAll(b2,<span class="number">-1</span>,<span class="number">-2</span>)</span><br><span class="line">res146: scala.collection.mutable.<span class="type">ArrayBuffer</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = <span class="type">ArrayBuffer</span>((<span class="number">1</span>,<span class="number">3</span>), (<span class="number">2</span>,<span class="number">4</span>), (<span class="number">3</span>,<span class="number">5</span>), (<span class="number">-1</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…ƒç´ å’Œè‡ªå·±çš„ç´¢å¼•å½¢æˆtuple.,å…ƒç´ åœ¨å‰, ç´¢å¼•åœ¨å</span></span><br><span class="line">scala&gt; b1.zipWithIndex</span><br><span class="line">res147: scala.collection.mutable.<span class="type">ArrayBuffer</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = <span class="type">ArrayBuffer</span>((<span class="number">1</span>,<span class="number">0</span>), (<span class="number">2</span>,<span class="number">1</span>), (<span class="number">3</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">scala&gt; b1.zip(b2).zipWithIndex</span><br><span class="line">res148: scala.collection.mutable.<span class="type">ArrayBuffer</span>[((<span class="type">Int</span>, <span class="type">Int</span>), <span class="type">Int</span>)] = <span class="type">ArrayBuffer</span>(((<span class="number">1</span>,<span class="number">3</span>),<span class="number">0</span>), ((<span class="number">2</span>,<span class="number">4</span>),<span class="number">1</span>), ((<span class="number">3</span>,<span class="number">5</span>),<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¦å³æŠ˜å </span></span><br><span class="line">------------------------------------------------------------</span><br><span class="line"><span class="comment">//å·¦æŠ˜å </span></span><br><span class="line">scala&gt; <span class="type">List</span>(<span class="number">1</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">9</span>).foldLeft(<span class="number">0</span>)(_-_)</span><br><span class="line">res87: <span class="type">Int</span> = <span class="number">-19</span></span><br><span class="line">    (<span class="number">0</span> - <span class="number">1</span>) - <span class="number">7</span> - <span class="number">2</span> - <span class="number">9</span>            <span class="comment">//-19</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//å³æŠ˜å </span></span><br><span class="line">scala&gt; <span class="type">List</span>(<span class="number">1</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">9</span>).foldRight(<span class="number">0</span>)(_-_)</span><br><span class="line">res88: <span class="type">Int</span> = <span class="number">-13</span></span><br><span class="line">    <span class="number">1</span>  - (<span class="number">7</span> - (<span class="number">2</span> - (<span class="number">9</span> - <span class="number">0</span>))_    <span class="comment">//-13</span></span><br></pre></td></tr></table></figure><hr><h1 id="åå››-æ¨¡å¼åŒ¹é…-amp-åå‡½æ•°"><a href="#åå››-æ¨¡å¼åŒ¹é…-amp-åå‡½æ•°" class="headerlink" title="åå››. æ¨¡å¼åŒ¹é… &amp; åå‡½æ•°"></a>åå››. æ¨¡å¼åŒ¹é… &amp; åå‡½æ•°</h1><h4 id="1-å­—ç¬¦ä¸²åŒ¹é…"><a href="#1-å­—ç¬¦ä¸²åŒ¹é…" class="headerlink" title="1. å­—ç¬¦ä¸²åŒ¹é…"></a>1. å­—ç¬¦ä¸²åŒ¹é…</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> x = '<span class="number">9</span>'</span><br><span class="line">x: <span class="type">Char</span> = <span class="number">9</span></span><br><span class="line"></span><br><span class="line">scala&gt; x <span class="keyword">match</span>&#123;</span><br><span class="line">     |   <span class="keyword">case</span> '+' =&gt; print(<span class="string">"++++"</span>)</span><br><span class="line">     |   <span class="keyword">case</span> '_' =&gt; print(<span class="string">"-----"</span>)</span><br><span class="line">     |   <span class="keyword">case</span> _ <span class="keyword">if</span> <span class="type">Character</span>.isDigit(x) =&gt; print(<span class="string">"is number!"</span>)</span><br><span class="line">     |   <span class="keyword">case</span> _ =&gt; print(<span class="string">"..."</span>)</span><br><span class="line">     | &#125;</span><br><span class="line">&gt; is number!</span><br></pre></td></tr></table></figure><h4 id="2-åŒ¹é…ç±»å‹-xç±»å‹å®šä¹‰æˆåˆ¤æ–­ç±»å‹çš„å…±åŒè¶…ç±»ã€‚"><a href="#2-åŒ¹é…ç±»å‹-xç±»å‹å®šä¹‰æˆåˆ¤æ–­ç±»å‹çš„å…±åŒè¶…ç±»ã€‚" class="headerlink" title="2. åŒ¹é…ç±»å‹,xç±»å‹å®šä¹‰æˆåˆ¤æ–­ç±»å‹çš„å…±åŒè¶…ç±»ã€‚"></a>2. åŒ¹é…ç±»å‹,xç±»å‹å®šä¹‰æˆåˆ¤æ–­ç±»å‹çš„å…±åŒè¶…ç±»ã€‚</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scala&gt;    <span class="keyword">val</span> x:<span class="type">Any</span> = <span class="string">"123"</span></span><br><span class="line">x: <span class="type">Any</span> = <span class="number">123</span></span><br><span class="line"></span><br><span class="line">scala&gt; x <span class="keyword">match</span>&#123;</span><br><span class="line">     |   <span class="keyword">case</span> b:<span class="type">Int</span> =&gt; print(<span class="string">"is Int"</span>) ;</span><br><span class="line">     |   <span class="keyword">case</span> a:<span class="type">String</span> =&gt; print(<span class="string">"is String"</span>) ;</span><br><span class="line">     |   <span class="keyword">case</span> _ =&gt; print(<span class="string">"is Int"</span>) ;</span><br><span class="line">     | &#125;</span><br><span class="line">is <span class="type">String</span></span><br></pre></td></tr></table></figure><h4 id="3-åŒ¹é…æ•°ç»„æ•°æ®"><a href="#3-åŒ¹é…æ•°ç»„æ•°æ®" class="headerlink" title="3. åŒ¹é…æ•°ç»„æ•°æ®"></a>3. åŒ¹é…æ•°ç»„æ•°æ®</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> arr = <span class="type">Array</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">arr: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; arr <span class="keyword">match</span>&#123;</span><br><span class="line">     |     <span class="comment">//åŒ¹é…arrä¸­åªæœ‰ 0 </span></span><br><span class="line">     |     <span class="keyword">case</span> <span class="type">Array</span>(<span class="number">0</span>) =&gt; println(<span class="string">"arr ä¸­åªå«æœ‰0"</span>)</span><br><span class="line">     |     <span class="comment">//åŒ¹é…æ˜¯å¦ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">     |     <span class="keyword">case</span> <span class="type">Array</span>(x,y) =&gt; println(<span class="string">"æœ‰ä¸¤ä¸ªå…ƒç´ "</span>)</span><br><span class="line">     |     <span class="comment">//æ˜¯å¦ä»0å¼€å§‹</span></span><br><span class="line">     |     <span class="keyword">case</span> <span class="type">Array</span>(<span class="number">0</span>,_*) =&gt; println(<span class="string">"ä»0å¼€å§‹"</span>)</span><br><span class="line">     |     <span class="keyword">case</span> _ =&gt; println(<span class="string">"æœ‰0"</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥åŒ¹é…å…¶å®ƒå¤æ‚æ•°æ®ç±»å‹ä¸­æŸä¸ªä½ç½®ä¸Šçš„å€¼.</span></span><br></pre></td></tr></table></figure><h4 id="4-åå‡½æ•°"><a href="#4-åå‡½æ•°" class="headerlink" title="4. åå‡½æ•°"></a>4. åå‡½æ•°</h4><p><strong>æŠŠæ¨¡å¼åŒ¹é…æŠ½å‡ºæ¥å˜æˆå‡½æ•°äº†</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> ---å®šä¹‰</span><br><span class="line"><span class="keyword">val</span> f : <span class="type">PartialFunction</span>[<span class="type">Char</span>, <span class="type">Int</span>] = &#123;</span><br><span class="line">        <span class="keyword">case</span> '+' =&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">case</span> '-' =&gt; <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">case</span> _ =&gt; <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">---æµ‹è¯•</span><br><span class="line">    scala&gt; f('x')</span><br><span class="line">    res106: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    scala&gt; f('+')</span><br><span class="line">    res107: <span class="type">Int</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><hr><h1 id="åäº”-æ ·ä¾‹ç±»"><a href="#åäº”-æ ·ä¾‹ç±»" class="headerlink" title="åäº”. æ ·ä¾‹ç±»"></a>åäº”. æ ·ä¾‹ç±»</h1><p><strong>å…³é”®å­— : case</strong></p><p>ä¸»è¦ç”¨äºæ¨¡å¼åŒ¹é….  </p><p><strong>å†…ç½®äº†applyå’Œunapplyæ–¹æ³•ï¼Œè¿˜æœ‰ä¸²è¡ŒåŒ–ç­‰æ¥å£ã€‚</strong> </p><p>åˆ›å»ºå¯¹è±¡æ—¶ä¸éœ€è¦ä½¿ç”¨new. </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// åˆ›å»ºæ ·ä¾‹ç±»</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Jing8</span>(<span class="params">name:<span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Dog</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Shapi</span>(<span class="params">age:<span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Dog</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    scala&gt; <span class="keyword">val</span> d = <span class="type">Jing8</span>(<span class="string">"tom"</span>)<span class="comment">// å¯ä»¥ç›´æ¥åˆ›å»º, å› ä¸ºå†…ç½®äº† apply</span></span><br><span class="line"></span><br><span class="line">    d <span class="keyword">match</span>&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Jing8</span>(name) =&gt; print(<span class="string">"æ˜¯Jing8 : "</span> + name);</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Shapi</span>(age) =&gt; print(<span class="string">"æ˜¯Shapi : "</span> + age);</span><br><span class="line">        <span class="keyword">case</span> _ =&gt; print(<span class="string">"aishiuihsui"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">--&gt; è¿è¡Œç»“æœ:</span><br><span class="line">æ˜¯ <span class="type">Jing8</span>: tom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥çœ‹ .class æ–‡ä»¶</span></span><br><span class="line"><span class="comment">// å‘ç°æœ‰ apply, unapply, implements scala.Serializable ç­‰</span></span><br><span class="line">--------------------------------------------------</span><br><span class="line">âœ  scala javap -<span class="keyword">private</span> <span class="type">Jing8</span>$.<span class="keyword">class</span></span><br><span class="line"><span class="type">Compiled</span> from <span class="string">"dog.scala"</span></span><br><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Jing8$</span> <span class="keyword">extends</span> <span class="title">scala</span>.<span class="title">runtime</span>.<span class="title">AbstractFunction1&lt;java</span>.<span class="title">lang</span>.<span class="title">String</span>, <span class="title">Jing8&gt;</span> <span class="title">implements</span> <span class="title">scala</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  public static <span class="type">Jing8</span>$ <span class="type">MODULE</span>$;</span><br><span class="line">  public static &#123;&#125;;</span><br><span class="line">  public <span class="keyword">final</span> java.lang.<span class="type">String</span> toString();</span><br><span class="line">  public <span class="type">Jing8</span> apply(java.lang.<span class="type">String</span>);</span><br><span class="line">  public scala.<span class="type">Option</span>&lt;java.lang.<span class="type">String</span>&gt; unapply(<span class="type">Jing8</span>);</span><br><span class="line">  <span class="keyword">private</span> java.lang.<span class="type">Object</span> readResolve();</span><br><span class="line">  public java.lang.<span class="type">Object</span> apply(java.lang.<span class="type">Object</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Jing8</span>$();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯†å°æ ·ä¾‹ç±»</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"> å­ç±»å’Œçˆ¶ç±»å¿…é¡»å®šä¹‰åœ¨åŒä¸€æ–‡ä»¶ä¸­ã€‚</span><br><span class="line">    <span class="keyword">sealed</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Jing8</span>(<span class="params">name:<span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Dog</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Shapi</span>(<span class="params">age:<span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Dog</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><h1 id="åå…­-æ³›å‹"><a href="#åå…­-æ³›å‹" class="headerlink" title="åå…­. æ³›å‹"></a>åå…­. æ³›å‹</h1><h4 id="1-æ³›å‹çš„å®šä¹‰-amp-ä¸Šä¸‹ç•Œ"><a href="#1-æ³›å‹çš„å®šä¹‰-amp-ä¸Šä¸‹ç•Œ" class="headerlink" title="1. æ³›å‹çš„å®šä¹‰ &amp; ä¸Šä¸‹ç•Œ"></a>1. æ³›å‹çš„å®šä¹‰ &amp; ä¸Šä¸‹ç•Œ</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java ä¸­å¸¸ç”¨çš„æ³›å‹</span></span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">String</span>&gt;            </span><br><span class="line">    <span class="type">Map</span>&lt;<span class="type">String</span>,<span class="type">String</span>&gt;      </span><br><span class="line"></span><br><span class="line"><span class="comment">// Scala ä¸­çš„æ³›å‹</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç±»çš„æ³›å‹,å®šä¹‰æ³›å‹ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>[<span class="type">T</span>,<span class="type">S</span>](<span class="params">one:<span class="type">T</span>,second:<span class="type">S</span></span>)</span>;        <span class="comment">//å®šä¹‰æ³›å‹ç±»</span></span><br><span class="line">    <span class="keyword">val</span> p = <span class="keyword">new</span> <span class="type">Pair</span>[<span class="type">String</span>,<span class="type">Int</span>](<span class="string">"tom"</span>,<span class="number">12</span>);    <span class="comment">// åˆ›å»ºæ³›å‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> p = <span class="keyword">new</span> <span class="type">Pair</span>(<span class="string">"tom"</span>,<span class="number">12</span>);                <span class="comment">//ç±»å‹æ¨æ–­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–¹æ³•æ³›å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMiddle</span></span>[<span class="type">T</span>](arr:<span class="type">Array</span>[<span class="type">T</span>]) = arr(arr.length / <span class="number">2</span>);</span><br><span class="line">-&gt; å¯ä»¥ä¼ å…¥ä»»æ„ç±»å‹çš„ <span class="type">Array</span></span><br><span class="line"></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line"><span class="comment">//æ³›å‹çš„ä¸Šç•Œ,Tå¿…é¡»æ˜¯Dogçš„å­ç±»ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>[<span class="type">T</span> &lt;: <span class="type">Dog</span>](d:<span class="type">T</span>) = println(<span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// å®šä¹‰ä¸‹ç•Œ,Tå¿…é¡»æ˜¯shapiçš„çˆ¶ç±»ã€‚æœ‰é—®é¢˜: æµ‹è¯•æ˜¯é€šé…çš„, ä¼ å•¥éƒ½å¯ä»¥ :TODO</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run2</span></span>[<span class="type">T</span> &gt;: <span class="type">Shapi</span>](d:<span class="type">T</span>) = println(<span class="string">"hello"</span>)  </span><br><span class="line"></span><br><span class="line">    &lt;:            <span class="comment">//ä¸Šç•Œï¼Œå­ç±»</span></span><br><span class="line">    &gt;:            <span class="comment">//ä¸‹ç•Œï¼Œçˆ¶ç±» ???</span></span><br><span class="line">    &lt;%            <span class="comment">// A &lt;% B,Aèƒ½å¤Ÿéšå¼è½¬æ¢æˆB</span></span><br><span class="line"><span class="type">T</span> &lt;:<span class="type">Dog</span> &gt;:<span class="type">Cat</span>        <span class="comment">//çº¦æŸå¤šä¸ªæ¡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è§†å›¾ç•Œå®š</span></span><br><span class="line">[<span class="type">T</span> &lt;: <span class="type">Comparable</span>]</span><br></pre></td></tr></table></figure><h4 id="2-æ³›å‹çš„å‹å˜-TODO-ä¸æ‡‚"><a href="#2-æ³›å‹çš„å‹å˜-TODO-ä¸æ‡‚" class="headerlink" title="2. æ³›å‹çš„å‹å˜ :TODO ä¸æ‡‚"></a>2. æ³›å‹çš„å‹å˜ :TODO ä¸æ‡‚</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Friend</span>[+<span class="type">Dog</span>]            <span class="comment">//åå˜, å¦‚æœ Aæ˜¯ Bçš„å­ç±», é‚£ä¹ˆListA ä¹Ÿæ˜¯  ListB çš„å­ç±»</span></span><br><span class="line"><span class="type">Friend</span>[-<span class="type">Dog</span>]            <span class="comment">//é€†å˜</span></span><br><span class="line"></span><br><span class="line"><span class="type">Friend</span>[-<span class="type">Dog</span>]    <span class="comment">// å½“é‡‡ç”¨ -å· çº¦æŸæ—¶, åŸæœ¬ Friend[NafangShapi] ä¸º   Friend[Shapi] çš„å­ç±»çš„, ç°åœ¨å˜æˆçˆ¶ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="type">Friend</span>[<span class="type">Shapi</span>]</span><br><span class="line"><span class="type">Friend</span>[<span class="type">NafangShapi</span>]</span><br></pre></td></tr></table></figure><hr><h1 id="åä¸ƒ-éšå¼è½¬æ¢-implicit"><a href="#åä¸ƒ-éšå¼è½¬æ¢-implicit" class="headerlink" title="åä¸ƒ. éšå¼è½¬æ¢ implicit"></a>åä¸ƒ. éšå¼è½¬æ¢ <strong>implicit</strong></h1><pre><code>éšå¼è½¬æ¢å‡½æ•°:ä½¿ç”¨ **implicit** ä¿®é¥°çš„å…·æœ‰ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚ </code></pre><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ï£¿ å®šä¹‰éšå¼è½¬æ¢å‡½æ•° ï£¿</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">   <span class="comment">// å®šä¹‰äº†ä¹‹å, è°ƒç”¨ run(100) , æ­¤100ä¼šè‡ªåŠ¨éšå¼çš„è½¬ä¸º dog å¯¹è±¡</span></span><br><span class="line">   <span class="comment">// å½“è°ƒç”¨ä¸€ä¸ªå¯¹è±¡ä¸å­˜åœ¨æ–¹æ³•æ—¶, ä¼šå¯»æ‰¾æ˜¯å¦èƒ½éšå¼è½¬æ¢ä¸ºå…¶å®ƒå¯¹è±¡</span></span><br><span class="line">   <span class="comment">// éœ€è¦å½“å‰ä»£ç ä¸Šä¸‹æ–‡å¯è§</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">int2Dog</span></span>(n:<span class="type">Int</span>) = <span class="type">Shapi</span>(n);   <span class="comment">//å®šä¹‰</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(d:<span class="type">Dog</span>) = print(<span class="string">"hello world"</span>);</span><br><span class="line"> </span><br><span class="line">    run(<span class="number">100</span>) ;      <span class="comment">//è°ƒç”¨run æ–¹æ³•, ä¼šç›´æ¥è°ƒç”¨éšå¼è½¬æ¢å‡½æ•°ã€‚ æŠŠ100ä½œä¸ºå‚æ•°, åˆ›å»º Shapi å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ï£¿ å®šä¹‰éšå¼å•ä¾‹å¯¹è±¡ ï£¿</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">DogUtil</span></span>&#123;</span><br><span class="line">        <span class="comment">//å®šä¹‰éšå¼è½¬æ¢å‡½æ•°</span></span><br><span class="line">        <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">str2Dog</span></span>(s:<span class="type">String</span>) = <span class="type">Jing8</span>(s) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">--- ä½¿ç”¨</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run3</span></span>(d:<span class="type">Dog</span>) = println(<span class="string">"hello world"</span>);</span><br><span class="line">    <span class="keyword">import</span> <span class="type">DogUtil</span>._<span class="comment">// </span></span><br><span class="line">    run3(<span class="string">"tom"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‚æ•°é»˜è®¤å€¼</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span></span>(prefix:<span class="type">String</span> = <span class="string">"[[["</span>,c:<span class="type">String</span>,suffix:<span class="type">String</span>=<span class="string">"]]]"</span>) = ...</span><br><span class="line">    decorate(c= <span class="string">"hello world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ï£¿ éšå¼å‚æ•°(é»˜è®¤å‚æ•°) ï£¿</span></span><br><span class="line"><span class="comment">// å‚æ•°ä¸ºéšå¼çš„å‚æ•°, å›å»æ‰¾æ­¤å‚æ•°, å¦‚æœå‚æ•°æœ‰é»˜è®¤å€¼, å°±ä¸éœ€è¦å¯¹æ­¤å‚æ•°èµ‹å€¼</span></span><br><span class="line">âœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœâœ</span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">DogUtil2</span></span>&#123;</span><br><span class="line">        <span class="keyword">implicit</span> <span class="keyword">val</span> dog = <span class="type">Jing8</span>(<span class="string">"tomas"</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> <span class="type">DogUtil2</span>._</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run4</span></span>(<span class="keyword">implicit</span> dog:<span class="type">Jing8</span>) = println(<span class="string">"hello : "</span>) ;</span><br><span class="line"></span><br><span class="line">    run4;    <span class="comment">// æ³¨æ„, å¦‚æœä¸æƒ³ä¼ å‚æ•°, æƒ³è¦è°ƒç”¨éšå¼çš„é»˜è®¤å€¼, åé¢ä¸éœ€è¦åŠ  (). æˆ–è€…é‡Œé¢ä¼  null, run4(null)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä¸€-æ¦‚è§ˆ&quot;&gt;&lt;a href=&quot;#ä¸€-æ¦‚è§ˆ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€. æ¦‚è§ˆ&quot;&gt;&lt;/a&gt;ä¸€. &lt;strong&gt;æ¦‚è§ˆ&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;scala&lt;/strong&gt; : javaè¯­è¨€çš„è„šæœ¬åŒ–ã€‚       
      
    
    </summary>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/categories/Hadoop/"/>
    
      <category term="Scala" scheme="https://airpoet.github.io/categories/Hadoop/Scala/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/tags/Hadoop/"/>
    
      <category term="Scala" scheme="https://airpoet.github.io/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»“æ„ &amp; ç®—æ³•</title>
    <link href="https://airpoet.github.io/2018/07/11/Hadoop/10_%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84&amp;%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-&amp;-%E7%AE%97%E6%B3%95/"/>
    <id>https://airpoet.github.io/2018/07/11/Hadoop/10_æ•°æ®ç»“æ„&amp;ç®—æ³•/æ•°æ®ç»“æ„-&amp;-ç®—æ³•/</id>
    <published>2018-07-11T15:21:45.174Z</published>
    <updated>2018-07-11T16:20:12.824Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><h2 id="å‚è€ƒ-PDF-æ–‡æ¡£"><a href="#å‚è€ƒ-PDF-æ–‡æ¡£" class="headerlink" title="å‚è€ƒ PDF æ–‡æ¡£"></a>å‚è€ƒ PDF æ–‡æ¡£</h2><p><a href="https://app.yinxiang.com/shard/s37/nl/7399077/02c256fa-61c7-4ffb-b956-5159389373a0/" target="_blank" rel="noopener">æ•°æ®ç»“æ„å‚è€ƒPDF</a></p><p><a href="https://app.yinxiang.com/shard/s37/nl/7399077/2a72211a-8ead-4e30-989f-256b7f15bc83/" target="_blank" rel="noopener">ç®—æ³•åŸºç¡€å‚è€ƒPDF</a></p><p><br></p><h2 id="å‚è€ƒå¤§ç‰›ç¬”è®°"><a href="#å‚è€ƒå¤§ç‰›ç¬”è®°" class="headerlink" title="å‚è€ƒå¤§ç‰›ç¬”è®°"></a>å‚è€ƒå¤§ç‰›ç¬”è®°</h2><p><a href="https://airpoet.github.io/2018/07/04/Java/Interview/Interview-Notebook/%E7%AE%97%E6%B3%95/">ç®—æ³•ç»¼è¿°åŠä»£ç å®ç°</a></p><p><a href="https://airpoet.github.io/2018/07/04/Java/Interview/Interview-Notebook/Leetcode%20%E9%A2%98%E8%A7%A3/">Leetcodeè§£é¢˜</a></p><p><a href="https://airpoet.github.io/2018/07/04/Java/Interview/Interview-Notebook/%E5%89%91%E6%8C%87%20offer%20%E9%A2%98%E8%A7%A3/">å‰‘æŒ‡ Offer è§£é¢˜</a></p><p>å…¶å®ƒçš„è‡ªè¡ŒæŸ¥çœ‹</p><p><br></p><h2 id="å‚è€ƒè‡ªå·±ä»£ç "><a href="#å‚è€ƒè‡ªå·±ä»£ç " class="headerlink" title="å‚è€ƒè‡ªå·±ä»£ç "></a>å‚è€ƒè‡ªå·±ä»£ç </h2><p><a href="https://github.com/airpoet/bigdata/tree/master/Arithmetic_Project" target="_blank" rel="noopener">mygithub</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‚è€ƒ-PDF-æ–‡æ¡£&quot;&gt;&lt;a href=&quot;#å‚è€ƒ-PDF-æ–‡æ¡£&quot; class=&quot;headerlink&quot; title=&quot;å‚è€ƒ PDF æ–‡æ¡£&quot;&gt;&lt;/a&gt;å‚è€ƒ PDF æ–‡æ¡£&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://app.yinxiang.
      
    
    </summary>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/categories/Hadoop/"/>
    
      <category term="æ•°æ®ç»“æ„&amp;ç®—æ³•" scheme="https://airpoet.github.io/categories/Hadoop/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/tags/Hadoop/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="https://airpoet.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="ç®—æ³•" scheme="https://airpoet.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>i-NIO</title>
    <link href="https://airpoet.github.io/2018/07/11/Hadoop/11_NIO/NIO/"/>
    <id>https://airpoet.github.io/2018/07/11/Hadoop/11_NIO/NIO/</id>
    <published>2018-07-11T03:38:15.042Z</published>
    <updated>2018-07-12T01:03:01.212Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><h1 id="ä¸€-åŒæ­¥-å¼‚æ­¥-amp-é˜»å¡-éé˜»å¡"><a href="#ä¸€-åŒæ­¥-å¼‚æ­¥-amp-é˜»å¡-éé˜»å¡" class="headerlink" title="ä¸€.  åŒæ­¥, å¼‚æ­¥ &amp; é˜»å¡, éé˜»å¡"></a>ä¸€.  åŒæ­¥, å¼‚æ­¥ &amp; é˜»å¡, éé˜»å¡</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><strong>åŒæ­¥å’Œå¼‚æ­¥å…¶å®æŒ‡çš„æ˜¯ï¼Œè¯·æ±‚å‘èµ·æ–¹å¯¹æ¶ˆæ¯ç»“æœçš„è·å–æ˜¯ä¸»åŠ¨å‘èµ·çš„ï¼Œè¿˜æ˜¯ç­‰è¢«åŠ¨é€šçŸ¥çš„</strong>ã€‚</p><ul><li>å¦‚æœæ˜¯è¯·æ±‚æ–¹ä¸»åŠ¨å‘èµ·çš„ï¼Œ<strong>ä¸€ç›´åœ¨ç­‰å¾…åº”ç­”ç»“æœï¼ˆåŒæ­¥é˜»å¡ï¼‰</strong></li><li>å¦‚æœæ˜¯<strong>ç»“æœç”±æœåŠ¡æ–¹é€šçŸ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚æ–¹å‘å‡ºè¯·æ±‚åï¼Œè¦ä¹ˆåœ¨ä¸€ç›´ç­‰å¾…é€šçŸ¥ï¼ˆå¼‚æ­¥é˜»å¡ï¼‰, è¦ä¹ˆå°±å…ˆå»å¹²è‡ªå·±çš„äº‹äº†ï¼ˆå¼‚æ­¥éé˜»å¡)</strong></li></ul><p><strong>è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°ä¹‹åï¼Œåœ¨ç­‰å¾…è¿™ä¸ªå‡½æ•°è¿”å›ç»“æœä¹‹å‰ï¼Œå½“å‰çš„çº¿ç¨‹æ˜¯å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œè¿˜æ˜¯è¿è¡ŒçŠ¶æ€ï¼š</strong></p><ul><li>å¦‚æœæ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œå°±æ„å‘³ç€<strong>å½“å‰çº¿ç¨‹ä»€ä¹ˆéƒ½ä¸èƒ½å¹²</strong>ï¼Œå°±ç­‰ç€è·å–ç»“æœï¼Œè¿™å°±å«<strong>åŒæ­¥é˜»å¡</strong>ï¼Œ</li><li>å¦‚æœä»ç„¶æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œå°±æ„å‘³<strong>å½“å‰çº¿ç¨‹æ˜¯å¯ä»¥çš„ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œä½†è¦æ—¶ä¸æ—¶çš„å»çœ‹ä¸‹æ˜¯å¦æœ‰ç»“æœäº†ï¼Œè¿™å°±æ˜¯åŒæ­¥éé˜»å¡</strong>ã€‚</li></ul><h2 id="å½¢è±¡çš„ä¾‹å­"><a href="#å½¢è±¡çš„ä¾‹å­" class="headerlink" title="å½¢è±¡çš„ä¾‹å­"></a>å½¢è±¡çš„ä¾‹å­</h2><p>æ•…äº‹ï¼šè€ç‹çƒ§å¼€æ°´ã€‚</p><p>å‡ºåœºäººç‰©ï¼šè€ç‹ï¼Œæ°´å£¶ä¸¤æŠŠï¼ˆæ™®é€šæ°´å£¶ï¼Œç®€ç§°æ°´å£¶ï¼›ä¼šå“çš„æ°´å£¶ï¼Œç®€ç§°å“æ°´å£¶ï¼‰ã€‚</p><p>è€ç‹æƒ³äº†æƒ³ï¼Œæœ‰å¥½å‡ ç§ç­‰å¾…æ–¹å¼<br>1ã€è€ç‹ç”¨æ°´å£¶ç…®æ°´ï¼Œå¹¶ä¸”ç«™åœ¨é‚£é‡Œï¼Œä¸ç®¡æ°´å¼€æ²¡å¼€ï¼Œæ¯éš”ä¸€å®šæ—¶é—´çœ‹çœ‹æ°´å¼€äº†æ²¡    â€”â€”â€”-åŒæ­¥é˜»å¡<br>è€ç‹æƒ³äº†æƒ³ï¼Œè¿™ç§æ–¹æ³•ä¸å¤Ÿèªæ˜ã€‚</p><p>2ã€è€ç‹è¿˜æ˜¯ç”¨æ°´å£¶ç…®æ°´ï¼Œä¸å†å‚»å‚»çš„ç«™åœ¨é‚£é‡Œçœ‹æ°´å¼€ï¼Œè·‘å»å¯å®¤ä¸Šç½‘ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯éš”ä¸€æ®µæ—¶é—´è¿‡æ¥çœ‹çœ‹æ°´å¼€äº†æ²¡æœ‰ï¼Œæ°´æ²¡æœ‰å¼€å°±èµ°äººã€‚    â€”â€”â€”-åŒæ­¥éé˜»å¡<br>è€ç‹æƒ³äº†æƒ³ï¼Œç°åœ¨çš„æ–¹æ³•èªæ˜äº†äº›ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤Ÿå¥½ã€‚</p><p>3ã€è€ç‹è¿™æ¬¡ä½¿ç”¨é«˜å¤§ä¸Šçš„å“æ°´å£¶æ¥ç…®æ°´ï¼Œç«™åœ¨é‚£é‡Œï¼Œä½†æ˜¯ä¸ä¼šå†æ¯éš”ä¸€æ®µæ—¶é—´å»çœ‹æ°´å¼€ï¼Œè€Œæ˜¯ç­‰æ°´å¼€äº†ï¼Œæ°´å£¶ä¼šè‡ªåŠ¨çš„é€šçŸ¥ä»–ã€‚    â€”â€”â€”-å¼‚æ­¥é˜»å¡<br>è€ç‹æƒ³äº†æƒ³ï¼Œä¸ä¼šå‘€ï¼Œæ—¢ç„¶æ°´å£¶å¯ä»¥é€šçŸ¥æˆ‘ï¼Œé‚£æˆ‘ä¸ºä»€ä¹ˆè¿˜è¦å‚»å‚»çš„ç«™åœ¨é‚£é‡Œç­‰å‘¢ï¼Œå—¯ï¼Œå¾—æ¢ä¸ªæ–¹æ³•ã€‚</p><p>4ã€è€ç‹è¿˜æ˜¯ä½¿ç”¨å“æ°´å£¶ç…®æ°´ï¼Œè·‘åˆ°å®¢å…ä¸Šç½‘å»ï¼Œç­‰ç€å“æ°´å£¶è‡ªå·±æŠŠæ°´ç…®ç†Ÿäº†ä»¥åé€šçŸ¥ä»–ã€‚    â€”â€”â€”-å¼‚æ­¥éé˜»å¡</p><p>è€ç‹è±ç„¶ï¼Œè¿™ä¸‹æ„Ÿè§‰è½»æ¾äº†å¾ˆå¤šã€‚</p><hr><h1 id="äºŒ-NIO-ä¸­ä¸€äº›é‡è¦æ¦‚å¿µ"><a href="#äºŒ-NIO-ä¸­ä¸€äº›é‡è¦æ¦‚å¿µ" class="headerlink" title="äºŒ. NIO ä¸­ä¸€äº›é‡è¦æ¦‚å¿µ"></a>äºŒ. NIO ä¸­ä¸€äº›é‡è¦æ¦‚å¿µ</h1><h2 id="Java-IO-æ¨¡å‹"><a href="#Java-IO-æ¨¡å‹" class="headerlink" title="Java IO æ¨¡å‹"></a>Java IO æ¨¡å‹</h2><p><strong>BIOâ€“åŒæ­¥é˜»å¡ï¼š</strong></p><p>JDK1.4 ä»¥å‰æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ BIO</p><p>é˜»å¡åˆ°æˆ‘ä»¬çš„è¯»å†™æ–¹æ³•ï¼Œé˜»å¡åˆ°çº¿ç¨‹æ¥æé«˜å¹¶å‘æ€§èƒ½ï¼Œä½†æ˜¯æ•ˆæœä¸æ˜¯å¾ˆå¥½</p><p><strong>NIOâ€“åŒæ­¥éé˜»å¡ï¼š</strong>(New IO)</p><p>JDK1.4 Linux å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼ˆselect æ¨¡å¼ï¼‰å®ç° IO äº‹ä»¶çš„è½®è¯¢æ–¹å¼ï¼šåŒæ­¥ éé˜»å¡çš„æ¨¡å¼ï¼Œè¿™ç§æ–¹å¼ç›®å‰æ˜¯ä¸»æµçš„ç½‘ç»œé€šä¿¡æ¨¡å¼</p><p>Mina å’Œ Netty</p><p>â€“ ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œæ¯”è‡ªå·±å†™ NIO è¦å®¹æ˜“äº›ï¼Œå¹¶ä¸”ä»£ç å¯è¯»æ€§æ›´å¥½</p><p><strong>AIOâ€“å¼‚æ­¥éé˜»å¡ IOï¼š</strong></p><p>JDK1.7ï¼ˆNIO2ï¼‰çœŸæ­£çš„å¼‚æ­¥éé˜»å¡ IO(åŸºäº linux çš„ epoll æ¨¡å¼ï¼‰AIO ç›® å‰ä½¿ç”¨çš„è¿˜æ¯”è¾ƒå°‘</p><h2 id="é€šé“-channel-amp-ç¼“å†²åŒº-buffer"><a href="#é€šé“-channel-amp-ç¼“å†²åŒº-buffer" class="headerlink" title="é€šé“ channel &amp; ç¼“å†²åŒº buffer"></a>é€šé“ channel &amp; ç¼“å†²åŒº buffer</h2><h4 id="1-é€šé“-channel"><a href="#1-é€šé“-channel" class="headerlink" title="1. é€šé“ channel"></a>1. é€šé“ channel</h4><p><strong>å…³é”®è¯:</strong> æ¨¡æ‹Ÿæµ,  æ‰“å¼€çš„è¿æ¥, åŒå‘å¯è¯»å†™, çº¿ç¨‹å®‰å…¨,  åªèƒ½é€šè¿‡ç¼“å†²åŒºæ“ä½œ</p><p><strong>ç±»å‹</strong></p><ul><li>FileChannelï¼šä»æ–‡ä»¶ä¸­è¯»å†™æ•°æ®ï¼›</li><li>DatagramChannelï¼šé€šè¿‡ UDP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›</li><li><strong>SocketChannel</strong>ï¼šé€šè¿‡ TCP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›</li><li><strong>ServerSocketChannel</strong>ï¼šå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„ TCP è¿æ¥ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ª SocketChannelã€‚</li></ul><h4 id="2-ç¼“å†²åŒº-buffer"><a href="#2-ç¼“å†²åŒº-buffer" class="headerlink" title="2. ç¼“å†²åŒº buffer"></a>2. ç¼“å†²åŒº buffer</h4><p>ä¸èƒ½ç›´æ¥å¯¹é€šé“è¿›è¡Œè¯»å†™æ•°æ®ï¼Œè€Œæ˜¯è¦å…ˆç»è¿‡ç¼“å†²åŒºã€‚</p><p>ç¼“å†²åŒºå®è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„, æä¾›äº†å¯¹æ•°æ®çš„ç»“æ„åŒ–è®¿é—®ã€‚</p><p><strong>ç±»å‹:</strong> </p><ul><li><strong>ByteBuffer</strong></li><li>CharBuffer</li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li></ul><p><strong>å…³é”®è¯:</strong> </p><ul><li>capacityï¼šæœ€å¤§å®¹é‡ï¼›</li><li>positionï¼šå½“å‰å·²ç»è¯»å†™çš„å­—èŠ‚æ•°ï¼›</li><li>limitï¼šè¿˜å¯ä»¥è¯»å†™çš„å­—èŠ‚æ•°ã€‚</li></ul><p><a href="https://airpoet.github.io/2018/07/04/Java/Interview/Interview-Notebook/Java%20IO/#%E4%B8%83nio">å…¶å®ƒè¯¦æƒ…å¯è§ Java IO</a> </p><hr><h1 id="ä¸‰-ä»£ç å®ä¾‹"><a href="#ä¸‰-ä»£ç å®ä¾‹" class="headerlink" title="ä¸‰. ä»£ç å®ä¾‹"></a>ä¸‰. ä»£ç å®ä¾‹</h1><h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rox.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ³¨æ„: selectoræŒ‘é€‰å™¨, ç»´æŠ¤è‹¥å¹²é›†åˆ</span></span><br><span class="line"><span class="comment"> * selectionKeys : æ³¨å†Œçš„key</span></span><br><span class="line"><span class="comment"> * selectedKeys  : æŒ‘é€‰å‡ºæ¥çš„key -- æœ‰äº‹ä»¶çš„ key</span></span><br><span class="line"><span class="comment"> * å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯å¯¹åº”çš„å®¢æˆ·ç«¯ SocketChannel(å¥—æ¥å­—é€šé“), ä¸€èˆ¬æ¥è®², åªéœ€è¦å¯¹ read æ„Ÿå…´è¶£</span></span><br><span class="line"><span class="comment"> * ä¹Ÿå°±æ˜¯æ‹¦æˆª read æ¶ˆæ¯, write çš„è¯éšæ—¶éƒ½å¯ä»¥ write</span></span><br><span class="line"><span class="comment"> * sc æ˜¯å¯è¯»å¯å†™çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ†é…ç¼“å†²åŒºbufå†…å­˜</span></span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å¯æŒ‘é€‰å™¨</span></span><br><span class="line">        Selector sel = Selector.open();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å¯ ServerSocket é€šé“</span></span><br><span class="line">        ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line">        <span class="comment">// ç»‘å®šç«¯å£</span></span><br><span class="line">        ssc.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">8888</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®éé˜»å¡</span></span><br><span class="line">        ssc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// åœ¨æŒ‘é€‰å™¨ä¸­æ³¨å†Œé€šé“(æœåŠ¡å™¨é€šé“, å’Œæ„Ÿå…´è¶£çš„äº‹ä»¶ - OP_ACCEPT)</span></span><br><span class="line">        ssc.register(sel, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–å¯é€‰æ‹©é€šé“å¯¹è±¡(ä¸º ServerSocketChannel &amp; SocketChannel çš„å…±åŒçˆ¶ç±»)</span></span><br><span class="line">        SelectableChannel sc = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æŒ‘é€‰å™¨å¼€å§‹é€‰æ‹©(é˜»å¡çš„)</span></span><br><span class="line">            <span class="comment">// å¦‚æœä¹ˆæœ‰æ¥æ”¶åˆ° æ„Ÿå…´è¶£äº‹ä»¶, å°±å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">            sel.select();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// èƒ½èµ°åˆ°è¿™ä¸€æ­¥, å°±æ˜¯å·²ç»æ¥æ”¶åˆ°äº† accept äº‹ä»¶</span></span><br><span class="line">            <span class="comment">// è¿­ä»£æŒ‘é€‰å‡ºæ¥çš„ key çš„é›†åˆ</span></span><br><span class="line">            Iterator&lt;SelectionKey&gt; it = sel.selectedKeys().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                SelectionKey key = it.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ³¨å†Œçš„ keyæ˜¯å¯æ¥å—çš„, å°±ä¸€å®šæ˜¯æœåŠ¡å™¨é€šé“</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// å–å‡ºè¯¥é€šé“, è¿”å›ä¸€ä¸ª SelectableChannel çš„è¶…ç±»å¯¹è±¡</span></span><br><span class="line">                        sc = key.channel();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// å› ä¸ºæ‹¿åˆ°çš„ key æ˜¯ isAcceptable, æ‰€ä»¥å¯ä»¥åˆ¤æ–­æ˜¯ ssc å¯¹è±¡, å¼ºè½¬</span></span><br><span class="line">                        <span class="comment">// å¹¶é€šè¿‡ accept()æ–¹æ³•, è¿”å›ä¸€ä¸ª sc å¯¹è±¡(ç±»ä¼¼äºå¥—æ¥å­—, ä¸å®¢æˆ·ç«¯çš„ sc å¯¹åº”, è´Ÿè´£è·Ÿå®¢æˆ·ç«¯çš„ sc é€šä¿¡)</span></span><br><span class="line">                        SocketChannel sc0 = ((ServerSocketChannel) sc).accept();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// è®¾ç½® sc0 ä¸ºéé˜»å¡</span></span><br><span class="line">                        sc0.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ä¸ºæ¥æ”¶åˆ°çš„è¿™ä¸ª sc åœ¨é€‰æ‹©å™¨ä¸­, æ³¨å†Œè¯»äº‹ä»¶</span></span><br><span class="line">                        sc0.register(sel, SelectionKey.OP_READ);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ä¸‹ä¸€æ¬¡è½®è¯¢, å‘ç°æ˜¯æ¥è‡ª è¯»äº‹ä»¶ çš„key</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="comment">// å–å‡º channel, ç›´æ¥å¼ºè½¬ä¸º SocketChannel</span></span><br><span class="line">                        SocketChannel sc1 = (SocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/// å›å¤å®¢æˆ·ç«¯æ¶ˆæ¯, å‰é¢åŠ ä¸ªå¤´'hello', ç„¶åå†å†™å›å»</span></span><br><span class="line">                        <span class="comment">// åˆ›å»ºæ¶ˆæ¯å­—èŠ‚æ•°ç»„</span></span><br><span class="line">                        <span class="keyword">byte</span>[] helloBytes = <span class="string">"hello: "</span>.getBytes();</span><br><span class="line">                        <span class="comment">// æŠŠå­—èŠ‚æ•°ç»„æ”¾å…¥ buf</span></span><br><span class="line">                        buf.put(helloBytes, <span class="number">0</span>, helloBytes.length);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// è¯»å–æ¶ˆæ¯</span></span><br><span class="line">                        <span class="comment">// ä¸å­˜åœ¨è¯»å®Œ, åªè¦ä¸ä¸º0, å°±ä¸€ç›´è½®è¯¢è¯»</span></span><br><span class="line">                        <span class="comment">// ä»é€šé“é‡Œè¯»å‡ºæ¥,æ”¾åˆ°ç¼“å†²åŒºé‡Œ</span></span><br><span class="line">                        <span class="keyword">while</span> (sc1.read(buf) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// æ‹æ¿, å®šç¨¿, &gt; 0è¯´æ˜æœ‰æ•°æ®</span></span><br><span class="line">                            <span class="comment">// position å½’0, limit ç½®åœ¨ å·²å†™å…ƒç´  çš„åé¢ä¸€æ ¼, æ­¤æ—¶ä¸æ¥å—å…¶å®ƒå†™å…¥äº†</span></span><br><span class="line">                            buf.flip();</span><br><span class="line">                            <span class="comment">// æŒæœ‰çš„ sc å¯¹è±¡å†™å…¥åˆ°channel</span></span><br><span class="line">                            sc1.write(buf);</span><br><span class="line">                            <span class="comment">// å†™å®Œå æ¸…ç©º, position å½’0, limit æœ€å¤§</span></span><br><span class="line">                            buf.clear();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå¤±è´¥, ç§»é™¤æœ¬æ¬¡æ¥æ”¶åˆ°çš„ keys</span></span><br><span class="line">                    sel.keys().remove(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ¬æ¬¡é€‰æ‹©å™¨äº‹ä»¶å¤„ç†å®Œäº†ä¹‹å</span></span><br><span class="line">            <span class="comment">// ç§»é™¤æ‰€æœ‰é€‰æ‹©å‡ºæ¥çš„ key</span></span><br><span class="line">            sel.selectedKeys().clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rox.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// buf</span></span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€ä¸€ä¸ª selector</span></span><br><span class="line">        Selector sel = Selector.open();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€ä¸€ä¸ªå¥—æ¥å­—é€šé“</span></span><br><span class="line">        SocketChannel sc = SocketChannel.open();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢2ç§è¿æ¥æ²¡åŒºåˆ«</span></span><br><span class="line">        sc.socket().connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">8888</span>));</span><br><span class="line"><span class="comment">//        sc.connect(new InetSocketAddress("localhost", 8888));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// é…ç½®æ˜¯å¦é˜»å¡</span></span><br><span class="line">        sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œ sel å¯¹è±¡åŠ å…³æ³¨çš„ key</span></span><br><span class="line">        sc.register(sel, SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾€ buf ä¸­ put è¿›æ•°æ®(ä¸€æ¬¡)</span></span><br><span class="line"><span class="comment">//        buf.put("tom".getBytes());</span></span><br><span class="line"><span class="comment">//        buf.flip();</span></span><br><span class="line"><span class="comment">//        sc.write(buf);</span></span><br><span class="line"><span class="comment">//        buf.clear();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæƒ³è¦æŒç»­ä¸æ–­çš„é€šä¿¡, å¯ä»¥å¼€ä¸ªåˆ†çº¿ç¨‹ (æŒç»­æ”¶å‘æ¶ˆæ¯)</span></span><br><span class="line">        <span class="comment">// ç¨‹åºæ˜¯ä»ä¸Šå¾€ä¸‹è¿è¡Œçš„, è¿è¡Œåˆ°ä¸‹é¢æ²¡æœ‰æ¥å—åˆ°æ¶ˆæ¯çš„è¯ä¼šå¡ä½</span></span><br><span class="line">        <span class="comment">// ä¸€æ—¦å¡ä½äº†, ä¹Ÿå°±æ— æ³•ç»§ç»­åŒæœåŠ¡ç«¯é€šä¿¡äº†</span></span><br><span class="line">        <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> i = <span class="number">0</span> ;</span><br><span class="line">                <span class="comment">// è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºä¸“ç”¨</span></span><br><span class="line">                ByteBuffer buf2 = ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">8</span>);</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        buf2.put((<span class="string">"Tom"</span> +  (i ++)).getBytes());</span><br><span class="line">                        buf2.flip();   <span class="comment">//åˆ‡æ¢è¯»å†™</span></span><br><span class="line">                        sc.write(buf2);</span><br><span class="line">                        buf2.clear();</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// é€‰æ‹©å™¨é€‰æ‹©, æ¥å— æœåŠ¡ç«¯è¿”å›çš„ key</span></span><br><span class="line">            sel.select();</span><br><span class="line"></span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒº</span></span><br><span class="line">            <span class="keyword">while</span> (sc.read(buf) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// è¯»åˆ°äº†æ•°æ®, å°±æ‹ä¸€ä¸‹æ¿</span></span><br><span class="line">                buf.flip();</span><br><span class="line">                <span class="comment">// ä»ç¼“å†²åŒº buf å†™å…¥åˆ° ByteArrayOutputStream æµ</span></span><br><span class="line">                baos.write(buf.array(), <span class="number">0</span>, buf.limit());</span><br><span class="line">                <span class="comment">// å†™å®Œäº†å°±æ¸…ç©º ç¼“å†²åŒºbuf</span></span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ‰“å°æ¥å—åˆ°çš„æ•°æ®</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="comment">// æ¸…ç©º selectedKeysçš„ set</span></span><br><span class="line">            sel.selectedKeys().clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¶å®ƒçš„ä»£ç å‚è€ƒæˆ‘çš„-Github"><a href="#å…¶å®ƒçš„ä»£ç å‚è€ƒæˆ‘çš„-Github" class="headerlink" title="å…¶å®ƒçš„ä»£ç å‚è€ƒæˆ‘çš„ Github"></a>å…¶å®ƒçš„ä»£ç å‚è€ƒæˆ‘çš„ Github</h2><p><a href="https://github.com/airpoet/bigdata/tree/master/Java_Project/NIO" target="_blank" rel="noopener">mygithub</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- GFM-TOC --&gt;
&lt;h1 id=&quot;ä¸€-åŒæ­¥-å¼‚æ­¥-amp-é˜»å¡-éé˜»å¡&quot;&gt;&lt;a href=&quot;#ä¸€-åŒæ­¥-å¼‚æ­¥-amp-é˜»å¡-éé˜»å¡&quot; class=&quot;headerlink&quot; title=&quot;ä¸€.  åŒæ­¥, å¼‚æ­¥ &amp;amp; é˜»å¡, éé˜»å¡&quot;&gt;&lt;/a&gt;ä¸€.  åŒæ­¥, å¼‚
      
    
    </summary>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/categories/Hadoop/"/>
    
      <category term="NIO" scheme="https://airpoet.github.io/categories/Hadoop/NIO/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/tags/Hadoop/"/>
    
      <category term="NIO" scheme="https://airpoet.github.io/tags/NIO/"/>
    
  </entry>
  
  <entry>
    <title>newObject</title>
    <link href="https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/newObject/"/>
    <id>https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/newObject/</id>
    <published>2018-07-09T03:26:48.528Z</published>
    <updated>2018-07-09T07:22:23.926Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…"><a href="#å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…" class="headerlink" title="å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…"></a>å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…</h1><h2 id="åˆ›å»ºå¯¹è±¡"><a href="#åˆ›å»ºå¯¹è±¡" class="headerlink" title="åˆ›å»ºå¯¹è±¡"></a>åˆ›å»ºå¯¹è±¡</h2><p>å½“ <code>JVM</code> æ”¶åˆ°ä¸€ä¸ª <code>new</code> æŒ‡ä»¤æ—¶ï¼Œä¼šæ£€æŸ¥æŒ‡ä»¤ä¸­çš„å‚æ•°åœ¨å¸¸é‡æ± æ˜¯å¦æœ‰è¿™ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œè¿˜ä¼šæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»è¢«<a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/ClassLoad.md" target="_blank" rel="noopener">åŠ è½½</a>è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯åˆ™è¦è¿›è¡Œä¸€æ¬¡ç±»åŠ è½½ã€‚</p><p>æ¥ç€å°±æ˜¯åˆ†é…å†…å­˜äº†ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>æŒ‡é’ˆç¢°æ’</li><li>ç©ºé—²åˆ—è¡¨</li></ul><p>ä½¿ç”¨æŒ‡é’ˆç¢°æ’çš„å‰ææ˜¯å †å†…å­˜æ˜¯<strong>å®Œå…¨å·¥æ•´</strong>çš„ï¼Œç”¨è¿‡çš„å†…å­˜å’Œæ²¡ç”¨çš„å†…å­˜å„åœ¨ä¸€è¾¹æ¯æ¬¡åˆ†é…çš„æ—¶å€™åªéœ€è¦å°†æŒ‡é’ˆå‘ç©ºé—²å†…å­˜ä¸€æ–¹ç§»åŠ¨ä¸€æ®µå’Œå†…å­˜å¤§å°ç›¸ç­‰åŒºåŸŸå³å¯ã€‚</p><p>å½“å †ä¸­å·²ç»ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜<strong>äº’ç›¸äº¤é”™</strong>æ—¶ï¼ŒæŒ‡é’ˆç¢°æ’çš„æ–¹å¼å°±è¡Œä¸é€šäº†ï¼Œè¿™æ—¶å°±éœ€è¦é‡‡ç”¨ç©ºé—²åˆ—è¡¨çš„æ–¹å¼ã€‚è™šæ‹Ÿæœºä¼šç»´æŠ¤ä¸€ä¸ªç©ºé—²çš„åˆ—è¡¨ï¼Œç”¨äºè®°å½•å“ªäº›å†…å­˜æ˜¯å¯ä»¥è¿›è¡Œåˆ†é…çš„ï¼Œåˆ†é…æ—¶ç›´æ¥ä»å¯ç”¨å†…å­˜ä¸­ç›´æ¥åˆ†é…å³å¯ã€‚</p><p>å †ä¸­çš„å†…å­˜æ˜¯å¦å·¥æ•´æ˜¯æœ‰<strong>åƒåœ¾æ”¶é›†å™¨</strong>æ¥å†³å®šçš„ï¼Œå¦‚æœå¸¦æœ‰å‹ç¼©åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨å°±æ˜¯é‡‡ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹å¼æ¥è¿›è¡Œå†…å­˜åˆ†é…çš„ã€‚</p><p>åˆ†é…å†…å­˜æ—¶ä¹Ÿä¼šå‡ºç°å¹¶å‘é—®é¢˜:</p><p>è¿™æ ·å¯ä»¥åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ä½¿ç”¨ <code>CAS</code> è¿™æ ·çš„ä¹è§‚é”æ¥ä¿è¯ã€‚</p><p>ä¹Ÿå¯ä»¥å°†å†…å­˜åˆ†é…å®‰æ’åœ¨æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰çš„ç©ºé—´è¿›è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹é¦–å…ˆåœ¨å †å†…å­˜ä¸­åˆ†é…ä¸€å°å—å†…å­˜ï¼Œç§°ä¸ºæœ¬åœ°åˆ†é…ç¼“å­˜(<code>TLAB : Thread Local Allocation Buffer</code>)ã€‚</p><p>åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€è¦åœ¨è‡ªå·±çš„åˆ†é…ç¼“å­˜ä¸­åˆ†é…å³å¯ï¼Œç”±äºè¿™ä¸ªå†…å­˜åŒºåŸŸæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚</p><p>å¯ä»¥ä½¿ç”¨ <code>-XX:+/-UseTLAB</code> å‚æ•°æ¥è®¾å®š <code>JVM</code> æ˜¯å¦å¼€å¯ <code>TLAB</code> ã€‚</p><p>å†…å­˜åˆ†é…ä¹‹åéœ€è¦å¯¹è¯¥å¯¹è±¡è¿›è¡Œè®¾ç½®ï¼Œå¦‚å¯¹è±¡å¤´ã€‚å¯¹è±¡å¤´çš„ä¸€äº›åº”ç”¨å¯ä»¥æŸ¥çœ‹ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/Synchronize.md" target="_blank" rel="noopener">Synchronize å…³é”®å­—åŸç†</a>ã€‚</p><h3 id="å¯¹è±¡è®¿é—®"><a href="#å¯¹è±¡è®¿é—®" class="headerlink" title="å¯¹è±¡è®¿é—®"></a>å¯¹è±¡è®¿é—®</h3><p>ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºä¹‹åè‡ªç„¶æ˜¯ä¸ºäº†ä½¿ç”¨ï¼Œåœ¨ <code>Java</code> ä¸­æ˜¯é€šè¿‡æ ˆæ¥å¼•ç”¨å †å†…å­˜ä¸­çš„å¯¹è±¡æ¥è¿›è¡Œæ“ä½œçš„ã€‚</p><p>å¯¹äºæˆ‘ä»¬å¸¸ç”¨çš„ <code>HotSpot</code> è™šæ‹Ÿæœºæ¥è¯´ï¼Œè¿™æ ·å¼•ç”¨å…³ç³»æ˜¯é€šè¿‡ç›´æ¥æŒ‡é’ˆæ¥å…³è”çš„ã€‚</p><p>å¦‚å›¾:</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fnkmy0bvu3j30o60heaaq.jpg" alt=""></p><p>è¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼šåœ¨ Java é‡Œè¿›è¡Œé¢‘ç¹çš„å¯¹è±¡è®¿é—®å¯ä»¥æå‡è®¿é—®é€Ÿåº¦(ç›¸å¯¹äºä½¿ç”¨å¥æŸ„æ± æ¥è¯´)ã€‚</p><h2 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h2><h3 id="Eden-åŒºåˆ†é…"><a href="#Eden-åŒºåˆ†é…" class="headerlink" title="Eden åŒºåˆ†é…"></a>Eden åŒºåˆ†é…</h3><p>ç®€å•çš„æ¥è¯´å¯¹è±¡éƒ½æ˜¯åœ¨å †å†…å­˜ä¸­åˆ†é…çš„ï¼Œå¾€ç»†ä¸€ç‚¹çœ‹åˆ™æ˜¯ä¼˜å…ˆåœ¨ <code>Eden</code> åŒºåˆ†é…ã€‚</p><p>è¿™é‡Œå°±æ¶‰åŠåˆ°å †å†…å­˜çš„åˆ’åˆ†äº†ï¼Œä¸ºäº†æ–¹ä¾¿åƒåœ¾å›æ”¶ï¼ŒJVM å°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚</p><p>è€Œæ–°ç”Ÿä»£ä¸­åˆä¼šåˆ’åˆ†ä¸º <code>Eden</code> åŒºï¼Œ<code>from Survivorã€to Survivor</code> åŒºã€‚</p><p>å…¶ä¸­ <code>Eden</code> å’Œ <code>Survivor</code> åŒºçš„æ¯”ä¾‹é»˜è®¤æ˜¯ <code>8:1:1</code>ï¼Œå½“ç„¶ä¹Ÿæ”¯æŒå‚æ•°è°ƒæ•´ <code>-XX:SurvivorRatio=8</code>ã€‚</p><p>å½“åœ¨ <code>Eden</code> åŒºåˆ†é…å†…å­˜ä¸è¶³æ—¶ï¼Œåˆ™ä¼šå‘ç”Ÿ <code>minorGC</code> ï¼Œç”±äº <code>Java</code> å¯¹è±¡å¤šæ•°æ˜¯<strong>æœç”Ÿå¤•ç­</strong>çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ <code>minorGC</code> é€šå¸¸ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œæ•ˆç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚</p><p>å½“å‘ç”Ÿ <code>minorGC</code> æ—¶ï¼ŒJVM ä¼šæ ¹æ®<a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/GarbageCollection.md#%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">å¤åˆ¶ç®—æ³•</a>å°†å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°å¦ä¸€ä¸ªæœªä½¿ç”¨çš„ <code>Survivor</code> åŒºï¼Œå¦‚æœ <code>Survivor</code> åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œåˆ™ä¼šä½¿ç”¨åˆ†é…æ‹…ä¿ç­–ç•¥å°†å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p><p>è°ˆåˆ° <code>minorGC</code> æ—¶ï¼Œå°±ä¸å¾—ä¸æåˆ° <code>fullGC(majorGC)</code> ï¼Œè¿™æ˜¯æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ <code>GC</code> ï¼Œä¸è®ºæ˜¯æ•ˆç‡è¿˜æ˜¯é€Ÿåº¦éƒ½æ¯” <code>minorGC</code> æ…¢çš„å¤šï¼Œå›æ”¶æ—¶è¿˜ä¼šå‘ç”Ÿ <code>stop the world</code> ä½¿ç¨‹åºå‘ç”Ÿåœé¡¿ï¼Œæ‰€ä»¥åº”å½“å°½é‡é¿å…å‘ç”Ÿ <code>fullGC</code> ã€‚</p><h3 id="è€å¹´ä»£åˆ†é…"><a href="#è€å¹´ä»£åˆ†é…" class="headerlink" title="è€å¹´ä»£åˆ†é…"></a>è€å¹´ä»£åˆ†é…</h3><p>ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¼šå¯¼è‡´å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ï¼Œæ¯”å¦‚å½“åˆ†é…ä¸€ä¸ªå¤§å¯¹è±¡æ—¶(å¤§çš„æ•°ç»„ï¼Œå¾ˆé•¿çš„å­—ç¬¦ä¸²)ï¼Œç”±äº <code>Eden</code> åŒºæ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´æ¥åˆ†é…æ—¶ï¼Œä¼šå¯¼è‡´æå‰è§¦å‘ä¸€æ¬¡ <code>GC</code>ï¼Œæ‰€ä»¥å°½é‡åˆ«é¢‘ç¹çš„åˆ›å»ºå¤§å¯¹è±¡ã€‚</p><p>å› æ­¤ <code>JVM</code> ä¼šæ ¹æ®ä¸€ä¸ªé˜ˆå€¼æ¥åˆ¤æ–­å¤§äºè¯¥é˜ˆå€¼å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ–°ç”Ÿä»£é¢‘ç¹çš„å‘ç”Ÿ <code>GC</code>ã€‚</p><p>å¯¹äºä¸€äº›åœ¨æ–°ç”Ÿä»£çš„è€å¯¹è±¡ <code>JVM</code> ä¹Ÿä¼šæ ¹æ®æŸç§æœºåˆ¶ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p><p>JVM æ˜¯æ ¹æ®è®°å½•å¯¹è±¡å¹´é¾„çš„æ–¹å¼æ¥åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦åº”è¯¥ç§»åŠ¨åˆ°è€å¹´ä»£ï¼Œæ ¹æ®æ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«ç§»åŠ¨åˆ° <code>Survivor</code> åŒºä¹‹å JVM å°±ç»™è¯¥å¯¹è±¡çš„å¹´é¾„è®°ä¸º1ï¼Œæ¯å½“ç†¬è¿‡ä¸€æ¬¡ <code>minorGC</code> åå¯¹è±¡çš„å¹´é¾„å°± +1 ï¼Œç›´åˆ°è¾¾åˆ°é˜ˆå€¼(é»˜è®¤ä¸º15)å°±ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p><blockquote><p>å¯ä»¥ä½¿ç”¨ <code>-XX:MaxTenuringThreshold=15</code> æ¥é…ç½®è¿™ä¸ªé˜ˆå€¼ã€‚</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è™½è¯´è¿™äº›å†…å®¹ç•¥æ˜¾æ¯ç‡¥ï¼Œä½†å½“åº”ç”¨å‘ç”Ÿä¸æ­£å¸¸çš„ <code>GC</code> æ—¶ï¼Œå¯ä»¥æ–¹ä¾¿æ›´å¿«çš„å®šä½é—®é¢˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…&quot;&gt;&lt;a href=&quot;#å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…&quot; class=&quot;headerlink&quot; title=&quot;å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…&quot;&gt;&lt;/a&gt;å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…&lt;/h1&gt;&lt;h2 id=&quot;åˆ›å»ºå¯¹è±¡&quot;&gt;&lt;a href=&quot;#åˆ›å»ºå¯¹è±¡&quot; class=&quot;head
      
    
    </summary>
    
      <category term="Github" scheme="https://airpoet.github.io/categories/Github/"/>
    
      <category term="Java-Interview" scheme="https://airpoet.github.io/categories/Github/Java-Interview/"/>
    
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="https://airpoet.github.io/tags/Java/"/>
    
      <category term="è½¬è½½" scheme="https://airpoet.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>LinkedHashMap</title>
    <link href="https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/collection/LinkedHashMap/"/>
    <id>https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/collection/LinkedHashMap/</id>
    <published>2018-07-09T03:26:48.526Z</published>
    <updated>2018-07-09T07:16:53.075Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LinkedHashMap-åº•å±‚åˆ†æ"><a href="#LinkedHashMap-åº•å±‚åˆ†æ" class="headerlink" title="LinkedHashMap åº•å±‚åˆ†æ"></a>LinkedHashMap åº•å±‚åˆ†æ</h1><p>ä¼—æ‰€å‘¨çŸ¥ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/HashMap.md" target="_blank" rel="noopener">HashMap</a> æ˜¯ä¸€ä¸ªæ— åºçš„ <code>Map</code>ï¼Œå› ä¸ºæ¯æ¬¡æ ¹æ® <code>key</code> çš„ <code>hashcode</code> æ˜ å°„åˆ° <code>Entry</code> æ•°ç»„ä¸Šï¼Œæ‰€ä»¥éå†å‡ºæ¥çš„é¡ºåºå¹¶ä¸æ˜¯å†™å…¥çš„é¡ºåºã€‚</p><p>å› æ­¤ JDK æ¨å‡ºä¸€ä¸ªåŸºäº <code>HashMap</code> ä½†å…·æœ‰é¡ºåºçš„ <code>LinkedHashMap</code> æ¥è§£å†³æœ‰æ’åºéœ€æ±‚çš„åœºæ™¯ã€‚</p><p>å®ƒçš„åº•å±‚æ˜¯ç»§æ‰¿äº <code>HashMap</code> å®ç°çš„ï¼Œç”±ä¸€ä¸ªåŒå‘é“¾è¡¨æ‰€æ„æˆã€‚</p><p><code>LinkedHashMap</code> çš„æ’åºæ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>æ ¹æ®å†™å…¥é¡ºåºæ’åºã€‚</li><li>æ ¹æ®è®¿é—®é¡ºåºæ’åºã€‚</li></ul><p>å…¶ä¸­æ ¹æ®è®¿é—®é¡ºåºæ’åºæ—¶ï¼Œæ¯æ¬¡ <code>get</code> éƒ½ä¼šå°†è®¿é—®çš„å€¼ç§»åŠ¨åˆ°é“¾è¡¨æœ«å°¾ï¼Œè¿™æ ·é‡å¤æ“ä½œå°±èƒ½å¾—åˆ°ä¸€ä¸ªæŒ‰ç…§è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚</p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">Map&lt;String, Integer&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;String, Integer&gt;();</span><br><span class="line">map.put(<span class="string">"1"</span>,<span class="number">1</span>) ;</span><br><span class="line">map.put(<span class="string">"2"</span>,<span class="number">2</span>) ;</span><br><span class="line">map.put(<span class="string">"3"</span>,<span class="number">3</span>) ;</span><br><span class="line">map.put(<span class="string">"4"</span>,<span class="number">4</span>) ;</span><br><span class="line">map.put(<span class="string">"5"</span>,<span class="number">5</span>) ;</span><br><span class="line">System.out.println(map.toString());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å¯ä»¥çœ‹åˆ° <code>map</code> çš„ç»„æˆï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo6l9xp91lj319m0s4tgi.jpg" alt=""></p><p>æ‰“å¼€æºç å¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The head of the doubly linked list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; header;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The iteration ordering method for this linked hash map: &lt;tt&gt;true&lt;/tt&gt;</span></span><br><span class="line"><span class="comment"> * for access-order, &lt;tt&gt;false&lt;/tt&gt; for insertion-order.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// These fields comprise the doubly linked list used for iteration.</span></span><br><span class="line">    Entry&lt;K,V&gt; before, after;</span><br><span class="line"></span><br><span class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, HashMap.Entry&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, value, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>Entry</code> ç»§æ‰¿äº <code>HashMap</code> çš„ <code>Entry</code>ï¼Œå¹¶æ–°å¢äº†ä¸Šä¸‹èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä¹Ÿå°±å½¢æˆäº†åŒå‘é“¾è¡¨ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ª <code>header</code> çš„æˆå‘˜å˜é‡ï¼Œæ˜¯è¿™ä¸ªåŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚ </p><p>ä¸Šè¾¹çš„ demo æ€»ç»“æˆä¸€å¼ å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fodggwc523j30za0n4wgj.jpg" alt=""></p><p>ç¬¬ä¸€ä¸ªç±»ä¼¼äº <code>HashMap</code> çš„ç»“æ„ï¼Œåˆ©ç”¨ <code>Entry</code> ä¸­çš„ <code>next</code> æŒ‡é’ˆè¿›è¡Œå…³è”ã€‚</p><p>ä¸‹è¾¹åˆ™æ˜¯ <code>LinkedHashMap</code> å¦‚ä½•è¾¾åˆ°æœ‰åºçš„å…³é”®ã€‚</p><p>å°±æ˜¯åˆ©ç”¨äº†å¤´èŠ‚ç‚¹å’Œå…¶ä½™çš„å„ä¸ªèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ <code>Entry</code> ä¸­çš„ <code>after</code> å’Œ <code>before</code> æŒ‡é’ˆè¿›è¡Œå…³è”ã€‚</p><p>å…¶ä¸­è¿˜æœ‰ä¸€ä¸ª <code>accessOrder</code> æˆå‘˜å˜é‡ï¼Œé»˜è®¤æ˜¯ <code>false</code>ï¼Œé»˜è®¤æŒ‰ç…§æ’å…¥é¡ºåºæ’åºï¼Œä¸º <code>true</code> æ—¶æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œä¹Ÿå¯ä»¥è°ƒç”¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public LinkedHashMap(int initialCapacity,</span><br><span class="line">                     float loadFactor,</span><br><span class="line">                     boolean accessOrder) &#123;</span><br><span class="line">    super(initialCapacity, loadFactor);</span><br><span class="line">    this.accessOrder = accessOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ„é€ æ–¹æ³•å¯ä»¥æ˜¾ç¤ºçš„ä¼ å…¥ <code>accessOrder</code>ã€‚</p><h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p><code>LinkedHashMap</code> çš„æ„é€ æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯è°ƒç”¨çš„ <code>HashMap</code> çš„æ„é€ æ–¹æ³•:</p><p><code>HashMap</code> å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    threshold = initialCapacity;</span><br><span class="line">    <span class="comment">//HashMap åªæ˜¯å®šä¹‰äº†æ”¹æ–¹æ³•ï¼Œå…·ä½“å®ç°äº¤ç»™äº† LinkedHashMap</span></span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªç©ºçš„ <code>init()</code>ï¼Œå…·ä½“æ˜¯ç”± <code>LinkedHashMap</code> æ¥å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    header = <span class="keyword">new</span> Entry&lt;&gt;(-<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    header.before = header.after = header;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¹Ÿå°±æ˜¯å¯¹ <code>header</code> è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p><h2 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put() æ–¹æ³•"></a>put() æ–¹æ³•</h2><p>çœ‹ <code>LinkedHashMap</code> çš„ <code>put()</code> æ–¹æ³•ä¹‹å‰å…ˆçœ‹çœ‹ <code>HashMap</code> çš„ <code>put</code> æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">    if (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    if (key == null)</span><br><span class="line">        return putForNullKey(value);</span><br><span class="line">    int hash = hash(key);</span><br><span class="line">    int i = indexFor(hash, table.length);</span><br><span class="line">    for (Entry&lt;K,V&gt; e = table[i]; e != null; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            //ç©ºå®ç°ï¼Œäº¤ç»™ LinkedHashMap è‡ªå·±å®ç°</span><br><span class="line">            e.recordAccess(this);</span><br><span class="line">            return oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    // LinkedHashMap å¯¹å…¶é‡å†™</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// LinkedHashMap å¯¹å…¶é‡å†™</span><br><span class="line">void addEntry(int hash, K key, V value, int bucketIndex) &#123;</span><br><span class="line">    if ((size &gt;= threshold) &amp;&amp; (null != table[bucketIndex])) &#123;</span><br><span class="line">        resize(2 * table.length);</span><br><span class="line">        hash = (null != key) ? hash(key) : 0;</span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// LinkedHashMap å¯¹å…¶é‡å†™</span><br><span class="line">void createEntry(int hash, K key, V value, int bucketIndex) &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = new Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»ä½“çš„å®ç°éƒ½æ˜¯å€ŸåŠ©äº <code>HashMap</code> æ¥å®Œæˆçš„ï¼Œåªæ˜¯å¯¹å…¶ä¸­çš„ <code>recordAccess(), addEntry(), createEntry()</code> è¿›è¡Œäº†é‡å†™ã€‚</p><p><code>LinkedHashMap</code> çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ®è®¿é—®é¡ºåºæ’åºï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦å°†å½“å‰è¿™ä¸ª Entry ç§»åŠ¨åˆ°é“¾è¡¨çš„æœ«å°¾</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</span><br><span class="line">        LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</span><br><span class="line">        <span class="keyword">if</span> (lm.accessOrder) &#123;</span><br><span class="line">            lm.modCount++;</span><br><span class="line">            remove();</span><br><span class="line">            addBefore(lm.header);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//è°ƒç”¨äº† HashMap çš„å®ç°ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ é™¤æœ€å°‘ä½¿ç”¨çš„ Entry(é»˜è®¤ä¸åˆ é™¤)    </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.addEntry(hash, key, value, bucketIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove eldest entry if instructed</span></span><br><span class="line">    Entry&lt;K,V&gt; eldest = header.after;</span><br><span class="line">    <span class="keyword">if</span> (removeEldestEntry(eldest)) &#123;</span><br><span class="line">        removeEntryForKey(eldest.key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    HashMap.Entry&lt;K,V&gt; old = table[bucketIndex];</span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, old);</span><br><span class="line">    <span class="comment">//å°±å¤šäº†è¿™ä¸€æ­¥ï¼Œå°†æ–°å¢çš„ Entry åŠ å…¥åˆ° header åŒå‘é“¾è¡¨ä¸­</span></span><br><span class="line">    table[bucketIndex] = e;</span><br><span class="line">    e.addBefore(header);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å†™å…¥åˆ°åŒå‘é“¾è¡¨ä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBefore</span><span class="params">(Entry&lt;K,V&gt; existingEntry)</span> </span>&#123;</span><br><span class="line">        after  = existingEntry;</span><br><span class="line">        before = existingEntry.before;</span><br><span class="line">        before.after = <span class="keyword">this</span>;</span><br><span class="line">        after.before = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h2><p>LinkedHashMap çš„ <code>get()</code> æ–¹æ³•ä¹Ÿé‡å†™äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)getEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//å¤šäº†ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æ˜¯æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œæ˜¯åˆ™å°†å½“å‰çš„ Entry ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨ã€‚   </span></span><br><span class="line">    e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</span><br><span class="line">    LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</span><br><span class="line">    <span class="keyword">if</span> (lm.accessOrder) &#123;</span><br><span class="line">        lm.modCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åˆ é™¤</span></span><br><span class="line">        remove();</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ°å¤´éƒ¨</span></span><br><span class="line">        addBefore(lm.header);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>clear()</code> æ¸…ç©ºå°±è¦æ¯”è¾ƒç®€å•äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åªéœ€è¦æŠŠæŒ‡é’ˆéƒ½æŒ‡å‘è‡ªå·±å³å¯ï¼ŒåŸæœ¬é‚£äº› Entry æ²¡æœ‰å¼•ç”¨ä¹‹åå°±ä¼šè¢« JVM è‡ªåŠ¨å›æ”¶ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.clear();</span><br><span class="line">    header.before = header.after = header;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ <code>LinkedHashMap</code> å…¶å®å°±æ˜¯å¯¹ <code>HashMap</code> è¿›è¡Œäº†æ‹“å±•ï¼Œä½¿ç”¨äº†åŒå‘é“¾è¡¨æ¥ä¿è¯äº†é¡ºåºæ€§ã€‚</p><p>å› ä¸ºæ˜¯ç»§æ‰¿ä¸ <code>HashMap</code> çš„ï¼Œæ‰€ä»¥ä¸€äº› <code>HashMap</code> å­˜åœ¨çš„é—®é¢˜ <code>LinkedHashMap</code> ä¹Ÿä¼šå­˜åœ¨ï¼Œæ¯”å¦‚ä¸æ”¯æŒå¹¶å‘ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;LinkedHashMap-åº•å±‚åˆ†æ&quot;&gt;&lt;a href=&quot;#LinkedHashMap-åº•å±‚åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;LinkedHashMap åº•å±‚åˆ†æ&quot;&gt;&lt;/a&gt;LinkedHashMap åº•å±‚åˆ†æ&lt;/h1&gt;&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ &lt;
      
    
    </summary>
    
      <category term="Github" scheme="https://airpoet.github.io/categories/Github/"/>
    
      <category term="Java-Interview" scheme="https://airpoet.github.io/categories/Github/Java-Interview/"/>
    
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="https://airpoet.github.io/tags/Java/"/>
    
      <category term="è½¬è½½" scheme="https://airpoet.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>Thread-common-problem</title>
    <link href="https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/Thread-common-problem/"/>
    <id>https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/Thread-common-problem/</id>
    <published>2018-07-09T03:26:48.524Z</published>
    <updated>2018-07-09T07:24:19.160Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-å¤šçº¿ç¨‹å¸¸è§é—®é¢˜"><a href="#Java-å¤šçº¿ç¨‹å¸¸è§é—®é¢˜" class="headerlink" title="Java å¤šçº¿ç¨‹å¸¸è§é—®é¢˜"></a>Java å¤šçº¿ç¨‹å¸¸è§é—®é¢˜</h1><h2 id="ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>ä¸Šä¸‹æ–‡åˆ‡æ¢</h2><p>å¤šçº¿ç¨‹å¹¶ä¸ä¸€å®šæ˜¯è¦åœ¨å¤šæ ¸å¤„ç†å™¨æ‰æ”¯æŒçš„ï¼Œå°±ç®—æ˜¯å•æ ¸ä¹Ÿæ˜¯å¯ä»¥æ”¯æŒå¤šçº¿ç¨‹çš„ã€‚<br>CPU é€šè¿‡ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å®šçš„æ—¶é—´ç‰‡ï¼Œç”±äºæ—¶é—´éå¸¸çŸ­é€šå¸¸æ˜¯å‡ åæ¯«ç§’ï¼Œæ‰€ä»¥ CPU å¯ä»¥ä¸åœçš„åˆ‡æ¢çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ä»è€Œè¾¾åˆ°äº†å¤šçº¿ç¨‹çš„æ•ˆæœã€‚</p><p>ä½†æ˜¯ç”±äºåœ¨çº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™éœ€è¦ä¿å­˜æœ¬æ¬¡æ‰§è¡Œçš„ä¿¡æ¯(<a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/MemoryAllocation.md#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8" target="_blank" rel="noopener">è¯¦è§</a>)ï¼Œåœ¨è¯¥çº¿ç¨‹è¢« CPU å‰¥å¤ºæ—¶é—´ç‰‡ååˆå†æ¬¡è¿è¡Œæ¢å¤ä¸Šæ¬¡æ‰€ä¿å­˜çš„ä¿¡æ¯çš„è¿‡ç¨‹å°±æˆä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><blockquote><p>ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯éå¸¸è€—æ•ˆç‡çš„ã€‚</p></blockquote><p>é€šå¸¸æœ‰ä»¥ä¸‹è§£å†³æ–¹æ¡ˆ:</p><ul><li>é‡‡ç”¨æ— é”ç¼–ç¨‹ï¼Œæ¯”å¦‚å°†æ•°æ®æŒ‰ç…§ <code>Hash(id)</code> è¿›è¡Œå–æ¨¡åˆ†æ®µï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†å„è‡ªåˆ†æ®µçš„æ•°æ®ï¼Œä»è€Œé¿å…ä½¿ç”¨é”ã€‚</li><li>é‡‡ç”¨ CAS(compare and swap) ç®—æ³•ï¼Œå¦‚ <code>Atomic</code> åŒ…å°±æ˜¯é‡‡ç”¨ CAS ç®—æ³•(<a href="https://github.com/crossoverJie/Java-Interview/blob/master/Threadcore.md#%E5%8E%9F%E5%AD%90%E6%80%A7" target="_blank" rel="noopener">è¯¦è§</a>)ã€‚</li><li>åˆç†çš„åˆ›å»ºçº¿ç¨‹ï¼Œé¿å…åˆ›å»ºäº†ä¸€äº›çº¿ç¨‹ä½†å…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å‡ºäº <code>waiting</code> çŠ¶æ€ï¼Œå› ä¸ºæ¯å½“ä» <code>waiting</code> çŠ¶æ€åˆ‡æ¢åˆ° <code>running</code> çŠ¶æ€éƒ½æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>æ­»é”çš„åœºæ™¯ä¸€èˆ¬æ˜¯ï¼šçº¿ç¨‹ A å’Œçº¿ç¨‹ B éƒ½åœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œæˆ–è€…æ˜¯å…¶ä¸­æŸä¸ªçº¿ç¨‹åœ¨é‡Šæ”¾é”çš„æ—¶å€™å‡ºç°å¼‚å¸¸å¦‚æ­»å¾ªç¯ä¹‹ç±»çš„ã€‚è¿™æ—¶å°±ä¼šå¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨ã€‚</p><p>å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>å°½é‡ä¸€ä¸ªçº¿ç¨‹åªè·å–ä¸€ä¸ªé”ã€‚</li><li>ä¸€ä¸ªçº¿ç¨‹åªå ç”¨ä¸€ä¸ªèµ„æºã€‚</li><li>å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œè‡³å°‘èƒ½ä¿è¯é”æœ€ç»ˆä¼šè¢«é‡Šæ”¾ã€‚</li></ul><h2 id="èµ„æºé™åˆ¶"><a href="#èµ„æºé™åˆ¶" class="headerlink" title="èµ„æºé™åˆ¶"></a>èµ„æºé™åˆ¶</h2><p>å½“åœ¨å¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹ä¸€ä¸ªçº¿ç¨‹ä¸‹è½½æŸä¸ªèµ„æºéœ€è¦ <code>1M/S</code>,å½“å¼€ 10 ä¸ªçº¿ç¨‹æ—¶é€Ÿåº¦å¹¶ä¸ä¼šä¹˜ 10 å€ï¼Œåè€Œè¿˜ä¼šå¢åŠ æ—¶é—´ï¼Œæ¯•ç«Ÿä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¾ƒè€—æ—¶ã€‚</p><p>å¦‚æœæ˜¯å—é™äºèµ„æºçš„è¯å¯ä»¥é‡‡ç”¨é›†ç¾¤æ¥å¤„ç†ä»»åŠ¡ï¼Œä¸åŒçš„æœºå™¨æ¥å¤„ç†ä¸åŒçš„æ•°æ®ï¼Œå°±ç±»ä¼¼äºå¼€å§‹æåˆ°çš„æ— é”ç¼–ç¨‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Java-å¤šçº¿ç¨‹å¸¸è§é—®é¢˜&quot;&gt;&lt;a href=&quot;#Java-å¤šçº¿ç¨‹å¸¸è§é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;Java å¤šçº¿ç¨‹å¸¸è§é—®é¢˜&quot;&gt;&lt;/a&gt;Java å¤šçº¿ç¨‹å¸¸è§é—®é¢˜&lt;/h1&gt;&lt;h2 id=&quot;ä¸Šä¸‹æ–‡åˆ‡æ¢&quot;&gt;&lt;a href=&quot;#ä¸Šä¸‹æ–‡åˆ‡æ¢&quot; c
      
    
    </summary>
    
      <category term="Github" scheme="https://airpoet.github.io/categories/Github/"/>
    
      <category term="Java-Interview" scheme="https://airpoet.github.io/categories/Github/Java-Interview/"/>
    
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="https://airpoet.github.io/tags/Java/"/>
    
      <category term="è½¬è½½" scheme="https://airpoet.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>HashMap</title>
    <link href="https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/HashMap/"/>
    <id>https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/HashMap/</id>
    <published>2018-07-09T03:26:48.519Z</published>
    <updated>2018-07-09T07:20:35.760Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HashMap-åº•å±‚åˆ†æ"><a href="#HashMap-åº•å±‚åˆ†æ" class="headerlink" title="HashMap åº•å±‚åˆ†æ"></a>HashMap åº•å±‚åˆ†æ</h1><blockquote><p>ä»¥ä¸‹åŸºäº JDK1.7 åˆ†æã€‚</p></blockquote><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn84b0ftj4j30eb0560sv.jpg" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼ŒHashMap åº•å±‚æ˜¯åŸºäºæ•°ç»„å’Œé“¾è¡¨å®ç°çš„ã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„å‚æ•°ï¼š</p><ul><li>å®¹é‡</li><li>è´Ÿè½½å› å­</li></ul><p>å®¹é‡çš„é»˜è®¤å¤§å°æ˜¯ 16ï¼Œè´Ÿè½½å› å­æ˜¯ 0.75ï¼Œå½“ <code>HashMap</code> çš„ <code>size &gt; 16*0.75</code> æ—¶å°±ä¼šå‘ç”Ÿæ‰©å®¹(å®¹é‡å’Œè´Ÿè½½å› å­éƒ½å¯ä»¥è‡ªç”±è°ƒæ•´)ã€‚</p><h2 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h2><p>é¦–å…ˆä¼šå°†ä¼ å…¥çš„ Key åš <code>hash</code> è¿ç®—è®¡ç®—å‡º hashcode,ç„¶åæ ¹æ®æ•°ç»„é•¿åº¦å–æ¨¡è®¡ç®—å‡ºåœ¨æ•°ç»„ä¸­çš„ index ä¸‹æ ‡ã€‚</p><p>ç”±äºåœ¨è®¡ç®—ä¸­ä½è¿ç®—æ¯”å–æ¨¡è¿ç®—æ•ˆç‡é«˜çš„å¤šï¼Œæ‰€ä»¥ HashMap è§„å®šæ•°ç»„çš„é•¿åº¦ä¸º <code>2&lt;sup&gt;n</code> ã€‚è¿™æ ·ç”¨ <code>2&lt;/sup&gt;n - 1</code> åšä½è¿ç®—ä¸å–æ¨¡æ•ˆæœä¸€è‡´ï¼Œå¹¶ä¸”æ•ˆç‡è¿˜è¦é«˜å‡ºè®¸å¤šã€‚</p><p>ç”±äºæ•°ç»„çš„é•¿åº¦æœ‰é™ï¼Œæ‰€ä»¥éš¾å…ä¼šå‡ºç°ä¸åŒçš„ Key é€šè¿‡è¿ç®—å¾—åˆ°çš„ index ç›¸åŒï¼Œè¿™ç§æƒ…å†µå¯ä»¥åˆ©ç”¨é“¾è¡¨æ¥è§£å†³ï¼ŒHashMap ä¼šåœ¨ <code>table[index]</code>å¤„å½¢æˆé“¾è¡¨ï¼Œé‡‡ç”¨å¤´æ’æ³•å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨ä¸­ã€‚</p><h2 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h2><p>get å’Œ put ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†ä¼ å…¥çš„ Key è®¡ç®—å‡º index ï¼Œå¦‚æœè¯¥ä½ç½®ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨å°±éœ€è¦éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€šè¿‡ <code>key.equals(k)</code> æ¥æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ ã€‚</p><h2 id="éå†æ–¹å¼"><a href="#éå†æ–¹å¼" class="headerlink" title="éå†æ–¹å¼"></a>éå†æ–¹å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;Map.Entry&lt;String, Integer&gt;&gt; entryIterator = map.entrySet().iterator();</span><br><span class="line">       <span class="keyword">while</span> (entryIterator.hasNext()) &#123;</span><br><span class="line">           Map.Entry&lt;String, Integer&gt; next = entryIterator.next();</span><br><span class="line">           System.out.println(<span class="string">"key="</span> + next.getKey() + <span class="string">" value="</span> + next.getValue());</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;String&gt; iterator = map.keySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">            String key = iterator.next();</span><br><span class="line">            System.out.println(<span class="string">"key="</span> + key + <span class="string">" value="</span> + map.get(key));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map.forEach((key,value)-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">"key="</span> + key + <span class="string">" value="</span> + value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>å¼ºçƒˆå»ºè®®</strong>ä½¿ç”¨ç¬¬ä¸€ç§ EntrySet è¿›è¡Œéå†ã€‚</p><p>ç¬¬ä¸€ç§å¯ä»¥æŠŠ key value åŒæ—¶å–å‡ºï¼Œç¬¬äºŒç§è¿˜å¾—éœ€è¦é€šè¿‡ key å–ä¸€æ¬¡ valueï¼Œæ•ˆç‡è¾ƒä½, ç¬¬ä¸‰ç§éœ€è¦ <code>JDK1.8</code> ä»¥ä¸Šï¼Œé€šè¿‡å¤–å±‚éå† tableï¼Œå†…å±‚éå†é“¾è¡¨æˆ–çº¢é»‘æ ‘ã€‚ </p><h2 id="notice"><a href="#notice" class="headerlink" title="notice"></a>notice</h2><p>åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä½¿ç”¨ <code>HashMap</code> å®¹æ˜“å‡ºç°æ­»å¾ªç¯ã€‚</p><p>å¹¶å‘åœºæ™¯å‘ç”Ÿæ‰©å®¹ï¼Œè°ƒç”¨ <code>resize()</code> æ–¹æ³•é‡Œçš„ <code>rehash()</code> æ—¶ï¼Œå®¹æ˜“å‡ºç°ç¯å½¢é“¾è¡¨ã€‚è¿™æ ·å½“è·å–ä¸€ä¸ªä¸å­˜åœ¨çš„ <code>key</code> æ—¶ï¼Œè®¡ç®—å‡ºçš„ <code>index</code> æ­£å¥½æ˜¯ç¯å½¢é“¾è¡¨çš„ä¸‹æ ‡æ—¶å°±ä¼šå‡ºç°æ­»å¾ªç¯ã€‚</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn85u0a0d9j30n20ii0tp.jpg" alt=""></p><blockquote><p>æ‰€ä»¥ HashMap åªèƒ½åœ¨å•çº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”å°½é‡çš„é¢„è®¾å®¹é‡ï¼Œå°½å¯èƒ½çš„å‡å°‘æ‰©å®¹ã€‚</p></blockquote><p>åœ¨ <code>JDK1.8</code> ä¸­å¯¹ <code>HashMap</code> è¿›è¡Œäº†ä¼˜åŒ–ï¼š<br>å½“ <code>hash</code> ç¢°æ’ä¹‹åå†™å…¥é“¾è¡¨çš„é•¿åº¦è¶…è¿‡äº†é˜ˆå€¼(é»˜è®¤ä¸º8)ï¼Œé“¾è¡¨å°†ä¼šè½¬æ¢ä¸º<strong>çº¢é»‘æ ‘</strong>ã€‚</p><p>å‡è®¾ <code>hash</code> å†²çªéå¸¸ä¸¥é‡ï¼Œä¸€ä¸ªæ•°ç»„åé¢æ¥äº†å¾ˆé•¿çš„é“¾è¡¨ï¼Œæ­¤æ—¶é‡æ–°çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ <code>O(n)</code> ã€‚</p><p>å¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œæ—¶é—´å¤æ‚åº¦å°±æ˜¯ <code>O(logn)</code> ã€‚</p><p>å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ã€‚</p><p>å¤šçº¿ç¨‹åœºæ™¯ä¸‹æ¨èä½¿ç”¨ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/ConcurrentHashMap.md" target="_blank" rel="noopener">ConcurrentHashMap</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;HashMap-åº•å±‚åˆ†æ&quot;&gt;&lt;a href=&quot;#HashMap-åº•å±‚åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;HashMap åº•å±‚åˆ†æ&quot;&gt;&lt;/a&gt;HashMap åº•å±‚åˆ†æ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;ä»¥ä¸‹åŸºäº JDK1.7 åˆ†æã€‚&lt;/
      
    
    </summary>
    
      <category term="Github" scheme="https://airpoet.github.io/categories/Github/"/>
    
      <category term="Java-Interview" scheme="https://airpoet.github.io/categories/Github/Java-Interview/"/>
    
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="https://airpoet.github.io/tags/Java/"/>
    
      <category term="è½¬è½½" scheme="https://airpoet.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>ConcurrentHashMap</title>
    <link href="https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/ConcurrentHashMap/"/>
    <id>https://airpoet.github.io/2018/07/09/Java/Interview/Java-Interview/ConcurrentHashMap/</id>
    <published>2018-07-09T03:26:48.516Z</published>
    <updated>2018-07-09T07:19:20.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ConcurrentHashMap-å®ç°åŸç†"><a href="#ConcurrentHashMap-å®ç°åŸç†" class="headerlink" title="ConcurrentHashMap å®ç°åŸç†"></a>ConcurrentHashMap å®ç°åŸç†</h1><p>ç”±äº <code>HashMap</code> æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å®¹å™¨ï¼Œä¸»è¦ä½“ç°åœ¨å®¹é‡å¤§äº<code>æ€»é‡*è´Ÿè½½å› å­</code>å‘ç”Ÿæ‰©å®¹æ—¶ä¼šå‡ºç°ç¯å½¢é“¾è¡¨ä»è€Œå¯¼è‡´æ­»å¾ªç¯ã€‚</p><p>å› æ­¤éœ€è¦æ”¯æŒçº¿ç¨‹å®‰å…¨çš„å¹¶å‘å®¹å™¨ <code>ConcurrentHashMap</code> ã€‚</p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fn2f5pgxinj30dw0730t7.jpg" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯ç”± <code>Segment</code> æ•°ç»„ã€<code>HashEntry</code> æ•°ç»„ç»„æˆï¼Œå’Œ <code>HashMap</code> ä¸€æ ·ï¼Œä»ç„¶æ˜¯æ•°ç»„åŠ é“¾è¡¨ç»„æˆã€‚</p><p><code>ConcurrentHashMap</code> é‡‡ç”¨äº†åˆ†æ®µé”æŠ€æœ¯ï¼Œå…¶ä¸­ <code>Segment</code> ç»§æ‰¿äº <code>ReentrantLock</code>ã€‚ä¸ä¼šåƒ <code>HashTable</code> é‚£æ ·ä¸ç®¡æ˜¯ <code>put</code> è¿˜æ˜¯ <code>get</code> æ“ä½œéƒ½éœ€è¦åšåŒæ­¥å¤„ç†ï¼Œç†è®ºä¸Š ConcurrentHashMap æ”¯æŒ <code>CurrencyLevel</code> (Segment æ•°ç»„æ•°é‡)çš„çº¿ç¨‹å¹¶å‘ã€‚æ¯å½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®ä¸€ä¸ª <code>Segment</code> æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ <code>Segment</code>ã€‚</p><h2 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h2><p><code>ConcurrentHashMap</code> çš„ <code>get</code> æ–¹æ³•æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦åŠ é”ã€‚</p><p>åªéœ€è¦å°† <code>Key</code> é€šè¿‡ <code>Hash</code> ä¹‹åå®šä½åˆ°å…·ä½“çš„ <code>Segment</code> ï¼Œå†é€šè¿‡ä¸€æ¬¡ <code>Hash</code> å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Šã€‚ç”±äº <code>HashEntry</code> ä¸­çš„ <code>value</code> å±æ€§æ˜¯ç”¨ <code>volatile</code> å…³é”®è¯ä¿®é¥°çš„ï¼Œä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–æ—¶éƒ½æ˜¯æœ€æ–°å€¼(<a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/Threadcore.md#%E5%8F%AF%E8%A7%81%E6%80%A7" target="_blank" rel="noopener">volatile ç›¸å…³çŸ¥è¯†ç‚¹</a>)ã€‚</p><h2 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h2><p>å†…éƒ¨ <code>HashEntry</code> ç±» ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V value;</span><br><span class="line">    <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    HashEntry(<span class="keyword">int</span> hash, K key, V value, HashEntry&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è™½ç„¶ HashEntry ä¸­çš„ value æ˜¯ç”¨ <code>volatile</code> å…³é”®è¯ä¿®é¥°çš„ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯å¹¶å‘çš„åŸå­æ€§ï¼Œæ‰€ä»¥ put æ“ä½œæ—¶ä»ç„¶éœ€è¦åŠ é”å¤„ç†ã€‚</p><p>é¦–å…ˆä¹Ÿæ˜¯é€šè¿‡ Key çš„ Hash å®šä½åˆ°å…·ä½“çš„ Segmentï¼Œåœ¨ put ä¹‹å‰ä¼šè¿›è¡Œä¸€æ¬¡æ‰©å®¹æ ¡éªŒã€‚è¿™é‡Œæ¯” HashMap è¦å¥½çš„ä¸€ç‚¹æ˜¯ï¼šHashMap æ˜¯æ’å…¥å…ƒç´ ä¹‹åå†çœ‹æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œæœ‰å¯èƒ½æ‰©å®¹ä¹‹ååç»­å°±æ²¡æœ‰æ’å…¥å°±æµªè´¹äº†æœ¬æ¬¡æ‰©å®¹(æ‰©å®¹éå¸¸æ¶ˆè€—æ€§èƒ½)ã€‚</p><p>è€Œ ConcurrentHashMap ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯å…ˆå°†æ•°æ®æ’å…¥ä¹‹åå†æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹‹åå†åšæ’å…¥ã€‚</p><h2 id="size-æ–¹æ³•"><a href="#size-æ–¹æ³•" class="headerlink" title="size æ–¹æ³•"></a>size æ–¹æ³•</h2><p>æ¯ä¸ª <code>Segment</code> éƒ½æœ‰ä¸€ä¸ª <code>volatile</code> ä¿®é¥°çš„å…¨å±€å˜é‡ <code>count</code> ,æ±‚æ•´ä¸ª <code>ConcurrentHashMap</code> çš„ <code>size</code> æ—¶å¾ˆæ˜æ˜¾å°±æ˜¯å°†æ‰€æœ‰çš„ <code>count</code> ç´¯åŠ å³å¯ã€‚ä½†æ˜¯ <code>volatile</code> ä¿®é¥°çš„å˜é‡å´ä¸èƒ½ä¿è¯å¤šçº¿ç¨‹çš„åŸå­æ€§ï¼Œæ‰€æœ‰ç›´æ¥ç´¯åŠ å¾ˆå®¹æ˜“å‡ºç°å¹¶å‘é—®é¢˜ã€‚</p><p>ä½†å¦‚æœæ¯æ¬¡è°ƒç”¨ <code>size</code> æ–¹æ³•å°†å…¶ä½™çš„ä¿®æ”¹æ“ä½œåŠ é”æ•ˆç‡ä¹Ÿå¾ˆä½ã€‚æ‰€ä»¥åšæ³•æ˜¯å…ˆå°è¯•ä¸¤æ¬¡å°† <code>count</code> ç´¯åŠ ï¼Œå¦‚æœå®¹å™¨çš„ <code>count</code> å‘ç”Ÿäº†å˜åŒ–å†åŠ é”æ¥ç»Ÿè®¡ <code>size</code>ã€‚</p><p>è‡³äº <code>ConcurrentHashMap</code> æ˜¯å¦‚ä½•çŸ¥é“åœ¨ç»Ÿè®¡æ—¶å¤§å°å‘ç”Ÿäº†å˜åŒ–å‘¢ï¼Œæ¯ä¸ª <code>Segment</code> éƒ½æœ‰ä¸€ä¸ª <code>modCount</code> å˜é‡ï¼Œæ¯å½“è¿›è¡Œä¸€æ¬¡ <code>put remove</code> ç­‰æ“ä½œï¼Œ<code>modCount</code> å°†ä¼š +1ã€‚åªè¦ <code>modCount</code> å‘ç”Ÿäº†å˜åŒ–å°±è®¤ä¸ºå®¹å™¨çš„å¤§å°ä¹Ÿåœ¨å‘ç”Ÿå˜åŒ–ã€‚</p><blockquote><p>ä»¥ä¸Šå†…å®¹ base JDK1.7ï¼Œ1.8 çš„å®ç°æ›´åŠ å¤æ‚ä½†æ˜¯åŸç†ç±»ä¼¼ï¼Œå»ºè®®åœ¨ 1.7 çš„åŸºç¡€ä¸ŠæŸ¥çœ‹æºç ã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ConcurrentHashMap-å®ç°åŸç†&quot;&gt;&lt;a href=&quot;#ConcurrentHashMap-å®ç°åŸç†&quot; class=&quot;headerlink&quot; title=&quot;ConcurrentHashMap å®ç°åŸç†&quot;&gt;&lt;/a&gt;ConcurrentHashMap å®ç°
      
    
    </summary>
    
      <category term="Github" scheme="https://airpoet.github.io/categories/Github/"/>
    
      <category term="Java-Interview" scheme="https://airpoet.github.io/categories/Github/Java-Interview/"/>
    
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="https://airpoet.github.io/tags/Java/"/>
    
      <category term="è½¬è½½" scheme="https://airpoet.github.io/tags/%E8%BD%AC%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>çˆ¬è™«çš„ç®€å•å…¥é—¨</title>
    <link href="https://airpoet.github.io/2018/07/06/Python/Python%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/"/>
    <id>https://airpoet.github.io/2018/07/06/Python/Pythonç®€å•å…¥é—¨/</id>
    <published>2018-07-06T01:29:54.058Z</published>
    <updated>2018-07-23T07:47:02.388Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-æ•°æ®æ¥æº"><a href="#1-æ•°æ®æ¥æº" class="headerlink" title="1.æ•°æ®æ¥æº"></a>1.æ•°æ®æ¥æº</h2><ul><li>ä¸šåŠ¡åº“</li><li>æ—¥å¿—æ•°æ®</li><li>å…¬å…±æ•°æ®</li><li>è´­ä¹° â€“ å€’å– â€“ æœ‰æ³•å¾‹é£é™©</li></ul><h2 id="2-çˆ¬è™«å·¥ç¨‹å¸ˆæŠ€èƒ½æ¸…å•"><a href="#2-çˆ¬è™«å·¥ç¨‹å¸ˆæŠ€èƒ½æ¸…å•" class="headerlink" title="2.çˆ¬è™«å·¥ç¨‹å¸ˆæŠ€èƒ½æ¸…å•"></a>2.çˆ¬è™«å·¥ç¨‹å¸ˆæŠ€èƒ½æ¸…å•</h2><ol><li>pythonç¼–ç¨‹è¯­è¨€åŸºç¡€</li><li>HTTPåè®®</li><li>html,css,javascriptåŸºæœ¬webæŠ€èƒ½</li><li>mysql/mongodb/redisç­‰å­˜å‚¨ç³»ç»Ÿ</li><li>scrapy/pyspider/django</li><li>æŠ“åŒ…å·¥å…·å’Œç½‘é¡µåˆ†æå·¥å…·(æ­£åˆ™ï¼Œbs4ï¼Œxpathï¼Œselenuim)</li><li>json/csv/db</li></ol><h2 id="3-Python3åŸºç¡€å†…å®¹"><a href="#3-Python3åŸºç¡€å†…å®¹" class="headerlink" title="3.Python3åŸºç¡€å†…å®¹"></a>3.Python3åŸºç¡€å†…å®¹</h2><p><a href="http://www.liaoxuefeng.com/" target="_blank" rel="noopener">å»–é›ªå³°Python3æ•™ç¨‹(æ–‡æ¡£)</a><br><a href="http://www.runoob.com/python3/python3-tutorial.html" target="_blank" rel="noopener">èœé¸Ÿæ•™ç¨‹Python3æ•™ç¨‹(æ–‡æ¡£)</a></p><p>pythonç¼–ç¨‹è¯­è¨€ç®€å•ä»‹ç»ï¼ˆäº§ç”ŸèƒŒæ™¯ï¼Œä¼˜ç¼ºç‚¹ï¼Œæµè¡Œåº¦ï¼‰<br>pythonçš„å¼€å‘ç¯å¢ƒæ­å»ºï¼ˆlinuxï¼Œwindowsï¼Œpythonï¼Œpycharmï¼‰<br>pythonçš„hello world<br>pythonå…³é”®å­—æŸ¥çœ‹<br>pythonçš„å˜é‡å®šä¹‰<br>pythonçš„æ•°æ®ç±»å‹ï¼ˆNumber String List Tuple Set Dictï¼‰<br>pythonçš„æ³¨é‡Šï¼ˆå•è¡Œå’Œæ®µè½ï¼‰<br>pythonçš„è¾“å…¥è¾“å‡ºï¼ˆprint å’Œ inputï¼‰<br>pythonæ•°æ®ç±»å‹è½¬æ¢/å¸¸ç”¨æ•°å€¼è¿ç®—/ç±»å‹åˆ¤æ–­<br>pythonçš„é›†åˆï¼Œåˆ—è¡¨ï¼Œå…ƒç»„ï¼Œå­—å…¸<br>pythonçš„æµç¨‹æ§åˆ¶forå’Œwhileå’Œifï¼ˆbreakï¼Œ continueï¼Œ passï¼‰<br>pythonçš„åˆ‡ç‰‡<br>pythonçš„ä»£ç ç¼©è¿›ï¼ˆæ¢è¡Œï¼Œæ®µè½ï¼‰<br>pythonå‡½æ•°ï¼ˆè‡ªå®šä¹‰å‡½æ•°ï¼Œå¸¸ç”¨å†…ç½®æ¨¡å—ï¼Œå¸¸ç”¨å‡½æ•°ï¼Œå‡½æ•°è°ƒç”¨ï¼‰<br>pythonå¼‚å¸¸<br>pythonæ¨¡å—ï¼ˆå†…ç½®æ¨¡å—ï¼Œå¯¼å…¥æ¨¡å—ï¼Œè‡ªå®šä¹‰æ¨¡å—ï¼‰<br>pythonè¿­ä»£å™¨å’Œç”Ÿæˆå™¨<br>pythoné¢å‘å¯¹è±¡<br>pythonè¯»å†™æ–‡ä»¶IO<br>pythonæ•°æ®åº“å’ŒJSONå’ŒCSV</p><h4 id="3-1-åŸºæœ¬è¯­æ³•è®°å½•"><a href="#3-1-åŸºæœ¬è¯­æ³•è®°å½•" class="headerlink" title="3.1 åŸºæœ¬è¯­æ³•è®°å½•"></a>3.1 åŸºæœ¬è¯­æ³•è®°å½•</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŒæ—¶éå†2ä¸ªé•¿åº¦ç›¸åŒçš„ list</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(companys)):</span><br><span class="line">    print(companys[i] + <span class="string">","</span> + fincs[i])</span><br><span class="line">    </span><br><span class="line">jobs <span class="comment"># å·¥ä½œå²—ä½</span></span><br><span class="line">companys <span class="comment">#å…¬å¸å</span></span><br><span class="line">m</span><br><span class="line">moneys <span class="comment"># è–ªèµ„</span></span><br><span class="line">edus <span class="comment"># å­¦å†</span></span><br><span class="line">exps <span class="comment"># ç»éªŒ</span></span><br><span class="line">cmptypes <span class="comment"># å…¬å¸ç±»å‹</span></span><br><span class="line">fincs  <span class="comment"># èèµ„çŠ¶æ€</span></span><br><span class="line">true_tags <span class="comment">#job æ ‡ç­¾</span></span><br><span class="line">c_b_s  <span class="comment"># å…¬å¸ä¼˜åŠ¿</span></span><br></pre></td></tr></table></figure><h2 id="4-æœç´¢å¼•æ“åŸºæœ¬å·¥ä½œåŸç†"><a href="#4-æœç´¢å¼•æ“åŸºæœ¬å·¥ä½œåŸç†" class="headerlink" title="4.æœç´¢å¼•æ“åŸºæœ¬å·¥ä½œåŸç†"></a>4.æœç´¢å¼•æ“åŸºæœ¬å·¥ä½œåŸç†</h2><p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-06-023330.png" alt="image-20180706103329915"></p><h2 id="5-python-åŸºæœ¬æ“ä½œ-amp-çˆ¬è™«ä»£ç "><a href="#5-python-åŸºæœ¬æ“ä½œ-amp-çˆ¬è™«ä»£ç " class="headerlink" title="5.python åŸºæœ¬æ“ä½œ &amp; çˆ¬è™«ä»£ç "></a>5.python åŸºæœ¬æ“ä½œ &amp; çˆ¬è™«ä»£ç </h2><h4 id="5-1åŸºæœ¬è¯­æ³•"><a href="#5-1åŸºæœ¬è¯­æ³•" class="headerlink" title="5.1åŸºæœ¬è¯­æ³•"></a>5.1åŸºæœ¬è¯­æ³•</h4><p><a href="https://github.com/airpoet/bigdata/tree/master/Python_Project/python_basic" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/tree/master/Python_Project/python_basic</a></p><h4 id="5-2-é«˜çº§è¯­æ³•-tcp-udp-å¤šçº¿ç¨‹-é¢å‘å¯¹è±¡OOP-py-æ“ä½œ-mysql"><a href="#5-2-é«˜çº§è¯­æ³•-tcp-udp-å¤šçº¿ç¨‹-é¢å‘å¯¹è±¡OOP-py-æ“ä½œ-mysql" class="headerlink" title="5.2 é«˜çº§è¯­æ³•(tcp,udp / å¤šçº¿ç¨‹ /  é¢å‘å¯¹è±¡OOP /  py æ“ä½œ mysql)"></a>5.2 é«˜çº§è¯­æ³•(tcp,udp / å¤šçº¿ç¨‹ /  é¢å‘å¯¹è±¡OOP /  py æ“ä½œ mysql)</h4><p><a href="https://github.com/airpoet/bigdata/tree/master/Python_Project/mypython-1" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/tree/master/Python_Project/mypython-1</a></p><h4 id="5-3-çˆ¬è™«"><a href="#5-3-çˆ¬è™«" class="headerlink" title="5.3 çˆ¬è™«"></a>5.3 çˆ¬è™«</h4><p><a href="https://github.com/airpoet/bigdata/tree/master/Python_Project/spiderDemo" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/tree/master/Python_Project/spiderDemo</a></p><h4 id="5-5-python-ä¸-Hadoop-Spark-ç”Ÿæ€çš„äº¤äº’"><a href="#5-5-python-ä¸-Hadoop-Spark-ç”Ÿæ€çš„äº¤äº’" class="headerlink" title="5.5 python ä¸ Hadoop / Spark ç”Ÿæ€çš„äº¤äº’"></a>5.5 python ä¸ Hadoop / Spark ç”Ÿæ€çš„äº¤äº’</h4><p><a href="https://github.com/airpoet/bigdata/tree/master/Spark_Project/HBasePythonDemo" target="_blank" rel="noopener">https://github.com/airpoet/bigdata/tree/master/Spark_Project/HBasePythonDemo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-æ•°æ®æ¥æº&quot;&gt;&lt;a href=&quot;#1-æ•°æ®æ¥æº&quot; class=&quot;headerlink&quot; title=&quot;1.æ•°æ®æ¥æº&quot;&gt;&lt;/a&gt;1.æ•°æ®æ¥æº&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ä¸šåŠ¡åº“&lt;/li&gt;
&lt;li&gt;æ—¥å¿—æ•°æ®&lt;/li&gt;
&lt;li&gt;å…¬å…±æ•°æ®&lt;/li&gt;
&lt;li&gt;è´­ä¹° â€“ å€’å–
      
    
    </summary>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/categories/Hadoop/"/>
    
      <category term="çˆ¬è™«" scheme="https://airpoet.github.io/categories/Hadoop/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Hadoop" scheme="https://airpoet.github.io/tags/Hadoop/"/>
    
      <category term="çˆ¬è™«" scheme="https://airpoet.github.io/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>CentOS6.xä¸‹Python3çš„å®‰è£…</title>
    <link href="https://airpoet.github.io/2018/07/05/Python/CentOS6.x%E4%B8%8BPython3%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>https://airpoet.github.io/2018/07/05/Python/CentOS6.xä¸‹Python3çš„å®‰è£…/</id>
    <published>2018-07-05T06:03:43.250Z</published>
    <updated>2018-07-05T06:06:10.115Z</updated>
    
    <content type="html"><![CDATA[<h3 id="python-3-6-4åœ¨centos-6-7å®‰è£…ï¼š"><a href="#python-3-6-4åœ¨centos-6-7å®‰è£…ï¼š" class="headerlink" title="python-3.6.4åœ¨centos-6.7å®‰è£…ï¼š"></a><strong>python-3.6.4åœ¨centos-6.7å®‰è£…ï¼š</strong></h3><blockquote><p>è¯¦ç»†æ­¥éª¤ï¼š</p></blockquote><p><strong>1ã€å®‰è£…ä¸€äº›ä¾èµ–çš„è½¯ä»¶åŒ…</strong><br>yum -y groupinstall â€œDevelopment toolsâ€<br>yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel<br>yum -y install yum-plugin-remove-with-leaves</p><p><strong>2ã€ä¸‹è½½Python3.6çš„æºç åŒ…å¹¶ç¼–è¯‘ï¼ˆåœ¨/usr/localç›®å½•ä¸‹ï¼‰</strong><br>wget <a href="https://www.python.org/ftp/python/3.6.4/Python-3.6.4.tgz" target="_blank" rel="noopener">https://www.python.org/ftp/python/3.6.4/Python-3.6.4.tgz</a><br>tar -vxf Python-3.6.4.tgz -C ~/apps<br>cd Python-3.6.4<br>mkdir /usr/local/python3<br>./configure â€“prefix=/usr/local/python3 â€“enable-shared â€“enable-optimizations<br>make<br>make install</p><p><strong>3ã€æŠŠæ–°å®‰è£…çš„python3.6æ‹·è´åˆ°/usr/bin/ç›®å½•ä¸‹</strong><br>cp /usr/local/python3/bin/python3.6 /usr/bin/python3.6<br>ç„¶åæ–°å»ºå¿«æ·æ–¹å¼ï¼š<br>ln -s /usr/bin/python3.6 /usr/bin/python3</p><p><strong>4ã€ä¸€æ­¥æ“ä½œï¼š</strong><br>echo /usr/local/python3/lib/ &gt;&gt; /etc/ld.so.conf.d/local.conf<br>ldconfig</p><p><strong>5ã€éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ</strong><br>/usr/bin/python3 â€“version</p><p><strong>6ã€é…ç½®ç¯å¢ƒå˜é‡</strong><br>vim /etc/profile<br>export PYTHON_HOME=/usr/local/python3<br>export PATH=$PATH:$PYTHON_HOME/bin<br>source /etc/profile</p><p><strong>7ã€å°è¯•å®‰è£…ä¸€ä¸ªæ¨¡å—</strong><br>pip3 install beautifulsoup4</p><p><strong>8ã€ä¿®æ”¹pipæºï¼š</strong><br>mkdir ~/.pip<br>cd ~/.pip<br>vi pip.conf<br>[global]<br>trusted-host =  pypi.douban.com<br>index-url = <a href="http://pypi.douban.com/simple" target="_blank" rel="noopener">http://pypi.douban.com/simple</a></p><p><strong>9ã€å®‰è£…numpy</strong><br>pip3 install numpy</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;python-3-6-4åœ¨centos-6-7å®‰è£…ï¼š&quot;&gt;&lt;a href=&quot;#python-3-6-4åœ¨centos-6-7å®‰è£…ï¼š&quot; class=&quot;headerlink&quot; title=&quot;python-3.6.4åœ¨centos-6.7å®‰è£…ï¼š&quot;&gt;&lt;/a&gt;&lt;strong&gt;
      
    
    </summary>
    
      <category term="Python" scheme="https://airpoet.github.io/categories/Python/"/>
    
    
      <category term="åŸåˆ›" scheme="https://airpoet.github.io/tags/%E5%8E%9F%E5%88%9B/"/>
    
      <category term="æŠ€æœ¯" scheme="https://airpoet.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Python" scheme="https://airpoet.github.io/tags/Python/"/>
    
  </entry>
  
</feed>
