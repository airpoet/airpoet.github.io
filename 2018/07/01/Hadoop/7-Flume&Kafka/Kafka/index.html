<!DOCTYPE html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="原创,技术,Hadoop,Kafka," />





  <link rel="alternate" href="/atom.xml" title="A.P的文艺杂谈" type="application/atom+xml" />






<meta name="description" content="1.概览分布式流处理平台。  分布式, 副本, 容错的分布式存储流. 在系统之间构建实时数据流管道。  以topic分类对记录进行存储  每个记录包含key-value+timestamp  每秒钟百万消息吞吐量。  Java 的 JMS 有2种模式: 发布订阅模式( 拿到的是 copy) &amp;amp; 队列模式(queue):  kafka 通过 group 把这两种模式完美的结合起来  如果想要">
<meta name="keywords" content="原创,技术,Hadoop,Kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka">
<meta property="og:url" content="https://airpoet.github.io/2018/07/01/Hadoop/7-Flume&Kafka/Kafka/index.html">
<meta property="og:site_name" content="A.P的文艺杂谈">
<meta property="og:description" content="1.概览分布式流处理平台。  分布式, 副本, 容错的分布式存储流. 在系统之间构建实时数据流管道。  以topic分类对记录进行存储  每个记录包含key-value+timestamp  每秒钟百万消息吞吐量。  Java 的 JMS 有2种模式: 发布订阅模式( 拿到的是 copy) &amp;amp; 队列模式(queue):  kafka 通过 group 把这两种模式完美的结合起来  如果想要">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032535.png">
<meta property="og:image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032546.png">
<meta property="og:image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032635.png">
<meta property="og:image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032302.png">
<meta property="og:updated_time" content="2018-07-03T17:28:46.335Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka">
<meta name="twitter:description" content="1.概览分布式流处理平台。  分布式, 副本, 容错的分布式存储流. 在系统之间构建实时数据流管道。  以topic分类对记录进行存储  每个记录包含key-value+timestamp  每秒钟百万消息吞吐量。  Java 的 JMS 有2种模式: 发布订阅模式( 拿到的是 copy) &amp;amp; 队列模式(queue):  kafka 通过 group 把这两种模式完美的结合起来  如果想要">
<meta name="twitter:image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032535.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'airpoet'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://airpoet.github.io/2018/07/01/Hadoop/7-Flume&Kafka/Kafka/"/>





  <title>Kafka | A.P的文艺杂谈</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">A.P的文艺杂谈</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://airpoet.github.io/2018/07/01/Hadoop/7-Flume&Kafka/Kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="airpoet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p6i5vzkfk.bkt.clouddn.com/study/2018-06-14-045043.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A.P的文艺杂谈">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kafka</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-01T21:55:50+08:00">
                2018-07-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-07-04T01:28:46+08:00">
                2018-07-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/Kafka/" itemprop="url" rel="index">
                    <span itemprop="name">Kafka</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/01/Hadoop/7-Flume&Kafka/Kafka/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/01/Hadoop/7-Flume&Kafka/Kafka/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-概览"><a href="#1-概览" class="headerlink" title="1.概览"></a>1.概览</h2><p><strong>分布式流处理平台。</strong> </p>
<p>分布式, 副本, 容错的分布式存储流.</p>
<p>在系统之间构建实时数据流管道。 </p>
<p>以topic分类对记录进行存储 </p>
<p>每个记录包含key-value+timestamp </p>
<p>每秒钟百万消息吞吐量。 </p>
<p><strong>Java 的 JMS</strong> 有2种模式: <strong>发布订阅模式( 拿到的是 copy) &amp; 队列模式(queue): </strong></p>
<p>kafka 通过 group 把这两种模式完美的结合起来</p>
<ul>
<li>如果想要实现queue 模式, 就把消费者放在同一组, 此组中只能有一个成员来消费此消息</li>
<li>想要实现发布订阅模式, 就把每个消费者各自一组, 每个人都可以拿到一个消息副本</li>
</ul>
<p><strong>关键词:</strong></p>
<ul>
<li>producer             //消息生产者</li>
<li>consumer              //消息消费者</li>
<li>consumer group        //消费者组</li>
<li>kafka server          //broker,kafka服务器</li>
<li>topic                     //主题,副本数,分区.</li>
<li>zookeeper            //hadoop namenoade + RM HA | hbase | kafka</li>
</ul>
<p>优化方案: </p>
<ul>
<li>把磁盘挂载在某个目录, 然后让这个目录, 只是存储某个分区的数据</li>
</ul>
<h4 id="kafka-的要点"><a href="#kafka-的要点" class="headerlink" title="kafka 的要点"></a>kafka 的要点</h4><p>一条消息是存在一个分区的</p>
<p>副本–可靠性</p>
<p>分区–高效性  =&gt; 并发访问</p>
<p>分区(partition)是 producer 通过负载均衡选择的</p>
<p>一个分区存着多条消息, 消息是有序的</p>
<p>一个分区内的消息只能被一个组内的一个成员消费</p>
<p>topic 是在 kafka server 上</p>
<p>topic 包含 副本数, 分区</p>
<p>producer &amp; consumer 都是针对 topic 来操作的</p>
<p>kafka 的 consumer 是拉模式,  从 kafka去pull 消息, 实时计算框架有多大能力, 就 pull 多少</p>
<p>所以 kafka 一般都用在实时/准实时 计算中</p>
<p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032535.png" alt="image-20180703112535633"></p>
<p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032546.png" alt="image-20180703112545937"></p>
<p><strong>顺序读写</strong></p>
<ul>
<li>追加数据, 是追加到最后</li>
<li>读取是从开头读取</li>
<li>可用 offset 跳转到指定的数据段</li>
<li>数据可重复消费</li>
</ul>
<p><strong>Consumers</strong></p>
<ul>
<li>一条数据只能被同组内一个成员消费</li>
<li>不同组的可以消费同一个数据</li>
</ul>
<p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032635.png" alt="image-20180703112634857"></p>
<p><strong>SSD读写速度: 1200 ~ 3500 MB/s</strong></p>
<p><img src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-07-03-032302.png" alt="image-20180703112302238"></p>
<p><strong>注意点:</strong> </p>
<ul>
<li>Kafka 的分区数, 可以动态调整</li>
<li>Kafka 的每个分区都有对应的冗余数量, 默认是1</li>
<li>每个分区如果有多个副本, 这些副本中, 会有一个是 active 的状态, 负责读写, 其它的都是 standby 的状态</li>
<li>对于HDFS和kafka的  block  partition 对于不同的文件或者topic来说，都可以有不同的副本数！(每个 topic 可以单独设置)<br>设置的副本数不能超过broker的数量！！！</li>
</ul>
<hr>
<h4 id="Kafka-的大致工作模式："><a href="#Kafka-的大致工作模式：" class="headerlink" title="Kafka 的大致工作模式："></a><strong>Kafka 的大致工作模式：</strong></h4><p>1、启动 ZooKeeper 的 server</p>
<p>2、启动 Kafka 的 server</p>
<p>3、Producer 生产数据，然后通过 ZooKeeper 找到 Broker，再将数据 push 到 Broker 保存</p>
<p>4、Consumer 通过 ZooKeeper 找到 Broker，然后再主动 pull 数据</p>
<h2 id="2-安装-kafka"><a href="#2-安装-kafka" class="headerlink" title="2.安装 kafka"></a>2.安装 kafka</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">0.选择cs1 ~ cs6,  6台主机都安装kafka</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">1.准备zk</span><br><span class="line">略</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">2.jdk</span><br><span class="line">略</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">3.tar文件</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">4.环境变量</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">略</span><br><span class="line">5.配置kafka</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    [kafka/config/server.properties]</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 这里每台不一样</span></span><br><span class="line">    broker.id=1</span><br><span class="line">    ...</span><br><span class="line">    listeners=PLAINTEXT://:9092</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 这里每台不一样</span></span><br><span class="line">    advertised.listeners=PLAINTEXT://cs1:9092</span><br><span class="line">    host.name=cs1</span><br><span class="line">    ...</span><br><span class="line">    log.dirs=/home/centos/kafka/logs</span><br><span class="line">    ...</span><br><span class="line">    zookeeper.connect=s201:2181,s202:2181,s203:2181</span><br><span class="line"></span><br><span class="line">6.分发整个文件 &amp; 符号链接,  .zshrc配置文件,     同时修改每个server.properties 文件的broker.id参数 </span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">7.启动kafka服务器</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    a)先启动zk</span><br><span class="line">    b)启动kafka       </span><br><span class="line">    b1)前台启动</span><br><span class="line">    [cs2 ~ cs4]</span><br><span class="line">    [ap@cs1]~% kafka-server-start.sh /home/ap/apps/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">    b2)后台启动</span><br><span class="line">    <span class="comment"># 这里日志直接打印在控制台</span></span><br><span class="line">    $&gt; kafka-server-start.sh  -daemon  /home/ap/apps/kafka/config/server.properties     </span><br><span class="line">    [或者]</span><br><span class="line">    <span class="comment"># 这样能把日志输出到文件中</span></span><br><span class="line">    nohup kafka-server-start.sh /home/ap/apps/kafka/config/server.properties 1&gt;&lt;sub&gt;/kafka/logs/kafka_std.log  2&gt;&lt;/sub&gt;/kafka/logs/kafka_err.log &amp;</span><br><span class="line"></span><br><span class="line">    c)验证kafka服务器是否启动</span><br><span class="line">    $&gt;netstat -anop | grep 9092</span><br><span class="line"></span><br><span class="line">8.创建主题 </span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    [ap@cs2]~% kafka-topics.sh --create  --zookeeper cs1:2181 --replication-factor 3 --partitions 3 --topic <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">9.查看主题列表</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">[ap@cs2]~% kafka-topics.sh --list --zookeeper cs1:2181</span><br><span class="line"></span><br><span class="line">10.启动控制台生产者  (前提是 操作本机 &amp; cs2 上已经启动kafka服务)</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    注意 : producer 不直接连接 zk, 而是连接 broker, 也就是 kafka server. </span><br><span class="line">    其它的都是连 zk</span><br><span class="line">    如果producer 连的某一台挂掉的话, 可以在 --broker-list 后面, 加上多台服务器,用逗号隔开</span><br><span class="line">    [ap@cs2]~% kafka-console-producer.sh --broker-list cs2:9092 --topic <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">11.启动控制台消费者 (前提是 操作本机 &amp; cs2 上已经启动卡夫卡服务)</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">    <span class="comment"># 使用bootstrap-server参数 替代zookeeper</span></span><br><span class="line">    Using the ConsoleConsumer with old consumer is deprecated and will be removed <span class="keyword">in</span> a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].</span><br><span class="line">    [ap@cs3]~% kafka-console-consumer.sh --bootstrap-server cs2:9092 --topic <span class="built_in">test</span> --from-beginning</span><br><span class="line"></span><br><span class="line">12.在生产者控制台输入hello world</span><br><span class="line">---------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<h2 id="3-kafka集群在zk的配置"><a href="#3-kafka集群在zk的配置" class="headerlink" title="3.kafka集群在zk的配置"></a>3.kafka集群在zk的配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/controller            ===&gt;    &#123;<span class="string">"version"</span>:1,<span class="string">"brokerid"</span>:202,<span class="string">"timestamp"</span>:<span class="string">"1490926369148"</span></span><br><span class="line"></span><br><span class="line">/controller_epoch    ===&gt;    1</span><br><span class="line"></span><br><span class="line">/brokers</span><br><span class="line">/brokers/ids</span><br><span class="line">/brokers/ids/202    ===&gt;    &#123;<span class="string">"jmx_port"</span>:-1,<span class="string">"timestamp"</span>:<span class="string">"1490926370304"</span>,<span class="string">"endpoints"</span>:[<span class="string">"PLAINTEXT://s202:9092"</span>],<span class="string">"host"</span>:<span class="string">"s202"</span>,<span class="string">"version"</span>:3,<span class="string">"port"</span>:9092&#125;</span><br><span class="line">/brokers/ids/203</span><br><span class="line">/brokers/ids/204    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/brokers/topics/<span class="built_in">test</span>/partitions/0/state ===&gt;&#123;<span class="string">"controller_epoch"</span>:1,<span class="string">"leader"</span>:203,<span class="string">"version"</span>:1,<span class="string">"leader_epoch"</span>:0,<span class="string">"isr"</span>:[203,204,202]&#125;</span><br><span class="line">/brokers/topics/<span class="built_in">test</span>/partitions/1/state ===&gt;...</span><br><span class="line">/brokers/topics/<span class="built_in">test</span>/partitions/2/state ===&gt;...</span><br><span class="line"></span><br><span class="line">/brokers/seqid        ===&gt; null</span><br><span class="line"></span><br><span class="line">/admin</span><br><span class="line">/admin/delete_topics/<span class="built_in">test</span>        ===&gt;标记删除的主题, 但是实际删除后, 这里没出现</span><br><span class="line"></span><br><span class="line">/isr_change_notification</span><br><span class="line"></span><br><span class="line">/consumers/xxxx/</span><br><span class="line">/config</span><br></pre></td></tr></table></figure>
<h2 id="4-kafka-主题-amp-副本操作"><a href="#4-kafka-主题-amp-副本操作" class="headerlink" title="4.kafka 主题&amp;副本操作"></a>4.kafka 主题&amp;副本操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------------------</span><br><span class="line">PS: 查看帮助套路</span><br><span class="line">* 如果看 topic 相关帮助</span><br><span class="line">    * bin/kafka-topic.sh  脚本直接回车, 查看帮助</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">查看主题列表</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">[ap@cs2]~% kafka-topics.sqqh --list --zookeeper cs1:2181</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建主题</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">    repliation_factor 2 partitions 5</span><br><span class="line"></span><br><span class="line">    $&gt;kafka-topics.sh --zookeeper cs2:2181 --replication-factor 2 --partitions 3 --create --topic test2</span><br><span class="line"></span><br><span class="line">    2 x 3  = 6        //个文件夹</span><br><span class="line"></span><br><span class="line">    2份副本, 每份副本有3个分区</span><br><span class="line">    总分区数为 6</span><br><span class="line">    每个分区都有一个 leader,  follower 就是其它的副本</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">删除主题</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">[ap@cs2]~% kafka-topics.sh --zookeeper cs1:2181,cs2:2181,cs3:2181  --delete --topic kafka_test1</span><br><span class="line"></span><br><span class="line">查看主题描述</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">[ap@cs2]~% kafka-topics.sh --zookeeper cs1:2181,cs2:2181,cs3:2181  --describe --topic kafka_test1</span><br><span class="line"></span><br><span class="line">增加/删除分区数</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">kafka-topics.sh \</span><br><span class="line">--alter \</span><br><span class="line">--zookeeper cs1:2181,cs2:2181,cs3:2181 \</span><br><span class="line">--topic kafka_test1 \</span><br><span class="line">--partitions 20</span><br><span class="line">--------------</span><br><span class="line">kafka-topics.sh \</span><br><span class="line">--alter \</span><br><span class="line">--zookeeper hadoop02:2181,hadoop03:2181,hadoop04:2181 \ --topic kafka_test \</span><br><span class="line">--replication-factor 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看某 topic 某个分区的偏移量最大值和最小值 :TODO  啥意思??</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">kafka-run-class.sh kafka.tools.GetOffsetShell --topic kafka_test1 --time -1 --broker-list cs1:9092,cs2:9092,cs3:9092 --partitions 1</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">重新布局分区和副本，手动再平衡  :TODO 还未测试 </span><br><span class="line">------------------------------------------------------------</span><br><span class="line">alter 似乎是有问题的, create好像没问题</span><br><span class="line">此句是手动把分区放到 203 &amp; 204上了</span><br><span class="line">    $&gt;kafka-topics.sh --alter --zookeeper s202:2181 --topic test2 --replica-assignment 203:204,203:204,203:204,203:204,203:204</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">测试 producer 发消息后, 存在本地的logs 目录的文件</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">1. 开启一个producer, 发消息</span><br><span class="line">2. 查看本地 <span class="built_in">cd</span>  ~/kafka/logs</span><br><span class="line">3. 查看文件大小, 找出文件(一次性查看)</span><br><span class="line">    1. [ap@cs1]~% xcall.sh <span class="string">"ls -lh  kafka/logs/test2-*"</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">副本</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">broker存放消息以消息达到顺序存放。生产和消费都是副本感知的。</span><br><span class="line">支持到n-1故障。每个分区都有leader，follow.</span><br><span class="line">leader挂掉时，消息分区写入到本地<span class="built_in">log</span>或者，向生产者发送消息确认回执之前，生产者向新的leader发送消息。</span><br><span class="line"></span><br><span class="line">新leader的选举是通过isr进行，第一个注册的follower成为leader。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## kafka支持副本模式, 就是 producer 写到 broker的 topic中的 partition 的副本机制</span></span><br><span class="line">---------------------</span><br><span class="line">[同步复制]</span><br><span class="line">    1.producer联系zk识别leader</span><br><span class="line">    2.向leader发送消息</span><br><span class="line">    3.leadr收到消息写入到本地<span class="built_in">log</span></span><br><span class="line">    4.follower从leader pull消息</span><br><span class="line">    5.follower向本地写入<span class="built_in">log</span></span><br><span class="line">    6.follower向leader发送ack消息</span><br><span class="line">    7.leader收到所有follower的ack消息</span><br><span class="line">    8.leader向producer回传ack</span><br><span class="line">                    </span><br><span class="line">    </span><br><span class="line">[异步副本]</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">    和同步复制的区别在于 leader写入本地<span class="built_in">log</span>之后，</span><br><span class="line">    直接向client回传ack消息，不需要等待所有follower复制完成。</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka 副本模式 &amp; leader 机制 | 官方文档</span></span><br><span class="line">----------------------------------------------------</span><br><span class="line">ps : 推选leader过程就是follower在zk中注册过程，第一个注册就是leader</span><br><span class="line"></span><br><span class="line">The process of choosing the new lead replica is that all followers<span class="string">' In-sync Replicas (ISRs) register themselves with ZooKeeper. The very first registered replica becomes the new lead replica, and the rest of the registered replicas become the followers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Kafka supports the following replication modes:</span></span><br><span class="line"><span class="string">• Synchronous replication: In synchronous replication, a producer first identifies the lead replica from ZooKeeper and publishes the message. As soon as the message is published, it is written to the log of the lead replica and all the followers of the lead start pulling the message, and by using a single channel, the order of messages is ensured. Each follower replica sends an acknowledgement to the lead replica once the message is written to its respective logs. Once replications are complete and all expected acknowledgements are received, the lead replica sends an acknowledgement to the producer.</span></span><br><span class="line"><span class="string">On the consumer side, all the pulling of messages is done from the lead replica.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">• Asynchronous replication: The only difference in this mode is that as soon as a lead replica writes the message to its local log, it sends the acknowledgement to the message client and does not wait for the acknowledgements from follower replicas. But as a down side, this mode does not ensure the message delivery in case of broker failure.</span></span><br></pre></td></tr></table></figure>
<h2 id="5-Kafka-java-API"><a href="#5-Kafka-java-API" class="headerlink" title="5.Kafka java API"></a>5.Kafka java API</h2><h4 id="5-0-pom-文件"><a href="#5-0-pom-文件" class="headerlink" title="5.0   pom 文件"></a>5.0   pom 文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Kafka_Demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="5-1实现消息生产者，发送-amp-接受-消息"><a href="#5-1实现消息生产者，发送-amp-接受-消息" class="headerlink" title="5.1实现消息生产者，发送&amp;接受 消息"></a>5.1实现消息生产者，发送&amp;接受 消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rox.kafkademo.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kafka.consumer.Consumer;</span><br><span class="line"><span class="keyword">import</span> kafka.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> kafka.consumer.ConsumerIterator;</span><br><span class="line"><span class="keyword">import</span> kafka.consumer.KafkaStream;</span><br><span class="line"><span class="keyword">import</span> kafka.producer.KeyedMessage$;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kafka.javaapi.producer.Producer;</span><br><span class="line"><span class="keyword">import</span> kafka.producer.KeyedMessage;</span><br><span class="line"><span class="keyword">import</span> kafka.producer.ProducerConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProducer</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息 producer</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// broker列表</span></span><br><span class="line">        props.put(<span class="string">"metadata.broker.list"</span>,<span class="string">"cs2:9092"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 串行化</span></span><br><span class="line">        props.put(<span class="string">"serializer.class"</span>, <span class="string">"kafka.serializer.StringEncoder"</span>);</span><br><span class="line">        props.put(<span class="string">"request.required.acks"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建生产者配置对象</span></span><br><span class="line">        ProducerConfig config = <span class="keyword">new</span> ProducerConfig(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建生产者</span></span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">new</span> Producer&lt;String, String&gt;(config);</span><br><span class="line"></span><br><span class="line">        KeyedMessage&lt;String, String&gt; msg = <span class="keyword">new</span> KeyedMessage&lt;String, String&gt;(<span class="string">"test2"</span>, <span class="string">"100"</span>, <span class="string">"hello word fuck you kafka"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送</span></span><br><span class="line">        producer.send(msg);</span><br><span class="line">        System.out.println(<span class="string">"发送完成"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收消息 consumer</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConsumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(<span class="string">"zookeeper.connect"</span>, <span class="string">"cs2:2181"</span>);</span><br><span class="line">        props.put(<span class="string">"group.id"</span>, <span class="string">"g2"</span>);</span><br><span class="line">        props.put(<span class="string">"zookeeper.session.timeout.ms"</span>, <span class="string">"500"</span>);</span><br><span class="line">        props.put(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"smallest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建消费者配置对象</span></span><br><span class="line">        ConsumerConfig config = <span class="keyword">new</span> ConsumerConfig(props);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">        map.put(<span class="string">"test2"</span>, <span class="keyword">new</span> Integer(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;&gt; msgs = Consumer.createJavaConsumerConnector(<span class="keyword">new</span> ConsumerConfig(props)).createMessageStreams(map);</span><br><span class="line">        List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; msgList = msgs.get(<span class="string">"test2"</span>);</span><br><span class="line">        <span class="keyword">for</span>(KafkaStream&lt;<span class="keyword">byte</span>[],<span class="keyword">byte</span>[]&gt; stream : msgList)&#123;</span><br><span class="line">            ConsumerIterator&lt;<span class="keyword">byte</span>[],<span class="keyword">byte</span>[]&gt; it = stream.iterator();</span><br><span class="line">            <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">                <span class="keyword">byte</span>[] message = it.next().message();</span><br><span class="line">                System.out.println(<span class="keyword">new</span> String(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-新的-API"><a href="#5-2-新的-API" class="headerlink" title="5.2 新的 API"></a>5.2 新的 API</h4><h2 id="6-Flume-集成-kafak"><a href="#6-Flume-集成-kafak" class="headerlink" title="6.Flume 集成 kafak"></a>6.Flume 集成 kafak</h2><h4 id="6-1KafkaSink"><a href="#6-1KafkaSink" class="headerlink" title="6.1KafkaSink"></a>6.1KafkaSink</h4><p><strong>kafka 是 consumer (消费者)</strong></p>
<p><strong>flume 的消息, 经由 kafkaSink 导出到 kafka –最常用</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[flume 为生产者]</span><br><span class="line">1.1) flume 参数配置 </span><br><span class="line">----------------------------------------------------</span><br><span class="line">    a1.sources = r1</span><br><span class="line">    a1.sinks = k1</span><br><span class="line">    a1.channels = c1</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.type=netcat</span><br><span class="line">    a1.sources.r1.bind=localhost</span><br><span class="line">    a1.sources.r1.port=8888</span><br><span class="line"></span><br><span class="line">    a1.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSink</span><br><span class="line">    a1.sinks.k1.kafka.topic = test3</span><br><span class="line">    a1.sinks.k1.kafka.bootstrap.servers = cs2:9092</span><br><span class="line">    a1.sinks.k1.kafka.flumeBatchSize = 20</span><br><span class="line">    a1.sinks.k1.kafka.producer.acks = 1</span><br><span class="line"></span><br><span class="line">    a1.channels.c1.type=memory</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.channels = c1</span><br><span class="line">    a1.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line">1.2) 开启 kafka 消费者</span><br><span class="line">----------------------------------------------------</span><br><span class="line">    kafka-console-consumer.sh --bootstrap-server cs2:9092 --topic test3 --from-beginning</span><br><span class="line">    注意 :  Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper]. </span><br><span class="line">    使用 [bootstrap-server]代替[zookeeper]</span><br><span class="line"></span><br><span class="line">1.3) flume 执行 kafka_sink.conf </span><br><span class="line">----------------------------------------------------</span><br><span class="line">	flume-ng agent -f apps/flume/conf/confs/kafka_sink.conf -n a1</span><br><span class="line"></span><br><span class="line">1.4) 验证端口</span><br><span class="line">----------------------------------------------------</span><br><span class="line">    netstat -anop | grep 8888  </span><br><span class="line">    [OR]</span><br><span class="line">    lsof -i tcp:8888</span><br><span class="line"></span><br><span class="line">1.5) nc 连接</span><br><span class="line">----------------------------------------------------</span><br><span class="line">    nc localhost 8888</span><br><span class="line">    发消息....</span><br><span class="line"></span><br><span class="line">1.6) 观察 kafka 消费者接受消息</span><br><span class="line">----------------------------------------------------</span><br><span class="line">	发现特别快!</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">========================================================</span><br><span class="line">简单案例2</span><br><span class="line">--------------</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">a1.sources.r1.type=<span class="built_in">exec</span></span><br><span class="line"><span class="comment">#-F 最后10行,如果从头开始收集 -c +0 -F:持续收集后续数据,否则进程停止。</span></span><br><span class="line">a1.sources.r1.command=tail -F -c +0  /home/ap/calllog/calllog.log</span><br><span class="line"></span><br><span class="line">a1.channels.c1.type=memory</span><br><span class="line"></span><br><span class="line">a1.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSink</span><br><span class="line">a1.sinks.k1.kafka.topic = calllog</span><br><span class="line">a1.sinks.k1.kafka.bootstrap.servers = cs2:9092 cs3:9092 cs4:9092</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many messages to process in one batch. Larger batches improve throughput while adding latency.</span></span><br><span class="line">a1.sinks.k1.kafka.flumeBatchSize = 20</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many replicas must acknowledge a message before its considered successfully written. Accepted values are 0 (Never wait for acknowledgement), 1 (wait for leader only), -1 (wait for all replicas) Set this to -1 to avoid data loss in some cases of leader failure.</span></span><br><span class="line">a1.sinks.k1.kafka.producer.acks = 1</span><br><span class="line"></span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="6-2-KafkaSource-TODO"><a href="#6-2-KafkaSource-TODO" class="headerlink" title="6.2 KafkaSource :TODO"></a>6.2 KafkaSource :TODO</h4><p><strong>flume source 从 kafka 抓数据, flume source 是消费者,  kafka 开启 producer.</strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[消费者]</span><br><span class="line">1) 配置</span><br><span class="line">    a1.sources = r1</span><br><span class="line">    a1.sinks = k1</span><br><span class="line">    a1.channels = c1</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.type = org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">    a1.sources.r1.batchSize = 5000</span><br><span class="line">    a1.sources.r1.batchDurationMillis = 2000</span><br><span class="line">    a1.sources.r1.kafka.bootstrap.servers =  cs2:9092</span><br><span class="line">    a1.sources.r1.kafka.topics = test3</span><br><span class="line">    a1.sources.r1.kafka.consumer.group.id = g4</span><br><span class="line"></span><br><span class="line">    a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line">    a1.channels.c1.type=memory</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.channels = c1</span><br><span class="line">    a1.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line">2) 启动 flume </span><br><span class="line">    flume-ng agent -f /home/ap/apps/flume/conf/confs/kafka_source.conf -n a1 -Dflume.root.logger=INFO,console</span><br><span class="line"></span><br><span class="line">3) 启动 kafka producer</span><br><span class="line">	kafka-console-producer.sh --broker-list cs2:9092 --topic test3 </span><br><span class="line"></span><br><span class="line">4) kafka 发消息:  收不到!!!!  :TODO</span><br></pre></td></tr></table></figure>
<h4 id="6-3-KafkaChannel-TODO"><a href="#6-3-KafkaChannel-TODO" class="headerlink" title="6.3 KafkaChannel  :TODO"></a>6.3 KafkaChannel  :TODO</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">:TODO  也出错 ?? </span><br><span class="line">    越界</span><br><span class="line">            生产者 + 消费者</span><br><span class="line">    a1.sources = r1</span><br><span class="line">    a1.sinks = k1</span><br><span class="line">    a1.channels = c1</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.type = avro</span><br><span class="line">    a1.sources.r1.bind = localhost</span><br><span class="line">    a1.sources.r1.port = 8888</span><br><span class="line"></span><br><span class="line">    a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line">    a1.channels.c1.type = org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">    a1.channels.c1.kafka.bootstrap.servers = cs2:9092</span><br><span class="line">    a1.channels.c1.kafka.topic = test3</span><br><span class="line">    a1.channels.c1.kafka.consumer.group.id = g6</span><br><span class="line">    a1.channels.c1.kafka.parseAsFlumeEvent = <span class="literal">false</span></span><br><span class="line">    a1.channels.c1.zookeeperConnect= cs2:2181</span><br><span class="line"></span><br><span class="line">    a1.sources.r1.channels = c1</span><br><span class="line">    a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>如果帮到你, 可以给我赞助杯咖啡☕️</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/images/wechat-reward.jpg" alt="airpoet 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/原创/" rel="tag"># 原创</a>
          
            <a href="/tags/技术/" rel="tag"># 技术</a>
          
            <a href="/tags/Hadoop/" rel="tag"># Hadoop</a>
          
            <a href="/tags/Kafka/" rel="tag"># Kafka</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/30/Hadoop/7-Flume&Kafka/Flume/" rel="next" title="Flume">
                <i class="fa fa-chevron-left"></i> Flume
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/03/Hadoop/8_Redis/Redis/" rel="prev" title="Redis">
                Redis <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p6i5vzkfk.bkt.clouddn.com/study/2018-06-14-045043.jpg"
                alt="airpoet" />
            
              <p class="site-author-name" itemprop="name">airpoet</p>
              <p class="site-description motion-element" itemprop="description">没有边界就没有自由.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">115</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/3b9b97fe7e04" target="_blank" title="我的简书">
                      
                        <i class="fa fa-fw fa-globe"></i>我的简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:airpoet@qq.com" target="_blank" title="Mile2Me">
                      
                        <i class="fa fa-fw fa-envelope"></i>Mile2Me</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/8ee264c6557d" title="女神凉姨" target="_blank">女神凉姨</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-概览"><span class="nav-text">1.概览</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kafka-的要点"><span class="nav-text">kafka 的要点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka-的大致工作模式："><span class="nav-text">Kafka 的大致工作模式：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-安装-kafka"><span class="nav-text">2.安装 kafka</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-kafka集群在zk的配置"><span class="nav-text">3.kafka集群在zk的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-kafka-主题-amp-副本操作"><span class="nav-text">4.kafka 主题&amp;副本操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Kafka-java-API"><span class="nav-text">5.Kafka java API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-0-pom-文件"><span class="nav-text">5.0   pom 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1实现消息生产者，发送-amp-接受-消息"><span class="nav-text">5.1实现消息生产者，发送&amp;接受 消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-新的-API"><span class="nav-text">5.2 新的 API</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Flume-集成-kafak"><span class="nav-text">6.Flume 集成 kafak</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1KafkaSink"><span class="nav-text">6.1KafkaSink</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-KafkaSource-TODO"><span class="nav-text">6.2 KafkaSource :TODO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-KafkaChannel-TODO"><span class="nav-text">6.3 KafkaChannel  :TODO</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">airpoet</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://A.P.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://airpoet.github.io/2018/07/01/Hadoop/7-Flume&Kafka/Kafka/';
          this.page.identifier = '2018/07/01/Hadoop/7-Flume&Kafka/Kafka/';
          this.page.title = 'Kafka';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://A.P.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
